<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ARK2D: src/ARK2D/vendor/lpng151/pngrtran.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ARK2D
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('pngrtran_8c.html','');
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">src/ARK2D/vendor/lpng151/pngrtran.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="pngrtran_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="comment">/* pngrtran.c - transforms the data in a row for PNG readers</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Last changed in libpng 1.5.1 [February 3, 2011]</span>
<a name="l00005"></a>00005 <span class="comment"> * Copyright (c) 1998-2011 Glenn Randers-Pehrson</span>
<a name="l00006"></a>00006 <span class="comment"> * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)</span>
<a name="l00007"></a>00007 <span class="comment"> * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This code is released under the libpng license.</span>
<a name="l00010"></a>00010 <span class="comment"> * For conditions of distribution and use, see the disclaimer</span>
<a name="l00011"></a>00011 <span class="comment"> * and license in png.h</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * This file contains functions optionally called by an application</span>
<a name="l00014"></a>00014 <span class="comment"> * in order to tell libpng how to handle data when reading a PNG.</span>
<a name="l00015"></a>00015 <span class="comment"> * Transformations that are used in both reading and writing are</span>
<a name="l00016"></a>00016 <span class="comment"> * in pngtrans.c.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="pngpriv_8h.html">pngpriv.h</a>&quot;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#ifdef PNG_READ_SUPPORTED</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 <span class="comment">/* Set the action on getting a CRC error for an ancillary or critical chunk. */</span>
<a name="l00024"></a>00024 <span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00025"></a><a class="code" href="pngrtran_8c.html#ab5410e99c2f89f747480999d1824c286">00025</a> <a class="code" href="pngrtran_8c.html#ab5410e99c2f89f747480999d1824c286">png_set_crc_action</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr, <span class="keywordtype">int</span> crit_action, <span class="keywordtype">int</span> ancil_action)
<a name="l00026"></a>00026 {
<a name="l00027"></a>00027    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_crc_action&quot;</span>);
<a name="l00028"></a>00028 
<a name="l00029"></a>00029    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00030"></a>00030       <span class="keywordflow">return</span>;
<a name="l00031"></a>00031 
<a name="l00032"></a>00032    <span class="comment">/* Tell libpng how we react to CRC errors in critical chunks */</span>
<a name="l00033"></a>00033    <span class="keywordflow">switch</span> (crit_action)
<a name="l00034"></a>00034    {
<a name="l00035"></a>00035       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#aec797bd595810b63c4fb5a7ed1f6aeaf">PNG_CRC_NO_CHANGE</a>:                        <span class="comment">/* Leave setting as is */</span>
<a name="l00036"></a>00036          <span class="keywordflow">break</span>;
<a name="l00037"></a>00037 
<a name="l00038"></a>00038       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#aec4131e1d7116c4d5a63d9a749f01b10">PNG_CRC_WARN_USE</a>:                               <span class="comment">/* Warn/use data */</span>
<a name="l00039"></a>00039          png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#a5ec52ff06ace485cf3747067654780f5">PNG_FLAG_CRC_CRITICAL_MASK</a>;
<a name="l00040"></a>00040          png_ptr-&gt;flags |= <a class="code" href="pngpriv_8h.html#a2bdec947e68eabedc6affa7f0e869ec0">PNG_FLAG_CRC_CRITICAL_USE</a>;
<a name="l00041"></a>00041          <span class="keywordflow">break</span>;
<a name="l00042"></a>00042 
<a name="l00043"></a>00043       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a72d8ab50dcc1c24a99abe99970cd59d4">PNG_CRC_QUIET_USE</a>:                             <span class="comment">/* Quiet/use data */</span>
<a name="l00044"></a>00044          png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#a5ec52ff06ace485cf3747067654780f5">PNG_FLAG_CRC_CRITICAL_MASK</a>;
<a name="l00045"></a>00045          png_ptr-&gt;flags |= <a class="code" href="pngpriv_8h.html#a2bdec947e68eabedc6affa7f0e869ec0">PNG_FLAG_CRC_CRITICAL_USE</a> |
<a name="l00046"></a>00046                            <a class="code" href="pngpriv_8h.html#a922b5a4db5f1662ba212ee02675b5312">PNG_FLAG_CRC_CRITICAL_IGNORE</a>;
<a name="l00047"></a>00047          <span class="keywordflow">break</span>;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a41d8267d916aa3fcf8596f7c82781dee">PNG_CRC_WARN_DISCARD</a>:    <span class="comment">/* Not a valid action for critical data */</span>
<a name="l00050"></a>00050          <a class="code" href="pngerror_8c.html#a34b3bb3a1ff0050b9317c3ca6d18df24">png_warning</a>(png_ptr,
<a name="l00051"></a>00051             <span class="stringliteral">&quot;Can&#39;t discard critical data on CRC error&quot;</span>);
<a name="l00052"></a>00052       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#ae0798892ae905a1bf8a2a90f390cae68">PNG_CRC_ERROR_QUIT</a>:                                <span class="comment">/* Error/quit */</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a2566b8927857d163d6788bde3caf3fd5">PNG_CRC_DEFAULT</a>:
<a name="l00055"></a>00055       <span class="keywordflow">default</span>:
<a name="l00056"></a>00056          png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#a5ec52ff06ace485cf3747067654780f5">PNG_FLAG_CRC_CRITICAL_MASK</a>;
<a name="l00057"></a>00057          <span class="keywordflow">break</span>;
<a name="l00058"></a>00058    }
<a name="l00059"></a>00059 
<a name="l00060"></a>00060    <span class="comment">/* Tell libpng how we react to CRC errors in ancillary chunks */</span>
<a name="l00061"></a>00061    <span class="keywordflow">switch</span> (ancil_action)
<a name="l00062"></a>00062    {
<a name="l00063"></a>00063       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#aec797bd595810b63c4fb5a7ed1f6aeaf">PNG_CRC_NO_CHANGE</a>:                       <span class="comment">/* Leave setting as is */</span>
<a name="l00064"></a>00064          <span class="keywordflow">break</span>;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#aec4131e1d7116c4d5a63d9a749f01b10">PNG_CRC_WARN_USE</a>:                              <span class="comment">/* Warn/use data */</span>
<a name="l00067"></a>00067          png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#a785b09e694fd4a494216db8047350827">PNG_FLAG_CRC_ANCILLARY_MASK</a>;
<a name="l00068"></a>00068          png_ptr-&gt;flags |= <a class="code" href="pngpriv_8h.html#a39cce97abbb75d1b5bc9b67badb01219">PNG_FLAG_CRC_ANCILLARY_USE</a>;
<a name="l00069"></a>00069          <span class="keywordflow">break</span>;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a72d8ab50dcc1c24a99abe99970cd59d4">PNG_CRC_QUIET_USE</a>:                            <span class="comment">/* Quiet/use data */</span>
<a name="l00072"></a>00072          png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#a785b09e694fd4a494216db8047350827">PNG_FLAG_CRC_ANCILLARY_MASK</a>;
<a name="l00073"></a>00073          png_ptr-&gt;flags |= <a class="code" href="pngpriv_8h.html#a39cce97abbb75d1b5bc9b67badb01219">PNG_FLAG_CRC_ANCILLARY_USE</a> |
<a name="l00074"></a>00074                            <a class="code" href="pngpriv_8h.html#a51179052df9802a7c8db76c5b182cb9b">PNG_FLAG_CRC_ANCILLARY_NOWARN</a>;
<a name="l00075"></a>00075          <span class="keywordflow">break</span>;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#ae0798892ae905a1bf8a2a90f390cae68">PNG_CRC_ERROR_QUIT</a>:                               <span class="comment">/* Error/quit */</span>
<a name="l00078"></a>00078          png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#a785b09e694fd4a494216db8047350827">PNG_FLAG_CRC_ANCILLARY_MASK</a>;
<a name="l00079"></a>00079          png_ptr-&gt;flags |= <a class="code" href="pngpriv_8h.html#a51179052df9802a7c8db76c5b182cb9b">PNG_FLAG_CRC_ANCILLARY_NOWARN</a>;
<a name="l00080"></a>00080          <span class="keywordflow">break</span>;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a41d8267d916aa3fcf8596f7c82781dee">PNG_CRC_WARN_DISCARD</a>:                      <span class="comment">/* Warn/discard data */</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084       <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a2566b8927857d163d6788bde3caf3fd5">PNG_CRC_DEFAULT</a>:
<a name="l00085"></a>00085       <span class="keywordflow">default</span>:
<a name="l00086"></a>00086          png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#a785b09e694fd4a494216db8047350827">PNG_FLAG_CRC_ANCILLARY_MASK</a>;
<a name="l00087"></a>00087          <span class="keywordflow">break</span>;
<a name="l00088"></a>00088    }
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="preprocessor">#ifdef PNG_READ_BACKGROUND_SUPPORTED</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="comment">/* Handle alpha and tRNS via a background color */</span>
<a name="l00093"></a>00093 <span class="keywordtype">void</span> <a class="code" href="pngpriv_8h.html#a79ff4521dd0f0f4ef9384534e26584e5">PNGFAPI</a>
<a name="l00094"></a><a class="code" href="pngrtran_8c.html#ac85c93520588809faf82728eba4bace7">00094</a> <a class="code" href="pngrtran_8c.html#ac85c93520588809faf82728eba4bace7">png_set_background_fixed</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr,
<a name="l00095"></a>00095     <a class="code" href="png_8h.html#ab40f2d0b64d6dedbdcfabdaada204863">png_const_color_16p</a> background_color, <span class="keywordtype">int</span> background_gamma_code,
<a name="l00096"></a>00096     <span class="keywordtype">int</span> need_expand, <a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> background_gamma)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_background_fixed&quot;</span>);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00101"></a>00101       <span class="keywordflow">return</span>;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103    <span class="keywordflow">if</span> (background_gamma_code == <a class="code" href="png_8h.html#acab81f27c757b0fc364c32c557598237">PNG_BACKGROUND_GAMMA_UNKNOWN</a>)
<a name="l00104"></a>00104    {
<a name="l00105"></a>00105       <a class="code" href="pngerror_8c.html#a34b3bb3a1ff0050b9317c3ca6d18df24">png_warning</a>(png_ptr, <span class="stringliteral">&quot;Application must supply a known background gamma&quot;</span>);
<a name="l00106"></a>00106       <span class="keywordflow">return</span>;
<a name="l00107"></a>00107    }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109    png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#a50b268079e6d070ec3f695503b104929">PNG_BACKGROUND</a>;
<a name="l00110"></a>00110    <a class="code" href="pngpriv_8h.html#a142df9a55255d0878cc17a10957acbd9">png_memcpy</a>(&amp;(png_ptr-&gt;background), background_color,
<a name="l00111"></a>00111       <a class="code" href="pngconf_8h.html#a18c80f490efdb3ecfc2bb6aa840a94c0">png_sizeof</a>(<a class="code" href="structpng__color__16__struct.html">png_color_16</a>));
<a name="l00112"></a>00112    png_ptr-&gt;background_gamma = background_gamma;
<a name="l00113"></a>00113    png_ptr-&gt;background_gamma_type = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background_gamma_code);
<a name="l00114"></a>00114    png_ptr-&gt;transformations |= (need_expand ? <a class="code" href="pngpriv_8h.html#a791f1a1597217b632f1b49fa83d43525">PNG_BACKGROUND_EXPAND</a> : 0);
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="preprocessor">#  ifdef PNG_FLOATING_POINT_SUPPORTED</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00119"></a><a class="code" href="pngrtran_8c.html#a8bf366b6942948c17fd3f0fb00556521">00119</a> <a class="code" href="pngrtran_8c.html#a8bf366b6942948c17fd3f0fb00556521">png_set_background</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr,
<a name="l00120"></a>00120     <a class="code" href="png_8h.html#ab40f2d0b64d6dedbdcfabdaada204863">png_const_color_16p</a> background_color, <span class="keywordtype">int</span> background_gamma_code,
<a name="l00121"></a>00121     <span class="keywordtype">int</span> need_expand, <span class="keywordtype">double</span> background_gamma)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123    <a class="code" href="pngrtran_8c.html#ac85c93520588809faf82728eba4bace7">png_set_background_fixed</a>(png_ptr, background_color, background_gamma_code,
<a name="l00124"></a>00124       need_expand, <a class="code" href="png_8c.html#aac88dce74a4459fb930afbd17bb32965">png_fixed</a>(png_ptr, background_gamma, <span class="stringliteral">&quot;png_set_background&quot;</span>));
<a name="l00125"></a>00125 }
<a name="l00126"></a>00126 <span class="preprocessor">#  endif  </span><span class="comment">/* FLOATING_POINT */</span>
<a name="l00127"></a>00127 <span class="preprocessor">#endif </span><span class="comment">/* READ_BACKGROUND */</span>
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="preprocessor">#ifdef PNG_READ_16_TO_8_SUPPORTED</span>
<a name="l00130"></a>00130 <span class="preprocessor"></span><span class="comment">/* Strip 16 bit depth files to 8 bit depth */</span>
<a name="l00131"></a>00131 <span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00132"></a><a class="code" href="pngrtran_8c.html#a93f89506543a622d9e23495b26387508">00132</a> <a class="code" href="pngrtran_8c.html#a93f89506543a622d9e23495b26387508">png_set_strip_16</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr)
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_strip_16&quot;</span>);
<a name="l00135"></a>00135 
<a name="l00136"></a>00136    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00137"></a>00137       <span class="keywordflow">return</span>;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139    png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#ae70a30d4407554f37c393a1755b1aba2">PNG_16_TO_8</a>;
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 <span class="preprocessor">#endif</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span>
<a name="l00143"></a>00143 <span class="preprocessor">#ifdef PNG_READ_STRIP_ALPHA_SUPPORTED</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00145"></a><a class="code" href="pngrtran_8c.html#ac7d9b1dcc56a717791993b4edbb90ca4">00145</a> <a class="code" href="pngrtran_8c.html#ac7d9b1dcc56a717791993b4edbb90ca4">png_set_strip_alpha</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr)
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_strip_alpha&quot;</span>);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00150"></a>00150       <span class="keywordflow">return</span>;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152    png_ptr-&gt;flags |= <a class="code" href="pngpriv_8h.html#a2f97a7023aad11e350a082928b9eef0d">PNG_FLAG_STRIP_ALPHA</a>;
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 <span class="preprocessor">#endif</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>
<a name="l00156"></a>00156 <span class="preprocessor">#ifdef PNG_READ_QUANTIZE_SUPPORTED</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span><span class="comment">/* Dither file to 8 bit.  Supply a palette, the current number</span>
<a name="l00158"></a>00158 <span class="comment"> * of elements in the palette, the maximum number of elements</span>
<a name="l00159"></a>00159 <span class="comment"> * allowed, and a histogram if possible.  If the current number</span>
<a name="l00160"></a>00160 <span class="comment"> * of colors is greater then the maximum number, the palette will be</span>
<a name="l00161"></a>00161 <span class="comment"> * modified to fit in the maximum number.  &quot;full_quantize&quot; indicates</span>
<a name="l00162"></a>00162 <span class="comment"> * whether we need a quantizing cube set up for RGB images, or if we</span>
<a name="l00163"></a>00163 <span class="comment"> * simply are reducing the number of colors in a paletted image.</span>
<a name="l00164"></a>00164 <span class="comment"> */</span>
<a name="l00165"></a>00165 
<a name="l00166"></a><a class="code" href="structpng__dsort__struct.html">00166</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structpng__dsort__struct.html">png_dsort_struct</a>
<a name="l00167"></a>00167 {
<a name="l00168"></a><a class="code" href="structpng__dsort__struct.html#a1220c12ccc8d2eb1f3c0f49548efdfe7">00168</a>    <span class="keyword">struct </span><a class="code" href="structpng__dsort__struct.html">png_dsort_struct</a> <a class="code" href="pngconf_8h.html#aef060b3456fdcc093a7210a762d5f2ed">FAR</a> * <a class="code" href="structpng__dsort__struct.html#a1220c12ccc8d2eb1f3c0f49548efdfe7">next</a>;
<a name="l00169"></a><a class="code" href="structpng__dsort__struct.html#a09ba275bb5489f22e906be30b63f5452">00169</a>    <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> <a class="code" href="structpng__dsort__struct.html#a09ba275bb5489f22e906be30b63f5452">left</a>;
<a name="l00170"></a><a class="code" href="structpng__dsort__struct.html#a9cfe3ab6de9319c0d18dd16075c21fa2">00170</a>    <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> <a class="code" href="structpng__dsort__struct.html#a9cfe3ab6de9319c0d18dd16075c21fa2">right</a>;
<a name="l00171"></a>00171 } <a class="code" href="pngrtran_8c.html#a109d232389c1eeff31ccb300320b74e9">png_dsort</a>;
<a name="l00172"></a><a class="code" href="pngrtran_8c.html#a1c9734331d58dab58b3187252c02721f">00172</a> <span class="keyword">typedef</span> <a class="code" href="structpng__dsort__struct.html">png_dsort</a> <a class="code" href="pngconf_8h.html#aef060b3456fdcc093a7210a762d5f2ed">FAR</a> *       <a class="code" href="pngrtran_8c.html#a1c9734331d58dab58b3187252c02721f">png_dsortp</a>;
<a name="l00173"></a><a class="code" href="pngrtran_8c.html#a4c6bf79ae4dc283a545647f05423a21d">00173</a> <span class="keyword">typedef</span> <a class="code" href="structpng__dsort__struct.html">png_dsort</a> <a class="code" href="pngconf_8h.html#aef060b3456fdcc093a7210a762d5f2ed">FAR</a> * <a class="code" href="pngconf_8h.html#aef060b3456fdcc093a7210a762d5f2ed">FAR</a> * <a class="code" href="pngrtran_8c.html#a4c6bf79ae4dc283a545647f05423a21d">png_dsortpp</a>;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00176"></a><a class="code" href="pngrtran_8c.html#ac1500120eb60ee1910e3e1757c2f248f">00176</a> <a class="code" href="pngrtran_8c.html#ac1500120eb60ee1910e3e1757c2f248f">png_set_quantize</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr, <a class="code" href="png_8h.html#a22c26a022c2bdca0fed457713767ca45">png_colorp</a> palette,
<a name="l00177"></a>00177     <span class="keywordtype">int</span> num_palette, <span class="keywordtype">int</span> maximum_colors, <a class="code" href="pngconf_8h.html#af040d366dbbac90e543804785b0695be">png_const_uint_16p</a> histogram,
<a name="l00178"></a>00178     <span class="keywordtype">int</span> full_quantize)
<a name="l00179"></a>00179 {
<a name="l00180"></a>00180    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_quantize&quot;</span>);
<a name="l00181"></a>00181 
<a name="l00182"></a>00182    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00183"></a>00183       <span class="keywordflow">return</span>;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185    png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#a612425a0a63db8b8651d599f99745829">PNG_QUANTIZE</a>;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187    <span class="keywordflow">if</span> (!full_quantize)
<a name="l00188"></a>00188    {
<a name="l00189"></a>00189       <span class="keywordtype">int</span> i;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191       png_ptr-&gt;quantize_index = (<a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a>)png_malloc(png_ptr,
<a name="l00192"></a>00192           (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)(num_palette * <a class="code" href="pngconf_8h.html#a18c80f490efdb3ecfc2bb6aa840a94c0">png_sizeof</a>(<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)));
<a name="l00193"></a>00193       <span class="keywordflow">for</span> (i = 0; i &lt; num_palette; i++)
<a name="l00194"></a>00194          png_ptr-&gt;quantize_index[i] = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)i;
<a name="l00195"></a>00195    }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197    <span class="keywordflow">if</span> (num_palette &gt; maximum_colors)
<a name="l00198"></a>00198    {
<a name="l00199"></a>00199       <span class="keywordflow">if</span> (histogram != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00200"></a>00200       {
<a name="l00201"></a>00201          <span class="comment">/* This is easy enough, just throw out the least used colors.</span>
<a name="l00202"></a>00202 <span class="comment">          * Perhaps not the best solution, but good enough.</span>
<a name="l00203"></a>00203 <span class="comment">          */</span>
<a name="l00204"></a>00204 
<a name="l00205"></a>00205          <span class="keywordtype">int</span> i;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207          <span class="comment">/* Initialize an array to sort colors */</span>
<a name="l00208"></a>00208          png_ptr-&gt;quantize_sort = (<a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a>)png_malloc(png_ptr,
<a name="l00209"></a>00209              (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)(num_palette * <a class="code" href="pngconf_8h.html#a18c80f490efdb3ecfc2bb6aa840a94c0">png_sizeof</a>(<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)));
<a name="l00210"></a>00210 
<a name="l00211"></a>00211          <span class="comment">/* Initialize the quantize_sort array */</span>
<a name="l00212"></a>00212          <span class="keywordflow">for</span> (i = 0; i &lt; num_palette; i++)
<a name="l00213"></a>00213             png_ptr-&gt;quantize_sort[i] = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)i;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215          <span class="comment">/* Find the least used palette entries by starting a</span>
<a name="l00216"></a>00216 <span class="comment">          * bubble sort, and running it until we have sorted</span>
<a name="l00217"></a>00217 <span class="comment">          * out enough colors.  Note that we don&#39;t care about</span>
<a name="l00218"></a>00218 <span class="comment">          * sorting all the colors, just finding which are</span>
<a name="l00219"></a>00219 <span class="comment">          * least used.</span>
<a name="l00220"></a>00220 <span class="comment">          */</span>
<a name="l00221"></a>00221 
<a name="l00222"></a>00222          <span class="keywordflow">for</span> (i = num_palette - 1; i &gt;= maximum_colors; i--)
<a name="l00223"></a>00223          {
<a name="l00224"></a>00224             <span class="keywordtype">int</span> done; <span class="comment">/* To stop early if the list is pre-sorted */</span>
<a name="l00225"></a>00225             <span class="keywordtype">int</span> j;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227             done = 1;
<a name="l00228"></a>00228             <span class="keywordflow">for</span> (j = 0; j &lt; i; j++)
<a name="l00229"></a>00229             {
<a name="l00230"></a>00230                <span class="keywordflow">if</span> (histogram[png_ptr-&gt;quantize_sort[j]]
<a name="l00231"></a>00231                    &lt; histogram[png_ptr-&gt;quantize_sort[j + 1]])
<a name="l00232"></a>00232                {
<a name="l00233"></a>00233                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> t;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235                   t = png_ptr-&gt;quantize_sort[j];
<a name="l00236"></a>00236                   png_ptr-&gt;quantize_sort[j] = png_ptr-&gt;quantize_sort[j + 1];
<a name="l00237"></a>00237                   png_ptr-&gt;quantize_sort[j + 1] = t;
<a name="l00238"></a>00238                   done = 0;
<a name="l00239"></a>00239                }
<a name="l00240"></a>00240             }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242             <span class="keywordflow">if</span> (done)
<a name="l00243"></a>00243                <span class="keywordflow">break</span>;
<a name="l00244"></a>00244          }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246          <span class="comment">/* Swap the palette around, and set up a table, if necessary */</span>
<a name="l00247"></a>00247          <span class="keywordflow">if</span> (full_quantize)
<a name="l00248"></a>00248          {
<a name="l00249"></a>00249             <span class="keywordtype">int</span> j = num_palette;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251             <span class="comment">/* Put all the useful colors within the max, but don&#39;t</span>
<a name="l00252"></a>00252 <span class="comment">             * move the others.</span>
<a name="l00253"></a>00253 <span class="comment">             */</span>
<a name="l00254"></a>00254             <span class="keywordflow">for</span> (i = 0; i &lt; maximum_colors; i++)
<a name="l00255"></a>00255             {
<a name="l00256"></a>00256                <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)png_ptr-&gt;quantize_sort[i] &gt;= maximum_colors)
<a name="l00257"></a>00257                {
<a name="l00258"></a>00258                   <span class="keywordflow">do</span>
<a name="l00259"></a>00259                      j--;
<a name="l00260"></a>00260                   <span class="keywordflow">while</span> ((<span class="keywordtype">int</span>)png_ptr-&gt;quantize_sort[j] &gt;= maximum_colors);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262                   palette[i] = palette[j];
<a name="l00263"></a>00263                }
<a name="l00264"></a>00264             }
<a name="l00265"></a>00265          }
<a name="l00266"></a>00266          <span class="keywordflow">else</span>
<a name="l00267"></a>00267          {
<a name="l00268"></a>00268             <span class="keywordtype">int</span> j = num_palette;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270             <span class="comment">/* Move all the used colors inside the max limit, and</span>
<a name="l00271"></a>00271 <span class="comment">             * develop a translation table.</span>
<a name="l00272"></a>00272 <span class="comment">             */</span>
<a name="l00273"></a>00273             <span class="keywordflow">for</span> (i = 0; i &lt; maximum_colors; i++)
<a name="l00274"></a>00274             {
<a name="l00275"></a>00275                <span class="comment">/* Only move the colors we need to */</span>
<a name="l00276"></a>00276                <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)png_ptr-&gt;quantize_sort[i] &gt;= maximum_colors)
<a name="l00277"></a>00277                {
<a name="l00278"></a>00278                   <a class="code" href="structpng__color__struct.html">png_color</a> tmp_color;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280                   <span class="keywordflow">do</span>
<a name="l00281"></a>00281                      j--;
<a name="l00282"></a>00282                   <span class="keywordflow">while</span> ((<span class="keywordtype">int</span>)png_ptr-&gt;quantize_sort[j] &gt;= maximum_colors);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284                   tmp_color = palette[j];
<a name="l00285"></a>00285                   palette[j] = palette[i];
<a name="l00286"></a>00286                   palette[i] = tmp_color;
<a name="l00287"></a>00287                   <span class="comment">/* Indicate where the color went */</span>
<a name="l00288"></a>00288                   png_ptr-&gt;quantize_index[j] = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)i;
<a name="l00289"></a>00289                   png_ptr-&gt;quantize_index[i] = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)j;
<a name="l00290"></a>00290                }
<a name="l00291"></a>00291             }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293             <span class="comment">/* Find closest color for those colors we are not using */</span>
<a name="l00294"></a>00294             <span class="keywordflow">for</span> (i = 0; i &lt; num_palette; i++)
<a name="l00295"></a>00295             {
<a name="l00296"></a>00296                <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)png_ptr-&gt;quantize_index[i] &gt;= maximum_colors)
<a name="l00297"></a>00297                {
<a name="l00298"></a>00298                   <span class="keywordtype">int</span> min_d, k, min_k, d_index;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300                   <span class="comment">/* Find the closest color to one we threw out */</span>
<a name="l00301"></a>00301                   d_index = png_ptr-&gt;quantize_index[i];
<a name="l00302"></a>00302                   min_d = <a class="code" href="pngpriv_8h.html#a9dad4da3d087bca8ed14727bae5f2a7e">PNG_COLOR_DIST</a>(palette[d_index], palette[0]);
<a name="l00303"></a>00303                   <span class="keywordflow">for</span> (k = 1, min_k = 0; k &lt; maximum_colors; k++)
<a name="l00304"></a>00304                   {
<a name="l00305"></a>00305                      <span class="keywordtype">int</span> d;
<a name="l00306"></a>00306 
<a name="l00307"></a>00307                      d = <a class="code" href="pngpriv_8h.html#a9dad4da3d087bca8ed14727bae5f2a7e">PNG_COLOR_DIST</a>(palette[d_index], palette[k]);
<a name="l00308"></a>00308 
<a name="l00309"></a>00309                      <span class="keywordflow">if</span> (d &lt; min_d)
<a name="l00310"></a>00310                      {
<a name="l00311"></a>00311                         min_d = d;
<a name="l00312"></a>00312                         min_k = k;
<a name="l00313"></a>00313                      }
<a name="l00314"></a>00314                   }
<a name="l00315"></a>00315                   <span class="comment">/* Point to closest color */</span>
<a name="l00316"></a>00316                   png_ptr-&gt;quantize_index[i] = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)min_k;
<a name="l00317"></a>00317                }
<a name="l00318"></a>00318             }
<a name="l00319"></a>00319          }
<a name="l00320"></a>00320          <a class="code" href="pngmem_8c.html#a6b14e847afcaed26a92542cfa0b3326a">png_free</a>(png_ptr, png_ptr-&gt;quantize_sort);
<a name="l00321"></a>00321          png_ptr-&gt;quantize_sort = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00322"></a>00322       }
<a name="l00323"></a>00323       <span class="keywordflow">else</span>
<a name="l00324"></a>00324       {
<a name="l00325"></a>00325          <span class="comment">/* This is much harder to do simply (and quickly).  Perhaps</span>
<a name="l00326"></a>00326 <span class="comment">          * we need to go through a median cut routine, but those</span>
<a name="l00327"></a>00327 <span class="comment">          * don&#39;t always behave themselves with only a few colors</span>
<a name="l00328"></a>00328 <span class="comment">          * as input.  So we will just find the closest two colors,</span>
<a name="l00329"></a>00329 <span class="comment">          * and throw out one of them (chosen somewhat randomly).</span>
<a name="l00330"></a>00330 <span class="comment">          * [We don&#39;t understand this at all, so if someone wants to</span>
<a name="l00331"></a>00331 <span class="comment">          *  work on improving it, be our guest - AED, GRP]</span>
<a name="l00332"></a>00332 <span class="comment">          */</span>
<a name="l00333"></a>00333          <span class="keywordtype">int</span> i;
<a name="l00334"></a>00334          <span class="keywordtype">int</span> max_d;
<a name="l00335"></a>00335          <span class="keywordtype">int</span> num_new_palette;
<a name="l00336"></a>00336          <a class="code" href="pngrtran_8c.html#a1c9734331d58dab58b3187252c02721f">png_dsortp</a> t;
<a name="l00337"></a>00337          <a class="code" href="pngrtran_8c.html#a4c6bf79ae4dc283a545647f05423a21d">png_dsortpp</a> hash;
<a name="l00338"></a>00338 
<a name="l00339"></a>00339          t = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341          <span class="comment">/* Initialize palette index arrays */</span>
<a name="l00342"></a>00342          png_ptr-&gt;index_to_palette = (<a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a>)png_malloc(png_ptr,
<a name="l00343"></a>00343              (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)(num_palette * <a class="code" href="pngconf_8h.html#a18c80f490efdb3ecfc2bb6aa840a94c0">png_sizeof</a>(<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)));
<a name="l00344"></a>00344          png_ptr-&gt;palette_to_index = (<a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a>)png_malloc(png_ptr,
<a name="l00345"></a>00345              (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)(num_palette * <a class="code" href="pngconf_8h.html#a18c80f490efdb3ecfc2bb6aa840a94c0">png_sizeof</a>(<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)));
<a name="l00346"></a>00346 
<a name="l00347"></a>00347          <span class="comment">/* Initialize the sort array */</span>
<a name="l00348"></a>00348          <span class="keywordflow">for</span> (i = 0; i &lt; num_palette; i++)
<a name="l00349"></a>00349          {
<a name="l00350"></a>00350             png_ptr-&gt;index_to_palette[i] = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)i;
<a name="l00351"></a>00351             png_ptr-&gt;palette_to_index[i] = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)i;
<a name="l00352"></a>00352          }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354          hash = (<a class="code" href="pngrtran_8c.html#a4c6bf79ae4dc283a545647f05423a21d">png_dsortpp</a>)png_calloc(png_ptr, (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)(769 *
<a name="l00355"></a>00355              <a class="code" href="pngconf_8h.html#a18c80f490efdb3ecfc2bb6aa840a94c0">png_sizeof</a>(<a class="code" href="pngrtran_8c.html#a1c9734331d58dab58b3187252c02721f">png_dsortp</a>)));
<a name="l00356"></a>00356 
<a name="l00357"></a>00357          num_new_palette = num_palette;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359          <span class="comment">/* Initial wild guess at how far apart the farthest pixel</span>
<a name="l00360"></a>00360 <span class="comment">          * pair we will be eliminating will be.  Larger</span>
<a name="l00361"></a>00361 <span class="comment">          * numbers mean more areas will be allocated, Smaller</span>
<a name="l00362"></a>00362 <span class="comment">          * numbers run the risk of not saving enough data, and</span>
<a name="l00363"></a>00363 <span class="comment">          * having to do this all over again.</span>
<a name="l00364"></a>00364 <span class="comment">          *</span>
<a name="l00365"></a>00365 <span class="comment">          * I have not done extensive checking on this number.</span>
<a name="l00366"></a>00366 <span class="comment">          */</span>
<a name="l00367"></a>00367          max_d = 96;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369          <span class="keywordflow">while</span> (num_new_palette &gt; maximum_colors)
<a name="l00370"></a>00370          {
<a name="l00371"></a>00371             <span class="keywordflow">for</span> (i = 0; i &lt; num_new_palette - 1; i++)
<a name="l00372"></a>00372             {
<a name="l00373"></a>00373                <span class="keywordtype">int</span> j;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375                <span class="keywordflow">for</span> (j = i + 1; j &lt; num_new_palette; j++)
<a name="l00376"></a>00376                {
<a name="l00377"></a>00377                   <span class="keywordtype">int</span> d;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379                   d = <a class="code" href="pngpriv_8h.html#a9dad4da3d087bca8ed14727bae5f2a7e">PNG_COLOR_DIST</a>(palette[i], palette[j]);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381                   <span class="keywordflow">if</span> (d &lt;= max_d)
<a name="l00382"></a>00382                   {
<a name="l00383"></a>00383 
<a name="l00384"></a>00384                      t = (<a class="code" href="pngrtran_8c.html#a1c9734331d58dab58b3187252c02721f">png_dsortp</a>)png_malloc_warn(png_ptr,
<a name="l00385"></a>00385                          (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)(<a class="code" href="pngconf_8h.html#a18c80f490efdb3ecfc2bb6aa840a94c0">png_sizeof</a>(<a class="code" href="structpng__dsort__struct.html">png_dsort</a>)));
<a name="l00386"></a>00386 
<a name="l00387"></a>00387                      <span class="keywordflow">if</span> (t == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00388"></a>00388                          <span class="keywordflow">break</span>;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390                      t-&gt;next = hash[d];
<a name="l00391"></a>00391                      t-&gt;left = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)i;
<a name="l00392"></a>00392                      t-&gt;right = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)j;
<a name="l00393"></a>00393                      hash[d] = t;
<a name="l00394"></a>00394                   }
<a name="l00395"></a>00395                }
<a name="l00396"></a>00396                <span class="keywordflow">if</span> (t == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00397"></a>00397                   <span class="keywordflow">break</span>;
<a name="l00398"></a>00398             }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400             <span class="keywordflow">if</span> (t != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00401"></a>00401             <span class="keywordflow">for</span> (i = 0; i &lt;= max_d; i++)
<a name="l00402"></a>00402             {
<a name="l00403"></a>00403                <span class="keywordflow">if</span> (hash[i] != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00404"></a>00404                {
<a name="l00405"></a>00405                   <a class="code" href="pngrtran_8c.html#a1c9734331d58dab58b3187252c02721f">png_dsortp</a> p;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407                   <span class="keywordflow">for</span> (p = hash[i]; p; p = p-&gt;next)
<a name="l00408"></a>00408                   {
<a name="l00409"></a>00409                      <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)png_ptr-&gt;index_to_palette[p-&gt;left]
<a name="l00410"></a>00410                          &lt; num_new_palette &amp;&amp;
<a name="l00411"></a>00411                          (int)png_ptr-&gt;index_to_palette[p-&gt;right]
<a name="l00412"></a>00412                          &lt; num_new_palette)
<a name="l00413"></a>00413                      {
<a name="l00414"></a>00414                         <span class="keywordtype">int</span> j, next_j;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416                         <span class="keywordflow">if</span> (num_new_palette &amp; 0x01)
<a name="l00417"></a>00417                         {
<a name="l00418"></a>00418                            j = p-&gt;left;
<a name="l00419"></a>00419                            next_j = p-&gt;right;
<a name="l00420"></a>00420                         }
<a name="l00421"></a>00421                         <span class="keywordflow">else</span>
<a name="l00422"></a>00422                         {
<a name="l00423"></a>00423                            j = p-&gt;right;
<a name="l00424"></a>00424                            next_j = p-&gt;left;
<a name="l00425"></a>00425                         }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427                         num_new_palette--;
<a name="l00428"></a>00428                         palette[png_ptr-&gt;index_to_palette[j]]
<a name="l00429"></a>00429                             = palette[num_new_palette];
<a name="l00430"></a>00430                         <span class="keywordflow">if</span> (!full_quantize)
<a name="l00431"></a>00431                         {
<a name="l00432"></a>00432                            <span class="keywordtype">int</span> k;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434                            <span class="keywordflow">for</span> (k = 0; k &lt; num_palette; k++)
<a name="l00435"></a>00435                            {
<a name="l00436"></a>00436                               <span class="keywordflow">if</span> (png_ptr-&gt;quantize_index[k] ==
<a name="l00437"></a>00437                                   png_ptr-&gt;index_to_palette[j])
<a name="l00438"></a>00438                                  png_ptr-&gt;quantize_index[k] =
<a name="l00439"></a>00439                                      png_ptr-&gt;index_to_palette[next_j];
<a name="l00440"></a>00440 
<a name="l00441"></a>00441                               <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)png_ptr-&gt;quantize_index[k] ==
<a name="l00442"></a>00442                                   num_new_palette)
<a name="l00443"></a>00443                                  png_ptr-&gt;quantize_index[k] =
<a name="l00444"></a>00444                                      png_ptr-&gt;index_to_palette[j];
<a name="l00445"></a>00445                            }
<a name="l00446"></a>00446                         }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448                         png_ptr-&gt;index_to_palette[png_ptr-&gt;palette_to_index
<a name="l00449"></a>00449                             [num_new_palette]] = png_ptr-&gt;index_to_palette[j];
<a name="l00450"></a>00450 
<a name="l00451"></a>00451                         png_ptr-&gt;palette_to_index[png_ptr-&gt;index_to_palette[j]]
<a name="l00452"></a>00452                             = png_ptr-&gt;palette_to_index[num_new_palette];
<a name="l00453"></a>00453 
<a name="l00454"></a>00454                         png_ptr-&gt;index_to_palette[j] =
<a name="l00455"></a>00455                             (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)num_new_palette;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457                         png_ptr-&gt;palette_to_index[num_new_palette] =
<a name="l00458"></a>00458                             (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)j;
<a name="l00459"></a>00459                      }
<a name="l00460"></a>00460                      <span class="keywordflow">if</span> (num_new_palette &lt;= maximum_colors)
<a name="l00461"></a>00461                         <span class="keywordflow">break</span>;
<a name="l00462"></a>00462                   }
<a name="l00463"></a>00463                   <span class="keywordflow">if</span> (num_new_palette &lt;= maximum_colors)
<a name="l00464"></a>00464                      <span class="keywordflow">break</span>;
<a name="l00465"></a>00465                }
<a name="l00466"></a>00466             }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468             <span class="keywordflow">for</span> (i = 0; i &lt; 769; i++)
<a name="l00469"></a>00469             {
<a name="l00470"></a>00470                <span class="keywordflow">if</span> (hash[i] != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00471"></a>00471                {
<a name="l00472"></a>00472                   <a class="code" href="pngrtran_8c.html#a1c9734331d58dab58b3187252c02721f">png_dsortp</a> p = hash[i];
<a name="l00473"></a>00473                   <span class="keywordflow">while</span> (p)
<a name="l00474"></a>00474                   {
<a name="l00475"></a>00475                      t = p-&gt;next;
<a name="l00476"></a>00476                      <a class="code" href="pngmem_8c.html#a6b14e847afcaed26a92542cfa0b3326a">png_free</a>(png_ptr, p);
<a name="l00477"></a>00477                      p = t;
<a name="l00478"></a>00478                   }
<a name="l00479"></a>00479                }
<a name="l00480"></a>00480                hash[i] = 0;
<a name="l00481"></a>00481             }
<a name="l00482"></a>00482             max_d += 96;
<a name="l00483"></a>00483          }
<a name="l00484"></a>00484          <a class="code" href="pngmem_8c.html#a6b14e847afcaed26a92542cfa0b3326a">png_free</a>(png_ptr, hash);
<a name="l00485"></a>00485          <a class="code" href="pngmem_8c.html#a6b14e847afcaed26a92542cfa0b3326a">png_free</a>(png_ptr, png_ptr-&gt;palette_to_index);
<a name="l00486"></a>00486          <a class="code" href="pngmem_8c.html#a6b14e847afcaed26a92542cfa0b3326a">png_free</a>(png_ptr, png_ptr-&gt;index_to_palette);
<a name="l00487"></a>00487          png_ptr-&gt;palette_to_index = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00488"></a>00488          png_ptr-&gt;index_to_palette = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00489"></a>00489       }
<a name="l00490"></a>00490       num_palette = maximum_colors;
<a name="l00491"></a>00491    }
<a name="l00492"></a>00492    <span class="keywordflow">if</span> (png_ptr-&gt;palette == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00493"></a>00493    {
<a name="l00494"></a>00494       png_ptr-&gt;palette = palette;
<a name="l00495"></a>00495    }
<a name="l00496"></a>00496    png_ptr-&gt;num_palette = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)num_palette;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498    <span class="keywordflow">if</span> (full_quantize)
<a name="l00499"></a>00499    {
<a name="l00500"></a>00500       <span class="keywordtype">int</span> i;
<a name="l00501"></a>00501       <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> distance;
<a name="l00502"></a>00502       <span class="keywordtype">int</span> total_bits = <a class="code" href="pnglibconf_8h.html#ae893b1730ca275384af3d75c6c673513">PNG_QUANTIZE_RED_BITS</a> + <a class="code" href="pnglibconf_8h.html#a5e5e7d6d57eb08fdfb843bf618d7adac">PNG_QUANTIZE_GREEN_BITS</a> +
<a name="l00503"></a>00503           <a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>;
<a name="l00504"></a>00504       <span class="keywordtype">int</span> num_red = (1 &lt;&lt; <a class="code" href="pnglibconf_8h.html#ae893b1730ca275384af3d75c6c673513">PNG_QUANTIZE_RED_BITS</a>);
<a name="l00505"></a>00505       <span class="keywordtype">int</span> num_green = (1 &lt;&lt; <a class="code" href="pnglibconf_8h.html#a5e5e7d6d57eb08fdfb843bf618d7adac">PNG_QUANTIZE_GREEN_BITS</a>);
<a name="l00506"></a>00506       <span class="keywordtype">int</span> num_blue = (1 &lt;&lt; <a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>);
<a name="l00507"></a>00507       <a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a> num_entries = ((<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)1 &lt;&lt; total_bits);
<a name="l00508"></a>00508 
<a name="l00509"></a>00509       png_ptr-&gt;palette_lookup = (<a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a>)png_calloc(png_ptr,
<a name="l00510"></a>00510           (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)(num_entries * <a class="code" href="pngconf_8h.html#a18c80f490efdb3ecfc2bb6aa840a94c0">png_sizeof</a>(<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)));
<a name="l00511"></a>00511 
<a name="l00512"></a>00512       distance = (<a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a>)png_malloc(png_ptr, (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)(num_entries *
<a name="l00513"></a>00513           <a class="code" href="pngconf_8h.html#a18c80f490efdb3ecfc2bb6aa840a94c0">png_sizeof</a>(<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)));
<a name="l00514"></a>00514 
<a name="l00515"></a>00515       <a class="code" href="pngpriv_8h.html#a13978b57d9482facf252d67cfd1b76b9">png_memset</a>(distance, 0xff, num_entries * <a class="code" href="pngconf_8h.html#a18c80f490efdb3ecfc2bb6aa840a94c0">png_sizeof</a>(<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>));
<a name="l00516"></a>00516 
<a name="l00517"></a>00517       <span class="keywordflow">for</span> (i = 0; i &lt; num_palette; i++)
<a name="l00518"></a>00518       {
<a name="l00519"></a>00519          <span class="keywordtype">int</span> ir, ig, ib;
<a name="l00520"></a>00520          <span class="keywordtype">int</span> r = (palette[i].red &gt;&gt; (8 - <a class="code" href="pnglibconf_8h.html#ae893b1730ca275384af3d75c6c673513">PNG_QUANTIZE_RED_BITS</a>));
<a name="l00521"></a>00521          <span class="keywordtype">int</span> g = (palette[i].green &gt;&gt; (8 - <a class="code" href="pnglibconf_8h.html#a5e5e7d6d57eb08fdfb843bf618d7adac">PNG_QUANTIZE_GREEN_BITS</a>));
<a name="l00522"></a>00522          <span class="keywordtype">int</span> b = (palette[i].blue &gt;&gt; (8 - <a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>));
<a name="l00523"></a>00523 
<a name="l00524"></a>00524          <span class="keywordflow">for</span> (ir = 0; ir &lt; num_red; ir++)
<a name="l00525"></a>00525          {
<a name="l00526"></a>00526             <span class="comment">/* int dr = abs(ir - r); */</span>
<a name="l00527"></a>00527             <span class="keywordtype">int</span> dr = ((ir &gt; r) ? ir - r : r - ir);
<a name="l00528"></a>00528             <span class="keywordtype">int</span> index_r = (ir &lt;&lt; (PNG_QUANTIZE_BLUE_BITS +
<a name="l00529"></a>00529                 <a class="code" href="pnglibconf_8h.html#a5e5e7d6d57eb08fdfb843bf618d7adac">PNG_QUANTIZE_GREEN_BITS</a>));
<a name="l00530"></a>00530 
<a name="l00531"></a>00531             <span class="keywordflow">for</span> (ig = 0; ig &lt; num_green; ig++)
<a name="l00532"></a>00532             {
<a name="l00533"></a>00533                <span class="comment">/* int dg = abs(ig - g); */</span>
<a name="l00534"></a>00534                <span class="keywordtype">int</span> dg = ((ig &gt; g) ? ig - g : g - ig);
<a name="l00535"></a>00535                <span class="keywordtype">int</span> dt = dr + dg;
<a name="l00536"></a>00536                <span class="keywordtype">int</span> dm = ((dr &gt; dg) ? dr : dg);
<a name="l00537"></a>00537                <span class="keywordtype">int</span> index_g = index_r | (ig &lt;&lt; <a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539                <span class="keywordflow">for</span> (ib = 0; ib &lt; num_blue; ib++)
<a name="l00540"></a>00540                {
<a name="l00541"></a>00541                   <span class="keywordtype">int</span> d_index = index_g | ib;
<a name="l00542"></a>00542                   <span class="comment">/* int db = abs(ib - b); */</span>
<a name="l00543"></a>00543                   <span class="keywordtype">int</span> db = ((ib &gt; b) ? ib - b : b - ib);
<a name="l00544"></a>00544                   <span class="keywordtype">int</span> dmax = ((dm &gt; db) ? dm : db);
<a name="l00545"></a>00545                   <span class="keywordtype">int</span> d = dmax + dt + db;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547                   <span class="keywordflow">if</span> (d &lt; (<span class="keywordtype">int</span>)distance[d_index])
<a name="l00548"></a>00548                   {
<a name="l00549"></a>00549                      distance[d_index] = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)d;
<a name="l00550"></a>00550                      png_ptr-&gt;palette_lookup[d_index] = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)i;
<a name="l00551"></a>00551                   }
<a name="l00552"></a>00552                }
<a name="l00553"></a>00553             }
<a name="l00554"></a>00554          }
<a name="l00555"></a>00555       }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557       <a class="code" href="pngmem_8c.html#a6b14e847afcaed26a92542cfa0b3326a">png_free</a>(png_ptr, distance);
<a name="l00558"></a>00558    }
<a name="l00559"></a>00559 }
<a name="l00560"></a>00560 <span class="preprocessor">#endif </span><span class="comment">/* PNG_READ_QUANTIZE_SUPPORTED */</span>
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l00563"></a>00563 <span class="preprocessor"></span><span class="comment">/* Transform the image from the file_gamma to the screen_gamma.  We</span>
<a name="l00564"></a>00564 <span class="comment"> * only do transformations on images where the file_gamma and screen_gamma</span>
<a name="l00565"></a>00565 <span class="comment"> * are not close reciprocals, otherwise it slows things down slightly, and</span>
<a name="l00566"></a>00566 <span class="comment"> * also needlessly introduces small errors.</span>
<a name="l00567"></a>00567 <span class="comment"> *</span>
<a name="l00568"></a>00568 <span class="comment"> * We will turn off gamma transformation later if no semitransparent entries</span>
<a name="l00569"></a>00569 <span class="comment"> * are present in the tRNS array for palette images.  We can&#39;t do it here</span>
<a name="l00570"></a>00570 <span class="comment"> * because we don&#39;t necessarily have the tRNS chunk yet.</span>
<a name="l00571"></a>00571 <span class="comment"> */</span>
<a name="l00572"></a>00572 <span class="keyword">static</span> <span class="keywordtype">int</span> <span class="comment">/* PRIVATE */</span>
<a name="l00573"></a>00573 png_gamma_threshold(<a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> scrn_gamma, <a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> file_gamma)
<a name="l00574"></a>00574 {
<a name="l00575"></a>00575    <span class="comment">/* PNG_GAMMA_THRESHOLD is the threshold for performing gamma</span>
<a name="l00576"></a>00576 <span class="comment">    * correction as a difference of the overall transform from 1.0</span>
<a name="l00577"></a>00577 <span class="comment">    *</span>
<a name="l00578"></a>00578 <span class="comment">    * We want to compare the threshold with s*f - 1, if we get</span>
<a name="l00579"></a>00579 <span class="comment">    * overflow here it is because of wacky gamma values so we</span>
<a name="l00580"></a>00580 <span class="comment">    * turn on processing anyway.</span>
<a name="l00581"></a>00581 <span class="comment">    */</span>
<a name="l00582"></a>00582    <a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> gtest;
<a name="l00583"></a>00583    <span class="keywordflow">return</span> !<a class="code" href="png_8c.html#a545a6639cd52ad3f9e039cf936fe0097">png_muldiv</a>(&amp;gtest, scrn_gamma, file_gamma, <a class="code" href="png_8h.html#a458103440bda531da20a310730308f2d">PNG_FP_1</a>) ||
<a name="l00584"></a>00584        <a class="code" href="png_8c.html#a81580f4aec524e52aaa71fd52ff82eb6">png_gamma_significant</a>(gtest);
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587 <span class="keywordtype">void</span> <a class="code" href="pngpriv_8h.html#a79ff4521dd0f0f4ef9384534e26584e5">PNGFAPI</a>
<a name="l00588"></a><a class="code" href="pngrtran_8c.html#ae8cfc3bc540de104ae2667e7619b22a5">00588</a> <a class="code" href="pngrtran_8c.html#ae8cfc3bc540de104ae2667e7619b22a5">png_set_gamma_fixed</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr, <a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> scrn_gamma,
<a name="l00589"></a>00589    <a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> file_gamma)
<a name="l00590"></a>00590 {
<a name="l00591"></a>00591    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_gamma_fixed&quot;</span>);
<a name="l00592"></a>00592 
<a name="l00593"></a>00593    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00594"></a>00594       <span class="keywordflow">return</span>;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596    <span class="keywordflow">if</span> ((png_ptr-&gt;color_type &amp; <a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>) ||
<a name="l00597"></a>00597        (png_ptr-&gt;color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>) ||
<a name="l00598"></a>00598        png_gamma_threshold(scrn_gamma, file_gamma))
<a name="l00599"></a>00599       png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#ac0534e475464f58ecb12296da4c4ab63">PNG_GAMMA</a>;
<a name="l00600"></a>00600    png_ptr-&gt;gamma = file_gamma;
<a name="l00601"></a>00601    png_ptr-&gt;screen_gamma = scrn_gamma;
<a name="l00602"></a>00602 }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604 <span class="preprocessor">#  ifdef PNG_FLOATING_POINT_SUPPORTED</span>
<a name="l00605"></a>00605 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00606"></a><a class="code" href="pngrtran_8c.html#a8936bdabee91ae9939491944de0ab45f">00606</a> <a class="code" href="pngrtran_8c.html#a8936bdabee91ae9939491944de0ab45f">png_set_gamma</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr, <span class="keywordtype">double</span> scrn_gamma, <span class="keywordtype">double</span> file_gamma)
<a name="l00607"></a>00607 {
<a name="l00608"></a>00608    <a class="code" href="pngrtran_8c.html#ae8cfc3bc540de104ae2667e7619b22a5">png_set_gamma_fixed</a>(png_ptr,
<a name="l00609"></a>00609       <a class="code" href="png_8c.html#aac88dce74a4459fb930afbd17bb32965">png_fixed</a>(png_ptr, scrn_gamma, <span class="stringliteral">&quot;png_set_gamma screen gamma&quot;</span>),
<a name="l00610"></a>00610       <a class="code" href="png_8c.html#aac88dce74a4459fb930afbd17bb32965">png_fixed</a>(png_ptr, file_gamma, <span class="stringliteral">&quot;png_set_gamma file gamma&quot;</span>));
<a name="l00611"></a>00611 }
<a name="l00612"></a>00612 <span class="preprocessor">#  endif </span><span class="comment">/* FLOATING_POINT_SUPPORTED */</span>
<a name="l00613"></a>00613 <span class="preprocessor">#endif </span><span class="comment">/* READ_GAMMA */</span>
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 <span class="preprocessor">#ifdef PNG_READ_EXPAND_SUPPORTED</span>
<a name="l00616"></a>00616 <span class="preprocessor"></span><span class="comment">/* Expand paletted images to RGB, expand grayscale images of</span>
<a name="l00617"></a>00617 <span class="comment"> * less than 8-bit depth to 8-bit depth, and expand tRNS chunks</span>
<a name="l00618"></a>00618 <span class="comment"> * to alpha channels.</span>
<a name="l00619"></a>00619 <span class="comment"> */</span>
<a name="l00620"></a>00620 <span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00621"></a><a class="code" href="pngrtran_8c.html#a9518d576c4833a454a716617cc158bd4">00621</a> <a class="code" href="pngrtran_8c.html#a9518d576c4833a454a716617cc158bd4">png_set_expand</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr)
<a name="l00622"></a>00622 {
<a name="l00623"></a>00623    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_expand&quot;</span>);
<a name="l00624"></a>00624 
<a name="l00625"></a>00625    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00626"></a>00626       <span class="keywordflow">return</span>;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628    png_ptr-&gt;transformations |= (<a class="code" href="pngpriv_8h.html#a97ca3e4f86251d2062f403524704a1c7">PNG_EXPAND</a> | <a class="code" href="pngpriv_8h.html#a588339f3d888cc9a19e1143ec32e34d3">PNG_EXPAND_tRNS</a>);
<a name="l00629"></a>00629    png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#aaeb40b161e32ee3801d460e3df0099f6">PNG_FLAG_ROW_INIT</a>;
<a name="l00630"></a>00630 }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632 <span class="comment">/* GRR 19990627:  the following three functions currently are identical</span>
<a name="l00633"></a>00633 <span class="comment"> *  to png_set_expand().  However, it is entirely reasonable that someone</span>
<a name="l00634"></a>00634 <span class="comment"> *  might wish to expand an indexed image to RGB but *not* expand a single,</span>
<a name="l00635"></a>00635 <span class="comment"> *  fully transparent palette entry to a full alpha channel--perhaps instead</span>
<a name="l00636"></a>00636 <span class="comment"> *  convert tRNS to the grayscale/RGB format (16-bit RGB value), or replace</span>
<a name="l00637"></a>00637 <span class="comment"> *  the transparent color with a particular RGB value, or drop tRNS entirely.</span>
<a name="l00638"></a>00638 <span class="comment"> *  IOW, a future version of the library may make the transformations flag</span>
<a name="l00639"></a>00639 <span class="comment"> *  a bit more fine-grained, with separate bits for each of these three</span>
<a name="l00640"></a>00640 <span class="comment"> *  functions.</span>
<a name="l00641"></a>00641 <span class="comment"> *</span>
<a name="l00642"></a>00642 <span class="comment"> *  More to the point, these functions make it obvious what libpng will be</span>
<a name="l00643"></a>00643 <span class="comment"> *  doing, whereas &quot;expand&quot; can (and does) mean any number of things.</span>
<a name="l00644"></a>00644 <span class="comment"> *</span>
<a name="l00645"></a>00645 <span class="comment"> *  GRP 20060307: In libpng-1.2.9, png_set_gray_1_2_4_to_8() was modified</span>
<a name="l00646"></a>00646 <span class="comment"> *  to expand only the sample depth but not to expand the tRNS to alpha</span>
<a name="l00647"></a>00647 <span class="comment"> *  and its name was changed to png_set_expand_gray_1_2_4_to_8().</span>
<a name="l00648"></a>00648 <span class="comment"> */</span>
<a name="l00649"></a>00649 
<a name="l00650"></a>00650 <span class="comment">/* Expand paletted images to RGB. */</span>
<a name="l00651"></a>00651 <span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00652"></a><a class="code" href="pngrtran_8c.html#a0639c916b1e458aad2ab3bf372303b1a">00652</a> <a class="code" href="pngrtran_8c.html#a0639c916b1e458aad2ab3bf372303b1a">png_set_palette_to_rgb</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr)
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_palette_to_rgb&quot;</span>);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00657"></a>00657       <span class="keywordflow">return</span>;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659    png_ptr-&gt;transformations |= (<a class="code" href="pngpriv_8h.html#a97ca3e4f86251d2062f403524704a1c7">PNG_EXPAND</a> | <a class="code" href="pngpriv_8h.html#a588339f3d888cc9a19e1143ec32e34d3">PNG_EXPAND_tRNS</a>);
<a name="l00660"></a>00660    png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#aaeb40b161e32ee3801d460e3df0099f6">PNG_FLAG_ROW_INIT</a>;
<a name="l00661"></a>00661 }
<a name="l00662"></a>00662 
<a name="l00663"></a>00663 <span class="comment">/* Expand grayscale images of less than 8-bit depth to 8 bits. */</span>
<a name="l00664"></a>00664 <span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00665"></a><a class="code" href="pngrtran_8c.html#ac615a5551d1c581849756319b6031d8d">00665</a> <a class="code" href="pngrtran_8c.html#ac615a5551d1c581849756319b6031d8d">png_set_expand_gray_1_2_4_to_8</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr)
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_expand_gray_1_2_4_to_8&quot;</span>);
<a name="l00668"></a>00668 
<a name="l00669"></a>00669    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00670"></a>00670       <span class="keywordflow">return</span>;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672    png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#a97ca3e4f86251d2062f403524704a1c7">PNG_EXPAND</a>;
<a name="l00673"></a>00673    png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#aaeb40b161e32ee3801d460e3df0099f6">PNG_FLAG_ROW_INIT</a>;
<a name="l00674"></a>00674 }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 
<a name="l00677"></a>00677 
<a name="l00678"></a>00678 <span class="comment">/* Expand tRNS chunks to alpha channels. */</span>
<a name="l00679"></a>00679 <span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00680"></a><a class="code" href="pngrtran_8c.html#ace7b25e5530b4ae9c02f1d51401e713b">00680</a> <a class="code" href="pngrtran_8c.html#ace7b25e5530b4ae9c02f1d51401e713b">png_set_tRNS_to_alpha</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr)
<a name="l00681"></a>00681 {
<a name="l00682"></a>00682    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_tRNS_to_alpha&quot;</span>);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684    png_ptr-&gt;transformations |= (<a class="code" href="pngpriv_8h.html#a97ca3e4f86251d2062f403524704a1c7">PNG_EXPAND</a> | <a class="code" href="pngpriv_8h.html#a588339f3d888cc9a19e1143ec32e34d3">PNG_EXPAND_tRNS</a>);
<a name="l00685"></a>00685    png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#aaeb40b161e32ee3801d460e3df0099f6">PNG_FLAG_ROW_INIT</a>;
<a name="l00686"></a>00686 }
<a name="l00687"></a>00687 <span class="preprocessor">#endif </span><span class="comment">/* defined(PNG_READ_EXPAND_SUPPORTED) */</span>
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 <span class="preprocessor">#ifdef PNG_READ_GRAY_TO_RGB_SUPPORTED</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00691"></a><a class="code" href="pngrtran_8c.html#a7f100be93f5c2ceb1b9da0f8f9a7a4f2">00691</a> <a class="code" href="pngrtran_8c.html#a7f100be93f5c2ceb1b9da0f8f9a7a4f2">png_set_gray_to_rgb</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr)
<a name="l00692"></a>00692 {
<a name="l00693"></a>00693    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_gray_to_rgb&quot;</span>);
<a name="l00694"></a>00694 
<a name="l00695"></a>00695    <span class="keywordflow">if</span> (png_ptr != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00696"></a>00696    {
<a name="l00697"></a>00697       <span class="comment">/* Because rgb must be 8 bits or more: */</span>
<a name="l00698"></a>00698       <a class="code" href="pngrtran_8c.html#ac615a5551d1c581849756319b6031d8d">png_set_expand_gray_1_2_4_to_8</a>(png_ptr);
<a name="l00699"></a>00699       png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#acc6d613a0273102f811a5783d4cf116f">PNG_GRAY_TO_RGB</a>;
<a name="l00700"></a>00700       png_ptr-&gt;flags &amp;= ~<a class="code" href="pngpriv_8h.html#aaeb40b161e32ee3801d460e3df0099f6">PNG_FLAG_ROW_INIT</a>;
<a name="l00701"></a>00701    }
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 <span class="preprocessor">#endif</span>
<a name="l00704"></a>00704 <span class="preprocessor"></span>
<a name="l00705"></a>00705 <span class="preprocessor">#ifdef PNG_READ_RGB_TO_GRAY_SUPPORTED</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="pngpriv_8h.html#a79ff4521dd0f0f4ef9384534e26584e5">PNGFAPI</a>
<a name="l00707"></a><a class="code" href="pngrtran_8c.html#a5dac8ee6df0f72accba155aff041d264">00707</a> <a class="code" href="pngrtran_8c.html#a5dac8ee6df0f72accba155aff041d264">png_set_rgb_to_gray_fixed</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr, <span class="keywordtype">int</span> error_action,
<a name="l00708"></a>00708     <a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> red, <a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> green)
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_rgb_to_gray&quot;</span>);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00713"></a>00713       <span class="keywordflow">return</span>;
<a name="l00714"></a>00714 
<a name="l00715"></a>00715    <span class="keywordflow">switch</span>(error_action)
<a name="l00716"></a>00716    {
<a name="l00717"></a>00717       <span class="keywordflow">case</span> 1:
<a name="l00718"></a>00718          png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#ac5121e4ab7b1551f7bc114a97410aa74">PNG_RGB_TO_GRAY</a>;
<a name="l00719"></a>00719          <span class="keywordflow">break</span>;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721       <span class="keywordflow">case</span> 2:
<a name="l00722"></a>00722          png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#ad13d3f3d445291d1c1f6b0dcbb230eff">PNG_RGB_TO_GRAY_WARN</a>;
<a name="l00723"></a>00723          <span class="keywordflow">break</span>;
<a name="l00724"></a>00724 
<a name="l00725"></a>00725       <span class="keywordflow">case</span> 3:
<a name="l00726"></a>00726          png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#a17987a8a349241530e6a13904ca12a7b">PNG_RGB_TO_GRAY_ERR</a>;
<a name="l00727"></a>00727          <span class="keywordflow">break</span>;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729       <span class="keywordflow">default</span>:
<a name="l00730"></a>00730          png_error(png_ptr, <span class="stringliteral">&quot;invalid error action to rgb_to_gray&quot;</span>);
<a name="l00731"></a>00731          <span class="keywordflow">break</span>;
<a name="l00732"></a>00732    }
<a name="l00733"></a>00733    <span class="keywordflow">if</span> (png_ptr-&gt;color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>)
<a name="l00734"></a>00734 <span class="preprocessor">#ifdef PNG_READ_EXPAND_SUPPORTED</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span>      png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#a97ca3e4f86251d2062f403524704a1c7">PNG_EXPAND</a>;
<a name="l00736"></a>00736 <span class="preprocessor">#else</span>
<a name="l00737"></a>00737 <span class="preprocessor"></span>   {
<a name="l00738"></a>00738       <a class="code" href="pngerror_8c.html#a34b3bb3a1ff0050b9317c3ca6d18df24">png_warning</a>(png_ptr,
<a name="l00739"></a>00739         <span class="stringliteral">&quot;Cannot do RGB_TO_GRAY without EXPAND_SUPPORTED&quot;</span>);
<a name="l00740"></a>00740 
<a name="l00741"></a>00741       png_ptr-&gt;transformations &amp;= ~<a class="code" href="pngpriv_8h.html#ac5121e4ab7b1551f7bc114a97410aa74">PNG_RGB_TO_GRAY</a>;
<a name="l00742"></a>00742    }
<a name="l00743"></a>00743 <span class="preprocessor">#endif</span>
<a name="l00744"></a>00744 <span class="preprocessor"></span>   {
<a name="l00745"></a>00745       <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> red_int, green_int;
<a name="l00746"></a>00746       <span class="keywordflow">if</span> (red &lt; 0 || green &lt; 0)
<a name="l00747"></a>00747       {
<a name="l00748"></a>00748          red_int   =  6968; <span class="comment">/* .212671 * 32768 + .5 */</span>
<a name="l00749"></a>00749          green_int = 23434; <span class="comment">/* .715160 * 32768 + .5 */</span>
<a name="l00750"></a>00750       }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (red + green &lt; 100000L)
<a name="l00753"></a>00753       {
<a name="l00754"></a>00754          red_int = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)red*32768L)/100000L);
<a name="l00755"></a>00755          green_int = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)green*32768L)/100000L);
<a name="l00756"></a>00756       }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758       <span class="keywordflow">else</span>
<a name="l00759"></a>00759       {
<a name="l00760"></a>00760          <a class="code" href="pngerror_8c.html#a34b3bb3a1ff0050b9317c3ca6d18df24">png_warning</a>(png_ptr, <span class="stringliteral">&quot;ignoring out of range rgb_to_gray coefficients&quot;</span>);
<a name="l00761"></a>00761          red_int   =  6968;
<a name="l00762"></a>00762          green_int = 23434;
<a name="l00763"></a>00763       }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765       png_ptr-&gt;rgb_to_gray_red_coeff   = red_int;
<a name="l00766"></a>00766       png_ptr-&gt;rgb_to_gray_green_coeff = green_int;
<a name="l00767"></a>00767       png_ptr-&gt;rgb_to_gray_blue_coeff  =
<a name="l00768"></a>00768           (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(32768 - red_int - green_int);
<a name="l00769"></a>00769    }
<a name="l00770"></a>00770 }
<a name="l00771"></a>00771 
<a name="l00772"></a>00772 <span class="preprocessor">#ifdef PNG_FLOATING_POINT_SUPPORTED</span>
<a name="l00773"></a>00773 <span class="preprocessor"></span><span class="comment">/* Convert a RGB image to a grayscale of the same width.  This allows us,</span>
<a name="l00774"></a>00774 <span class="comment"> * for example, to convert a 24 bpp RGB image into an 8 bpp grayscale image.</span>
<a name="l00775"></a>00775 <span class="comment"> */</span>
<a name="l00776"></a>00776 
<a name="l00777"></a>00777 <span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00778"></a><a class="code" href="pngrtran_8c.html#aac5aa68d523f0d8109b3679baea9ee21">00778</a> <a class="code" href="pngrtran_8c.html#aac5aa68d523f0d8109b3679baea9ee21">png_set_rgb_to_gray</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr, <span class="keywordtype">int</span> error_action, <span class="keywordtype">double</span> red,
<a name="l00779"></a>00779    <span class="keywordtype">double</span> green)
<a name="l00780"></a>00780 {
<a name="l00781"></a>00781    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00782"></a>00782       <span class="keywordflow">return</span>;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784    <a class="code" href="pngrtran_8c.html#a5dac8ee6df0f72accba155aff041d264">png_set_rgb_to_gray_fixed</a>(png_ptr, error_action,
<a name="l00785"></a>00785       <a class="code" href="png_8c.html#aac88dce74a4459fb930afbd17bb32965">png_fixed</a>(png_ptr, red, <span class="stringliteral">&quot;rgb to gray red coefficient&quot;</span>),
<a name="l00786"></a>00786       <a class="code" href="png_8c.html#aac88dce74a4459fb930afbd17bb32965">png_fixed</a>(png_ptr, green, <span class="stringliteral">&quot;rgb to gray green coefficient&quot;</span>));
<a name="l00787"></a>00787 }
<a name="l00788"></a>00788 <span class="preprocessor">#endif </span><span class="comment">/* FLOATING POINT */</span>
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 <span class="preprocessor">#endif</span>
<a name="l00791"></a>00791 <span class="preprocessor"></span>
<a name="l00792"></a>00792 <span class="preprocessor">#if defined(PNG_READ_USER_TRANSFORM_SUPPORTED) || \</span>
<a name="l00793"></a>00793 <span class="preprocessor">    defined(PNG_WRITE_USER_TRANSFORM_SUPPORTED)</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l00795"></a><a class="code" href="pngrtran_8c.html#a52e6371f85962032e8f2377bc039f4c1">00795</a> <a class="code" href="pngrtran_8c.html#a52e6371f85962032e8f2377bc039f4c1">png_set_read_user_transform_fn</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr, png_user_transform_ptr
<a name="l00796"></a>00796     read_user_transform_fn)
<a name="l00797"></a>00797 {
<a name="l00798"></a>00798    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_set_read_user_transform_fn&quot;</span>);
<a name="l00799"></a>00799 
<a name="l00800"></a>00800    <span class="keywordflow">if</span> (png_ptr == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00801"></a>00801       <span class="keywordflow">return</span>;
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 <span class="preprocessor">#ifdef PNG_READ_USER_TRANSFORM_SUPPORTED</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span>   png_ptr-&gt;transformations |= <a class="code" href="pngpriv_8h.html#a5f3002d2db6845ec190027edb5d67a06">PNG_USER_TRANSFORM</a>;
<a name="l00805"></a>00805    png_ptr-&gt;read_user_transform_fn = read_user_transform_fn;
<a name="l00806"></a>00806 <span class="preprocessor">#endif</span>
<a name="l00807"></a>00807 <span class="preprocessor"></span>}
<a name="l00808"></a>00808 <span class="preprocessor">#endif</span>
<a name="l00809"></a>00809 <span class="preprocessor"></span>
<a name="l00810"></a>00810 <span class="comment">/* Initialize everything needed for the read.  This includes modifying</span>
<a name="l00811"></a>00811 <span class="comment"> * the palette.</span>
<a name="l00812"></a>00812 <span class="comment"> */</span>
<a name="l00813"></a>00813 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l00814"></a><a class="code" href="pngrtran_8c.html#aa06679bc4097b98ed4944ccbdd2baa77">00814</a> <a class="code" href="pngrtran_8c.html#aa06679bc4097b98ed4944ccbdd2baa77">png_init_read_transformations</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr)
<a name="l00815"></a>00815 {
<a name="l00816"></a>00816    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_init_read_transformations&quot;</span>);
<a name="l00817"></a>00817 
<a name="l00818"></a>00818   {
<a name="l00819"></a>00819 <span class="preprocessor">#if defined(PNG_READ_BACKGROUND_SUPPORTED) || \</span>
<a name="l00820"></a>00820 <span class="preprocessor">    defined(PNG_READ_SHIFT_SUPPORTED) || \</span>
<a name="l00821"></a>00821 <span class="preprocessor">    defined(PNG_READ_GAMMA_SUPPORTED)</span>
<a name="l00822"></a>00822 <span class="preprocessor"></span>   <span class="keywordtype">int</span> color_type = png_ptr-&gt;color_type;
<a name="l00823"></a>00823 <span class="preprocessor">#endif</span>
<a name="l00824"></a>00824 <span class="preprocessor"></span>
<a name="l00825"></a>00825 <span class="preprocessor">#if defined(PNG_READ_EXPAND_SUPPORTED) &amp;&amp; defined(PNG_READ_BACKGROUND_SUPPORTED)</span>
<a name="l00826"></a>00826 <span class="preprocessor"></span>
<a name="l00827"></a>00827 <span class="preprocessor">#ifdef PNG_READ_GRAY_TO_RGB_SUPPORTED</span>
<a name="l00828"></a>00828 <span class="preprocessor"></span>   <span class="comment">/* Detect gray background and attempt to enable optimization</span>
<a name="l00829"></a>00829 <span class="comment">    * for gray --&gt; RGB case</span>
<a name="l00830"></a>00830 <span class="comment">    *</span>
<a name="l00831"></a>00831 <span class="comment">    * Note:  if PNG_BACKGROUND_EXPAND is set and color_type is either RGB or</span>
<a name="l00832"></a>00832 <span class="comment">    * RGB_ALPHA (in which case need_expand is superfluous anyway), the</span>
<a name="l00833"></a>00833 <span class="comment">    * background color might actually be gray yet not be flagged as such.</span>
<a name="l00834"></a>00834 <span class="comment">    * This is not a problem for the current code, which uses</span>
<a name="l00835"></a>00835 <span class="comment">    * PNG_BACKGROUND_IS_GRAY only to decide when to do the</span>
<a name="l00836"></a>00836 <span class="comment">    * png_do_gray_to_rgb() transformation.</span>
<a name="l00837"></a>00837 <span class="comment">    */</span>
<a name="l00838"></a>00838    <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a791f1a1597217b632f1b49fa83d43525">PNG_BACKGROUND_EXPAND</a>) &amp;&amp;
<a name="l00839"></a>00839        !(color_type &amp; <a class="code" href="png_8h.html#a87bc785c34abddf3bb9ff206d721964b">PNG_COLOR_MASK_COLOR</a>))
<a name="l00840"></a>00840    {
<a name="l00841"></a>00841       png_ptr-&gt;mode |= <a class="code" href="pngpriv_8h.html#ae93c2b0027efdde092856e83df691ae5">PNG_BACKGROUND_IS_GRAY</a>;
<a name="l00842"></a>00842    }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a50b268079e6d070ec3f695503b104929">PNG_BACKGROUND</a>) &amp;&amp;
<a name="l00845"></a>00845        !(png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a791f1a1597217b632f1b49fa83d43525">PNG_BACKGROUND_EXPAND</a>) &amp;&amp;
<a name="l00846"></a>00846        (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#acc6d613a0273102f811a5783d4cf116f">PNG_GRAY_TO_RGB</a>) &amp;&amp;
<a name="l00847"></a>00847        png_ptr-&gt;background.red == png_ptr-&gt;background.green &amp;&amp;
<a name="l00848"></a>00848        png_ptr-&gt;background.red == png_ptr-&gt;background.blue)
<a name="l00849"></a>00849    {
<a name="l00850"></a>00850       png_ptr-&gt;mode |= <a class="code" href="pngpriv_8h.html#ae93c2b0027efdde092856e83df691ae5">PNG_BACKGROUND_IS_GRAY</a>;
<a name="l00851"></a>00851       png_ptr-&gt;background.gray = png_ptr-&gt;background.red;
<a name="l00852"></a>00852    }
<a name="l00853"></a>00853 <span class="preprocessor">#endif</span>
<a name="l00854"></a>00854 <span class="preprocessor"></span>
<a name="l00855"></a>00855    <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a791f1a1597217b632f1b49fa83d43525">PNG_BACKGROUND_EXPAND</a>) &amp;&amp;
<a name="l00856"></a>00856        (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a97ca3e4f86251d2062f403524704a1c7">PNG_EXPAND</a>))
<a name="l00857"></a>00857    {
<a name="l00858"></a>00858       <span class="keywordflow">if</span> (!(color_type &amp; PNG_COLOR_MASK_COLOR))  <span class="comment">/* i.e., GRAY or GRAY_ALPHA */</span>
<a name="l00859"></a>00859       {
<a name="l00860"></a>00860          <span class="comment">/* Expand background and tRNS chunks */</span>
<a name="l00861"></a>00861          <span class="keywordflow">switch</span> (png_ptr-&gt;bit_depth)
<a name="l00862"></a>00862          {
<a name="l00863"></a>00863             <span class="keywordflow">case</span> 1:
<a name="l00864"></a>00864                png_ptr-&gt;background.gray *= (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)0xff;
<a name="l00865"></a>00865                png_ptr-&gt;background.red = png_ptr-&gt;background.green
<a name="l00866"></a>00866                    =  png_ptr-&gt;background.blue = png_ptr-&gt;background.gray;
<a name="l00867"></a>00867                <span class="keywordflow">if</span> (!(png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a588339f3d888cc9a19e1143ec32e34d3">PNG_EXPAND_tRNS</a>))
<a name="l00868"></a>00868                {
<a name="l00869"></a>00869                  png_ptr-&gt;trans_color.gray *= (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)0xff;
<a name="l00870"></a>00870                  png_ptr-&gt;trans_color.red = png_ptr-&gt;trans_color.green
<a name="l00871"></a>00871                      = png_ptr-&gt;trans_color.blue = png_ptr-&gt;trans_color.gray;
<a name="l00872"></a>00872                }
<a name="l00873"></a>00873                <span class="keywordflow">break</span>;
<a name="l00874"></a>00874 
<a name="l00875"></a>00875             <span class="keywordflow">case</span> 2:
<a name="l00876"></a>00876                png_ptr-&gt;background.gray *= (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)0x55;
<a name="l00877"></a>00877                png_ptr-&gt;background.red = png_ptr-&gt;background.green
<a name="l00878"></a>00878                    = png_ptr-&gt;background.blue = png_ptr-&gt;background.gray;
<a name="l00879"></a>00879                <span class="keywordflow">if</span> (!(png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a588339f3d888cc9a19e1143ec32e34d3">PNG_EXPAND_tRNS</a>))
<a name="l00880"></a>00880                {
<a name="l00881"></a>00881                   png_ptr-&gt;trans_color.gray *= (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)0x55;
<a name="l00882"></a>00882                   png_ptr-&gt;trans_color.red = png_ptr-&gt;trans_color.green
<a name="l00883"></a>00883                       = png_ptr-&gt;trans_color.blue = png_ptr-&gt;trans_color.gray;
<a name="l00884"></a>00884                }
<a name="l00885"></a>00885                <span class="keywordflow">break</span>;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887             <span class="keywordflow">case</span> 4:
<a name="l00888"></a>00888                png_ptr-&gt;background.gray *= (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)0x11;
<a name="l00889"></a>00889                png_ptr-&gt;background.red = png_ptr-&gt;background.green
<a name="l00890"></a>00890                    = png_ptr-&gt;background.blue = png_ptr-&gt;background.gray;
<a name="l00891"></a>00891                <span class="keywordflow">if</span> (!(png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a588339f3d888cc9a19e1143ec32e34d3">PNG_EXPAND_tRNS</a>))
<a name="l00892"></a>00892                {
<a name="l00893"></a>00893                   png_ptr-&gt;trans_color.gray *= (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)0x11;
<a name="l00894"></a>00894                   png_ptr-&gt;trans_color.red = png_ptr-&gt;trans_color.green
<a name="l00895"></a>00895                       = png_ptr-&gt;trans_color.blue = png_ptr-&gt;trans_color.gray;
<a name="l00896"></a>00896                }
<a name="l00897"></a>00897                <span class="keywordflow">break</span>;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899             <span class="keywordflow">default</span>:
<a name="l00900"></a>00900 
<a name="l00901"></a>00901             <span class="keywordflow">case</span> 8:
<a name="l00902"></a>00902 
<a name="l00903"></a>00903             <span class="keywordflow">case</span> 16:
<a name="l00904"></a>00904                png_ptr-&gt;background.red = png_ptr-&gt;background.green
<a name="l00905"></a>00905                    = png_ptr-&gt;background.blue = png_ptr-&gt;background.gray;
<a name="l00906"></a>00906                <span class="keywordflow">break</span>;
<a name="l00907"></a>00907          }
<a name="l00908"></a>00908       }
<a name="l00909"></a>00909       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>)
<a name="l00910"></a>00910       {
<a name="l00911"></a>00911          png_ptr-&gt;background.red   =
<a name="l00912"></a>00912              png_ptr-&gt;palette[png_ptr-&gt;background.index].red;
<a name="l00913"></a>00913          png_ptr-&gt;background.green =
<a name="l00914"></a>00914              png_ptr-&gt;palette[png_ptr-&gt;background.index].green;
<a name="l00915"></a>00915          png_ptr-&gt;background.blue  =
<a name="l00916"></a>00916              png_ptr-&gt;palette[png_ptr-&gt;background.index].blue;
<a name="l00917"></a>00917 
<a name="l00918"></a>00918 <span class="preprocessor">#ifdef PNG_READ_INVERT_ALPHA_SUPPORTED</span>
<a name="l00919"></a>00919 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a46c7472f9af9e3f298db8626698ccf85">PNG_INVERT_ALPHA</a>)
<a name="l00920"></a>00920         {
<a name="l00921"></a>00921 <span class="preprocessor">#ifdef PNG_READ_EXPAND_SUPPORTED</span>
<a name="l00922"></a>00922 <span class="preprocessor"></span>           <span class="keywordflow">if</span> (!(png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a588339f3d888cc9a19e1143ec32e34d3">PNG_EXPAND_tRNS</a>))
<a name="l00923"></a>00923 #endif
<a name="l00924"></a>00924            {
<a name="l00925"></a>00925               <span class="comment">/* Invert the alpha channel (in tRNS) unless the pixels are</span>
<a name="l00926"></a>00926 <span class="comment">               * going to be expanded, in which case leave it for later</span>
<a name="l00927"></a>00927 <span class="comment">               */</span>
<a name="l00928"></a>00928               <span class="keywordtype">int</span> i, istop;
<a name="l00929"></a>00929               istop=(int)png_ptr-&gt;num_trans;
<a name="l00930"></a>00930               for (i=0; i&lt;istop; i++)
<a name="l00931"></a>00931                  png_ptr-&gt;trans_alpha[i] = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(255 -
<a name="l00932"></a>00932                     png_ptr-&gt;trans_alpha[i]);
<a name="l00933"></a>00933            }
<a name="l00934"></a>00934         }
<a name="l00935"></a>00935 <span class="preprocessor">#endif</span>
<a name="l00936"></a>00936 <span class="preprocessor"></span>
<a name="l00937"></a>00937       }
<a name="l00938"></a>00938    }
<a name="l00939"></a>00939 <span class="preprocessor">#endif</span>
<a name="l00940"></a>00940 <span class="preprocessor"></span>
<a name="l00941"></a>00941 <span class="preprocessor">#if defined(PNG_READ_BACKGROUND_SUPPORTED) &amp;&amp; defined(PNG_READ_GAMMA_SUPPORTED)</span>
<a name="l00942"></a>00942 <span class="preprocessor"></span>   png_ptr-&gt;background_1 = png_ptr-&gt;background;
<a name="l00943"></a>00943 <span class="preprocessor">#endif</span>
<a name="l00944"></a>00944 <span class="preprocessor"></span><span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l00945"></a>00945 <span class="preprocessor"></span>
<a name="l00946"></a>00946    <span class="keywordflow">if</span> ((color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a> &amp;&amp; png_ptr-&gt;num_trans != 0)
<a name="l00947"></a>00947        &amp;&amp; png_gamma_threshold(png_ptr-&gt;screen_gamma, png_ptr-&gt;gamma))
<a name="l00948"></a>00948    {
<a name="l00949"></a>00949       <span class="keywordtype">int</span> i, k;
<a name="l00950"></a>00950       k=0;
<a name="l00951"></a>00951       <span class="keywordflow">for</span> (i=0; i&lt;png_ptr-&gt;num_trans; i++)
<a name="l00952"></a>00952       {
<a name="l00953"></a>00953         <span class="keywordflow">if</span> (png_ptr-&gt;trans_alpha[i] != 0 &amp;&amp; png_ptr-&gt;trans_alpha[i] != 0xff)
<a name="l00954"></a>00954            k=1; <span class="comment">/* Partial transparency is present */</span>
<a name="l00955"></a>00955       }
<a name="l00956"></a>00956       <span class="keywordflow">if</span> (k == 0)
<a name="l00957"></a>00957          png_ptr-&gt;transformations &amp;= ~<a class="code" href="pngpriv_8h.html#ac0534e475464f58ecb12296da4c4ab63">PNG_GAMMA</a>;
<a name="l00958"></a>00958    }
<a name="l00959"></a>00959 
<a name="l00960"></a>00960    <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; (<a class="code" href="pngpriv_8h.html#ac0534e475464f58ecb12296da4c4ab63">PNG_GAMMA</a> | <a class="code" href="pngpriv_8h.html#ac5121e4ab7b1551f7bc114a97410aa74">PNG_RGB_TO_GRAY</a>)) &amp;&amp;
<a name="l00961"></a>00961        png_ptr-&gt;gamma != 0)
<a name="l00962"></a>00962    {
<a name="l00963"></a>00963       <a class="code" href="png_8c.html#ad459755c86ac70fe6a551bc60d14f913">png_build_gamma_table</a>(png_ptr, png_ptr-&gt;bit_depth);
<a name="l00964"></a>00964 
<a name="l00965"></a>00965 <span class="preprocessor">#ifdef PNG_READ_BACKGROUND_SUPPORTED</span>
<a name="l00966"></a>00966 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a50b268079e6d070ec3f695503b104929">PNG_BACKGROUND</a>)
<a name="l00967"></a>00967       {
<a name="l00968"></a>00968          <span class="keywordflow">if</span> (color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>)
<a name="l00969"></a>00969          {
<a name="l00970"></a>00970             <span class="comment">/* Could skip if no transparency */</span>
<a name="l00971"></a>00971             <a class="code" href="structpng__color__struct.html">png_color</a> back, back_1;
<a name="l00972"></a>00972             <a class="code" href="png_8h.html#a22c26a022c2bdca0fed457713767ca45">png_colorp</a> palette = png_ptr-&gt;palette;
<a name="l00973"></a>00973             <span class="keywordtype">int</span> num_palette = png_ptr-&gt;num_palette;
<a name="l00974"></a>00974             <span class="keywordtype">int</span> i;
<a name="l00975"></a>00975             <span class="keywordflow">if</span> (png_ptr-&gt;background_gamma_type == <a class="code" href="png_8h.html#ae9b61738aa547992c5750946004b5363">PNG_BACKGROUND_GAMMA_FILE</a>)
<a name="l00976"></a>00976             {
<a name="l00977"></a>00977 
<a name="l00978"></a>00978                back.<a class="code" href="structpng__color__struct.html#ad39dc2d7cb82e3670a3ad397bb4083cb">red</a> = png_ptr-&gt;gamma_table[png_ptr-&gt;background.red];
<a name="l00979"></a>00979                back.<a class="code" href="structpng__color__struct.html#ada9b5a911b185eaf7c6b87934e9f11ce">green</a> = png_ptr-&gt;gamma_table[png_ptr-&gt;background.green];
<a name="l00980"></a>00980                back.<a class="code" href="structpng__color__struct.html#a528e625b2778e787dc182e5df1164bbc">blue</a> = png_ptr-&gt;gamma_table[png_ptr-&gt;background.blue];
<a name="l00981"></a>00981 
<a name="l00982"></a>00982                back_1.<a class="code" href="structpng__color__struct.html#ad39dc2d7cb82e3670a3ad397bb4083cb">red</a> = png_ptr-&gt;gamma_to_1[png_ptr-&gt;background.red];
<a name="l00983"></a>00983                back_1.<a class="code" href="structpng__color__struct.html#ada9b5a911b185eaf7c6b87934e9f11ce">green</a> = png_ptr-&gt;gamma_to_1[png_ptr-&gt;background.green];
<a name="l00984"></a>00984                back_1.<a class="code" href="structpng__color__struct.html#a528e625b2778e787dc182e5df1164bbc">blue</a> = png_ptr-&gt;gamma_to_1[png_ptr-&gt;background.blue];
<a name="l00985"></a>00985             }
<a name="l00986"></a>00986             <span class="keywordflow">else</span>
<a name="l00987"></a>00987             {
<a name="l00988"></a>00988                <a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> g, gs;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990                <span class="keywordflow">switch</span> (png_ptr-&gt;background_gamma_type)
<a name="l00991"></a>00991                {
<a name="l00992"></a>00992                   <span class="keywordflow">case</span> <a class="code" href="png_8h.html#afae1856912d79ebc09b419c945d1c9c3">PNG_BACKGROUND_GAMMA_SCREEN</a>:
<a name="l00993"></a>00993                      g = (png_ptr-&gt;screen_gamma);
<a name="l00994"></a>00994                      gs = <a class="code" href="png_8h.html#a458103440bda531da20a310730308f2d">PNG_FP_1</a>;
<a name="l00995"></a>00995                      <span class="keywordflow">break</span>;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997                   <span class="keywordflow">case</span> <a class="code" href="png_8h.html#ae9b61738aa547992c5750946004b5363">PNG_BACKGROUND_GAMMA_FILE</a>:
<a name="l00998"></a>00998                      g = <a class="code" href="png_8c.html#ae283542e5726b179f6bac94e6cd1a924">png_reciprocal</a>(png_ptr-&gt;gamma);
<a name="l00999"></a>00999                      gs = <a class="code" href="png_8c.html#aeac45602d31c07111f6f1f893fa4db6c">png_reciprocal2</a>(png_ptr-&gt;gamma,
<a name="l01000"></a>01000                         png_ptr-&gt;screen_gamma);
<a name="l01001"></a>01001                      <span class="keywordflow">break</span>;
<a name="l01002"></a>01002 
<a name="l01003"></a>01003                   <span class="keywordflow">case</span> <a class="code" href="png_8h.html#abfd7bc6f800e5b3ab64ec98b31400a77">PNG_BACKGROUND_GAMMA_UNIQUE</a>:
<a name="l01004"></a>01004                      g = <a class="code" href="png_8c.html#ae283542e5726b179f6bac94e6cd1a924">png_reciprocal</a>(png_ptr-&gt;background_gamma);
<a name="l01005"></a>01005                      gs = <a class="code" href="png_8c.html#aeac45602d31c07111f6f1f893fa4db6c">png_reciprocal2</a>(png_ptr-&gt;background_gamma,
<a name="l01006"></a>01006                         png_ptr-&gt;screen_gamma);
<a name="l01007"></a>01007                      <span class="keywordflow">break</span>;
<a name="l01008"></a>01008                   <span class="keywordflow">default</span>:
<a name="l01009"></a>01009                      g = <a class="code" href="png_8h.html#a458103440bda531da20a310730308f2d">PNG_FP_1</a>;    <span class="comment">/* back_1 */</span>
<a name="l01010"></a>01010                      gs = <a class="code" href="png_8h.html#a458103440bda531da20a310730308f2d">PNG_FP_1</a>;   <span class="comment">/* back */</span>
<a name="l01011"></a>01011                      <span class="keywordflow">break</span>;
<a name="l01012"></a>01012                }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014                <span class="keywordflow">if</span> (<a class="code" href="png_8c.html#a81580f4aec524e52aaa71fd52ff82eb6">png_gamma_significant</a>(gs))
<a name="l01015"></a>01015                {
<a name="l01016"></a>01016                   back.<a class="code" href="structpng__color__struct.html#ad39dc2d7cb82e3670a3ad397bb4083cb">red</a>   = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)png_ptr-&gt;background.red;
<a name="l01017"></a>01017                   back.<a class="code" href="structpng__color__struct.html#ada9b5a911b185eaf7c6b87934e9f11ce">green</a> = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)png_ptr-&gt;background.green;
<a name="l01018"></a>01018                   back.<a class="code" href="structpng__color__struct.html#a528e625b2778e787dc182e5df1164bbc">blue</a>  = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)png_ptr-&gt;background.blue;
<a name="l01019"></a>01019                }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021                <span class="keywordflow">else</span>
<a name="l01022"></a>01022                {
<a name="l01023"></a>01023                   back.<a class="code" href="structpng__color__struct.html#ad39dc2d7cb82e3670a3ad397bb4083cb">red</a> = <a class="code" href="png_8c.html#a4302dba18d7e58542d9cc8267154f377">png_gamma_8bit_correct</a>(png_ptr-&gt;background.red,
<a name="l01024"></a>01024                       gs);
<a name="l01025"></a>01025                   back.<a class="code" href="structpng__color__struct.html#ada9b5a911b185eaf7c6b87934e9f11ce">green</a> = <a class="code" href="png_8c.html#a4302dba18d7e58542d9cc8267154f377">png_gamma_8bit_correct</a>(png_ptr-&gt;background.green,
<a name="l01026"></a>01026                       gs);
<a name="l01027"></a>01027                   back.<a class="code" href="structpng__color__struct.html#a528e625b2778e787dc182e5df1164bbc">blue</a> = <a class="code" href="png_8c.html#a4302dba18d7e58542d9cc8267154f377">png_gamma_8bit_correct</a>(png_ptr-&gt;background.blue,
<a name="l01028"></a>01028                       gs);
<a name="l01029"></a>01029                }
<a name="l01030"></a>01030                back_1.<a class="code" href="structpng__color__struct.html#ad39dc2d7cb82e3670a3ad397bb4083cb">red</a> = <a class="code" href="png_8c.html#a4302dba18d7e58542d9cc8267154f377">png_gamma_8bit_correct</a>(png_ptr-&gt;background.red, g);
<a name="l01031"></a>01031                back_1.<a class="code" href="structpng__color__struct.html#ada9b5a911b185eaf7c6b87934e9f11ce">green</a> = <a class="code" href="png_8c.html#a4302dba18d7e58542d9cc8267154f377">png_gamma_8bit_correct</a>(png_ptr-&gt;background.green,
<a name="l01032"></a>01032                    g);
<a name="l01033"></a>01033                back_1.<a class="code" href="structpng__color__struct.html#a528e625b2778e787dc182e5df1164bbc">blue</a> = <a class="code" href="png_8c.html#a4302dba18d7e58542d9cc8267154f377">png_gamma_8bit_correct</a>(png_ptr-&gt;background.blue,
<a name="l01034"></a>01034                    g);
<a name="l01035"></a>01035             }
<a name="l01036"></a>01036             <span class="keywordflow">for</span> (i = 0; i &lt; num_palette; i++)
<a name="l01037"></a>01037             {
<a name="l01038"></a>01038                <span class="keywordflow">if</span> (i &lt; (<span class="keywordtype">int</span>)png_ptr-&gt;num_trans &amp;&amp;
<a name="l01039"></a>01039                    png_ptr-&gt;trans_alpha[i] != 0xff)
<a name="l01040"></a>01040                {
<a name="l01041"></a>01041                   <span class="keywordflow">if</span> (png_ptr-&gt;trans_alpha[i] == 0)
<a name="l01042"></a>01042                   {
<a name="l01043"></a>01043                      palette[i] = back;
<a name="l01044"></a>01044                   }
<a name="l01045"></a>01045                   <span class="keywordflow">else</span> <span class="comment">/* if (png_ptr-&gt;trans_alpha[i] != 0xff) */</span>
<a name="l01046"></a>01046                   {
<a name="l01047"></a>01047                      <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> v, w;
<a name="l01048"></a>01048 
<a name="l01049"></a>01049                      v = png_ptr-&gt;gamma_to_1[palette[i].red];
<a name="l01050"></a>01050                      <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(w, v, png_ptr-&gt;trans_alpha[i], back_1.<a class="code" href="structpng__color__struct.html#ad39dc2d7cb82e3670a3ad397bb4083cb">red</a>);
<a name="l01051"></a>01051                      palette[i].red = png_ptr-&gt;gamma_from_1[w];
<a name="l01052"></a>01052 
<a name="l01053"></a>01053                      v = png_ptr-&gt;gamma_to_1[palette[i].green];
<a name="l01054"></a>01054                      <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(w, v, png_ptr-&gt;trans_alpha[i], back_1.<a class="code" href="structpng__color__struct.html#ada9b5a911b185eaf7c6b87934e9f11ce">green</a>);
<a name="l01055"></a>01055                      palette[i].green = png_ptr-&gt;gamma_from_1[w];
<a name="l01056"></a>01056 
<a name="l01057"></a>01057                      v = png_ptr-&gt;gamma_to_1[palette[i].blue];
<a name="l01058"></a>01058                      <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(w, v, png_ptr-&gt;trans_alpha[i], back_1.<a class="code" href="structpng__color__struct.html#a528e625b2778e787dc182e5df1164bbc">blue</a>);
<a name="l01059"></a>01059                      palette[i].blue = png_ptr-&gt;gamma_from_1[w];
<a name="l01060"></a>01060                   }
<a name="l01061"></a>01061                }
<a name="l01062"></a>01062                <span class="keywordflow">else</span>
<a name="l01063"></a>01063                {
<a name="l01064"></a>01064                   palette[i].red = png_ptr-&gt;gamma_table[palette[i].red];
<a name="l01065"></a>01065                   palette[i].green = png_ptr-&gt;gamma_table[palette[i].green];
<a name="l01066"></a>01066                   palette[i].blue = png_ptr-&gt;gamma_table[palette[i].blue];
<a name="l01067"></a>01067                }
<a name="l01068"></a>01068             }
<a name="l01069"></a>01069             <span class="comment">/* Prevent the transformations being done again, and make sure</span>
<a name="l01070"></a>01070 <span class="comment">             * that the now spurious alpha channel is stripped - the code</span>
<a name="l01071"></a>01071 <span class="comment">             * has just reduced background composition and gamma correction</span>
<a name="l01072"></a>01072 <span class="comment">             * to a simple alpha channel strip.</span>
<a name="l01073"></a>01073 <span class="comment">             */</span>
<a name="l01074"></a>01074             png_ptr-&gt;transformations &amp;= ~<a class="code" href="pngpriv_8h.html#a50b268079e6d070ec3f695503b104929">PNG_BACKGROUND</a>;
<a name="l01075"></a>01075             png_ptr-&gt;transformations &amp;= ~<a class="code" href="pngpriv_8h.html#ac0534e475464f58ecb12296da4c4ab63">PNG_GAMMA</a>;
<a name="l01076"></a>01076             png_ptr-&gt;flags |= <a class="code" href="pngpriv_8h.html#a2f97a7023aad11e350a082928b9eef0d">PNG_FLAG_STRIP_ALPHA</a>;
<a name="l01077"></a>01077          }
<a name="l01078"></a>01078 
<a name="l01079"></a>01079          <span class="comment">/* if (png_ptr-&gt;background_gamma_type!=PNG_BACKGROUND_GAMMA_UNKNOWN) */</span>
<a name="l01080"></a>01080          <span class="keywordflow">else</span>
<a name="l01081"></a>01081          <span class="comment">/* color_type != PNG_COLOR_TYPE_PALETTE */</span>
<a name="l01082"></a>01082          {
<a name="l01083"></a>01083             <a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> g = <a class="code" href="png_8h.html#a458103440bda531da20a310730308f2d">PNG_FP_1</a>;
<a name="l01084"></a>01084             <a class="code" href="pngconf_8h.html#ad346e9127ae0a236421481b814a6a682">png_fixed_point</a> gs = <a class="code" href="png_8h.html#a458103440bda531da20a310730308f2d">PNG_FP_1</a>;
<a name="l01085"></a>01085 
<a name="l01086"></a>01086             <span class="keywordflow">switch</span> (png_ptr-&gt;background_gamma_type)
<a name="l01087"></a>01087             {
<a name="l01088"></a>01088                <span class="keywordflow">case</span> <a class="code" href="png_8h.html#afae1856912d79ebc09b419c945d1c9c3">PNG_BACKGROUND_GAMMA_SCREEN</a>:
<a name="l01089"></a>01089                   g = png_ptr-&gt;screen_gamma;
<a name="l01090"></a>01090                   <span class="comment">/* gs = PNG_FP_1; */</span>
<a name="l01091"></a>01091                   <span class="keywordflow">break</span>;
<a name="l01092"></a>01092 
<a name="l01093"></a>01093                <span class="keywordflow">case</span> <a class="code" href="png_8h.html#ae9b61738aa547992c5750946004b5363">PNG_BACKGROUND_GAMMA_FILE</a>:
<a name="l01094"></a>01094                   g = <a class="code" href="png_8c.html#ae283542e5726b179f6bac94e6cd1a924">png_reciprocal</a>(png_ptr-&gt;gamma);
<a name="l01095"></a>01095                   gs = <a class="code" href="png_8c.html#aeac45602d31c07111f6f1f893fa4db6c">png_reciprocal2</a>(png_ptr-&gt;gamma, png_ptr-&gt;screen_gamma);
<a name="l01096"></a>01096                   <span class="keywordflow">break</span>;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098                <span class="keywordflow">case</span> <a class="code" href="png_8h.html#abfd7bc6f800e5b3ab64ec98b31400a77">PNG_BACKGROUND_GAMMA_UNIQUE</a>:
<a name="l01099"></a>01099                   g = <a class="code" href="png_8c.html#ae283542e5726b179f6bac94e6cd1a924">png_reciprocal</a>(png_ptr-&gt;background_gamma);
<a name="l01100"></a>01100                   gs = <a class="code" href="png_8c.html#aeac45602d31c07111f6f1f893fa4db6c">png_reciprocal2</a>(png_ptr-&gt;background_gamma,
<a name="l01101"></a>01101                       png_ptr-&gt;screen_gamma);
<a name="l01102"></a>01102                   <span class="keywordflow">break</span>;
<a name="l01103"></a>01103 
<a name="l01104"></a>01104                <span class="keywordflow">default</span>:
<a name="l01105"></a>01105                   png_error(png_ptr, <span class="stringliteral">&quot;invalid background gamma type&quot;</span>);
<a name="l01106"></a>01106             }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108             png_ptr-&gt;background_1.gray = <a class="code" href="png_8c.html#a3c9cce785a8c5f58148e7aab16706318">png_gamma_correct</a>(png_ptr,
<a name="l01109"></a>01109                 png_ptr-&gt;background.gray, g);
<a name="l01110"></a>01110 
<a name="l01111"></a>01111             png_ptr-&gt;background.gray = <a class="code" href="png_8c.html#a3c9cce785a8c5f58148e7aab16706318">png_gamma_correct</a>(png_ptr,
<a name="l01112"></a>01112                 png_ptr-&gt;background.gray, gs);
<a name="l01113"></a>01113 
<a name="l01114"></a>01114             <span class="keywordflow">if</span> ((png_ptr-&gt;background.red != png_ptr-&gt;background.green) ||
<a name="l01115"></a>01115                 (png_ptr-&gt;background.red != png_ptr-&gt;background.blue) ||
<a name="l01116"></a>01116                 (png_ptr-&gt;background.red != png_ptr-&gt;background.gray))
<a name="l01117"></a>01117             {
<a name="l01118"></a>01118                <span class="comment">/* RGB or RGBA with color background */</span>
<a name="l01119"></a>01119                png_ptr-&gt;background_1.red = <a class="code" href="png_8c.html#a3c9cce785a8c5f58148e7aab16706318">png_gamma_correct</a>(png_ptr,
<a name="l01120"></a>01120                    png_ptr-&gt;background.red, g);
<a name="l01121"></a>01121 
<a name="l01122"></a>01122                png_ptr-&gt;background_1.green = <a class="code" href="png_8c.html#a3c9cce785a8c5f58148e7aab16706318">png_gamma_correct</a>(png_ptr,
<a name="l01123"></a>01123                    png_ptr-&gt;background.green, g);
<a name="l01124"></a>01124 
<a name="l01125"></a>01125                png_ptr-&gt;background_1.blue = <a class="code" href="png_8c.html#a3c9cce785a8c5f58148e7aab16706318">png_gamma_correct</a>(png_ptr,
<a name="l01126"></a>01126                    png_ptr-&gt;background.blue, g);
<a name="l01127"></a>01127 
<a name="l01128"></a>01128                png_ptr-&gt;background.red = <a class="code" href="png_8c.html#a3c9cce785a8c5f58148e7aab16706318">png_gamma_correct</a>(png_ptr,
<a name="l01129"></a>01129                    png_ptr-&gt;background.red, gs);
<a name="l01130"></a>01130 
<a name="l01131"></a>01131                png_ptr-&gt;background.green = <a class="code" href="png_8c.html#a3c9cce785a8c5f58148e7aab16706318">png_gamma_correct</a>(png_ptr,
<a name="l01132"></a>01132                    png_ptr-&gt;background.green, gs);
<a name="l01133"></a>01133 
<a name="l01134"></a>01134                png_ptr-&gt;background.blue = <a class="code" href="png_8c.html#a3c9cce785a8c5f58148e7aab16706318">png_gamma_correct</a>(png_ptr,
<a name="l01135"></a>01135                    png_ptr-&gt;background.blue, gs);
<a name="l01136"></a>01136             }
<a name="l01137"></a>01137 
<a name="l01138"></a>01138             <span class="keywordflow">else</span>
<a name="l01139"></a>01139             {
<a name="l01140"></a>01140                <span class="comment">/* GRAY, GRAY ALPHA, RGB, or RGBA with gray background */</span>
<a name="l01141"></a>01141                png_ptr-&gt;background_1.red = png_ptr-&gt;background_1.green
<a name="l01142"></a>01142                    = png_ptr-&gt;background_1.blue = png_ptr-&gt;background_1.gray;
<a name="l01143"></a>01143 
<a name="l01144"></a>01144                png_ptr-&gt;background.red = png_ptr-&gt;background.green
<a name="l01145"></a>01145                    = png_ptr-&gt;background.blue = png_ptr-&gt;background.gray;
<a name="l01146"></a>01146             }
<a name="l01147"></a>01147          }
<a name="l01148"></a>01148       }
<a name="l01149"></a>01149       <span class="keywordflow">else</span>
<a name="l01150"></a>01150       <span class="comment">/* Transformation does not include PNG_BACKGROUND */</span>
<a name="l01151"></a>01151 <span class="preprocessor">#endif </span><span class="comment">/* PNG_READ_BACKGROUND_SUPPORTED */</span>
<a name="l01152"></a>01152       <span class="keywordflow">if</span> (color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>)
<a name="l01153"></a>01153       {
<a name="l01154"></a>01154          <a class="code" href="png_8h.html#a22c26a022c2bdca0fed457713767ca45">png_colorp</a> palette = png_ptr-&gt;palette;
<a name="l01155"></a>01155          <span class="keywordtype">int</span> num_palette = png_ptr-&gt;num_palette;
<a name="l01156"></a>01156          <span class="keywordtype">int</span> i;
<a name="l01157"></a>01157 
<a name="l01158"></a>01158          <span class="keywordflow">for</span> (i = 0; i &lt; num_palette; i++)
<a name="l01159"></a>01159          {
<a name="l01160"></a>01160             palette[i].red = png_ptr-&gt;gamma_table[palette[i].red];
<a name="l01161"></a>01161             palette[i].green = png_ptr-&gt;gamma_table[palette[i].green];
<a name="l01162"></a>01162             palette[i].blue = png_ptr-&gt;gamma_table[palette[i].blue];
<a name="l01163"></a>01163          }
<a name="l01164"></a>01164 
<a name="l01165"></a>01165          <span class="comment">/* Done the gamma correction. */</span>
<a name="l01166"></a>01166          png_ptr-&gt;transformations &amp;= ~<a class="code" href="pngpriv_8h.html#ac0534e475464f58ecb12296da4c4ab63">PNG_GAMMA</a>;
<a name="l01167"></a>01167       }
<a name="l01168"></a>01168    }
<a name="l01169"></a>01169 <span class="preprocessor">#ifdef PNG_READ_BACKGROUND_SUPPORTED</span>
<a name="l01170"></a>01170 <span class="preprocessor"></span>   <span class="keywordflow">else</span>
<a name="l01171"></a>01171 <span class="preprocessor">#endif</span>
<a name="l01172"></a>01172 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* PNG_READ_GAMMA_SUPPORTED */</span>
<a name="l01173"></a>01173 <span class="preprocessor">#ifdef PNG_READ_BACKGROUND_SUPPORTED</span>
<a name="l01174"></a>01174 <span class="preprocessor"></span>   <span class="comment">/* No GAMMA transformation */</span>
<a name="l01175"></a>01175    <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a50b268079e6d070ec3f695503b104929">PNG_BACKGROUND</a>) &amp;&amp;
<a name="l01176"></a>01176        (color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>))
<a name="l01177"></a>01177    {
<a name="l01178"></a>01178       <span class="keywordtype">int</span> i;
<a name="l01179"></a>01179       <span class="keywordtype">int</span> istop = (int)png_ptr-&gt;num_trans;
<a name="l01180"></a>01180       <a class="code" href="structpng__color__struct.html">png_color</a> back;
<a name="l01181"></a>01181       <a class="code" href="png_8h.html#a22c26a022c2bdca0fed457713767ca45">png_colorp</a> palette = png_ptr-&gt;palette;
<a name="l01182"></a>01182 
<a name="l01183"></a>01183       back.<a class="code" href="structpng__color__struct.html#ad39dc2d7cb82e3670a3ad397bb4083cb">red</a>   = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)png_ptr-&gt;background.red;
<a name="l01184"></a>01184       back.green = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)png_ptr-&gt;background.green;
<a name="l01185"></a>01185       back.blue  = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)png_ptr-&gt;background.blue;
<a name="l01186"></a>01186 
<a name="l01187"></a>01187       <span class="keywordflow">for</span> (i = 0; i &lt; istop; i++)
<a name="l01188"></a>01188       {
<a name="l01189"></a>01189          <span class="keywordflow">if</span> (png_ptr-&gt;trans_alpha[i] == 0)
<a name="l01190"></a>01190          {
<a name="l01191"></a>01191             palette[i] = back;
<a name="l01192"></a>01192          }
<a name="l01193"></a>01193 
<a name="l01194"></a>01194          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (png_ptr-&gt;trans_alpha[i] != 0xff)
<a name="l01195"></a>01195          {
<a name="l01196"></a>01196             <span class="comment">/* The png_composite() macro is defined in png.h */</span>
<a name="l01197"></a>01197             <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(palette[i].red, palette[i].red,
<a name="l01198"></a>01198                 png_ptr-&gt;trans_alpha[i], back.red);
<a name="l01199"></a>01199 
<a name="l01200"></a>01200             <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(palette[i].green, palette[i].green,
<a name="l01201"></a>01201                 png_ptr-&gt;trans_alpha[i], back.green);
<a name="l01202"></a>01202 
<a name="l01203"></a>01203             <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(palette[i].blue, palette[i].blue,
<a name="l01204"></a>01204                 png_ptr-&gt;trans_alpha[i], back.blue);
<a name="l01205"></a>01205          }
<a name="l01206"></a>01206       }
<a name="l01207"></a>01207 
<a name="l01208"></a>01208       <span class="comment">/* Handled alpha, still need to strip the channel. */</span>
<a name="l01209"></a>01209       png_ptr-&gt;transformations &amp;= ~<a class="code" href="pngpriv_8h.html#a50b268079e6d070ec3f695503b104929">PNG_BACKGROUND</a>;
<a name="l01210"></a>01210       png_ptr-&gt;flags |= <a class="code" href="pngpriv_8h.html#a2f97a7023aad11e350a082928b9eef0d">PNG_FLAG_STRIP_ALPHA</a>;
<a name="l01211"></a>01211    }
<a name="l01212"></a>01212 <span class="preprocessor">#endif </span><span class="comment">/* PNG_READ_BACKGROUND_SUPPORTED */</span>
<a name="l01213"></a>01213 
<a name="l01214"></a>01214 <span class="preprocessor">#ifdef PNG_READ_SHIFT_SUPPORTED</span>
<a name="l01215"></a>01215 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a7adf7c783af267566c46423a631ec250">PNG_SHIFT</a>) &amp;&amp;
<a name="l01216"></a>01216        (color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>))
<a name="l01217"></a>01217    {
<a name="l01218"></a>01218       <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> i;
<a name="l01219"></a>01219       <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> istop = png_ptr-&gt;num_palette;
<a name="l01220"></a>01220       <span class="keywordtype">int</span> sr = 8 - png_ptr-&gt;sig_bit.red;
<a name="l01221"></a>01221       <span class="keywordtype">int</span> sg = 8 - png_ptr-&gt;sig_bit.green;
<a name="l01222"></a>01222       <span class="keywordtype">int</span> sb = 8 - png_ptr-&gt;sig_bit.blue;
<a name="l01223"></a>01223 
<a name="l01224"></a>01224       <span class="keywordflow">if</span> (sr &lt; 0 || sr &gt; 8)
<a name="l01225"></a>01225          sr = 0;
<a name="l01226"></a>01226 
<a name="l01227"></a>01227       <span class="keywordflow">if</span> (sg &lt; 0 || sg &gt; 8)
<a name="l01228"></a>01228          sg = 0;
<a name="l01229"></a>01229 
<a name="l01230"></a>01230       <span class="keywordflow">if</span> (sb &lt; 0 || sb &gt; 8)
<a name="l01231"></a>01231          sb = 0;
<a name="l01232"></a>01232 
<a name="l01233"></a>01233       <span class="keywordflow">for</span> (i = 0; i &lt; istop; i++)
<a name="l01234"></a>01234       {
<a name="l01235"></a>01235          png_ptr-&gt;palette[i].red &gt;&gt;= sr;
<a name="l01236"></a>01236          png_ptr-&gt;palette[i].green &gt;&gt;= sg;
<a name="l01237"></a>01237          png_ptr-&gt;palette[i].blue &gt;&gt;= sb;
<a name="l01238"></a>01238       }
<a name="l01239"></a>01239    }
<a name="l01240"></a>01240 <span class="preprocessor">#endif  </span><span class="comment">/* PNG_READ_SHIFT_SUPPORTED */</span>
<a name="l01241"></a>01241  }
<a name="l01242"></a>01242 <span class="preprocessor">#if !defined(PNG_READ_GAMMA_SUPPORTED) &amp;&amp; !defined(PNG_READ_SHIFT_SUPPORTED) \</span>
<a name="l01243"></a>01243 <span class="preprocessor"> &amp;&amp; !defined(PNG_READ_BACKGROUND_SUPPORTED)</span>
<a name="l01244"></a>01244 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr)
<a name="l01245"></a>01245       <span class="keywordflow">return</span>;
<a name="l01246"></a>01246 <span class="preprocessor">#endif</span>
<a name="l01247"></a>01247 <span class="preprocessor"></span>}
<a name="l01248"></a>01248 
<a name="l01249"></a>01249 <span class="comment">/* Modify the info structure to reflect the transformations.  The</span>
<a name="l01250"></a>01250 <span class="comment"> * info should be updated so a PNG file could be written with it,</span>
<a name="l01251"></a>01251 <span class="comment"> * assuming the transformations result in valid PNG data.</span>
<a name="l01252"></a>01252 <span class="comment"> */</span>
<a name="l01253"></a>01253 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l01254"></a><a class="code" href="pngrtran_8c.html#a12bf9ff03785f45d77872d40827e3714">01254</a> <a class="code" href="pngrtran_8c.html#a12bf9ff03785f45d77872d40827e3714">png_read_transform_info</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr, <a class="code" href="png_8h.html#afa5f0022354f5a2e933f1b1c686dbeaf">png_infop</a> info_ptr)
<a name="l01255"></a>01255 {
<a name="l01256"></a>01256    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_read_transform_info&quot;</span>);
<a name="l01257"></a>01257 
<a name="l01258"></a>01258 <span class="preprocessor">#ifdef PNG_READ_EXPAND_SUPPORTED</span>
<a name="l01259"></a>01259 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a97ca3e4f86251d2062f403524704a1c7">PNG_EXPAND</a>)
<a name="l01260"></a>01260    {
<a name="l01261"></a>01261       <span class="keywordflow">if</span> (info_ptr-&gt;color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>)
<a name="l01262"></a>01262       {
<a name="l01263"></a>01263          <span class="keywordflow">if</span> (png_ptr-&gt;num_trans &amp;&amp;
<a name="l01264"></a>01264              (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a588339f3d888cc9a19e1143ec32e34d3">PNG_EXPAND_tRNS</a>))
<a name="l01265"></a>01265             info_ptr-&gt;color_type = <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a>;
<a name="l01266"></a>01266 
<a name="l01267"></a>01267          <span class="keywordflow">else</span>
<a name="l01268"></a>01268             info_ptr-&gt;color_type = <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a>;
<a name="l01269"></a>01269 
<a name="l01270"></a>01270          info_ptr-&gt;bit_depth = 8;
<a name="l01271"></a>01271          info_ptr-&gt;num_trans = 0;
<a name="l01272"></a>01272       }
<a name="l01273"></a>01273       <span class="keywordflow">else</span>
<a name="l01274"></a>01274       {
<a name="l01275"></a>01275          <span class="keywordflow">if</span> (png_ptr-&gt;num_trans)
<a name="l01276"></a>01276          {
<a name="l01277"></a>01277             <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a588339f3d888cc9a19e1143ec32e34d3">PNG_EXPAND_tRNS</a>)
<a name="l01278"></a>01278                info_ptr-&gt;color_type |= <a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>;
<a name="l01279"></a>01279          }
<a name="l01280"></a>01280          <span class="keywordflow">if</span> (info_ptr-&gt;bit_depth &lt; 8)
<a name="l01281"></a>01281             info_ptr-&gt;bit_depth = 8;
<a name="l01282"></a>01282 
<a name="l01283"></a>01283          info_ptr-&gt;num_trans = 0;
<a name="l01284"></a>01284       }
<a name="l01285"></a>01285    }
<a name="l01286"></a>01286 <span class="preprocessor">#endif</span>
<a name="l01287"></a>01287 <span class="preprocessor"></span>
<a name="l01288"></a>01288 <span class="preprocessor">#ifdef PNG_READ_BACKGROUND_SUPPORTED</span>
<a name="l01289"></a>01289 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a50b268079e6d070ec3f695503b104929">PNG_BACKGROUND</a>)
<a name="l01290"></a>01290    {
<a name="l01291"></a>01291       info_ptr-&gt;color_type = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(info_ptr-&gt;color_type &amp;
<a name="l01292"></a>01292           ~<a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>);
<a name="l01293"></a>01293       info_ptr-&gt;num_trans = 0;
<a name="l01294"></a>01294       info_ptr-&gt;background = png_ptr-&gt;background;
<a name="l01295"></a>01295    }
<a name="l01296"></a>01296 <span class="preprocessor">#endif</span>
<a name="l01297"></a>01297 <span class="preprocessor"></span>
<a name="l01298"></a>01298 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l01299"></a>01299 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ac0534e475464f58ecb12296da4c4ab63">PNG_GAMMA</a>)
<a name="l01300"></a>01300    {
<a name="l01301"></a>01301       info_ptr-&gt;gamma = png_ptr-&gt;gamma;
<a name="l01302"></a>01302    }
<a name="l01303"></a>01303 <span class="preprocessor">#endif</span>
<a name="l01304"></a>01304 <span class="preprocessor"></span>
<a name="l01305"></a>01305 <span class="preprocessor">#ifdef PNG_READ_16_TO_8_SUPPORTED</span>
<a name="l01306"></a>01306 <span class="preprocessor"></span><span class="preprocessor">#ifdef PNG_READ_16BIT_SUPPORTED</span>
<a name="l01307"></a>01307 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ae70a30d4407554f37c393a1755b1aba2">PNG_16_TO_8</a>) &amp;&amp; (info_ptr-&gt;bit_depth == 16))
<a name="l01308"></a>01308       info_ptr-&gt;bit_depth = 8;
<a name="l01309"></a>01309 <span class="preprocessor">#else</span>
<a name="l01310"></a>01310 <span class="preprocessor"></span>   <span class="comment">/* Force chopping 16-bit input down to 8 */</span>
<a name="l01311"></a>01311    <span class="keywordflow">if</span> (info_ptr-&gt;bit_depth == 16)
<a name="l01312"></a>01312    {
<a name="l01313"></a>01313       png_ptr-&gt;transformations |=<a class="code" href="pngpriv_8h.html#ae70a30d4407554f37c393a1755b1aba2">PNG_16_TO_8</a>;
<a name="l01314"></a>01314       info_ptr-&gt;bit_depth = 8;
<a name="l01315"></a>01315    }
<a name="l01316"></a>01316 <span class="preprocessor">#endif</span>
<a name="l01317"></a>01317 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01318"></a>01318 <span class="preprocessor"></span>
<a name="l01319"></a>01319 <span class="preprocessor">#ifdef PNG_READ_GRAY_TO_RGB_SUPPORTED</span>
<a name="l01320"></a>01320 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#acc6d613a0273102f811a5783d4cf116f">PNG_GRAY_TO_RGB</a>)
<a name="l01321"></a>01321       info_ptr-&gt;color_type |= <a class="code" href="png_8h.html#a87bc785c34abddf3bb9ff206d721964b">PNG_COLOR_MASK_COLOR</a>;
<a name="l01322"></a>01322 <span class="preprocessor">#endif</span>
<a name="l01323"></a>01323 <span class="preprocessor"></span>
<a name="l01324"></a>01324 <span class="preprocessor">#ifdef PNG_READ_RGB_TO_GRAY_SUPPORTED</span>
<a name="l01325"></a>01325 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ac5121e4ab7b1551f7bc114a97410aa74">PNG_RGB_TO_GRAY</a>)
<a name="l01326"></a>01326       info_ptr-&gt;color_type &amp;= ~<a class="code" href="png_8h.html#a87bc785c34abddf3bb9ff206d721964b">PNG_COLOR_MASK_COLOR</a>;
<a name="l01327"></a>01327 <span class="preprocessor">#endif</span>
<a name="l01328"></a>01328 <span class="preprocessor"></span>
<a name="l01329"></a>01329 <span class="preprocessor">#ifdef PNG_READ_QUANTIZE_SUPPORTED</span>
<a name="l01330"></a>01330 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a612425a0a63db8b8651d599f99745829">PNG_QUANTIZE</a>)
<a name="l01331"></a>01331    {
<a name="l01332"></a>01332       <span class="keywordflow">if</span> (((info_ptr-&gt;color_type == <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a>) ||
<a name="l01333"></a>01333           (info_ptr-&gt;color_type == <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a>)) &amp;&amp;
<a name="l01334"></a>01334           png_ptr-&gt;palette_lookup &amp;&amp; info_ptr-&gt;bit_depth == 8)
<a name="l01335"></a>01335       {
<a name="l01336"></a>01336          info_ptr-&gt;color_type = <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>;
<a name="l01337"></a>01337       }
<a name="l01338"></a>01338    }
<a name="l01339"></a>01339 <span class="preprocessor">#endif</span>
<a name="l01340"></a>01340 <span class="preprocessor"></span>
<a name="l01341"></a>01341 <span class="preprocessor">#ifdef PNG_READ_PACK_SUPPORTED</span>
<a name="l01342"></a>01342 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ad5b612b7569bf7bf96956ae601c1aa7d">PNG_PACK</a>) &amp;&amp; (info_ptr-&gt;bit_depth &lt; 8))
<a name="l01343"></a>01343       info_ptr-&gt;bit_depth = 8;
<a name="l01344"></a>01344 <span class="preprocessor">#endif</span>
<a name="l01345"></a>01345 <span class="preprocessor"></span>
<a name="l01346"></a>01346    <span class="keywordflow">if</span> (info_ptr-&gt;color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>)
<a name="l01347"></a>01347       info_ptr-&gt;channels = 1;
<a name="l01348"></a>01348 
<a name="l01349"></a>01349    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info_ptr-&gt;color_type &amp; <a class="code" href="png_8h.html#a87bc785c34abddf3bb9ff206d721964b">PNG_COLOR_MASK_COLOR</a>)
<a name="l01350"></a>01350       info_ptr-&gt;channels = 3;
<a name="l01351"></a>01351 
<a name="l01352"></a>01352    <span class="keywordflow">else</span>
<a name="l01353"></a>01353       info_ptr-&gt;channels = 1;
<a name="l01354"></a>01354 
<a name="l01355"></a>01355 <span class="preprocessor">#ifdef PNG_READ_STRIP_ALPHA_SUPPORTED</span>
<a name="l01356"></a>01356 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;flags &amp; <a class="code" href="pngpriv_8h.html#a2f97a7023aad11e350a082928b9eef0d">PNG_FLAG_STRIP_ALPHA</a>)
<a name="l01357"></a>01357       info_ptr-&gt;color_type &amp;= ~<a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>;
<a name="l01358"></a>01358 <span class="preprocessor">#endif</span>
<a name="l01359"></a>01359 <span class="preprocessor"></span>
<a name="l01360"></a>01360    <span class="keywordflow">if</span> (info_ptr-&gt;color_type &amp; <a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>)
<a name="l01361"></a>01361       info_ptr-&gt;channels++;
<a name="l01362"></a>01362 
<a name="l01363"></a>01363 <span class="preprocessor">#ifdef PNG_READ_FILLER_SUPPORTED</span>
<a name="l01364"></a>01364 <span class="preprocessor"></span>   <span class="comment">/* STRIP_ALPHA and FILLER allowed:  MASK_ALPHA bit stripped above */</span>
<a name="l01365"></a>01365    <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#aa16fe68c6c2a0e5804920d2822cf84d3">PNG_FILLER</a>) &amp;&amp;
<a name="l01366"></a>01366        ((info_ptr-&gt;color_type == <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a>) ||
<a name="l01367"></a>01367        (info_ptr-&gt;color_type == <a class="code" href="png_8h.html#ac679619ad9d3f2c46c2b69fe65bd19f1">PNG_COLOR_TYPE_GRAY</a>)))
<a name="l01368"></a>01368    {
<a name="l01369"></a>01369       info_ptr-&gt;channels++;
<a name="l01370"></a>01370       <span class="comment">/* If adding a true alpha channel not just filler */</span>
<a name="l01371"></a>01371       <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a7a7ee748d101a34e68b80419bb2ec634">PNG_ADD_ALPHA</a>)
<a name="l01372"></a>01372          info_ptr-&gt;color_type |= <a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>;
<a name="l01373"></a>01373    }
<a name="l01374"></a>01374 <span class="preprocessor">#endif</span>
<a name="l01375"></a>01375 <span class="preprocessor"></span>
<a name="l01376"></a>01376 <span class="preprocessor">#if defined(PNG_USER_TRANSFORM_PTR_SUPPORTED) &amp;&amp; \</span>
<a name="l01377"></a>01377 <span class="preprocessor">defined(PNG_READ_USER_TRANSFORM_SUPPORTED)</span>
<a name="l01378"></a>01378 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a5f3002d2db6845ec190027edb5d67a06">PNG_USER_TRANSFORM</a>)
<a name="l01379"></a>01379    {
<a name="l01380"></a>01380       <span class="keywordflow">if</span> (info_ptr-&gt;bit_depth &lt; png_ptr-&gt;user_transform_depth)
<a name="l01381"></a>01381          info_ptr-&gt;bit_depth = png_ptr-&gt;user_transform_depth;
<a name="l01382"></a>01382 
<a name="l01383"></a>01383       <span class="keywordflow">if</span> (info_ptr-&gt;channels &lt; png_ptr-&gt;user_transform_channels)
<a name="l01384"></a>01384          info_ptr-&gt;channels = png_ptr-&gt;user_transform_channels;
<a name="l01385"></a>01385    }
<a name="l01386"></a>01386 <span class="preprocessor">#endif</span>
<a name="l01387"></a>01387 <span class="preprocessor"></span>
<a name="l01388"></a>01388    info_ptr-&gt;pixel_depth = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(info_ptr-&gt;channels *
<a name="l01389"></a>01389        info_ptr-&gt;bit_depth);
<a name="l01390"></a>01390 
<a name="l01391"></a>01391    info_ptr-&gt;rowbytes = <a class="code" href="pngpriv_8h.html#a18a47644e4b7cd60bb2b4a8c82d53f30">PNG_ROWBYTES</a>(info_ptr-&gt;pixel_depth, info_ptr-&gt;width);
<a name="l01392"></a>01392 
<a name="l01393"></a>01393 <span class="preprocessor">#ifndef PNG_READ_EXPAND_SUPPORTED</span>
<a name="l01394"></a>01394 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr)
<a name="l01395"></a>01395       <span class="keywordflow">return</span>;
<a name="l01396"></a>01396 <span class="preprocessor">#endif</span>
<a name="l01397"></a>01397 <span class="preprocessor"></span>}
<a name="l01398"></a>01398 
<a name="l01399"></a>01399 <span class="comment">/* Transform the row.  The order of transformations is significant,</span>
<a name="l01400"></a>01400 <span class="comment"> * and is very touchy.  If you add a transformation, take care to</span>
<a name="l01401"></a>01401 <span class="comment"> * decide how it fits in with the other transformations here.</span>
<a name="l01402"></a>01402 <span class="comment"> */</span>
<a name="l01403"></a>01403 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l01404"></a><a class="code" href="pngrtran_8c.html#a1b5b653c855772da97efb015cbd9c8b0">01404</a> <a class="code" href="pngrtran_8c.html#a1b5b653c855772da97efb015cbd9c8b0">png_do_read_transformations</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr)
<a name="l01405"></a>01405 {
<a name="l01406"></a>01406    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_read_transformations&quot;</span>);
<a name="l01407"></a>01407 
<a name="l01408"></a>01408    <span class="keywordflow">if</span> (png_ptr-&gt;row_buf == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01409"></a>01409    {
<a name="l01410"></a>01410 <span class="preprocessor">#ifdef PNG_CONSOLE_IO_SUPPORTED</span>
<a name="l01411"></a>01411 <span class="preprocessor"></span>      <span class="keywordtype">char</span> msg[50];
<a name="l01412"></a>01412 
<a name="l01413"></a>01413       <a class="code" href="pngpriv_8h.html#a3ea2ac4d5f359826be82bf6e277b9f16">png_snprintf2</a>(msg, 50,
<a name="l01414"></a>01414           <span class="stringliteral">&quot;NULL row buffer for row %ld, pass %d&quot;</span>, (<span class="keywordtype">long</span>)png_ptr-&gt;row_number,
<a name="l01415"></a>01415           png_ptr-&gt;pass);
<a name="l01416"></a>01416       png_error(png_ptr, msg);
<a name="l01417"></a>01417 <span class="preprocessor">#else</span>
<a name="l01418"></a>01418 <span class="preprocessor"></span>      png_error(png_ptr, <span class="stringliteral">&quot;NULL row buffer&quot;</span>);
<a name="l01419"></a>01419 <span class="preprocessor">#endif</span>
<a name="l01420"></a>01420 <span class="preprocessor"></span>   }
<a name="l01421"></a>01421 <span class="preprocessor">#ifdef PNG_WARN_UNINITIALIZED_ROW</span>
<a name="l01422"></a>01422 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (!(png_ptr-&gt;flags &amp; <a class="code" href="pngpriv_8h.html#aaeb40b161e32ee3801d460e3df0099f6">PNG_FLAG_ROW_INIT</a>))
<a name="l01423"></a>01423       <span class="comment">/* Application has failed to call either png_read_start_image()</span>
<a name="l01424"></a>01424 <span class="comment">       * or png_read_update_info() after setting transforms that expand</span>
<a name="l01425"></a>01425 <span class="comment">       * pixels.  This check added to libpng-1.2.19</span>
<a name="l01426"></a>01426 <span class="comment">       */</span>
<a name="l01427"></a>01427 <span class="preprocessor">#if (PNG_WARN_UNINITIALIZED_ROW==1)</span>
<a name="l01428"></a>01428 <span class="preprocessor"></span>      png_error(png_ptr, <span class="stringliteral">&quot;Uninitialized row&quot;</span>);
<a name="l01429"></a>01429 <span class="preprocessor">#else</span>
<a name="l01430"></a>01430 <span class="preprocessor"></span>      <a class="code" href="pngerror_8c.html#a34b3bb3a1ff0050b9317c3ca6d18df24">png_warning</a>(png_ptr, <span class="stringliteral">&quot;Uninitialized row&quot;</span>);
<a name="l01431"></a>01431 <span class="preprocessor">#endif</span>
<a name="l01432"></a>01432 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01433"></a>01433 <span class="preprocessor"></span>
<a name="l01434"></a>01434 <span class="preprocessor">#ifdef PNG_READ_EXPAND_SUPPORTED</span>
<a name="l01435"></a>01435 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a97ca3e4f86251d2062f403524704a1c7">PNG_EXPAND</a>)
<a name="l01436"></a>01436    {
<a name="l01437"></a>01437       <span class="keywordflow">if</span> (png_ptr-&gt;row_info.color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>)
<a name="l01438"></a>01438       {
<a name="l01439"></a>01439          <a class="code" href="pngrtran_8c.html#a490d6794b731f4fc833b290d438c05cc">png_do_expand_palette</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1,
<a name="l01440"></a>01440              png_ptr-&gt;palette, png_ptr-&gt;trans_alpha, png_ptr-&gt;num_trans);
<a name="l01441"></a>01441       }
<a name="l01442"></a>01442       <span class="keywordflow">else</span>
<a name="l01443"></a>01443       {
<a name="l01444"></a>01444          <span class="keywordflow">if</span> (png_ptr-&gt;num_trans &amp;&amp;
<a name="l01445"></a>01445              (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a588339f3d888cc9a19e1143ec32e34d3">PNG_EXPAND_tRNS</a>))
<a name="l01446"></a>01446             <a class="code" href="pngrtran_8c.html#a11ab75ae810cda508df3305a3e78f7bd">png_do_expand</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1,
<a name="l01447"></a>01447                 &amp;(png_ptr-&gt;trans_color));
<a name="l01448"></a>01448          <span class="keywordflow">else</span>
<a name="l01449"></a>01449 
<a name="l01450"></a>01450             <a class="code" href="pngrtran_8c.html#a11ab75ae810cda508df3305a3e78f7bd">png_do_expand</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1,
<a name="l01451"></a>01451                 <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01452"></a>01452       }
<a name="l01453"></a>01453    }
<a name="l01454"></a>01454 <span class="preprocessor">#endif</span>
<a name="l01455"></a>01455 <span class="preprocessor"></span>
<a name="l01456"></a>01456 <span class="preprocessor">#ifdef PNG_READ_STRIP_ALPHA_SUPPORTED</span>
<a name="l01457"></a>01457 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;flags &amp; <a class="code" href="pngpriv_8h.html#a2f97a7023aad11e350a082928b9eef0d">PNG_FLAG_STRIP_ALPHA</a>)
<a name="l01458"></a>01458       <a class="code" href="pngtrans_8c.html#aa427a8f27e2f207618ddcd3942947d1c">png_do_strip_filler</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1,
<a name="l01459"></a>01459           <a class="code" href="pngpriv_8h.html#aa371ad6e23186d80cd83a33cf5eeb20c">PNG_FLAG_FILLER_AFTER</a> | (png_ptr-&gt;flags &amp; <a class="code" href="pngpriv_8h.html#a2f97a7023aad11e350a082928b9eef0d">PNG_FLAG_STRIP_ALPHA</a>));
<a name="l01460"></a>01460 <span class="preprocessor">#endif</span>
<a name="l01461"></a>01461 <span class="preprocessor"></span>
<a name="l01462"></a>01462 <span class="preprocessor">#ifdef PNG_READ_RGB_TO_GRAY_SUPPORTED</span>
<a name="l01463"></a>01463 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ac5121e4ab7b1551f7bc114a97410aa74">PNG_RGB_TO_GRAY</a>)
<a name="l01464"></a>01464    {
<a name="l01465"></a>01465       <span class="keywordtype">int</span> rgb_error =
<a name="l01466"></a>01466           <a class="code" href="pngrtran_8c.html#a98cd295723f0d96052ca348b7ac75b23">png_do_rgb_to_gray</a>(png_ptr, &amp;(png_ptr-&gt;row_info),
<a name="l01467"></a>01467               png_ptr-&gt;row_buf + 1);
<a name="l01468"></a>01468 
<a name="l01469"></a>01469       <span class="keywordflow">if</span> (rgb_error)
<a name="l01470"></a>01470       {
<a name="l01471"></a>01471          png_ptr-&gt;rgb_to_gray_status=1;
<a name="l01472"></a>01472          <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ac5121e4ab7b1551f7bc114a97410aa74">PNG_RGB_TO_GRAY</a>) ==
<a name="l01473"></a>01473              <a class="code" href="pngpriv_8h.html#ad13d3f3d445291d1c1f6b0dcbb230eff">PNG_RGB_TO_GRAY_WARN</a>)
<a name="l01474"></a>01474             <a class="code" href="pngerror_8c.html#a34b3bb3a1ff0050b9317c3ca6d18df24">png_warning</a>(png_ptr, <span class="stringliteral">&quot;png_do_rgb_to_gray found nongray pixel&quot;</span>);
<a name="l01475"></a>01475 
<a name="l01476"></a>01476          <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ac5121e4ab7b1551f7bc114a97410aa74">PNG_RGB_TO_GRAY</a>) ==
<a name="l01477"></a>01477              <a class="code" href="pngpriv_8h.html#a17987a8a349241530e6a13904ca12a7b">PNG_RGB_TO_GRAY_ERR</a>)
<a name="l01478"></a>01478             png_error(png_ptr, <span class="stringliteral">&quot;png_do_rgb_to_gray found nongray pixel&quot;</span>);
<a name="l01479"></a>01479       }
<a name="l01480"></a>01480    }
<a name="l01481"></a>01481 <span class="preprocessor">#endif</span>
<a name="l01482"></a>01482 <span class="preprocessor"></span>
<a name="l01483"></a>01483 <span class="comment">/* From Andreas Dilger e-mail to png-implement, 26 March 1998:</span>
<a name="l01484"></a>01484 <span class="comment"> *</span>
<a name="l01485"></a>01485 <span class="comment"> *   In most cases, the &quot;simple transparency&quot; should be done prior to doing</span>
<a name="l01486"></a>01486 <span class="comment"> *   gray-to-RGB, or you will have to test 3x as many bytes to check if a</span>
<a name="l01487"></a>01487 <span class="comment"> *   pixel is transparent.  You would also need to make sure that the</span>
<a name="l01488"></a>01488 <span class="comment"> *   transparency information is upgraded to RGB.</span>
<a name="l01489"></a>01489 <span class="comment"> *</span>
<a name="l01490"></a>01490 <span class="comment"> *   To summarize, the current flow is:</span>
<a name="l01491"></a>01491 <span class="comment"> *   - Gray + simple transparency -&gt; compare 1 or 2 gray bytes and composite</span>
<a name="l01492"></a>01492 <span class="comment"> *                                   with background &quot;in place&quot; if transparent,</span>
<a name="l01493"></a>01493 <span class="comment"> *                                   convert to RGB if necessary</span>
<a name="l01494"></a>01494 <span class="comment"> *   - Gray + alpha -&gt; composite with gray background and remove alpha bytes,</span>
<a name="l01495"></a>01495 <span class="comment"> *                                   convert to RGB if necessary</span>
<a name="l01496"></a>01496 <span class="comment"> *</span>
<a name="l01497"></a>01497 <span class="comment"> *   To support RGB backgrounds for gray images we need:</span>
<a name="l01498"></a>01498 <span class="comment"> *   - Gray + simple transparency -&gt; convert to RGB + simple transparency,</span>
<a name="l01499"></a>01499 <span class="comment"> *                                   compare 3 or 6 bytes and composite with</span>
<a name="l01500"></a>01500 <span class="comment"> *                                   background &quot;in place&quot; if transparent</span>
<a name="l01501"></a>01501 <span class="comment"> *                                   (3x compare/pixel compared to doing</span>
<a name="l01502"></a>01502 <span class="comment"> *                                   composite with gray bkgrnd)</span>
<a name="l01503"></a>01503 <span class="comment"> *   - Gray + alpha -&gt; convert to RGB + alpha, composite with background and</span>
<a name="l01504"></a>01504 <span class="comment"> *                                   remove alpha bytes (3x float</span>
<a name="l01505"></a>01505 <span class="comment"> *                                   operations/pixel compared with composite</span>
<a name="l01506"></a>01506 <span class="comment"> *                                   on gray background)</span>
<a name="l01507"></a>01507 <span class="comment"> *</span>
<a name="l01508"></a>01508 <span class="comment"> *  Greg&#39;s change will do this.  The reason it wasn&#39;t done before is for</span>
<a name="l01509"></a>01509 <span class="comment"> *  performance, as this increases the per-pixel operations.  If we would check</span>
<a name="l01510"></a>01510 <span class="comment"> *  in advance if the background was gray or RGB, and position the gray-to-RGB</span>
<a name="l01511"></a>01511 <span class="comment"> *  transform appropriately, then it would save a lot of work/time.</span>
<a name="l01512"></a>01512 <span class="comment"> */</span>
<a name="l01513"></a>01513 
<a name="l01514"></a>01514 <span class="preprocessor">#ifdef PNG_READ_GRAY_TO_RGB_SUPPORTED</span>
<a name="l01515"></a>01515 <span class="preprocessor"></span>   <span class="comment">/* If gray -&gt; RGB, do so now only if background is non-gray; else do later</span>
<a name="l01516"></a>01516 <span class="comment">    * for performance reasons</span>
<a name="l01517"></a>01517 <span class="comment">    */</span>
<a name="l01518"></a>01518    <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#acc6d613a0273102f811a5783d4cf116f">PNG_GRAY_TO_RGB</a>) &amp;&amp;
<a name="l01519"></a>01519        !(png_ptr-&gt;mode &amp; <a class="code" href="pngpriv_8h.html#ae93c2b0027efdde092856e83df691ae5">PNG_BACKGROUND_IS_GRAY</a>))
<a name="l01520"></a>01520       <a class="code" href="pngrtran_8c.html#af561406ff2ddd6523d49b88e51d5bf94">png_do_gray_to_rgb</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1);
<a name="l01521"></a>01521 <span class="preprocessor">#endif</span>
<a name="l01522"></a>01522 <span class="preprocessor"></span>
<a name="l01523"></a>01523 <span class="preprocessor">#ifdef PNG_READ_BACKGROUND_SUPPORTED</span>
<a name="l01524"></a>01524 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a50b268079e6d070ec3f695503b104929">PNG_BACKGROUND</a>) &amp;&amp;
<a name="l01525"></a>01525        ((png_ptr-&gt;num_trans != 0) ||
<a name="l01526"></a>01526        (png_ptr-&gt;color_type &amp; <a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>)))
<a name="l01527"></a>01527       <a class="code" href="pngrtran_8c.html#acc7e1bbdd58c9fb68b74b3f0f3ff0049">png_do_background</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1,
<a name="l01528"></a>01528           &amp;(png_ptr-&gt;trans_color), &amp;(png_ptr-&gt;background)
<a name="l01529"></a>01529 #ifdef <a class="code" href="pnglibconf_8h.html#a7a690fa3eb9de03fbadb80ff0ceb7c5f">PNG_READ_GAMMA_SUPPORTED</a>
<a name="l01530"></a>01530           , &amp;(png_ptr-&gt;background_1),
<a name="l01531"></a>01531           png_ptr-&gt;gamma_table, png_ptr-&gt;gamma_from_1,
<a name="l01532"></a>01532           png_ptr-&gt;gamma_to_1, png_ptr-&gt;gamma_16_table,
<a name="l01533"></a>01533           png_ptr-&gt;gamma_16_from_1, png_ptr-&gt;gamma_16_to_1,
<a name="l01534"></a>01534           png_ptr-&gt;gamma_shift
<a name="l01535"></a>01535 #endif
<a name="l01536"></a>01536           );
<a name="l01537"></a>01537 <span class="preprocessor">#endif</span>
<a name="l01538"></a>01538 <span class="preprocessor"></span>
<a name="l01539"></a>01539 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l01540"></a>01540 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ac0534e475464f58ecb12296da4c4ab63">PNG_GAMMA</a>) &amp;&amp;
<a name="l01541"></a>01541 #ifdef <a class="code" href="pnglibconf_8h.html#a1e2263d10ee7b6e1c1b9ed041b363c46">PNG_READ_BACKGROUND_SUPPORTED</a>
<a name="l01542"></a>01542        !((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a50b268079e6d070ec3f695503b104929">PNG_BACKGROUND</a>) &amp;&amp;
<a name="l01543"></a>01543        ((png_ptr-&gt;num_trans != 0) ||
<a name="l01544"></a>01544        (png_ptr-&gt;color_type &amp; <a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>))) &amp;&amp;
<a name="l01545"></a>01545 #endif
<a name="l01546"></a>01546        (png_ptr-&gt;color_type != <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>))
<a name="l01547"></a>01547       <a class="code" href="pngrtran_8c.html#a6506bd6efb94f82c38bd52191e686ba9">png_do_gamma</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1,
<a name="l01548"></a>01548           png_ptr-&gt;gamma_table, png_ptr-&gt;gamma_16_table,
<a name="l01549"></a>01549           png_ptr-&gt;gamma_shift);
<a name="l01550"></a>01550 <span class="preprocessor">#endif</span>
<a name="l01551"></a>01551 <span class="preprocessor"></span>
<a name="l01552"></a>01552 <span class="preprocessor">#ifdef PNG_READ_16_TO_8_SUPPORTED</span>
<a name="l01553"></a>01553 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ae70a30d4407554f37c393a1755b1aba2">PNG_16_TO_8</a>)
<a name="l01554"></a>01554       <a class="code" href="pngrtran_8c.html#af86d9a98a29156d9bbd8bda190a65f7e">png_do_chop</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1);
<a name="l01555"></a>01555 <span class="preprocessor">#endif</span>
<a name="l01556"></a>01556 <span class="preprocessor"></span>
<a name="l01557"></a>01557 <span class="preprocessor">#ifdef PNG_READ_QUANTIZE_SUPPORTED</span>
<a name="l01558"></a>01558 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a612425a0a63db8b8651d599f99745829">PNG_QUANTIZE</a>)
<a name="l01559"></a>01559    {
<a name="l01560"></a>01560       <a class="code" href="pngrtran_8c.html#a7c997efaee527ae3cf282135bf35778d">png_do_quantize</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1,
<a name="l01561"></a>01561           png_ptr-&gt;palette_lookup, png_ptr-&gt;quantize_index);
<a name="l01562"></a>01562 
<a name="l01563"></a>01563       <span class="keywordflow">if</span> (png_ptr-&gt;row_info.rowbytes == 0)
<a name="l01564"></a>01564          png_error(png_ptr, <span class="stringliteral">&quot;png_do_quantize returned rowbytes=0&quot;</span>);
<a name="l01565"></a>01565    }
<a name="l01566"></a>01566 <span class="preprocessor">#endif </span><span class="comment">/* PNG_READ_QUANTIZE_SUPPORTED */</span>
<a name="l01567"></a>01567 
<a name="l01568"></a>01568 <span class="preprocessor">#ifdef PNG_READ_INVERT_SUPPORTED</span>
<a name="l01569"></a>01569 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ad1c0a7805b5b507a1addf2356fe26edd">PNG_INVERT_MONO</a>)
<a name="l01570"></a>01570       <a class="code" href="pngtrans_8c.html#ad6a6f7e864a9754571ef7ff809bb27db">png_do_invert</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1);
<a name="l01571"></a>01571 <span class="preprocessor">#endif</span>
<a name="l01572"></a>01572 <span class="preprocessor"></span>
<a name="l01573"></a>01573 <span class="preprocessor">#ifdef PNG_READ_SHIFT_SUPPORTED</span>
<a name="l01574"></a>01574 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a7adf7c783af267566c46423a631ec250">PNG_SHIFT</a>)
<a name="l01575"></a>01575       <a class="code" href="pngrtran_8c.html#a4fe8882f8fd5f1e025362c5f8ef3ea65">png_do_unshift</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1,
<a name="l01576"></a>01576           &amp;(png_ptr-&gt;shift));
<a name="l01577"></a>01577 <span class="preprocessor">#endif</span>
<a name="l01578"></a>01578 <span class="preprocessor"></span>
<a name="l01579"></a>01579 <span class="preprocessor">#ifdef PNG_READ_PACK_SUPPORTED</span>
<a name="l01580"></a>01580 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ad5b612b7569bf7bf96956ae601c1aa7d">PNG_PACK</a>)
<a name="l01581"></a>01581       <a class="code" href="pngrtran_8c.html#aaf85bde11df668bfd081cf10e778be92">png_do_unpack</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1);
<a name="l01582"></a>01582 <span class="preprocessor">#endif</span>
<a name="l01583"></a>01583 <span class="preprocessor"></span>
<a name="l01584"></a>01584 <span class="preprocessor">#ifdef PNG_READ_BGR_SUPPORTED</span>
<a name="l01585"></a>01585 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#afcc9ed0cfb2ee46371d05dbc7b20dea3">PNG_BGR</a>)
<a name="l01586"></a>01586       <a class="code" href="pngtrans_8c.html#a0c93ed1664534f6ba58326b1aae229e3">png_do_bgr</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1);
<a name="l01587"></a>01587 <span class="preprocessor">#endif</span>
<a name="l01588"></a>01588 <span class="preprocessor"></span>
<a name="l01589"></a>01589 <span class="preprocessor">#ifdef PNG_READ_PACKSWAP_SUPPORTED</span>
<a name="l01590"></a>01590 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#ae50c543dbbead1de7116a8a9acf43aff">PNG_PACKSWAP</a>)
<a name="l01591"></a>01591       <a class="code" href="pngtrans_8c.html#a34b1e9a582bbeb827db329cb741ac2d4">png_do_packswap</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1);
<a name="l01592"></a>01592 <span class="preprocessor">#endif</span>
<a name="l01593"></a>01593 <span class="preprocessor"></span>
<a name="l01594"></a>01594 <span class="preprocessor">#ifdef PNG_READ_GRAY_TO_RGB_SUPPORTED</span>
<a name="l01595"></a>01595 <span class="preprocessor"></span>   <span class="comment">/* If gray -&gt; RGB, do so now only if we did not do so above */</span>
<a name="l01596"></a>01596    <span class="keywordflow">if</span> ((png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#acc6d613a0273102f811a5783d4cf116f">PNG_GRAY_TO_RGB</a>) &amp;&amp;
<a name="l01597"></a>01597        (png_ptr-&gt;mode &amp; <a class="code" href="pngpriv_8h.html#ae93c2b0027efdde092856e83df691ae5">PNG_BACKGROUND_IS_GRAY</a>))
<a name="l01598"></a>01598       <a class="code" href="pngrtran_8c.html#af561406ff2ddd6523d49b88e51d5bf94">png_do_gray_to_rgb</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1);
<a name="l01599"></a>01599 <span class="preprocessor">#endif</span>
<a name="l01600"></a>01600 <span class="preprocessor"></span>
<a name="l01601"></a>01601 <span class="preprocessor">#ifdef PNG_READ_FILLER_SUPPORTED</span>
<a name="l01602"></a>01602 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#aa16fe68c6c2a0e5804920d2822cf84d3">PNG_FILLER</a>)
<a name="l01603"></a>01603       <a class="code" href="pngrtran_8c.html#ac7c6c2d10e6f9e5e446164580a870203">png_do_read_filler</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1,
<a name="l01604"></a>01604           (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)png_ptr-&gt;filler, png_ptr-&gt;flags);
<a name="l01605"></a>01605 <span class="preprocessor">#endif</span>
<a name="l01606"></a>01606 <span class="preprocessor"></span>
<a name="l01607"></a>01607 <span class="preprocessor">#ifdef PNG_READ_INVERT_ALPHA_SUPPORTED</span>
<a name="l01608"></a>01608 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a46c7472f9af9e3f298db8626698ccf85">PNG_INVERT_ALPHA</a>)
<a name="l01609"></a>01609       <a class="code" href="pngrtran_8c.html#ae1ddd94a1c9c31a1ef220a4e035ef521">png_do_read_invert_alpha</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1);
<a name="l01610"></a>01610 <span class="preprocessor">#endif</span>
<a name="l01611"></a>01611 <span class="preprocessor"></span>
<a name="l01612"></a>01612 <span class="preprocessor">#ifdef PNG_READ_SWAP_ALPHA_SUPPORTED</span>
<a name="l01613"></a>01613 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a49f748b58ec272c5017666ad53f709ef">PNG_SWAP_ALPHA</a>)
<a name="l01614"></a>01614       <a class="code" href="pngrtran_8c.html#a9eeb093a9ae877b8f6a800040f1b98d9">png_do_read_swap_alpha</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1);
<a name="l01615"></a>01615 <span class="preprocessor">#endif</span>
<a name="l01616"></a>01616 <span class="preprocessor"></span>
<a name="l01617"></a>01617 <span class="preprocessor">#ifdef PNG_READ_16BIT_SUPPORTED</span>
<a name="l01618"></a>01618 <span class="preprocessor"></span><span class="preprocessor">#ifdef PNG_READ_SWAP_SUPPORTED</span>
<a name="l01619"></a>01619 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#aed70fdb74e7a5e3b83cf5183ef0c6eb2">PNG_SWAP_BYTES</a>)
<a name="l01620"></a>01620       <a class="code" href="pngtrans_8c.html#a99033adb0eeeb092471e92783055df7b">png_do_swap</a>(&amp;(png_ptr-&gt;row_info), png_ptr-&gt;row_buf + 1);
<a name="l01621"></a>01621 <span class="preprocessor">#endif</span>
<a name="l01622"></a>01622 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01623"></a>01623 <span class="preprocessor"></span>
<a name="l01624"></a>01624 <span class="preprocessor">#ifdef PNG_READ_USER_TRANSFORM_SUPPORTED</span>
<a name="l01625"></a>01625 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (png_ptr-&gt;transformations &amp; <a class="code" href="pngpriv_8h.html#a5f3002d2db6845ec190027edb5d67a06">PNG_USER_TRANSFORM</a>)
<a name="l01626"></a>01626     {
<a name="l01627"></a>01627       <span class="keywordflow">if</span> (png_ptr-&gt;read_user_transform_fn != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01628"></a>01628          (*(png_ptr-&gt;read_user_transform_fn)) <span class="comment">/* User read transform function */</span>
<a name="l01629"></a>01629              (png_ptr,                    <span class="comment">/* png_ptr */</span>
<a name="l01630"></a>01630              &amp;(png_ptr-&gt;row_info),     <span class="comment">/* row_info: */</span>
<a name="l01631"></a>01631                 <span class="comment">/*  png_uint_32 width;       width of row */</span>
<a name="l01632"></a>01632                 <span class="comment">/*  png_size_t rowbytes;     number of bytes in row */</span>
<a name="l01633"></a>01633                 <span class="comment">/*  png_byte color_type;     color type of pixels */</span>
<a name="l01634"></a>01634                 <span class="comment">/*  png_byte bit_depth;      bit depth of samples */</span>
<a name="l01635"></a>01635                 <span class="comment">/*  png_byte channels;       number of channels (1-4) */</span>
<a name="l01636"></a>01636                 <span class="comment">/*  png_byte pixel_depth;    bits per pixel (depth*channels) */</span>
<a name="l01637"></a>01637              png_ptr-&gt;row_buf + 1);    <span class="comment">/* start of pixel data for row */</span>
<a name="l01638"></a>01638 <span class="preprocessor">#ifdef PNG_USER_TRANSFORM_PTR_SUPPORTED</span>
<a name="l01639"></a>01639 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (png_ptr-&gt;user_transform_depth)
<a name="l01640"></a>01640          png_ptr-&gt;row_info.bit_depth = png_ptr-&gt;user_transform_depth;
<a name="l01641"></a>01641 
<a name="l01642"></a>01642       <span class="keywordflow">if</span> (png_ptr-&gt;user_transform_channels)
<a name="l01643"></a>01643          png_ptr-&gt;row_info.channels = png_ptr-&gt;user_transform_channels;
<a name="l01644"></a>01644 <span class="preprocessor">#endif</span>
<a name="l01645"></a>01645 <span class="preprocessor"></span>      png_ptr-&gt;row_info.pixel_depth = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(png_ptr-&gt;row_info.bit_depth *
<a name="l01646"></a>01646           png_ptr-&gt;row_info.channels);
<a name="l01647"></a>01647 
<a name="l01648"></a>01648       png_ptr-&gt;row_info.rowbytes = <a class="code" href="pngpriv_8h.html#a18a47644e4b7cd60bb2b4a8c82d53f30">PNG_ROWBYTES</a>(png_ptr-&gt;row_info.pixel_depth,
<a name="l01649"></a>01649           png_ptr-&gt;row_info.width);
<a name="l01650"></a>01650    }
<a name="l01651"></a>01651 <span class="preprocessor">#endif</span>
<a name="l01652"></a>01652 <span class="preprocessor"></span>
<a name="l01653"></a>01653 }
<a name="l01654"></a>01654 
<a name="l01655"></a>01655 <span class="preprocessor">#ifdef PNG_READ_PACK_SUPPORTED</span>
<a name="l01656"></a>01656 <span class="preprocessor"></span><span class="comment">/* Unpack pixels of 1, 2, or 4 bits per pixel into 1 byte per pixel,</span>
<a name="l01657"></a>01657 <span class="comment"> * without changing the actual values.  Thus, if you had a row with</span>
<a name="l01658"></a>01658 <span class="comment"> * a bit depth of 1, you would end up with bytes that only contained</span>
<a name="l01659"></a>01659 <span class="comment"> * the numbers 0 or 1.  If you would rather they contain 0 and 255, use</span>
<a name="l01660"></a>01660 <span class="comment"> * png_do_shift() after this.</span>
<a name="l01661"></a>01661 <span class="comment"> */</span>
<a name="l01662"></a>01662 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l01663"></a><a class="code" href="pngrtran_8c.html#aaf85bde11df668bfd081cf10e778be92">01663</a> <a class="code" href="pngrtran_8c.html#aaf85bde11df668bfd081cf10e778be92">png_do_unpack</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row)
<a name="l01664"></a>01664 {
<a name="l01665"></a>01665    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_unpack&quot;</span>);
<a name="l01666"></a>01666 
<a name="l01667"></a>01667    <span class="keywordflow">if</span> (row_info-&gt;bit_depth &lt; 8)
<a name="l01668"></a>01668    {
<a name="l01669"></a>01669       <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l01670"></a>01670       <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width=row_info-&gt;width;
<a name="l01671"></a>01671 
<a name="l01672"></a>01672       <span class="keywordflow">switch</span> (row_info-&gt;bit_depth)
<a name="l01673"></a>01673       {
<a name="l01674"></a>01674          <span class="keywordflow">case</span> 1:
<a name="l01675"></a>01675          {
<a name="l01676"></a>01676             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)((row_width - 1) &gt;&gt; 3);
<a name="l01677"></a>01677             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l01678"></a>01678             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> shift = 7 - (int)((row_width + 7) &amp; 0x07);
<a name="l01679"></a>01679             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l01680"></a>01680             {
<a name="l01681"></a>01681                *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((*sp &gt;&gt; shift) &amp; 0x01);
<a name="l01682"></a>01682 
<a name="l01683"></a>01683                <span class="keywordflow">if</span> (shift == 7)
<a name="l01684"></a>01684                {
<a name="l01685"></a>01685                   shift = 0;
<a name="l01686"></a>01686                   sp--;
<a name="l01687"></a>01687                }
<a name="l01688"></a>01688 
<a name="l01689"></a>01689                <span class="keywordflow">else</span>
<a name="l01690"></a>01690                   shift++;
<a name="l01691"></a>01691 
<a name="l01692"></a>01692                dp--;
<a name="l01693"></a>01693             }
<a name="l01694"></a>01694             <span class="keywordflow">break</span>;
<a name="l01695"></a>01695          }
<a name="l01696"></a>01696 
<a name="l01697"></a>01697          <span class="keywordflow">case</span> 2:
<a name="l01698"></a>01698          {
<a name="l01699"></a>01699 
<a name="l01700"></a>01700             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)((row_width - 1) &gt;&gt; 2);
<a name="l01701"></a>01701             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l01702"></a>01702             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> shift = (int)((3 - ((row_width + 3) &amp; 0x03)) &lt;&lt; 1);
<a name="l01703"></a>01703             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l01704"></a>01704             {
<a name="l01705"></a>01705                *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((*sp &gt;&gt; shift) &amp; 0x03);
<a name="l01706"></a>01706 
<a name="l01707"></a>01707                <span class="keywordflow">if</span> (shift == 6)
<a name="l01708"></a>01708                {
<a name="l01709"></a>01709                   shift = 0;
<a name="l01710"></a>01710                   sp--;
<a name="l01711"></a>01711                }
<a name="l01712"></a>01712 
<a name="l01713"></a>01713                <span class="keywordflow">else</span>
<a name="l01714"></a>01714                   shift += 2;
<a name="l01715"></a>01715 
<a name="l01716"></a>01716                dp--;
<a name="l01717"></a>01717             }
<a name="l01718"></a>01718             <span class="keywordflow">break</span>;
<a name="l01719"></a>01719          }
<a name="l01720"></a>01720 
<a name="l01721"></a>01721          <span class="keywordflow">case</span> 4:
<a name="l01722"></a>01722          {
<a name="l01723"></a>01723             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)((row_width - 1) &gt;&gt; 1);
<a name="l01724"></a>01724             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l01725"></a>01725             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> shift = (int)((1 - ((row_width + 1) &amp; 0x01)) &lt;&lt; 2);
<a name="l01726"></a>01726             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l01727"></a>01727             {
<a name="l01728"></a>01728                *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((*sp &gt;&gt; shift) &amp; 0x0f);
<a name="l01729"></a>01729 
<a name="l01730"></a>01730                <span class="keywordflow">if</span> (shift == 4)
<a name="l01731"></a>01731                {
<a name="l01732"></a>01732                   shift = 0;
<a name="l01733"></a>01733                   sp--;
<a name="l01734"></a>01734                }
<a name="l01735"></a>01735 
<a name="l01736"></a>01736                <span class="keywordflow">else</span>
<a name="l01737"></a>01737                   shift = 4;
<a name="l01738"></a>01738 
<a name="l01739"></a>01739                dp--;
<a name="l01740"></a>01740             }
<a name="l01741"></a>01741             <span class="keywordflow">break</span>;
<a name="l01742"></a>01742          }
<a name="l01743"></a>01743 
<a name="l01744"></a>01744          <span class="keywordflow">default</span>:
<a name="l01745"></a>01745             <span class="keywordflow">break</span>;
<a name="l01746"></a>01746       }
<a name="l01747"></a>01747       row_info-&gt;bit_depth = 8;
<a name="l01748"></a>01748       row_info-&gt;pixel_depth = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(8 * row_info-&gt;channels);
<a name="l01749"></a>01749       row_info-&gt;rowbytes = row_width * row_info-&gt;channels;
<a name="l01750"></a>01750    }
<a name="l01751"></a>01751 }
<a name="l01752"></a>01752 <span class="preprocessor">#endif</span>
<a name="l01753"></a>01753 <span class="preprocessor"></span>
<a name="l01754"></a>01754 <span class="preprocessor">#ifdef PNG_READ_SHIFT_SUPPORTED</span>
<a name="l01755"></a>01755 <span class="preprocessor"></span><span class="comment">/* Reverse the effects of png_do_shift.  This routine merely shifts the</span>
<a name="l01756"></a>01756 <span class="comment"> * pixels back to their significant bits values.  Thus, if you have</span>
<a name="l01757"></a>01757 <span class="comment"> * a row of bit depth 8, but only 5 are significant, this will shift</span>
<a name="l01758"></a>01758 <span class="comment"> * the values back to 0 through 31.</span>
<a name="l01759"></a>01759 <span class="comment"> */</span>
<a name="l01760"></a>01760 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l01761"></a><a class="code" href="pngrtran_8c.html#a4fe8882f8fd5f1e025362c5f8ef3ea65">01761</a> <a class="code" href="pngrtran_8c.html#a4fe8882f8fd5f1e025362c5f8ef3ea65">png_do_unshift</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row,
<a name="l01762"></a>01762     <a class="code" href="png_8h.html#a75a8334a14be13a004d33161becd6eee">png_const_color_8p</a> sig_bits)
<a name="l01763"></a>01763 {
<a name="l01764"></a>01764    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_unshift&quot;</span>);
<a name="l01765"></a>01765 
<a name="l01766"></a>01766    <span class="keywordflow">if</span> (
<a name="l01767"></a>01767        row_info-&gt;color_type != <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>)
<a name="l01768"></a>01768    {
<a name="l01769"></a>01769       <span class="keywordtype">int</span> shift[4];
<a name="l01770"></a>01770       <span class="keywordtype">int</span> channels = 0;
<a name="l01771"></a>01771       <span class="keywordtype">int</span> c;
<a name="l01772"></a>01772       <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> value = 0;
<a name="l01773"></a>01773       <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width = row_info-&gt;width;
<a name="l01774"></a>01774 
<a name="l01775"></a>01775       <span class="keywordflow">if</span> (row_info-&gt;color_type &amp; <a class="code" href="png_8h.html#a87bc785c34abddf3bb9ff206d721964b">PNG_COLOR_MASK_COLOR</a>)
<a name="l01776"></a>01776       {
<a name="l01777"></a>01777          shift[channels++] = row_info-&gt;bit_depth - sig_bits-&gt;red;
<a name="l01778"></a>01778          shift[channels++] = row_info-&gt;bit_depth - sig_bits-&gt;green;
<a name="l01779"></a>01779          shift[channels++] = row_info-&gt;bit_depth - sig_bits-&gt;blue;
<a name="l01780"></a>01780       }
<a name="l01781"></a>01781 
<a name="l01782"></a>01782       <span class="keywordflow">else</span>
<a name="l01783"></a>01783       {
<a name="l01784"></a>01784          shift[channels++] = row_info-&gt;bit_depth - sig_bits-&gt;gray;
<a name="l01785"></a>01785       }
<a name="l01786"></a>01786 
<a name="l01787"></a>01787       <span class="keywordflow">if</span> (row_info-&gt;color_type &amp; <a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>)
<a name="l01788"></a>01788       {
<a name="l01789"></a>01789          shift[channels++] = row_info-&gt;bit_depth - sig_bits-&gt;alpha;
<a name="l01790"></a>01790       }
<a name="l01791"></a>01791 
<a name="l01792"></a>01792       <span class="keywordflow">for</span> (c = 0; c &lt; channels; c++)
<a name="l01793"></a>01793       {
<a name="l01794"></a>01794          <span class="keywordflow">if</span> (shift[c] &lt;= 0)
<a name="l01795"></a>01795             shift[c] = 0;
<a name="l01796"></a>01796 
<a name="l01797"></a>01797          <span class="keywordflow">else</span>
<a name="l01798"></a>01798             value = 1;
<a name="l01799"></a>01799       }
<a name="l01800"></a>01800 
<a name="l01801"></a>01801       <span class="keywordflow">if</span> (!value)
<a name="l01802"></a>01802          <span class="keywordflow">return</span>;
<a name="l01803"></a>01803 
<a name="l01804"></a>01804       <span class="keywordflow">switch</span> (row_info-&gt;bit_depth)
<a name="l01805"></a>01805       {
<a name="l01806"></a>01806          <span class="keywordflow">default</span>:
<a name="l01807"></a>01807             <span class="keywordflow">break</span>; 
<a name="l01808"></a>01808 
<a name="l01809"></a>01809          <span class="keywordflow">case</span> 2:
<a name="l01810"></a>01810          {
<a name="l01811"></a>01811             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> bp;
<a name="l01812"></a>01812             <a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a> i;
<a name="l01813"></a>01813             <a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a> istop = row_info-&gt;rowbytes;
<a name="l01814"></a>01814 
<a name="l01815"></a>01815             <span class="keywordflow">for</span> (bp = row, i = 0; i &lt; istop; i++)
<a name="l01816"></a>01816             {
<a name="l01817"></a>01817                *bp &gt;&gt;= 1;
<a name="l01818"></a>01818                *bp++ &amp;= 0x55;
<a name="l01819"></a>01819             }
<a name="l01820"></a>01820             <span class="keywordflow">break</span>;
<a name="l01821"></a>01821          }
<a name="l01822"></a>01822 
<a name="l01823"></a>01823          <span class="keywordflow">case</span> 4:
<a name="l01824"></a>01824          {
<a name="l01825"></a>01825             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> bp = row;
<a name="l01826"></a>01826             <a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a> i;
<a name="l01827"></a>01827             <a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a> istop = row_info-&gt;rowbytes;
<a name="l01828"></a>01828             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> mask = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((((<span class="keywordtype">int</span>)0xf0 &gt;&gt; shift[0]) &amp; (<span class="keywordtype">int</span>)0xf0) |
<a name="l01829"></a>01829                 (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((<span class="keywordtype">int</span>)0xf &gt;&gt; shift[0]));
<a name="l01830"></a>01830 
<a name="l01831"></a>01831             <span class="keywordflow">for</span> (i = 0; i &lt; istop; i++)
<a name="l01832"></a>01832             {
<a name="l01833"></a>01833                *bp &gt;&gt;= shift[0];
<a name="l01834"></a>01834                *bp++ &amp;= mask;
<a name="l01835"></a>01835             }
<a name="l01836"></a>01836             <span class="keywordflow">break</span>;
<a name="l01837"></a>01837          }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839          <span class="keywordflow">case</span> 8:
<a name="l01840"></a>01840          {
<a name="l01841"></a>01841             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> bp = row;
<a name="l01842"></a>01842             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l01843"></a>01843             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> istop = row_width * channels;
<a name="l01844"></a>01844 
<a name="l01845"></a>01845             <span class="keywordflow">for</span> (i = 0; i &lt; istop; i++)
<a name="l01846"></a>01846             {
<a name="l01847"></a>01847                *bp++ &gt;&gt;= shift[i%channels];
<a name="l01848"></a>01848             }
<a name="l01849"></a>01849             <span class="keywordflow">break</span>;
<a name="l01850"></a>01850          }
<a name="l01851"></a>01851 
<a name="l01852"></a>01852 <span class="preprocessor">#ifdef PNG_READ_16BIT_SUPPORTED</span>
<a name="l01853"></a>01853 <span class="preprocessor"></span>         <span class="keywordflow">case</span> 16:
<a name="l01854"></a>01854          {
<a name="l01855"></a>01855             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> bp = row;
<a name="l01856"></a>01856             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l01857"></a>01857             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> istop = channels * row_width;
<a name="l01858"></a>01858 
<a name="l01859"></a>01859             <span class="keywordflow">for</span> (i = 0; i &lt; istop; i++)
<a name="l01860"></a>01860             {
<a name="l01861"></a>01861                value = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((*bp &lt;&lt; 8) + *(bp + 1));
<a name="l01862"></a>01862                value &gt;&gt;= shift[i%channels];
<a name="l01863"></a>01863                *bp++ = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(value &gt;&gt; 8);
<a name="l01864"></a>01864                *bp++ = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(value &amp; 0xff);
<a name="l01865"></a>01865             }
<a name="l01866"></a>01866             <span class="keywordflow">break</span>;
<a name="l01867"></a>01867          }
<a name="l01868"></a>01868 <span class="preprocessor">#endif</span>
<a name="l01869"></a>01869 <span class="preprocessor"></span>      }
<a name="l01870"></a>01870    }
<a name="l01871"></a>01871 }
<a name="l01872"></a>01872 <span class="preprocessor">#endif</span>
<a name="l01873"></a>01873 <span class="preprocessor"></span>
<a name="l01874"></a>01874 <span class="preprocessor">#ifdef PNG_READ_16_TO_8_SUPPORTED</span>
<a name="l01875"></a>01875 <span class="preprocessor"></span><span class="comment">/* Chop rows of bit depth 16 down to 8 */</span>
<a name="l01876"></a>01876 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l01877"></a><a class="code" href="pngrtran_8c.html#af86d9a98a29156d9bbd8bda190a65f7e">01877</a> <a class="code" href="pngrtran_8c.html#af86d9a98a29156d9bbd8bda190a65f7e">png_do_chop</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row)
<a name="l01878"></a>01878 {
<a name="l01879"></a>01879    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_chop&quot;</span>);
<a name="l01880"></a>01880 
<a name="l01881"></a>01881    <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 16)
<a name="l01882"></a>01882    {
<a name="l01883"></a>01883       <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row;
<a name="l01884"></a>01884       <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row;
<a name="l01885"></a>01885       <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l01886"></a>01886       <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> istop = row_info-&gt;width * row_info-&gt;channels;
<a name="l01887"></a>01887 
<a name="l01888"></a>01888       <span class="keywordflow">for</span> (i = 0; i&lt;istop; i++, sp += 2, dp++)
<a name="l01889"></a>01889       {
<a name="l01890"></a>01890 <span class="preprocessor">#ifdef PNG_READ_16_TO_8_ACCURATE_SCALE_SUPPORTED</span>
<a name="l01891"></a>01891 <span class="preprocessor"></span>      <span class="comment">/* This does a more accurate scaling of the 16-bit color</span>
<a name="l01892"></a>01892 <span class="comment">       * value, rather than a simple low-byte truncation.</span>
<a name="l01893"></a>01893 <span class="comment">       *</span>
<a name="l01894"></a>01894 <span class="comment">       * What the ideal calculation should be:</span>
<a name="l01895"></a>01895 <span class="comment">       *   *dp = (((((png_uint_32)(*sp) &lt;&lt; 8) |</span>
<a name="l01896"></a>01896 <span class="comment">       *          (png_uint_32)(*(sp + 1))) * 255 + 127)</span>
<a name="l01897"></a>01897 <span class="comment">       *          / (png_uint_32)65535L;</span>
<a name="l01898"></a>01898 <span class="comment">       *</span>
<a name="l01899"></a>01899 <span class="comment">       * GRR: no, I think this is what it really should be:</span>
<a name="l01900"></a>01900 <span class="comment">       *   *dp = (((((png_uint_32)(*sp) &lt;&lt; 8) |</span>
<a name="l01901"></a>01901 <span class="comment">       *           (png_uint_32)(*(sp + 1))) + 128L)</span>
<a name="l01902"></a>01902 <span class="comment">       *           / (png_uint_32)257L;</span>
<a name="l01903"></a>01903 <span class="comment">       *</span>
<a name="l01904"></a>01904 <span class="comment">       * GRR: here&#39;s the exact calculation with shifts:</span>
<a name="l01905"></a>01905 <span class="comment">       *   temp = (((png_uint_32)(*sp) &lt;&lt; 8) |</span>
<a name="l01906"></a>01906 <span class="comment">       *           (png_uint_32)(*(sp + 1))) + 128L;</span>
<a name="l01907"></a>01907 <span class="comment">       *   *dp = (temp - (temp &gt;&gt; 8)) &gt;&gt; 8;</span>
<a name="l01908"></a>01908 <span class="comment">       *</span>
<a name="l01909"></a>01909 <span class="comment">       * Approximate calculation with shift/add instead of multiply/divide:</span>
<a name="l01910"></a>01910 <span class="comment">       *   *dp = ((((png_uint_32)(*sp) &lt;&lt; 8) |</span>
<a name="l01911"></a>01911 <span class="comment">       *          (png_uint_32)((int)(*(sp + 1)) - *sp)) + 128) &gt;&gt; 8;</span>
<a name="l01912"></a>01912 <span class="comment">       *</span>
<a name="l01913"></a>01913 <span class="comment">       * What we actually do to avoid extra shifting and conversion:</span>
<a name="l01914"></a>01914 <span class="comment">       */</span>
<a name="l01915"></a>01915 
<a name="l01916"></a>01916          *dp = *sp + ((((int)(*(sp + 1)) - *sp) &gt; 128) ? 1 : 0);
<a name="l01917"></a>01917 <span class="preprocessor">#else</span>
<a name="l01918"></a>01918 <span class="preprocessor"></span>       <span class="comment">/* Simply discard the low order byte */</span>
<a name="l01919"></a>01919          *dp = *sp;
<a name="l01920"></a>01920 <span class="preprocessor">#endif</span>
<a name="l01921"></a>01921 <span class="preprocessor"></span>      }
<a name="l01922"></a>01922       row_info-&gt;bit_depth = 8;
<a name="l01923"></a>01923       row_info-&gt;pixel_depth = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(8 * row_info-&gt;channels);
<a name="l01924"></a>01924       row_info-&gt;rowbytes = row_info-&gt;width * row_info-&gt;channels;
<a name="l01925"></a>01925    }
<a name="l01926"></a>01926 }
<a name="l01927"></a>01927 <span class="preprocessor">#endif</span>
<a name="l01928"></a>01928 <span class="preprocessor"></span>
<a name="l01929"></a>01929 <span class="preprocessor">#ifdef PNG_READ_SWAP_ALPHA_SUPPORTED</span>
<a name="l01930"></a>01930 <span class="preprocessor"></span><span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l01931"></a><a class="code" href="pngrtran_8c.html#a9eeb093a9ae877b8f6a800040f1b98d9">01931</a> <a class="code" href="pngrtran_8c.html#a9eeb093a9ae877b8f6a800040f1b98d9">png_do_read_swap_alpha</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row)
<a name="l01932"></a>01932 {
<a name="l01933"></a>01933    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_read_swap_alpha&quot;</span>);
<a name="l01934"></a>01934 
<a name="l01935"></a>01935    {
<a name="l01936"></a>01936       <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width = row_info-&gt;width;
<a name="l01937"></a>01937       <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a>)
<a name="l01938"></a>01938       {
<a name="l01939"></a>01939          <span class="comment">/* This converts from RGBA to ARGB */</span>
<a name="l01940"></a>01940          <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l01941"></a>01941          {
<a name="l01942"></a>01942             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + row_info-&gt;rowbytes;
<a name="l01943"></a>01943             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp;
<a name="l01944"></a>01944             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> save;
<a name="l01945"></a>01945             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l01946"></a>01946 
<a name="l01947"></a>01947             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l01948"></a>01948             {
<a name="l01949"></a>01949                save = *(--sp);
<a name="l01950"></a>01950                *(--dp) = *(--sp);
<a name="l01951"></a>01951                *(--dp) = *(--sp);
<a name="l01952"></a>01952                *(--dp) = *(--sp);
<a name="l01953"></a>01953                *(--dp) = save;
<a name="l01954"></a>01954             }
<a name="l01955"></a>01955          }
<a name="l01956"></a>01956 
<a name="l01957"></a>01957 <span class="preprocessor">#ifdef PNG_READ_16BIT_SUPPORTED</span>
<a name="l01958"></a>01958 <span class="preprocessor"></span>         <span class="comment">/* This converts from RRGGBBAA to AARRGGBB */</span>
<a name="l01959"></a>01959          <span class="keywordflow">else</span>
<a name="l01960"></a>01960          {
<a name="l01961"></a>01961             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + row_info-&gt;rowbytes;
<a name="l01962"></a>01962             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp;
<a name="l01963"></a>01963             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> save[2];
<a name="l01964"></a>01964             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l01965"></a>01965 
<a name="l01966"></a>01966             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l01967"></a>01967             {
<a name="l01968"></a>01968                save[0] = *(--sp);
<a name="l01969"></a>01969                save[1] = *(--sp);
<a name="l01970"></a>01970                *(--dp) = *(--sp);
<a name="l01971"></a>01971                *(--dp) = *(--sp);
<a name="l01972"></a>01972                *(--dp) = *(--sp);
<a name="l01973"></a>01973                *(--dp) = *(--sp);
<a name="l01974"></a>01974                *(--dp) = *(--sp);
<a name="l01975"></a>01975                *(--dp) = *(--sp);
<a name="l01976"></a>01976                *(--dp) = save[0];
<a name="l01977"></a>01977                *(--dp) = save[1];
<a name="l01978"></a>01978             }
<a name="l01979"></a>01979          }
<a name="l01980"></a>01980 <span class="preprocessor">#endif</span>
<a name="l01981"></a>01981 <span class="preprocessor"></span>      }
<a name="l01982"></a>01982 
<a name="l01983"></a>01983       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a6f7f3931c163838e2bc3132de2cd4391">PNG_COLOR_TYPE_GRAY_ALPHA</a>)
<a name="l01984"></a>01984       {
<a name="l01985"></a>01985          <span class="comment">/* This converts from GA to AG */</span>
<a name="l01986"></a>01986          <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l01987"></a>01987          {
<a name="l01988"></a>01988             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + row_info-&gt;rowbytes;
<a name="l01989"></a>01989             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp;
<a name="l01990"></a>01990             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> save;
<a name="l01991"></a>01991             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l01992"></a>01992 
<a name="l01993"></a>01993             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l01994"></a>01994             {
<a name="l01995"></a>01995                save = *(--sp);
<a name="l01996"></a>01996                *(--dp) = *(--sp);
<a name="l01997"></a>01997                *(--dp) = save;
<a name="l01998"></a>01998             }
<a name="l01999"></a>01999          }
<a name="l02000"></a>02000 
<a name="l02001"></a>02001 <span class="preprocessor">#ifdef PNG_READ_16BIT_SUPPORTED</span>
<a name="l02002"></a>02002 <span class="preprocessor"></span>         <span class="comment">/* This converts from GGAA to AAGG */</span>
<a name="l02003"></a>02003          <span class="keywordflow">else</span>
<a name="l02004"></a>02004          {
<a name="l02005"></a>02005             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + row_info-&gt;rowbytes;
<a name="l02006"></a>02006             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp;
<a name="l02007"></a>02007             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> save[2];
<a name="l02008"></a>02008             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l02009"></a>02009 
<a name="l02010"></a>02010             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02011"></a>02011             {
<a name="l02012"></a>02012                save[0] = *(--sp);
<a name="l02013"></a>02013                save[1] = *(--sp);
<a name="l02014"></a>02014                *(--dp) = *(--sp);
<a name="l02015"></a>02015                *(--dp) = *(--sp);
<a name="l02016"></a>02016                *(--dp) = save[0];
<a name="l02017"></a>02017                *(--dp) = save[1];
<a name="l02018"></a>02018             }
<a name="l02019"></a>02019          }
<a name="l02020"></a>02020 <span class="preprocessor">#endif</span>
<a name="l02021"></a>02021 <span class="preprocessor"></span>      }
<a name="l02022"></a>02022    }
<a name="l02023"></a>02023 }
<a name="l02024"></a>02024 <span class="preprocessor">#endif</span>
<a name="l02025"></a>02025 <span class="preprocessor"></span>
<a name="l02026"></a>02026 <span class="preprocessor">#ifdef PNG_READ_INVERT_ALPHA_SUPPORTED</span>
<a name="l02027"></a>02027 <span class="preprocessor"></span><span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l02028"></a><a class="code" href="pngrtran_8c.html#ae1ddd94a1c9c31a1ef220a4e035ef521">02028</a> <a class="code" href="pngrtran_8c.html#ae1ddd94a1c9c31a1ef220a4e035ef521">png_do_read_invert_alpha</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row)
<a name="l02029"></a>02029 {
<a name="l02030"></a>02030    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width;
<a name="l02031"></a>02031    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_read_invert_alpha&quot;</span>);
<a name="l02032"></a>02032 
<a name="l02033"></a>02033    row_width = row_info-&gt;width;
<a name="l02034"></a>02034    <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a>)
<a name="l02035"></a>02035    {
<a name="l02036"></a>02036       <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l02037"></a>02037       {
<a name="l02038"></a>02038          <span class="comment">/* This inverts the alpha channel in RGBA */</span>
<a name="l02039"></a>02039          <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + row_info-&gt;rowbytes;
<a name="l02040"></a>02040          <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp;
<a name="l02041"></a>02041          <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l02042"></a>02042 
<a name="l02043"></a>02043          <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02044"></a>02044          {
<a name="l02045"></a>02045             *(--dp) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(255 - *(--sp));
<a name="l02046"></a>02046 
<a name="l02047"></a>02047 <span class="comment">/*          This does nothing:</span>
<a name="l02048"></a>02048 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02049"></a>02049 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02050"></a>02050 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02051"></a>02051 <span class="comment">            We can replace it with:</span>
<a name="l02052"></a>02052 <span class="comment">*/</span>
<a name="l02053"></a>02053             sp-=3;
<a name="l02054"></a>02054             dp=sp;
<a name="l02055"></a>02055          }
<a name="l02056"></a>02056       }
<a name="l02057"></a>02057 
<a name="l02058"></a>02058 <span class="preprocessor">#ifdef PNG_READ_16BIT_SUPPORTED</span>
<a name="l02059"></a>02059 <span class="preprocessor"></span>      <span class="comment">/* This inverts the alpha channel in RRGGBBAA */</span>
<a name="l02060"></a>02060       <span class="keywordflow">else</span>
<a name="l02061"></a>02061       {
<a name="l02062"></a>02062          <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + row_info-&gt;rowbytes;
<a name="l02063"></a>02063          <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp;
<a name="l02064"></a>02064          <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l02065"></a>02065 
<a name="l02066"></a>02066          <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02067"></a>02067          {
<a name="l02068"></a>02068             *(--dp) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(255 - *(--sp));
<a name="l02069"></a>02069             *(--dp) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(255 - *(--sp));
<a name="l02070"></a>02070 
<a name="l02071"></a>02071 <span class="comment">/*          This does nothing:</span>
<a name="l02072"></a>02072 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02073"></a>02073 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02074"></a>02074 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02075"></a>02075 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02076"></a>02076 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02077"></a>02077 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02078"></a>02078 <span class="comment">            We can replace it with:</span>
<a name="l02079"></a>02079 <span class="comment">*/</span>
<a name="l02080"></a>02080             sp-=6;
<a name="l02081"></a>02081             dp=sp;
<a name="l02082"></a>02082          }
<a name="l02083"></a>02083       }
<a name="l02084"></a>02084 <span class="preprocessor">#endif</span>
<a name="l02085"></a>02085 <span class="preprocessor"></span>   }
<a name="l02086"></a>02086    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a6f7f3931c163838e2bc3132de2cd4391">PNG_COLOR_TYPE_GRAY_ALPHA</a>)
<a name="l02087"></a>02087    {
<a name="l02088"></a>02088       <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l02089"></a>02089       {
<a name="l02090"></a>02090          <span class="comment">/* This inverts the alpha channel in GA */</span>
<a name="l02091"></a>02091          <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + row_info-&gt;rowbytes;
<a name="l02092"></a>02092          <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp;
<a name="l02093"></a>02093          <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l02094"></a>02094 
<a name="l02095"></a>02095          <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02096"></a>02096          {
<a name="l02097"></a>02097             *(--dp) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(255 - *(--sp));
<a name="l02098"></a>02098             *(--dp) = *(--sp);
<a name="l02099"></a>02099          }
<a name="l02100"></a>02100       }
<a name="l02101"></a>02101 
<a name="l02102"></a>02102 <span class="preprocessor">#ifdef PNG_READ_16BIT_SUPPORTED</span>
<a name="l02103"></a>02103 <span class="preprocessor"></span>      <span class="keywordflow">else</span>
<a name="l02104"></a>02104       {
<a name="l02105"></a>02105          <span class="comment">/* This inverts the alpha channel in GGAA */</span>
<a name="l02106"></a>02106          <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp  = row + row_info-&gt;rowbytes;
<a name="l02107"></a>02107          <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp;
<a name="l02108"></a>02108          <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l02109"></a>02109 
<a name="l02110"></a>02110          <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02111"></a>02111          {
<a name="l02112"></a>02112             *(--dp) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(255 - *(--sp));
<a name="l02113"></a>02113             *(--dp) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(255 - *(--sp));
<a name="l02114"></a>02114 <span class="comment">/*</span>
<a name="l02115"></a>02115 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02116"></a>02116 <span class="comment">            *(--dp) = *(--sp);</span>
<a name="l02117"></a>02117 <span class="comment">*/</span>
<a name="l02118"></a>02118             sp-=2;
<a name="l02119"></a>02119             dp=sp;
<a name="l02120"></a>02120          }
<a name="l02121"></a>02121       }
<a name="l02122"></a>02122 <span class="preprocessor">#endif</span>
<a name="l02123"></a>02123 <span class="preprocessor"></span>   }
<a name="l02124"></a>02124 }
<a name="l02125"></a>02125 <span class="preprocessor">#endif</span>
<a name="l02126"></a>02126 <span class="preprocessor"></span>
<a name="l02127"></a>02127 <span class="preprocessor">#ifdef PNG_READ_FILLER_SUPPORTED</span>
<a name="l02128"></a>02128 <span class="preprocessor"></span><span class="comment">/* Add filler channel if we have RGB color */</span>
<a name="l02129"></a>02129 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l02130"></a><a class="code" href="pngrtran_8c.html#ac7c6c2d10e6f9e5e446164580a870203">02130</a> <a class="code" href="pngrtran_8c.html#ac7c6c2d10e6f9e5e446164580a870203">png_do_read_filler</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row,
<a name="l02131"></a>02131     <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> filler, <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> flags)
<a name="l02132"></a>02132 {
<a name="l02133"></a>02133    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l02134"></a>02134    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width = row_info-&gt;width;
<a name="l02135"></a>02135 
<a name="l02136"></a>02136 <span class="preprocessor">#ifdef PNG_READ_16BIT_SUPPORTED</span>
<a name="l02137"></a>02137 <span class="preprocessor"></span>   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> hi_filler = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((filler&gt;&gt;8) &amp; 0xff);
<a name="l02138"></a>02138 <span class="preprocessor">#endif</span>
<a name="l02139"></a>02139 <span class="preprocessor"></span>   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> lo_filler = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(filler &amp; 0xff);
<a name="l02140"></a>02140 
<a name="l02141"></a>02141    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_read_filler&quot;</span>);
<a name="l02142"></a>02142 
<a name="l02143"></a>02143    <span class="keywordflow">if</span> (
<a name="l02144"></a>02144        row_info-&gt;color_type == <a class="code" href="png_8h.html#ac679619ad9d3f2c46c2b69fe65bd19f1">PNG_COLOR_TYPE_GRAY</a>)
<a name="l02145"></a>02145    {
<a name="l02146"></a>02146       <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l02147"></a>02147       {
<a name="l02148"></a>02148          <span class="keywordflow">if</span> (flags &amp; <a class="code" href="pngpriv_8h.html#aa371ad6e23186d80cd83a33cf5eeb20c">PNG_FLAG_FILLER_AFTER</a>)
<a name="l02149"></a>02149          {
<a name="l02150"></a>02150             <span class="comment">/* This changes the data from G to GX */</span>
<a name="l02151"></a>02151             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width;
<a name="l02152"></a>02152             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp =  sp + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width;
<a name="l02153"></a>02153             <span class="keywordflow">for</span> (i = 1; i &lt; row_width; i++)
<a name="l02154"></a>02154             {
<a name="l02155"></a>02155                *(--dp) = lo_filler;
<a name="l02156"></a>02156                *(--dp) = *(--sp);
<a name="l02157"></a>02157             }
<a name="l02158"></a>02158             *(--dp) = lo_filler;
<a name="l02159"></a>02159             row_info-&gt;channels = 2;
<a name="l02160"></a>02160             row_info-&gt;pixel_depth = 16;
<a name="l02161"></a>02161             row_info-&gt;rowbytes = row_width * 2;
<a name="l02162"></a>02162          }
<a name="l02163"></a>02163 
<a name="l02164"></a>02164          <span class="keywordflow">else</span>
<a name="l02165"></a>02165          {
<a name="l02166"></a>02166             <span class="comment">/* This changes the data from G to XG */</span>
<a name="l02167"></a>02167             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width;
<a name="l02168"></a>02168             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp  + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width;
<a name="l02169"></a>02169             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02170"></a>02170             {
<a name="l02171"></a>02171                *(--dp) = *(--sp);
<a name="l02172"></a>02172                *(--dp) = lo_filler;
<a name="l02173"></a>02173             }
<a name="l02174"></a>02174             row_info-&gt;channels = 2;
<a name="l02175"></a>02175             row_info-&gt;pixel_depth = 16;
<a name="l02176"></a>02176             row_info-&gt;rowbytes = row_width * 2;
<a name="l02177"></a>02177          }
<a name="l02178"></a>02178       }
<a name="l02179"></a>02179 
<a name="l02180"></a>02180 <span class="preprocessor">#ifdef PNG_READ_16BIT_SUPPORTED</span>
<a name="l02181"></a>02181 <span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 16)
<a name="l02182"></a>02182       {
<a name="l02183"></a>02183          <span class="keywordflow">if</span> (flags &amp; <a class="code" href="pngpriv_8h.html#aa371ad6e23186d80cd83a33cf5eeb20c">PNG_FLAG_FILLER_AFTER</a>)
<a name="l02184"></a>02184          {
<a name="l02185"></a>02185             <span class="comment">/* This changes the data from GG to GGXX */</span>
<a name="l02186"></a>02186             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 2;
<a name="l02187"></a>02187             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp  + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 2;
<a name="l02188"></a>02188             <span class="keywordflow">for</span> (i = 1; i &lt; row_width; i++)
<a name="l02189"></a>02189             {
<a name="l02190"></a>02190                *(--dp) = hi_filler;
<a name="l02191"></a>02191                *(--dp) = lo_filler;
<a name="l02192"></a>02192                *(--dp) = *(--sp);
<a name="l02193"></a>02193                *(--dp) = *(--sp);
<a name="l02194"></a>02194             }
<a name="l02195"></a>02195             *(--dp) = hi_filler;
<a name="l02196"></a>02196             *(--dp) = lo_filler;
<a name="l02197"></a>02197             row_info-&gt;channels = 2;
<a name="l02198"></a>02198             row_info-&gt;pixel_depth = 32;
<a name="l02199"></a>02199             row_info-&gt;rowbytes = row_width * 4;
<a name="l02200"></a>02200          }
<a name="l02201"></a>02201 
<a name="l02202"></a>02202          <span class="keywordflow">else</span>
<a name="l02203"></a>02203          {
<a name="l02204"></a>02204             <span class="comment">/* This changes the data from GG to XXGG */</span>
<a name="l02205"></a>02205             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 2;
<a name="l02206"></a>02206             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp  + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 2;
<a name="l02207"></a>02207             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02208"></a>02208             {
<a name="l02209"></a>02209                *(--dp) = *(--sp);
<a name="l02210"></a>02210                *(--dp) = *(--sp);
<a name="l02211"></a>02211                *(--dp) = hi_filler;
<a name="l02212"></a>02212                *(--dp) = lo_filler;
<a name="l02213"></a>02213             }
<a name="l02214"></a>02214             row_info-&gt;channels = 2;
<a name="l02215"></a>02215             row_info-&gt;pixel_depth = 32;
<a name="l02216"></a>02216             row_info-&gt;rowbytes = row_width * 4;
<a name="l02217"></a>02217          }
<a name="l02218"></a>02218       }
<a name="l02219"></a>02219 <span class="preprocessor">#endif</span>
<a name="l02220"></a>02220 <span class="preprocessor"></span>   } <span class="comment">/* COLOR_TYPE == GRAY */</span>
<a name="l02221"></a>02221    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a>)
<a name="l02222"></a>02222    {
<a name="l02223"></a>02223       <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l02224"></a>02224       {
<a name="l02225"></a>02225          <span class="keywordflow">if</span> (flags &amp; <a class="code" href="pngpriv_8h.html#aa371ad6e23186d80cd83a33cf5eeb20c">PNG_FLAG_FILLER_AFTER</a>)
<a name="l02226"></a>02226          {
<a name="l02227"></a>02227             <span class="comment">/* This changes the data from RGB to RGBX */</span>
<a name="l02228"></a>02228             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 3;
<a name="l02229"></a>02229             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp  + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width;
<a name="l02230"></a>02230             <span class="keywordflow">for</span> (i = 1; i &lt; row_width; i++)
<a name="l02231"></a>02231             {
<a name="l02232"></a>02232                *(--dp) = lo_filler;
<a name="l02233"></a>02233                *(--dp) = *(--sp);
<a name="l02234"></a>02234                *(--dp) = *(--sp);
<a name="l02235"></a>02235                *(--dp) = *(--sp);
<a name="l02236"></a>02236             }
<a name="l02237"></a>02237             *(--dp) = lo_filler;
<a name="l02238"></a>02238             row_info-&gt;channels = 4;
<a name="l02239"></a>02239             row_info-&gt;pixel_depth = 32;
<a name="l02240"></a>02240             row_info-&gt;rowbytes = row_width * 4;
<a name="l02241"></a>02241          }
<a name="l02242"></a>02242 
<a name="l02243"></a>02243          <span class="keywordflow">else</span>
<a name="l02244"></a>02244          {
<a name="l02245"></a>02245             <span class="comment">/* This changes the data from RGB to XRGB */</span>
<a name="l02246"></a>02246             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 3;
<a name="l02247"></a>02247             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width;
<a name="l02248"></a>02248             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02249"></a>02249             {
<a name="l02250"></a>02250                *(--dp) = *(--sp);
<a name="l02251"></a>02251                *(--dp) = *(--sp);
<a name="l02252"></a>02252                *(--dp) = *(--sp);
<a name="l02253"></a>02253                *(--dp) = lo_filler;
<a name="l02254"></a>02254             }
<a name="l02255"></a>02255             row_info-&gt;channels = 4;
<a name="l02256"></a>02256             row_info-&gt;pixel_depth = 32;
<a name="l02257"></a>02257             row_info-&gt;rowbytes = row_width * 4;
<a name="l02258"></a>02258          }
<a name="l02259"></a>02259       }
<a name="l02260"></a>02260 
<a name="l02261"></a>02261 <span class="preprocessor">#ifdef PNG_READ_16BIT_SUPPORTED</span>
<a name="l02262"></a>02262 <span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 16)
<a name="l02263"></a>02263       {
<a name="l02264"></a>02264          <span class="keywordflow">if</span> (flags &amp; <a class="code" href="pngpriv_8h.html#aa371ad6e23186d80cd83a33cf5eeb20c">PNG_FLAG_FILLER_AFTER</a>)
<a name="l02265"></a>02265          {
<a name="l02266"></a>02266             <span class="comment">/* This changes the data from RRGGBB to RRGGBBXX */</span>
<a name="l02267"></a>02267             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 6;
<a name="l02268"></a>02268             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp  + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 2;
<a name="l02269"></a>02269             <span class="keywordflow">for</span> (i = 1; i &lt; row_width; i++)
<a name="l02270"></a>02270             {
<a name="l02271"></a>02271                *(--dp) = hi_filler;
<a name="l02272"></a>02272                *(--dp) = lo_filler;
<a name="l02273"></a>02273                *(--dp) = *(--sp);
<a name="l02274"></a>02274                *(--dp) = *(--sp);
<a name="l02275"></a>02275                *(--dp) = *(--sp);
<a name="l02276"></a>02276                *(--dp) = *(--sp);
<a name="l02277"></a>02277                *(--dp) = *(--sp);
<a name="l02278"></a>02278                *(--dp) = *(--sp);
<a name="l02279"></a>02279             }
<a name="l02280"></a>02280             *(--dp) = hi_filler;
<a name="l02281"></a>02281             *(--dp) = lo_filler;
<a name="l02282"></a>02282             row_info-&gt;channels = 4;
<a name="l02283"></a>02283             row_info-&gt;pixel_depth = 64;
<a name="l02284"></a>02284             row_info-&gt;rowbytes = row_width * 8;
<a name="l02285"></a>02285          }
<a name="l02286"></a>02286 
<a name="l02287"></a>02287          <span class="keywordflow">else</span>
<a name="l02288"></a>02288          {
<a name="l02289"></a>02289             <span class="comment">/* This changes the data from RRGGBB to XXRRGGBB */</span>
<a name="l02290"></a>02290             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 6;
<a name="l02291"></a>02291             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp  + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 2;
<a name="l02292"></a>02292             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02293"></a>02293             {
<a name="l02294"></a>02294                *(--dp) = *(--sp);
<a name="l02295"></a>02295                *(--dp) = *(--sp);
<a name="l02296"></a>02296                *(--dp) = *(--sp);
<a name="l02297"></a>02297                *(--dp) = *(--sp);
<a name="l02298"></a>02298                *(--dp) = *(--sp);
<a name="l02299"></a>02299                *(--dp) = *(--sp);
<a name="l02300"></a>02300                *(--dp) = hi_filler;
<a name="l02301"></a>02301                *(--dp) = lo_filler;
<a name="l02302"></a>02302             }
<a name="l02303"></a>02303 
<a name="l02304"></a>02304             row_info-&gt;channels = 4;
<a name="l02305"></a>02305             row_info-&gt;pixel_depth = 64;
<a name="l02306"></a>02306             row_info-&gt;rowbytes = row_width * 8;
<a name="l02307"></a>02307          }
<a name="l02308"></a>02308       }
<a name="l02309"></a>02309 <span class="preprocessor">#endif</span>
<a name="l02310"></a>02310 <span class="preprocessor"></span>   } <span class="comment">/* COLOR_TYPE == RGB */</span>
<a name="l02311"></a>02311 }
<a name="l02312"></a>02312 <span class="preprocessor">#endif</span>
<a name="l02313"></a>02313 <span class="preprocessor"></span>
<a name="l02314"></a>02314 <span class="preprocessor">#ifdef PNG_READ_GRAY_TO_RGB_SUPPORTED</span>
<a name="l02315"></a>02315 <span class="preprocessor"></span><span class="comment">/* Expand grayscale files to RGB, with or without alpha */</span>
<a name="l02316"></a>02316 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l02317"></a><a class="code" href="pngrtran_8c.html#af561406ff2ddd6523d49b88e51d5bf94">02317</a> <a class="code" href="pngrtran_8c.html#af561406ff2ddd6523d49b88e51d5bf94">png_do_gray_to_rgb</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row)
<a name="l02318"></a>02318 {
<a name="l02319"></a>02319    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l02320"></a>02320    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width = row_info-&gt;width;
<a name="l02321"></a>02321 
<a name="l02322"></a>02322    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_gray_to_rgb&quot;</span>);
<a name="l02323"></a>02323 
<a name="l02324"></a>02324    <span class="keywordflow">if</span> (row_info-&gt;bit_depth &gt;= 8 &amp;&amp;
<a name="l02325"></a>02325        !(row_info-&gt;color_type &amp; <a class="code" href="png_8h.html#a87bc785c34abddf3bb9ff206d721964b">PNG_COLOR_MASK_COLOR</a>))
<a name="l02326"></a>02326    {
<a name="l02327"></a>02327       <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#ac679619ad9d3f2c46c2b69fe65bd19f1">PNG_COLOR_TYPE_GRAY</a>)
<a name="l02328"></a>02328       {
<a name="l02329"></a>02329          <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l02330"></a>02330          {
<a name="l02331"></a>02331             <span class="comment">/* This changes G to RGB */</span>
<a name="l02332"></a>02332             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l02333"></a>02333             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp  + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 2;
<a name="l02334"></a>02334             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02335"></a>02335             {
<a name="l02336"></a>02336                *(dp--) = *sp;
<a name="l02337"></a>02337                *(dp--) = *sp;
<a name="l02338"></a>02338                *(dp--) = *(sp--);
<a name="l02339"></a>02339             }
<a name="l02340"></a>02340          }
<a name="l02341"></a>02341 
<a name="l02342"></a>02342          <span class="keywordflow">else</span>
<a name="l02343"></a>02343          {
<a name="l02344"></a>02344             <span class="comment">/* This changes GG to RRGGBB */</span>
<a name="l02345"></a>02345             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 2 - 1;
<a name="l02346"></a>02346             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp  + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 4;
<a name="l02347"></a>02347             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02348"></a>02348             {
<a name="l02349"></a>02349                *(dp--) = *sp;
<a name="l02350"></a>02350                *(dp--) = *(sp - 1);
<a name="l02351"></a>02351                *(dp--) = *sp;
<a name="l02352"></a>02352                *(dp--) = *(sp - 1);
<a name="l02353"></a>02353                *(dp--) = *(sp--);
<a name="l02354"></a>02354                *(dp--) = *(sp--);
<a name="l02355"></a>02355             }
<a name="l02356"></a>02356          }
<a name="l02357"></a>02357       }
<a name="l02358"></a>02358 
<a name="l02359"></a>02359       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a6f7f3931c163838e2bc3132de2cd4391">PNG_COLOR_TYPE_GRAY_ALPHA</a>)
<a name="l02360"></a>02360       {
<a name="l02361"></a>02361          <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l02362"></a>02362          {
<a name="l02363"></a>02363             <span class="comment">/* This changes GA to RGBA */</span>
<a name="l02364"></a>02364             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 2 - 1;
<a name="l02365"></a>02365             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp  + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 2;
<a name="l02366"></a>02366             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02367"></a>02367             {
<a name="l02368"></a>02368                *(dp--) = *(sp--);
<a name="l02369"></a>02369                *(dp--) = *sp;
<a name="l02370"></a>02370                *(dp--) = *sp;
<a name="l02371"></a>02371                *(dp--) = *(sp--);
<a name="l02372"></a>02372             }
<a name="l02373"></a>02373          }
<a name="l02374"></a>02374 
<a name="l02375"></a>02375          <span class="keywordflow">else</span>
<a name="l02376"></a>02376          {
<a name="l02377"></a>02377             <span class="comment">/* This changes GGAA to RRGGBBAA */</span>
<a name="l02378"></a>02378             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 4 - 1;
<a name="l02379"></a>02379             <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = sp  + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width * 4;
<a name="l02380"></a>02380             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02381"></a>02381             {
<a name="l02382"></a>02382                *(dp--) = *(sp--);
<a name="l02383"></a>02383                *(dp--) = *(sp--);
<a name="l02384"></a>02384                *(dp--) = *sp;
<a name="l02385"></a>02385                *(dp--) = *(sp - 1);
<a name="l02386"></a>02386                *(dp--) = *sp;
<a name="l02387"></a>02387                *(dp--) = *(sp - 1);
<a name="l02388"></a>02388                *(dp--) = *(sp--);
<a name="l02389"></a>02389                *(dp--) = *(sp--);
<a name="l02390"></a>02390             }
<a name="l02391"></a>02391          }
<a name="l02392"></a>02392       }
<a name="l02393"></a>02393       row_info-&gt;channels += (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)2;
<a name="l02394"></a>02394       row_info-&gt;color_type |= <a class="code" href="png_8h.html#a87bc785c34abddf3bb9ff206d721964b">PNG_COLOR_MASK_COLOR</a>;
<a name="l02395"></a>02395       row_info-&gt;pixel_depth = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(row_info-&gt;channels *
<a name="l02396"></a>02396           row_info-&gt;bit_depth);
<a name="l02397"></a>02397       row_info-&gt;rowbytes = <a class="code" href="pngpriv_8h.html#a18a47644e4b7cd60bb2b4a8c82d53f30">PNG_ROWBYTES</a>(row_info-&gt;pixel_depth, row_width);
<a name="l02398"></a>02398    }
<a name="l02399"></a>02399 }
<a name="l02400"></a>02400 <span class="preprocessor">#endif</span>
<a name="l02401"></a>02401 <span class="preprocessor"></span>
<a name="l02402"></a>02402 <span class="preprocessor">#ifdef PNG_READ_RGB_TO_GRAY_SUPPORTED</span>
<a name="l02403"></a>02403 <span class="preprocessor"></span><span class="comment">/* Reduce RGB files to grayscale, with or without alpha</span>
<a name="l02404"></a>02404 <span class="comment"> * using the equation given in Poynton&#39;s ColorFAQ at</span>
<a name="l02405"></a>02405 <span class="comment"> * &lt;http://www.inforamp.net/~poynton/&gt;  (THIS LINK IS DEAD June 2008)</span>
<a name="l02406"></a>02406 <span class="comment"> * New link:</span>
<a name="l02407"></a>02407 <span class="comment"> * &lt;http://www.poynton.com/notes/colour_and_gamma/&gt;</span>
<a name="l02408"></a>02408 <span class="comment"> * Charles Poynton poynton at poynton.com</span>
<a name="l02409"></a>02409 <span class="comment"> *</span>
<a name="l02410"></a>02410 <span class="comment"> *     Y = 0.212671 * R + 0.715160 * G + 0.072169 * B</span>
<a name="l02411"></a>02411 <span class="comment"> *</span>
<a name="l02412"></a>02412 <span class="comment"> *  We approximate this with</span>
<a name="l02413"></a>02413 <span class="comment"> *</span>
<a name="l02414"></a>02414 <span class="comment"> *     Y = 0.21268 * R    + 0.7151 * G    + 0.07217 * B</span>
<a name="l02415"></a>02415 <span class="comment"> *</span>
<a name="l02416"></a>02416 <span class="comment"> *  which can be expressed with integers as</span>
<a name="l02417"></a>02417 <span class="comment"> *</span>
<a name="l02418"></a>02418 <span class="comment"> *     Y = (6969 * R + 23434 * G + 2365 * B)/32768</span>
<a name="l02419"></a>02419 <span class="comment"> *</span>
<a name="l02420"></a>02420 <span class="comment"> *  The calculation is to be done in a linear colorspace.</span>
<a name="l02421"></a>02421 <span class="comment"> *</span>
<a name="l02422"></a>02422 <span class="comment"> *  Other integer coefficents can be used via png_set_rgb_to_gray().</span>
<a name="l02423"></a>02423 <span class="comment"> */</span>
<a name="l02424"></a>02424 <span class="keywordtype">int</span> <span class="comment">/* PRIVATE */</span>
<a name="l02425"></a><a class="code" href="pngrtran_8c.html#a98cd295723f0d96052ca348b7ac75b23">02425</a> <a class="code" href="pngrtran_8c.html#a98cd295723f0d96052ca348b7ac75b23">png_do_rgb_to_gray</a>(<a class="code" href="png_8h.html#a431351f0dcae8200b5514bcc9c506217">png_structp</a> png_ptr, <a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row)
<a name="l02426"></a>02426 
<a name="l02427"></a>02427 {
<a name="l02428"></a>02428    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l02429"></a>02429 
<a name="l02430"></a>02430    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width = row_info-&gt;width;
<a name="l02431"></a>02431    <span class="keywordtype">int</span> rgb_error = 0;
<a name="l02432"></a>02432 
<a name="l02433"></a>02433    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_rgb_to_gray&quot;</span>);
<a name="l02434"></a>02434 
<a name="l02435"></a>02435    <span class="keywordflow">if</span> (!(row_info-&gt;color_type &amp; <a class="code" href="png_8h.html#a916b5054b0c691f4774e8b69cb2d2dc2">PNG_COLOR_MASK_PALETTE</a>) &amp;&amp;
<a name="l02436"></a>02436        (row_info-&gt;color_type &amp; <a class="code" href="png_8h.html#a87bc785c34abddf3bb9ff206d721964b">PNG_COLOR_MASK_COLOR</a>))
<a name="l02437"></a>02437    {
<a name="l02438"></a>02438       <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> rc = png_ptr-&gt;rgb_to_gray_red_coeff;
<a name="l02439"></a>02439       <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> gc = png_ptr-&gt;rgb_to_gray_green_coeff;
<a name="l02440"></a>02440       <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> bc = png_ptr-&gt;rgb_to_gray_blue_coeff;
<a name="l02441"></a>02441 
<a name="l02442"></a>02442       <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a>)
<a name="l02443"></a>02443       {
<a name="l02444"></a>02444          <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l02445"></a>02445          {
<a name="l02446"></a>02446 <span class="preprocessor">#if defined(PNG_READ_GAMMA_SUPPORTED) || defined(PNG_READ_BACKGROUND_SUPPORTED)</span>
<a name="l02447"></a>02447 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (png_ptr-&gt;gamma_from_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; png_ptr-&gt;gamma_to_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02448"></a>02448             {
<a name="l02449"></a>02449                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row;
<a name="l02450"></a>02450                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row;
<a name="l02451"></a>02451 
<a name="l02452"></a>02452                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02453"></a>02453                {
<a name="l02454"></a>02454                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> red   = png_ptr-&gt;gamma_to_1[*(sp++)];
<a name="l02455"></a>02455                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> green = png_ptr-&gt;gamma_to_1[*(sp++)];
<a name="l02456"></a>02456                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> blue  = png_ptr-&gt;gamma_to_1[*(sp++)];
<a name="l02457"></a>02457 
<a name="l02458"></a>02458                   <span class="keywordflow">if</span> (red != green || red != blue)
<a name="l02459"></a>02459                   {
<a name="l02460"></a>02460                      rgb_error |= 1;
<a name="l02461"></a>02461                      *(dp++) = png_ptr-&gt;gamma_from_1[
<a name="l02462"></a>02462                          (rc*red + gc*green + bc*blue)&gt;&gt;15];
<a name="l02463"></a>02463                   }
<a name="l02464"></a>02464 
<a name="l02465"></a>02465                   <span class="keywordflow">else</span>
<a name="l02466"></a>02466                      *(dp++) = *(sp - 1);
<a name="l02467"></a>02467                }
<a name="l02468"></a>02468             }
<a name="l02469"></a>02469             <span class="keywordflow">else</span>
<a name="l02470"></a>02470 <span class="preprocessor">#endif</span>
<a name="l02471"></a>02471 <span class="preprocessor"></span>            {
<a name="l02472"></a>02472                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row;
<a name="l02473"></a>02473                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row;
<a name="l02474"></a>02474                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02475"></a>02475                {
<a name="l02476"></a>02476                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> red   = *(sp++);
<a name="l02477"></a>02477                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> green = *(sp++);
<a name="l02478"></a>02478                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> blue  = *(sp++);
<a name="l02479"></a>02479 
<a name="l02480"></a>02480                   <span class="keywordflow">if</span> (red != green || red != blue)
<a name="l02481"></a>02481                   {
<a name="l02482"></a>02482                      rgb_error |= 1;
<a name="l02483"></a>02483                      *(dp++) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((rc*red + gc*green + bc*blue)&gt;&gt;15);
<a name="l02484"></a>02484                   }
<a name="l02485"></a>02485 
<a name="l02486"></a>02486                   <span class="keywordflow">else</span>
<a name="l02487"></a>02487                      *(dp++) = *(sp - 1);
<a name="l02488"></a>02488                }
<a name="l02489"></a>02489             }
<a name="l02490"></a>02490          }
<a name="l02491"></a>02491 
<a name="l02492"></a>02492          <span class="keywordflow">else</span> <span class="comment">/* RGB bit_depth == 16 */</span>
<a name="l02493"></a>02493          {
<a name="l02494"></a>02494 <span class="preprocessor">#if defined(PNG_READ_GAMMA_SUPPORTED) || defined(PNG_READ_BACKGROUND_SUPPORTED)</span>
<a name="l02495"></a>02495 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (png_ptr-&gt;gamma_16_to_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l02496"></a>02496                 png_ptr-&gt;gamma_16_from_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02497"></a>02497             {
<a name="l02498"></a>02498                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row;
<a name="l02499"></a>02499                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row;
<a name="l02500"></a>02500                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02501"></a>02501                {
<a name="l02502"></a>02502                   <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> red, green, blue, w;
<a name="l02503"></a>02503 
<a name="l02504"></a>02504                   red   = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp))&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02505"></a>02505                   green = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp))&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02506"></a>02506                   blue  = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp))&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02507"></a>02507 
<a name="l02508"></a>02508                   <span class="keywordflow">if</span> (red == green &amp;&amp; red == blue)
<a name="l02509"></a>02509                      w = red;
<a name="l02510"></a>02510 
<a name="l02511"></a>02511                   <span class="keywordflow">else</span>
<a name="l02512"></a>02512                   {
<a name="l02513"></a>02513                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> red_1   = png_ptr-&gt;gamma_16_to_1[(red&amp;0xff)
<a name="l02514"></a>02514                          &gt;&gt; png_ptr-&gt;gamma_shift][red&gt;&gt;8];
<a name="l02515"></a>02515                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> green_1 =
<a name="l02516"></a>02516                          png_ptr-&gt;gamma_16_to_1[(green&amp;0xff) &gt;&gt;
<a name="l02517"></a>02517                          png_ptr-&gt;gamma_shift][green&gt;&gt;8];
<a name="l02518"></a>02518                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> blue_1  = png_ptr-&gt;gamma_16_to_1[(blue&amp;0xff)
<a name="l02519"></a>02519                          &gt;&gt; png_ptr-&gt;gamma_shift][blue&gt;&gt;8];
<a name="l02520"></a>02520                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> gray16  = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((rc*red_1 + gc*green_1
<a name="l02521"></a>02521                          + bc*blue_1)&gt;&gt;15);
<a name="l02522"></a>02522                      w = png_ptr-&gt;gamma_16_from_1[(gray16&amp;0xff) &gt;&gt;
<a name="l02523"></a>02523                          png_ptr-&gt;gamma_shift][gray16 &gt;&gt; 8];
<a name="l02524"></a>02524                      rgb_error |= 1;
<a name="l02525"></a>02525                   }
<a name="l02526"></a>02526 
<a name="l02527"></a>02527                   *(dp++) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((w&gt;&gt;8) &amp; 0xff);
<a name="l02528"></a>02528                   *(dp++) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(w &amp; 0xff);
<a name="l02529"></a>02529                }
<a name="l02530"></a>02530             }
<a name="l02531"></a>02531             <span class="keywordflow">else</span>
<a name="l02532"></a>02532 <span class="preprocessor">#endif</span>
<a name="l02533"></a>02533 <span class="preprocessor"></span>            {
<a name="l02534"></a>02534                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row;
<a name="l02535"></a>02535                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row;
<a name="l02536"></a>02536                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02537"></a>02537                {
<a name="l02538"></a>02538                   <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> red, green, blue, gray16;
<a name="l02539"></a>02539 
<a name="l02540"></a>02540                   red   = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp))&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02541"></a>02541                   green = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp))&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02542"></a>02542                   blue  = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp))&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02543"></a>02543 
<a name="l02544"></a>02544                   <span class="keywordflow">if</span> (red != green || red != blue)
<a name="l02545"></a>02545                      rgb_error |= 1;
<a name="l02546"></a>02546 
<a name="l02547"></a>02547                   gray16  = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((rc*red + gc*green + bc*blue)&gt;&gt;15);
<a name="l02548"></a>02548                   *(dp++) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((gray16&gt;&gt;8) &amp; 0xff);
<a name="l02549"></a>02549                   *(dp++) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(gray16 &amp; 0xff);
<a name="l02550"></a>02550                }
<a name="l02551"></a>02551             }
<a name="l02552"></a>02552          }
<a name="l02553"></a>02553       }
<a name="l02554"></a>02554       <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a>)
<a name="l02555"></a>02555       {
<a name="l02556"></a>02556          <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l02557"></a>02557          {
<a name="l02558"></a>02558 <span class="preprocessor">#if defined(PNG_READ_GAMMA_SUPPORTED) || defined(PNG_READ_BACKGROUND_SUPPORTED)</span>
<a name="l02559"></a>02559 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (png_ptr-&gt;gamma_from_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; png_ptr-&gt;gamma_to_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02560"></a>02560             {
<a name="l02561"></a>02561                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row;
<a name="l02562"></a>02562                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row;
<a name="l02563"></a>02563                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02564"></a>02564                {
<a name="l02565"></a>02565                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> red   = png_ptr-&gt;gamma_to_1[*(sp++)];
<a name="l02566"></a>02566                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> green = png_ptr-&gt;gamma_to_1[*(sp++)];
<a name="l02567"></a>02567                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> blue  = png_ptr-&gt;gamma_to_1[*(sp++)];
<a name="l02568"></a>02568 
<a name="l02569"></a>02569                   <span class="keywordflow">if</span> (red != green || red != blue)
<a name="l02570"></a>02570                      rgb_error |= 1;
<a name="l02571"></a>02571 
<a name="l02572"></a>02572                   *(dp++) =  png_ptr-&gt;gamma_from_1
<a name="l02573"></a>02573                       [(rc*red + gc*green + bc*blue)&gt;&gt;15];
<a name="l02574"></a>02574 
<a name="l02575"></a>02575                   *(dp++) = *(sp++);  <span class="comment">/* alpha */</span>
<a name="l02576"></a>02576                }
<a name="l02577"></a>02577             }
<a name="l02578"></a>02578             <span class="keywordflow">else</span>
<a name="l02579"></a>02579 <span class="preprocessor">#endif</span>
<a name="l02580"></a>02580 <span class="preprocessor"></span>            {
<a name="l02581"></a>02581                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row;
<a name="l02582"></a>02582                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row;
<a name="l02583"></a>02583                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02584"></a>02584                {
<a name="l02585"></a>02585                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> red   = *(sp++);
<a name="l02586"></a>02586                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> green = *(sp++);
<a name="l02587"></a>02587                   <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> blue  = *(sp++);
<a name="l02588"></a>02588                   <span class="keywordflow">if</span> (red != green || red != blue)
<a name="l02589"></a>02589                      rgb_error |= 1;
<a name="l02590"></a>02590 
<a name="l02591"></a>02591                   *(dp++) =  (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((rc*red + gc*green + bc*blue)&gt;&gt;15);
<a name="l02592"></a>02592                   *(dp++) = *(sp++);  <span class="comment">/* alpha */</span>
<a name="l02593"></a>02593                }
<a name="l02594"></a>02594             }
<a name="l02595"></a>02595          }
<a name="l02596"></a>02596          <span class="keywordflow">else</span> <span class="comment">/* RGBA bit_depth == 16 */</span>
<a name="l02597"></a>02597          {
<a name="l02598"></a>02598 <span class="preprocessor">#if defined(PNG_READ_GAMMA_SUPPORTED) || defined(PNG_READ_BACKGROUND_SUPPORTED)</span>
<a name="l02599"></a>02599 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (png_ptr-&gt;gamma_16_to_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l02600"></a>02600                 png_ptr-&gt;gamma_16_from_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02601"></a>02601             {
<a name="l02602"></a>02602                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row;
<a name="l02603"></a>02603                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row;
<a name="l02604"></a>02604                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02605"></a>02605                {
<a name="l02606"></a>02606                   <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> red, green, blue, w;
<a name="l02607"></a>02607 
<a name="l02608"></a>02608                   red   = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp))&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02609"></a>02609                   green = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp))&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02610"></a>02610                   blue  = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp))&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02611"></a>02611 
<a name="l02612"></a>02612                   <span class="keywordflow">if</span> (red == green &amp;&amp; red == blue)
<a name="l02613"></a>02613                      w = red;
<a name="l02614"></a>02614 
<a name="l02615"></a>02615                   <span class="keywordflow">else</span>
<a name="l02616"></a>02616                   {
<a name="l02617"></a>02617                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> red_1   = png_ptr-&gt;gamma_16_to_1[(red&amp;0xff) &gt;&gt;
<a name="l02618"></a>02618                          png_ptr-&gt;gamma_shift][red&gt;&gt;8];
<a name="l02619"></a>02619 
<a name="l02620"></a>02620                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> green_1 =
<a name="l02621"></a>02621                          png_ptr-&gt;gamma_16_to_1[(green&amp;0xff) &gt;&gt;
<a name="l02622"></a>02622                          png_ptr-&gt;gamma_shift][green&gt;&gt;8];
<a name="l02623"></a>02623 
<a name="l02624"></a>02624                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> blue_1  = png_ptr-&gt;gamma_16_to_1[(blue&amp;0xff) &gt;&gt;
<a name="l02625"></a>02625                          png_ptr-&gt;gamma_shift][blue&gt;&gt;8];
<a name="l02626"></a>02626 
<a name="l02627"></a>02627                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> gray16  = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((rc * red_1
<a name="l02628"></a>02628                          + gc * green_1 + bc * blue_1)&gt;&gt;15);
<a name="l02629"></a>02629 
<a name="l02630"></a>02630                      w = png_ptr-&gt;gamma_16_from_1[(gray16&amp;0xff) &gt;&gt;
<a name="l02631"></a>02631                          png_ptr-&gt;gamma_shift][gray16 &gt;&gt; 8];
<a name="l02632"></a>02632 
<a name="l02633"></a>02633                      rgb_error |= 1;
<a name="l02634"></a>02634                   }
<a name="l02635"></a>02635 
<a name="l02636"></a>02636                   *(dp++) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((w&gt;&gt;8) &amp; 0xff);
<a name="l02637"></a>02637                   *(dp++) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(w &amp; 0xff);
<a name="l02638"></a>02638                   *(dp++) = *(sp++);  <span class="comment">/* alpha */</span>
<a name="l02639"></a>02639                   *(dp++) = *(sp++);
<a name="l02640"></a>02640                }
<a name="l02641"></a>02641             }
<a name="l02642"></a>02642             <span class="keywordflow">else</span>
<a name="l02643"></a>02643 <span class="preprocessor">#endif</span>
<a name="l02644"></a>02644 <span class="preprocessor"></span>            {
<a name="l02645"></a>02645                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp = row;
<a name="l02646"></a>02646                <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> dp = row;
<a name="l02647"></a>02647                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02648"></a>02648                {
<a name="l02649"></a>02649                   <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> red, green, blue, gray16;
<a name="l02650"></a>02650                   red   = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((*(sp)&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02651"></a>02651                   green = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((*(sp)&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02652"></a>02652                   blue  = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((*(sp)&lt;&lt;8) | *(sp + 1)); sp += 2;
<a name="l02653"></a>02653 
<a name="l02654"></a>02654                   <span class="keywordflow">if</span> (red != green || red != blue)
<a name="l02655"></a>02655                      rgb_error |= 1;
<a name="l02656"></a>02656 
<a name="l02657"></a>02657                   gray16  = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((rc*red + gc*green + bc*blue)&gt;&gt;15);
<a name="l02658"></a>02658                   *(dp++) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((gray16&gt;&gt;8) &amp; 0xff);
<a name="l02659"></a>02659                   *(dp++) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(gray16 &amp; 0xff);
<a name="l02660"></a>02660                   *(dp++) = *(sp++);  <span class="comment">/* alpha */</span>
<a name="l02661"></a>02661                   *(dp++) = *(sp++);
<a name="l02662"></a>02662                }
<a name="l02663"></a>02663             }
<a name="l02664"></a>02664          }
<a name="l02665"></a>02665       }
<a name="l02666"></a>02666       row_info-&gt;channels -= 2;
<a name="l02667"></a>02667       row_info-&gt;color_type = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(row_info-&gt;color_type &amp;
<a name="l02668"></a>02668           ~<a class="code" href="png_8h.html#a87bc785c34abddf3bb9ff206d721964b">PNG_COLOR_MASK_COLOR</a>);
<a name="l02669"></a>02669       row_info-&gt;pixel_depth = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(row_info-&gt;channels *
<a name="l02670"></a>02670           row_info-&gt;bit_depth);
<a name="l02671"></a>02671       row_info-&gt;rowbytes = <a class="code" href="pngpriv_8h.html#a18a47644e4b7cd60bb2b4a8c82d53f30">PNG_ROWBYTES</a>(row_info-&gt;pixel_depth, row_width);
<a name="l02672"></a>02672    }
<a name="l02673"></a>02673    <span class="keywordflow">return</span> rgb_error;
<a name="l02674"></a>02674 }
<a name="l02675"></a>02675 <span class="preprocessor">#endif</span>
<a name="l02676"></a>02676 <span class="preprocessor"></span>
<a name="l02677"></a>02677 <span class="comment">/* Build a grayscale palette.  Palette is assumed to be 1 &lt;&lt; bit_depth</span>
<a name="l02678"></a>02678 <span class="comment"> * large of png_color.  This lets grayscale images be treated as</span>
<a name="l02679"></a>02679 <span class="comment"> * paletted.  Most useful for gamma correction and simplification</span>
<a name="l02680"></a>02680 <span class="comment"> * of code.</span>
<a name="l02681"></a>02681 <span class="comment"> */</span>
<a name="l02682"></a>02682 <span class="keywordtype">void</span> <a class="code" href="pngconf_8h.html#a618eb992ee4d84d25d62175d6cc2c4c2">PNGAPI</a>
<a name="l02683"></a><a class="code" href="pngrtran_8c.html#a26a4ede8d91fe3a94f8cc6fec7dc6bce">02683</a> <a class="code" href="pngrtran_8c.html#a26a4ede8d91fe3a94f8cc6fec7dc6bce">png_build_grayscale_palette</a>(<span class="keywordtype">int</span> bit_depth, <a class="code" href="png_8h.html#a22c26a022c2bdca0fed457713767ca45">png_colorp</a> palette)
<a name="l02684"></a>02684 {
<a name="l02685"></a>02685    <span class="keywordtype">int</span> num_palette;
<a name="l02686"></a>02686    <span class="keywordtype">int</span> color_inc;
<a name="l02687"></a>02687    <span class="keywordtype">int</span> i;
<a name="l02688"></a>02688    <span class="keywordtype">int</span> v;
<a name="l02689"></a>02689 
<a name="l02690"></a>02690    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_build_grayscale_palette&quot;</span>);
<a name="l02691"></a>02691 
<a name="l02692"></a>02692    <span class="keywordflow">if</span> (palette == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02693"></a>02693       <span class="keywordflow">return</span>;
<a name="l02694"></a>02694 
<a name="l02695"></a>02695    <span class="keywordflow">switch</span> (bit_depth)
<a name="l02696"></a>02696    {
<a name="l02697"></a>02697       <span class="keywordflow">case</span> 1:
<a name="l02698"></a>02698          num_palette = 2;
<a name="l02699"></a>02699          color_inc = 0xff;
<a name="l02700"></a>02700          <span class="keywordflow">break</span>;
<a name="l02701"></a>02701 
<a name="l02702"></a>02702       <span class="keywordflow">case</span> 2:
<a name="l02703"></a>02703          num_palette = 4;
<a name="l02704"></a>02704          color_inc = 0x55;
<a name="l02705"></a>02705          <span class="keywordflow">break</span>;
<a name="l02706"></a>02706 
<a name="l02707"></a>02707       <span class="keywordflow">case</span> 4:
<a name="l02708"></a>02708          num_palette = 16;
<a name="l02709"></a>02709          color_inc = 0x11;
<a name="l02710"></a>02710          <span class="keywordflow">break</span>;
<a name="l02711"></a>02711 
<a name="l02712"></a>02712       <span class="keywordflow">case</span> 8:
<a name="l02713"></a>02713          num_palette = 256;
<a name="l02714"></a>02714          color_inc = 1;
<a name="l02715"></a>02715          <span class="keywordflow">break</span>;
<a name="l02716"></a>02716 
<a name="l02717"></a>02717       <span class="keywordflow">default</span>:
<a name="l02718"></a>02718          num_palette = 0;
<a name="l02719"></a>02719          color_inc = 0;
<a name="l02720"></a>02720          <span class="keywordflow">break</span>;
<a name="l02721"></a>02721    }
<a name="l02722"></a>02722 
<a name="l02723"></a>02723    <span class="keywordflow">for</span> (i = 0, v = 0; i &lt; num_palette; i++, v += color_inc)
<a name="l02724"></a>02724    {
<a name="l02725"></a>02725       palette[i].red = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)v;
<a name="l02726"></a>02726       palette[i].green = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)v;
<a name="l02727"></a>02727       palette[i].blue = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)v;
<a name="l02728"></a>02728    }
<a name="l02729"></a>02729 }
<a name="l02730"></a>02730 
<a name="l02731"></a>02731 
<a name="l02732"></a>02732 <span class="preprocessor">#ifdef PNG_READ_BACKGROUND_SUPPORTED</span>
<a name="l02733"></a>02733 <span class="preprocessor"></span><span class="comment">/* Replace any alpha or transparency with the supplied background color.</span>
<a name="l02734"></a>02734 <span class="comment"> * &quot;background&quot; is already in the screen gamma, while &quot;background_1&quot; is</span>
<a name="l02735"></a>02735 <span class="comment"> * at a gamma of 1.0.  Paletted files have already been taken care of.</span>
<a name="l02736"></a>02736 <span class="comment"> */</span>
<a name="l02737"></a>02737 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l02738"></a><a class="code" href="pngrtran_8c.html#acc7e1bbdd58c9fb68b74b3f0f3ff0049">02738</a> <a class="code" href="pngrtran_8c.html#acc7e1bbdd58c9fb68b74b3f0f3ff0049">png_do_background</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row,
<a name="l02739"></a>02739     <a class="code" href="png_8h.html#ab40f2d0b64d6dedbdcfabdaada204863">png_const_color_16p</a> trans_color, <a class="code" href="png_8h.html#ab40f2d0b64d6dedbdcfabdaada204863">png_const_color_16p</a> background
<a name="l02740"></a>02740 #ifdef <a class="code" href="pnglibconf_8h.html#a7a690fa3eb9de03fbadb80ff0ceb7c5f">PNG_READ_GAMMA_SUPPORTED</a>
<a name="l02741"></a>02741     , <a class="code" href="png_8h.html#ab40f2d0b64d6dedbdcfabdaada204863">png_const_color_16p</a> background_1, <a class="code" href="pngconf_8h.html#a53e11f2ed74ffe5e45513458517b8af3">png_const_bytep</a> gamma_table,
<a name="l02742"></a>02742     <a class="code" href="pngconf_8h.html#a53e11f2ed74ffe5e45513458517b8af3">png_const_bytep</a> gamma_from_1, <a class="code" href="pngconf_8h.html#a53e11f2ed74ffe5e45513458517b8af3">png_const_bytep</a> gamma_to_1,
<a name="l02743"></a>02743     <a class="code" href="pngpriv_8h.html#a5518933563c30291321e86b66d4ad36d">png_const_uint_16pp</a> gamma_16, <a class="code" href="pngpriv_8h.html#a5518933563c30291321e86b66d4ad36d">png_const_uint_16pp</a> gamma_16_from_1,
<a name="l02744"></a>02744     <a class="code" href="pngpriv_8h.html#a5518933563c30291321e86b66d4ad36d">png_const_uint_16pp</a> gamma_16_to_1, <span class="keywordtype">int</span> gamma_shift
<a name="l02745"></a>02745 #endif
<a name="l02746"></a>02746     )
<a name="l02747"></a>02747 {
<a name="l02748"></a>02748    <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp, dp;
<a name="l02749"></a>02749    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l02750"></a>02750    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width = row_info-&gt;width;
<a name="l02751"></a>02751    <span class="keywordtype">int</span> shift;
<a name="l02752"></a>02752 
<a name="l02753"></a>02753    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_background&quot;</span>);
<a name="l02754"></a>02754 
<a name="l02755"></a>02755    <span class="keywordflow">if</span> (background != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l02756"></a>02756       (!(row_info-&gt;color_type &amp; <a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>) ||
<a name="l02757"></a>02757       (row_info-&gt;color_type != <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a> &amp;&amp; trans_color)))
<a name="l02758"></a>02758    {
<a name="l02759"></a>02759       <span class="keywordflow">switch</span> (row_info-&gt;color_type)
<a name="l02760"></a>02760       {
<a name="l02761"></a>02761          <span class="keywordflow">case</span> <a class="code" href="png_8h.html#ac679619ad9d3f2c46c2b69fe65bd19f1">PNG_COLOR_TYPE_GRAY</a>:
<a name="l02762"></a>02762          {
<a name="l02763"></a>02763             <span class="keywordflow">switch</span> (row_info-&gt;bit_depth)
<a name="l02764"></a>02764             {
<a name="l02765"></a>02765                <span class="keywordflow">case</span> 1:
<a name="l02766"></a>02766                {
<a name="l02767"></a>02767                   sp = row;
<a name="l02768"></a>02768                   shift = 7;
<a name="l02769"></a>02769                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02770"></a>02770                   {
<a name="l02771"></a>02771                      <span class="keywordflow">if</span> ((<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((*sp &gt;&gt; shift) &amp; 0x01)
<a name="l02772"></a>02772                         == trans_color-&gt;gray)
<a name="l02773"></a>02773                      {
<a name="l02774"></a>02774                         *sp &amp;= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((0x7f7f &gt;&gt; (7 - shift)) &amp; 0xff);
<a name="l02775"></a>02775                         *sp |= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;gray &lt;&lt; shift);
<a name="l02776"></a>02776                      }
<a name="l02777"></a>02777 
<a name="l02778"></a>02778                      <span class="keywordflow">if</span> (!shift)
<a name="l02779"></a>02779                      {
<a name="l02780"></a>02780                         shift = 7;
<a name="l02781"></a>02781                         sp++;
<a name="l02782"></a>02782                      }
<a name="l02783"></a>02783 
<a name="l02784"></a>02784                      <span class="keywordflow">else</span>
<a name="l02785"></a>02785                         shift--;
<a name="l02786"></a>02786                   }
<a name="l02787"></a>02787                   <span class="keywordflow">break</span>;
<a name="l02788"></a>02788                }
<a name="l02789"></a>02789 
<a name="l02790"></a>02790                <span class="keywordflow">case</span> 2:
<a name="l02791"></a>02791                {
<a name="l02792"></a>02792 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l02793"></a>02793 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (gamma_table != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02794"></a>02794                   {
<a name="l02795"></a>02795                      sp = row;
<a name="l02796"></a>02796                      shift = 6;
<a name="l02797"></a>02797                      <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02798"></a>02798                      {
<a name="l02799"></a>02799                         <span class="keywordflow">if</span> ((<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((*sp &gt;&gt; shift) &amp; 0x03)
<a name="l02800"></a>02800                             == trans_color-&gt;gray)
<a name="l02801"></a>02801                         {
<a name="l02802"></a>02802                            *sp &amp;= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((0x3f3f &gt;&gt; (6 - shift)) &amp; 0xff);
<a name="l02803"></a>02803                            *sp |= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;gray &lt;&lt; shift);
<a name="l02804"></a>02804                         }
<a name="l02805"></a>02805 
<a name="l02806"></a>02806                         <span class="keywordflow">else</span>
<a name="l02807"></a>02807                         {
<a name="l02808"></a>02808                            <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> p = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((*sp &gt;&gt; shift) &amp; 0x03);
<a name="l02809"></a>02809                            <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> g = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((gamma_table [p | (p &lt;&lt; 2) |
<a name="l02810"></a>02810                                (p &lt;&lt; 4) | (p &lt;&lt; 6)] &gt;&gt; 6) &amp; 0x03);
<a name="l02811"></a>02811                            *sp &amp;= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((0x3f3f &gt;&gt; (6 - shift)) &amp; 0xff);
<a name="l02812"></a>02812                            *sp |= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(g &lt;&lt; shift);
<a name="l02813"></a>02813                         }
<a name="l02814"></a>02814 
<a name="l02815"></a>02815                         <span class="keywordflow">if</span> (!shift)
<a name="l02816"></a>02816                         {
<a name="l02817"></a>02817                            shift = 6;
<a name="l02818"></a>02818                            sp++;
<a name="l02819"></a>02819                         }
<a name="l02820"></a>02820 
<a name="l02821"></a>02821                         <span class="keywordflow">else</span>
<a name="l02822"></a>02822                            shift -= 2;
<a name="l02823"></a>02823                      }
<a name="l02824"></a>02824                   }
<a name="l02825"></a>02825 
<a name="l02826"></a>02826                   <span class="keywordflow">else</span>
<a name="l02827"></a>02827 <span class="preprocessor">#endif</span>
<a name="l02828"></a>02828 <span class="preprocessor"></span>                  {
<a name="l02829"></a>02829                      sp = row;
<a name="l02830"></a>02830                      shift = 6;
<a name="l02831"></a>02831                      <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02832"></a>02832                      {
<a name="l02833"></a>02833                         <span class="keywordflow">if</span> ((<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((*sp &gt;&gt; shift) &amp; 0x03)
<a name="l02834"></a>02834                             == trans_color-&gt;gray)
<a name="l02835"></a>02835                         {
<a name="l02836"></a>02836                            *sp &amp;= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((0x3f3f &gt;&gt; (6 - shift)) &amp; 0xff);
<a name="l02837"></a>02837                            *sp |= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;gray &lt;&lt; shift);
<a name="l02838"></a>02838                         }
<a name="l02839"></a>02839 
<a name="l02840"></a>02840                         <span class="keywordflow">if</span> (!shift)
<a name="l02841"></a>02841                         {
<a name="l02842"></a>02842                            shift = 6;
<a name="l02843"></a>02843                            sp++;
<a name="l02844"></a>02844                         }
<a name="l02845"></a>02845 
<a name="l02846"></a>02846                         <span class="keywordflow">else</span>
<a name="l02847"></a>02847                            shift -= 2;
<a name="l02848"></a>02848                      }
<a name="l02849"></a>02849                   }
<a name="l02850"></a>02850                   <span class="keywordflow">break</span>;
<a name="l02851"></a>02851                }
<a name="l02852"></a>02852 
<a name="l02853"></a>02853                <span class="keywordflow">case</span> 4:
<a name="l02854"></a>02854                {
<a name="l02855"></a>02855 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l02856"></a>02856 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (gamma_table != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02857"></a>02857                   {
<a name="l02858"></a>02858                      sp = row;
<a name="l02859"></a>02859                      shift = 4;
<a name="l02860"></a>02860                      <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02861"></a>02861                      {
<a name="l02862"></a>02862                         <span class="keywordflow">if</span> ((<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((*sp &gt;&gt; shift) &amp; 0x0f)
<a name="l02863"></a>02863                             == trans_color-&gt;gray)
<a name="l02864"></a>02864                         {
<a name="l02865"></a>02865                            *sp &amp;= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((0xf0f &gt;&gt; (4 - shift)) &amp; 0xff);
<a name="l02866"></a>02866                            *sp |= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;gray &lt;&lt; shift);
<a name="l02867"></a>02867                         }
<a name="l02868"></a>02868 
<a name="l02869"></a>02869                         <span class="keywordflow">else</span>
<a name="l02870"></a>02870                         {
<a name="l02871"></a>02871                            <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> p = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((*sp &gt;&gt; shift) &amp; 0x0f);
<a name="l02872"></a>02872                            <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> g = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((gamma_table[p |
<a name="l02873"></a>02873                                (p &lt;&lt; 4)] &gt;&gt; 4) &amp; 0x0f);
<a name="l02874"></a>02874                            *sp &amp;= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((0xf0f &gt;&gt; (4 - shift)) &amp; 0xff);
<a name="l02875"></a>02875                            *sp |= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(g &lt;&lt; shift);
<a name="l02876"></a>02876                         }
<a name="l02877"></a>02877 
<a name="l02878"></a>02878                         <span class="keywordflow">if</span> (!shift)
<a name="l02879"></a>02879                         {
<a name="l02880"></a>02880                            shift = 4;
<a name="l02881"></a>02881                            sp++;
<a name="l02882"></a>02882                         }
<a name="l02883"></a>02883 
<a name="l02884"></a>02884                         <span class="keywordflow">else</span>
<a name="l02885"></a>02885                            shift -= 4;
<a name="l02886"></a>02886                      }
<a name="l02887"></a>02887                   }
<a name="l02888"></a>02888 
<a name="l02889"></a>02889                   <span class="keywordflow">else</span>
<a name="l02890"></a>02890 <span class="preprocessor">#endif</span>
<a name="l02891"></a>02891 <span class="preprocessor"></span>                  {
<a name="l02892"></a>02892                      sp = row;
<a name="l02893"></a>02893                      shift = 4;
<a name="l02894"></a>02894                      <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l02895"></a>02895                      {
<a name="l02896"></a>02896                         <span class="keywordflow">if</span> ((<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((*sp &gt;&gt; shift) &amp; 0x0f)
<a name="l02897"></a>02897                             == trans_color-&gt;gray)
<a name="l02898"></a>02898                         {
<a name="l02899"></a>02899                            *sp &amp;= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((0xf0f &gt;&gt; (4 - shift)) &amp; 0xff);
<a name="l02900"></a>02900                            *sp |= (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;gray &lt;&lt; shift);
<a name="l02901"></a>02901                         }
<a name="l02902"></a>02902 
<a name="l02903"></a>02903                         <span class="keywordflow">if</span> (!shift)
<a name="l02904"></a>02904                         {
<a name="l02905"></a>02905                            shift = 4;
<a name="l02906"></a>02906                            sp++;
<a name="l02907"></a>02907                         }
<a name="l02908"></a>02908 
<a name="l02909"></a>02909                         <span class="keywordflow">else</span>
<a name="l02910"></a>02910                            shift -= 4;
<a name="l02911"></a>02911                      }
<a name="l02912"></a>02912                   }
<a name="l02913"></a>02913                   <span class="keywordflow">break</span>;
<a name="l02914"></a>02914                }
<a name="l02915"></a>02915 
<a name="l02916"></a>02916                <span class="keywordflow">case</span> 8:
<a name="l02917"></a>02917                {
<a name="l02918"></a>02918 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l02919"></a>02919 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (gamma_table != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02920"></a>02920                   {
<a name="l02921"></a>02921                      sp = row;
<a name="l02922"></a>02922                      <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp++)
<a name="l02923"></a>02923                      {
<a name="l02924"></a>02924                         <span class="keywordflow">if</span> (*sp == trans_color-&gt;gray)
<a name="l02925"></a>02925                            *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;gray;
<a name="l02926"></a>02926 
<a name="l02927"></a>02927                         <span class="keywordflow">else</span>
<a name="l02928"></a>02928                            *sp = gamma_table[*sp];
<a name="l02929"></a>02929                      }
<a name="l02930"></a>02930                   }
<a name="l02931"></a>02931                   <span class="keywordflow">else</span>
<a name="l02932"></a>02932 <span class="preprocessor">#endif</span>
<a name="l02933"></a>02933 <span class="preprocessor"></span>                  {
<a name="l02934"></a>02934                      sp = row;
<a name="l02935"></a>02935                      <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp++)
<a name="l02936"></a>02936                      {
<a name="l02937"></a>02937                         <span class="keywordflow">if</span> (*sp == trans_color-&gt;gray)
<a name="l02938"></a>02938                            *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;gray;
<a name="l02939"></a>02939                      }
<a name="l02940"></a>02940                   }
<a name="l02941"></a>02941                   <span class="keywordflow">break</span>;
<a name="l02942"></a>02942                }
<a name="l02943"></a>02943 
<a name="l02944"></a>02944                <span class="keywordflow">case</span> 16:
<a name="l02945"></a>02945                {
<a name="l02946"></a>02946 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l02947"></a>02947 <span class="preprocessor"></span>                  <span class="keywordflow">if</span> (gamma_16 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02948"></a>02948                   {
<a name="l02949"></a>02949                      sp = row;
<a name="l02950"></a>02950                      <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 2)
<a name="l02951"></a>02951                      {
<a name="l02952"></a>02952                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v;
<a name="l02953"></a>02953 
<a name="l02954"></a>02954                         v = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*sp) &lt;&lt; 8) + *(sp + 1));
<a name="l02955"></a>02955 
<a name="l02956"></a>02956                         <span class="keywordflow">if</span> (v == trans_color-&gt;gray)
<a name="l02957"></a>02957                         {
<a name="l02958"></a>02958                            <span class="comment">/* Background is already in screen gamma */</span>
<a name="l02959"></a>02959                            *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;gray &gt;&gt; 8) &amp; 0xff);
<a name="l02960"></a>02960                            *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;gray &amp; 0xff);
<a name="l02961"></a>02961                         }
<a name="l02962"></a>02962 
<a name="l02963"></a>02963                         <span class="keywordflow">else</span>
<a name="l02964"></a>02964                         {
<a name="l02965"></a>02965                            v = gamma_16[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l02966"></a>02966                            *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l02967"></a>02967                            *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l02968"></a>02968                         }
<a name="l02969"></a>02969                      }
<a name="l02970"></a>02970                   }
<a name="l02971"></a>02971                   <span class="keywordflow">else</span>
<a name="l02972"></a>02972 <span class="preprocessor">#endif</span>
<a name="l02973"></a>02973 <span class="preprocessor"></span>                  {
<a name="l02974"></a>02974                      sp = row;
<a name="l02975"></a>02975                      <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 2)
<a name="l02976"></a>02976                      {
<a name="l02977"></a>02977                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v;
<a name="l02978"></a>02978 
<a name="l02979"></a>02979                         v = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*sp) &lt;&lt; 8) + *(sp + 1));
<a name="l02980"></a>02980 
<a name="l02981"></a>02981                         <span class="keywordflow">if</span> (v == trans_color-&gt;gray)
<a name="l02982"></a>02982                         {
<a name="l02983"></a>02983                            *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;gray &gt;&gt; 8) &amp; 0xff);
<a name="l02984"></a>02984                            *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;gray &amp; 0xff);
<a name="l02985"></a>02985                         }
<a name="l02986"></a>02986                      }
<a name="l02987"></a>02987                   }
<a name="l02988"></a>02988                   <span class="keywordflow">break</span>;
<a name="l02989"></a>02989                }
<a name="l02990"></a>02990 
<a name="l02991"></a>02991                <span class="keywordflow">default</span>:
<a name="l02992"></a>02992                   <span class="keywordflow">break</span>;
<a name="l02993"></a>02993             }
<a name="l02994"></a>02994             <span class="keywordflow">break</span>;
<a name="l02995"></a>02995          }
<a name="l02996"></a>02996 
<a name="l02997"></a>02997          <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a>:
<a name="l02998"></a>02998          {
<a name="l02999"></a>02999             <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l03000"></a>03000             {
<a name="l03001"></a>03001 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03002"></a>03002 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (gamma_table != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03003"></a>03003                {
<a name="l03004"></a>03004                   sp = row;
<a name="l03005"></a>03005                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 3)
<a name="l03006"></a>03006                   {
<a name="l03007"></a>03007                      <span class="keywordflow">if</span> (*sp == trans_color-&gt;red &amp;&amp;
<a name="l03008"></a>03008                          *(sp + 1) == trans_color-&gt;green &amp;&amp;
<a name="l03009"></a>03009                          *(sp + 2) == trans_color-&gt;blue)
<a name="l03010"></a>03010                      {
<a name="l03011"></a>03011                         *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;red;
<a name="l03012"></a>03012                         *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;green;
<a name="l03013"></a>03013                         *(sp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;blue;
<a name="l03014"></a>03014                      }
<a name="l03015"></a>03015 
<a name="l03016"></a>03016                      <span class="keywordflow">else</span>
<a name="l03017"></a>03017                      {
<a name="l03018"></a>03018                         *sp = gamma_table[*sp];
<a name="l03019"></a>03019                         *(sp + 1) = gamma_table[*(sp + 1)];
<a name="l03020"></a>03020                         *(sp + 2) = gamma_table[*(sp + 2)];
<a name="l03021"></a>03021                      }
<a name="l03022"></a>03022                   }
<a name="l03023"></a>03023                }
<a name="l03024"></a>03024                <span class="keywordflow">else</span>
<a name="l03025"></a>03025 <span class="preprocessor">#endif</span>
<a name="l03026"></a>03026 <span class="preprocessor"></span>               {
<a name="l03027"></a>03027                   sp = row;
<a name="l03028"></a>03028                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 3)
<a name="l03029"></a>03029                   {
<a name="l03030"></a>03030                      <span class="keywordflow">if</span> (*sp == trans_color-&gt;red &amp;&amp;
<a name="l03031"></a>03031                          *(sp + 1) == trans_color-&gt;green &amp;&amp;
<a name="l03032"></a>03032                          *(sp + 2) == trans_color-&gt;blue)
<a name="l03033"></a>03033                      {
<a name="l03034"></a>03034                         *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;red;
<a name="l03035"></a>03035                         *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;green;
<a name="l03036"></a>03036                         *(sp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;blue;
<a name="l03037"></a>03037                      }
<a name="l03038"></a>03038                   }
<a name="l03039"></a>03039                }
<a name="l03040"></a>03040             }
<a name="l03041"></a>03041             <span class="keywordflow">else</span> <span class="comment">/* if (row_info-&gt;bit_depth == 16) */</span>
<a name="l03042"></a>03042             {
<a name="l03043"></a>03043 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03044"></a>03044 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (gamma_16 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03045"></a>03045                {
<a name="l03046"></a>03046                   sp = row;
<a name="l03047"></a>03047                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 6)
<a name="l03048"></a>03048                   {
<a name="l03049"></a>03049                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> r = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*sp) &lt;&lt; 8) + *(sp + 1));
<a name="l03050"></a>03050 
<a name="l03051"></a>03051                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> g = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp + 2)) &lt;&lt; 8)
<a name="l03052"></a>03052                          + *(sp + 3));
<a name="l03053"></a>03053 
<a name="l03054"></a>03054                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> b = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp + 4)) &lt;&lt; 8)
<a name="l03055"></a>03055                          + *(sp + 5));
<a name="l03056"></a>03056 
<a name="l03057"></a>03057                      <span class="keywordflow">if</span> (r == trans_color-&gt;red &amp;&amp; g == trans_color-&gt;green &amp;&amp;
<a name="l03058"></a>03058                          b == trans_color-&gt;blue)
<a name="l03059"></a>03059                      {
<a name="l03060"></a>03060                         <span class="comment">/* Background is already in screen gamma */</span>
<a name="l03061"></a>03061                         *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;red &gt;&gt; 8) &amp; 0xff);
<a name="l03062"></a>03062                         *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;red &amp; 0xff);
<a name="l03063"></a>03063                         *(sp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;green &gt;&gt; 8) &amp; 0xff);
<a name="l03064"></a>03064                         *(sp + 3) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;green &amp; 0xff);
<a name="l03065"></a>03065                         *(sp + 4) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;blue &gt;&gt; 8) &amp; 0xff);
<a name="l03066"></a>03066                         *(sp + 5) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;blue &amp; 0xff);
<a name="l03067"></a>03067                      }
<a name="l03068"></a>03068 
<a name="l03069"></a>03069                      <span class="keywordflow">else</span>
<a name="l03070"></a>03070                      {
<a name="l03071"></a>03071                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v = gamma_16[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03072"></a>03072                         *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03073"></a>03073                         *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03074"></a>03074 
<a name="l03075"></a>03075                         v = gamma_16[*(sp + 3) &gt;&gt; gamma_shift][*(sp + 2)];
<a name="l03076"></a>03076                         *(sp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03077"></a>03077                         *(sp + 3) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03078"></a>03078 
<a name="l03079"></a>03079                         v = gamma_16[*(sp + 5) &gt;&gt; gamma_shift][*(sp + 4)];
<a name="l03080"></a>03080                         *(sp + 4) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03081"></a>03081                         *(sp + 5) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03082"></a>03082                      }
<a name="l03083"></a>03083                   }
<a name="l03084"></a>03084                }
<a name="l03085"></a>03085 
<a name="l03086"></a>03086                <span class="keywordflow">else</span>
<a name="l03087"></a>03087 <span class="preprocessor">#endif</span>
<a name="l03088"></a>03088 <span class="preprocessor"></span>               {
<a name="l03089"></a>03089                   sp = row;
<a name="l03090"></a>03090                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 6)
<a name="l03091"></a>03091                   {
<a name="l03092"></a>03092                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> r = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*sp) &lt;&lt; 8) + *(sp + 1));
<a name="l03093"></a>03093 
<a name="l03094"></a>03094                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> g = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp + 2)) &lt;&lt; 8)
<a name="l03095"></a>03095                          + *(sp + 3));
<a name="l03096"></a>03096 
<a name="l03097"></a>03097                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> b = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp + 4)) &lt;&lt; 8)
<a name="l03098"></a>03098                          + *(sp + 5));
<a name="l03099"></a>03099 
<a name="l03100"></a>03100                      <span class="keywordflow">if</span> (r == trans_color-&gt;red &amp;&amp; g == trans_color-&gt;green &amp;&amp;
<a name="l03101"></a>03101                          b == trans_color-&gt;blue)
<a name="l03102"></a>03102                      {
<a name="l03103"></a>03103                         *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;red &gt;&gt; 8) &amp; 0xff);
<a name="l03104"></a>03104                         *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;red &amp; 0xff);
<a name="l03105"></a>03105                         *(sp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;green &gt;&gt; 8) &amp; 0xff);
<a name="l03106"></a>03106                         *(sp + 3) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;green &amp; 0xff);
<a name="l03107"></a>03107                         *(sp + 4) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;blue &gt;&gt; 8) &amp; 0xff);
<a name="l03108"></a>03108                         *(sp + 5) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;blue &amp; 0xff);
<a name="l03109"></a>03109                      }
<a name="l03110"></a>03110                   }
<a name="l03111"></a>03111                }
<a name="l03112"></a>03112             }
<a name="l03113"></a>03113             <span class="keywordflow">break</span>;
<a name="l03114"></a>03114          }
<a name="l03115"></a>03115 
<a name="l03116"></a>03116          <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a6f7f3931c163838e2bc3132de2cd4391">PNG_COLOR_TYPE_GRAY_ALPHA</a>:
<a name="l03117"></a>03117          {
<a name="l03118"></a>03118             <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l03119"></a>03119             {
<a name="l03120"></a>03120 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03121"></a>03121 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (gamma_to_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; gamma_from_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l03122"></a>03122                    gamma_table != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03123"></a>03123                {
<a name="l03124"></a>03124                   sp = row;
<a name="l03125"></a>03125                   dp = row;
<a name="l03126"></a>03126                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 2, dp++)
<a name="l03127"></a>03127                   {
<a name="l03128"></a>03128                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> a = *(sp + 1);
<a name="l03129"></a>03129 
<a name="l03130"></a>03130                      <span class="keywordflow">if</span> (a == 0xff)
<a name="l03131"></a>03131                         *dp = gamma_table[*sp];
<a name="l03132"></a>03132 
<a name="l03133"></a>03133                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a == 0)
<a name="l03134"></a>03134                      {
<a name="l03135"></a>03135                         <span class="comment">/* Background is already in screen gamma */</span>
<a name="l03136"></a>03136                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;gray;
<a name="l03137"></a>03137                      }
<a name="l03138"></a>03138 
<a name="l03139"></a>03139                      <span class="keywordflow">else</span>
<a name="l03140"></a>03140                      {
<a name="l03141"></a>03141                         <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> v, w;
<a name="l03142"></a>03142 
<a name="l03143"></a>03143                         v = gamma_to_1[*sp];
<a name="l03144"></a>03144                         <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(w, v, a, background_1-&gt;gray);
<a name="l03145"></a>03145                         *dp = gamma_from_1[w];
<a name="l03146"></a>03146                      }
<a name="l03147"></a>03147                   }
<a name="l03148"></a>03148                }
<a name="l03149"></a>03149                <span class="keywordflow">else</span>
<a name="l03150"></a>03150 <span class="preprocessor">#endif</span>
<a name="l03151"></a>03151 <span class="preprocessor"></span>               {
<a name="l03152"></a>03152                   sp = row;
<a name="l03153"></a>03153                   dp = row;
<a name="l03154"></a>03154                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 2, dp++)
<a name="l03155"></a>03155                   {
<a name="l03156"></a>03156                      <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> a = *(sp + 1);
<a name="l03157"></a>03157 
<a name="l03158"></a>03158                      <span class="keywordflow">if</span> (a == 0xff)
<a name="l03159"></a>03159                         *dp = *sp;
<a name="l03160"></a>03160 
<a name="l03161"></a>03161 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03162"></a>03162 <span class="preprocessor"></span>                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a == 0)
<a name="l03163"></a>03163                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;gray;
<a name="l03164"></a>03164 
<a name="l03165"></a>03165                      <span class="keywordflow">else</span>
<a name="l03166"></a>03166                         <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(*dp, *sp, a, background_1-&gt;gray);
<a name="l03167"></a>03167 
<a name="l03168"></a>03168 <span class="preprocessor">#else</span>
<a name="l03169"></a>03169 <span class="preprocessor"></span>                     *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;gray;
<a name="l03170"></a>03170 #endif
<a name="l03171"></a>03171                   }
<a name="l03172"></a>03172                }
<a name="l03173"></a>03173             }
<a name="l03174"></a>03174             <span class="keywordflow">else</span> <span class="comment">/* if (png_ptr-&gt;bit_depth == 16) */</span>
<a name="l03175"></a>03175             {
<a name="l03176"></a>03176 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03177"></a>03177 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (gamma_16 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; gamma_16_from_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l03178"></a>03178                    gamma_16_to_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03179"></a>03179                {
<a name="l03180"></a>03180                   sp = row;
<a name="l03181"></a>03181                   dp = row;
<a name="l03182"></a>03182                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 4, dp += 2)
<a name="l03183"></a>03183                   {
<a name="l03184"></a>03184                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> a = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp + 2)) &lt;&lt; 8)
<a name="l03185"></a>03185                          + *(sp + 3));
<a name="l03186"></a>03186 
<a name="l03187"></a>03187                      <span class="keywordflow">if</span> (a == (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)0xffff)
<a name="l03188"></a>03188                      {
<a name="l03189"></a>03189                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v;
<a name="l03190"></a>03190 
<a name="l03191"></a>03191                         v = gamma_16[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03192"></a>03192                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03193"></a>03193                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03194"></a>03194                      }
<a name="l03195"></a>03195 
<a name="l03196"></a>03196 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03197"></a>03197 <span class="preprocessor"></span>                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a == 0)
<a name="l03198"></a>03198 <span class="preprocessor">#else</span>
<a name="l03199"></a>03199 <span class="preprocessor"></span>                     <span class="keywordflow">else</span>
<a name="l03200"></a>03200 <span class="preprocessor">#endif</span>
<a name="l03201"></a>03201 <span class="preprocessor"></span>                     {
<a name="l03202"></a>03202                         <span class="comment">/* Background is already in screen gamma */</span>
<a name="l03203"></a>03203                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;gray &gt;&gt; 8) &amp; 0xff);
<a name="l03204"></a>03204                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;gray &amp; 0xff);
<a name="l03205"></a>03205                      }
<a name="l03206"></a>03206 
<a name="l03207"></a>03207 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03208"></a>03208 <span class="preprocessor"></span>                     <span class="keywordflow">else</span>
<a name="l03209"></a>03209                      {
<a name="l03210"></a>03210                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> g, v, w;
<a name="l03211"></a>03211 
<a name="l03212"></a>03212                         g = gamma_16_to_1[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03213"></a>03213                         <a class="code" href="png_8h.html#aad6a62f03f9df908ed63a9fdd97fd460">png_composite_16</a>(v, g, a, background_1-&gt;gray);
<a name="l03214"></a>03214                         w = gamma_16_from_1[(v&amp;0xff) &gt;&gt; gamma_shift][v &gt;&gt; 8];
<a name="l03215"></a>03215                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((w &gt;&gt; 8) &amp; 0xff);
<a name="l03216"></a>03216                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(w &amp; 0xff);
<a name="l03217"></a>03217                      }
<a name="l03218"></a>03218 <span class="preprocessor">#endif</span>
<a name="l03219"></a>03219 <span class="preprocessor"></span>                  }
<a name="l03220"></a>03220                }
<a name="l03221"></a>03221                <span class="keywordflow">else</span>
<a name="l03222"></a>03222 <span class="preprocessor">#endif</span>
<a name="l03223"></a>03223 <span class="preprocessor"></span>               {
<a name="l03224"></a>03224                   sp = row;
<a name="l03225"></a>03225                   dp = row;
<a name="l03226"></a>03226                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 4, dp += 2)
<a name="l03227"></a>03227                   {
<a name="l03228"></a>03228                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> a = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp + 2)) &lt;&lt; 8)
<a name="l03229"></a>03229                          + *(sp + 3));
<a name="l03230"></a>03230 
<a name="l03231"></a>03231                      <span class="keywordflow">if</span> (a == (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)0xffff)
<a name="l03232"></a>03232                         <a class="code" href="pngpriv_8h.html#a142df9a55255d0878cc17a10957acbd9">png_memcpy</a>(dp, sp, 2);
<a name="l03233"></a>03233 
<a name="l03234"></a>03234 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03235"></a>03235 <span class="preprocessor"></span>                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a == 0)
<a name="l03236"></a>03236 <span class="preprocessor">#else</span>
<a name="l03237"></a>03237 <span class="preprocessor"></span>                     <span class="keywordflow">else</span>
<a name="l03238"></a>03238 <span class="preprocessor">#endif</span>
<a name="l03239"></a>03239 <span class="preprocessor"></span>                     {
<a name="l03240"></a>03240                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;gray &gt;&gt; 8) &amp; 0xff);
<a name="l03241"></a>03241                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;gray &amp; 0xff);
<a name="l03242"></a>03242                      }
<a name="l03243"></a>03243 
<a name="l03244"></a>03244 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03245"></a>03245 <span class="preprocessor"></span>                     <span class="keywordflow">else</span>
<a name="l03246"></a>03246                      {
<a name="l03247"></a>03247                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> g, v;
<a name="l03248"></a>03248 
<a name="l03249"></a>03249                         g = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*sp) &lt;&lt; 8) + *(sp + 1));
<a name="l03250"></a>03250                         <a class="code" href="png_8h.html#aad6a62f03f9df908ed63a9fdd97fd460">png_composite_16</a>(v, g, a, background_1-&gt;gray);
<a name="l03251"></a>03251                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03252"></a>03252                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03253"></a>03253                      }
<a name="l03254"></a>03254 <span class="preprocessor">#endif</span>
<a name="l03255"></a>03255 <span class="preprocessor"></span>                  }
<a name="l03256"></a>03256                }
<a name="l03257"></a>03257             }
<a name="l03258"></a>03258             <span class="keywordflow">break</span>;
<a name="l03259"></a>03259          }
<a name="l03260"></a>03260 
<a name="l03261"></a>03261          <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a>:
<a name="l03262"></a>03262          {
<a name="l03263"></a>03263             <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l03264"></a>03264             {
<a name="l03265"></a>03265 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03266"></a>03266 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (gamma_to_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; gamma_from_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l03267"></a>03267                    gamma_table != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03268"></a>03268                {
<a name="l03269"></a>03269                   sp = row;
<a name="l03270"></a>03270                   dp = row;
<a name="l03271"></a>03271                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 4, dp += 3)
<a name="l03272"></a>03272                   {
<a name="l03273"></a>03273                      <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> a = *(sp + 3);
<a name="l03274"></a>03274 
<a name="l03275"></a>03275                      <span class="keywordflow">if</span> (a == 0xff)
<a name="l03276"></a>03276                      {
<a name="l03277"></a>03277                         *dp = gamma_table[*sp];
<a name="l03278"></a>03278                         *(dp + 1) = gamma_table[*(sp + 1)];
<a name="l03279"></a>03279                         *(dp + 2) = gamma_table[*(sp + 2)];
<a name="l03280"></a>03280                      }
<a name="l03281"></a>03281 
<a name="l03282"></a>03282                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a == 0)
<a name="l03283"></a>03283                      {
<a name="l03284"></a>03284                         <span class="comment">/* Background is already in screen gamma */</span>
<a name="l03285"></a>03285                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;red;
<a name="l03286"></a>03286                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;green;
<a name="l03287"></a>03287                         *(dp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;blue;
<a name="l03288"></a>03288                      }
<a name="l03289"></a>03289 
<a name="l03290"></a>03290                      <span class="keywordflow">else</span>
<a name="l03291"></a>03291                      {
<a name="l03292"></a>03292                         <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> v, w;
<a name="l03293"></a>03293 
<a name="l03294"></a>03294                         v = gamma_to_1[*sp];
<a name="l03295"></a>03295                         <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(w, v, a, background_1-&gt;red);
<a name="l03296"></a>03296                         *dp = gamma_from_1[w];
<a name="l03297"></a>03297 
<a name="l03298"></a>03298                         v = gamma_to_1[*(sp + 1)];
<a name="l03299"></a>03299                         <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(w, v, a, background_1-&gt;green);
<a name="l03300"></a>03300                         *(dp + 1) = gamma_from_1[w];
<a name="l03301"></a>03301 
<a name="l03302"></a>03302                         v = gamma_to_1[*(sp + 2)];
<a name="l03303"></a>03303                         <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(w, v, a, background_1-&gt;blue);
<a name="l03304"></a>03304                         *(dp + 2) = gamma_from_1[w];
<a name="l03305"></a>03305                      }
<a name="l03306"></a>03306                   }
<a name="l03307"></a>03307                }
<a name="l03308"></a>03308                <span class="keywordflow">else</span>
<a name="l03309"></a>03309 <span class="preprocessor">#endif</span>
<a name="l03310"></a>03310 <span class="preprocessor"></span>               {
<a name="l03311"></a>03311                   sp = row;
<a name="l03312"></a>03312                   dp = row;
<a name="l03313"></a>03313                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 4, dp += 3)
<a name="l03314"></a>03314                   {
<a name="l03315"></a>03315                      <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> a = *(sp + 3);
<a name="l03316"></a>03316 
<a name="l03317"></a>03317                      <span class="keywordflow">if</span> (a == 0xff)
<a name="l03318"></a>03318                      {
<a name="l03319"></a>03319                         *dp = *sp;
<a name="l03320"></a>03320                         *(dp + 1) = *(sp + 1);
<a name="l03321"></a>03321                         *(dp + 2) = *(sp + 2);
<a name="l03322"></a>03322                      }
<a name="l03323"></a>03323 
<a name="l03324"></a>03324                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a == 0)
<a name="l03325"></a>03325                      {
<a name="l03326"></a>03326                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;red;
<a name="l03327"></a>03327                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;green;
<a name="l03328"></a>03328                         *(dp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)background-&gt;blue;
<a name="l03329"></a>03329                      }
<a name="l03330"></a>03330 
<a name="l03331"></a>03331                      <span class="keywordflow">else</span>
<a name="l03332"></a>03332                      {
<a name="l03333"></a>03333                         <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(*dp, *sp, a, background-&gt;red);
<a name="l03334"></a>03334 
<a name="l03335"></a>03335                         <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(*(dp + 1), *(sp + 1), a,
<a name="l03336"></a>03336                             background-&gt;green);
<a name="l03337"></a>03337 
<a name="l03338"></a>03338                         <a class="code" href="png_8h.html#a395a53aed8c31cb3897e3cc78df2f12b">png_composite</a>(*(dp + 2), *(sp + 2), a,
<a name="l03339"></a>03339                             background-&gt;blue);
<a name="l03340"></a>03340                      }
<a name="l03341"></a>03341                   }
<a name="l03342"></a>03342                }
<a name="l03343"></a>03343             }
<a name="l03344"></a>03344             <span class="keywordflow">else</span> <span class="comment">/* if (row_info-&gt;bit_depth == 16) */</span>
<a name="l03345"></a>03345             {
<a name="l03346"></a>03346 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03347"></a>03347 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (gamma_16 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; gamma_16_from_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l03348"></a>03348                    gamma_16_to_1 != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03349"></a>03349                {
<a name="l03350"></a>03350                   sp = row;
<a name="l03351"></a>03351                   dp = row;
<a name="l03352"></a>03352                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 8, dp += 6)
<a name="l03353"></a>03353                   {
<a name="l03354"></a>03354                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> a = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(*(sp + 6))
<a name="l03355"></a>03355                          &lt;&lt; 8) + (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(*(sp + 7)));
<a name="l03356"></a>03356 
<a name="l03357"></a>03357                      <span class="keywordflow">if</span> (a == (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)0xffff)
<a name="l03358"></a>03358                      {
<a name="l03359"></a>03359                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v;
<a name="l03360"></a>03360 
<a name="l03361"></a>03361                         v = gamma_16[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03362"></a>03362                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03363"></a>03363                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03364"></a>03364 
<a name="l03365"></a>03365                         v = gamma_16[*(sp + 3) &gt;&gt; gamma_shift][*(sp + 2)];
<a name="l03366"></a>03366                         *(dp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03367"></a>03367                         *(dp + 3) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03368"></a>03368 
<a name="l03369"></a>03369                         v = gamma_16[*(sp + 5) &gt;&gt; gamma_shift][*(sp + 4)];
<a name="l03370"></a>03370                         *(dp + 4) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03371"></a>03371                         *(dp + 5) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03372"></a>03372                      }
<a name="l03373"></a>03373 
<a name="l03374"></a>03374                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a == 0)
<a name="l03375"></a>03375                      {
<a name="l03376"></a>03376                         <span class="comment">/* Background is already in screen gamma */</span>
<a name="l03377"></a>03377                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;red &gt;&gt; 8) &amp; 0xff);
<a name="l03378"></a>03378                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;red &amp; 0xff);
<a name="l03379"></a>03379                         *(dp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;green &gt;&gt; 8) &amp; 0xff);
<a name="l03380"></a>03380                         *(dp + 3) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;green &amp; 0xff);
<a name="l03381"></a>03381                         *(dp + 4) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;blue &gt;&gt; 8) &amp; 0xff);
<a name="l03382"></a>03382                         *(dp + 5) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;blue &amp; 0xff);
<a name="l03383"></a>03383                      }
<a name="l03384"></a>03384 
<a name="l03385"></a>03385                      <span class="keywordflow">else</span>
<a name="l03386"></a>03386                      {
<a name="l03387"></a>03387                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v, w, x;
<a name="l03388"></a>03388 
<a name="l03389"></a>03389                         v = gamma_16_to_1[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03390"></a>03390                         <a class="code" href="png_8h.html#aad6a62f03f9df908ed63a9fdd97fd460">png_composite_16</a>(w, v, a, background_1-&gt;red);
<a name="l03391"></a>03391 
<a name="l03392"></a>03392                         x = gamma_16_from_1[((w&amp;0xff) &gt;&gt; gamma_shift)][w &gt;&gt; 8];
<a name="l03393"></a>03393                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((x &gt;&gt; 8) &amp; 0xff);
<a name="l03394"></a>03394                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(x &amp; 0xff);
<a name="l03395"></a>03395 
<a name="l03396"></a>03396                         v = gamma_16_to_1[*(sp + 3) &gt;&gt; gamma_shift][*(sp + 2)];
<a name="l03397"></a>03397                         <a class="code" href="png_8h.html#aad6a62f03f9df908ed63a9fdd97fd460">png_composite_16</a>(w, v, a, background_1-&gt;green);
<a name="l03398"></a>03398 
<a name="l03399"></a>03399                         x = gamma_16_from_1[((w&amp;0xff) &gt;&gt; gamma_shift)][w &gt;&gt; 8];
<a name="l03400"></a>03400                         *(dp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((x &gt;&gt; 8) &amp; 0xff);
<a name="l03401"></a>03401                         *(dp + 3) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(x &amp; 0xff);
<a name="l03402"></a>03402 
<a name="l03403"></a>03403                         v = gamma_16_to_1[*(sp + 5) &gt;&gt; gamma_shift][*(sp + 4)];
<a name="l03404"></a>03404                         <a class="code" href="png_8h.html#aad6a62f03f9df908ed63a9fdd97fd460">png_composite_16</a>(w, v, a, background_1-&gt;blue);
<a name="l03405"></a>03405 
<a name="l03406"></a>03406                         x = gamma_16_from_1[(w &amp; 0xff) &gt;&gt; gamma_shift][w &gt;&gt; 8];
<a name="l03407"></a>03407                         *(dp + 4) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((x &gt;&gt; 8) &amp; 0xff);
<a name="l03408"></a>03408                         *(dp + 5) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(x &amp; 0xff);
<a name="l03409"></a>03409                      }
<a name="l03410"></a>03410                   }
<a name="l03411"></a>03411                }
<a name="l03412"></a>03412 
<a name="l03413"></a>03413                <span class="keywordflow">else</span>
<a name="l03414"></a>03414 <span class="preprocessor">#endif</span>
<a name="l03415"></a>03415 <span class="preprocessor"></span>               {
<a name="l03416"></a>03416                   sp = row;
<a name="l03417"></a>03417                   dp = row;
<a name="l03418"></a>03418                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp += 8, dp += 6)
<a name="l03419"></a>03419                   {
<a name="l03420"></a>03420                      <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> a = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(*(sp + 6))
<a name="l03421"></a>03421                          &lt;&lt; 8) + (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(*(sp + 7)));
<a name="l03422"></a>03422 
<a name="l03423"></a>03423                      <span class="keywordflow">if</span> (a == (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)0xffff)
<a name="l03424"></a>03424                      {
<a name="l03425"></a>03425                         <a class="code" href="pngpriv_8h.html#a142df9a55255d0878cc17a10957acbd9">png_memcpy</a>(dp, sp, 6);
<a name="l03426"></a>03426                      }
<a name="l03427"></a>03427 
<a name="l03428"></a>03428                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a == 0)
<a name="l03429"></a>03429                      {
<a name="l03430"></a>03430                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;red &gt;&gt; 8) &amp; 0xff);
<a name="l03431"></a>03431                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;red &amp; 0xff);
<a name="l03432"></a>03432                         *(dp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;green &gt;&gt; 8) &amp; 0xff);
<a name="l03433"></a>03433                         *(dp + 3) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;green &amp; 0xff);
<a name="l03434"></a>03434                         *(dp + 4) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((background-&gt;blue &gt;&gt; 8) &amp; 0xff);
<a name="l03435"></a>03435                         *(dp + 5) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(background-&gt;blue &amp; 0xff);
<a name="l03436"></a>03436                      }
<a name="l03437"></a>03437 
<a name="l03438"></a>03438                      <span class="keywordflow">else</span>
<a name="l03439"></a>03439                      {
<a name="l03440"></a>03440                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v;
<a name="l03441"></a>03441 
<a name="l03442"></a>03442                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> r = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*sp) &lt;&lt; 8) + *(sp + 1));
<a name="l03443"></a>03443                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> g = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp + 2)) &lt;&lt; 8)
<a name="l03444"></a>03444                             + *(sp + 3));
<a name="l03445"></a>03445                         <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> b = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(((*(sp + 4)) &lt;&lt; 8)
<a name="l03446"></a>03446                             + *(sp + 5));
<a name="l03447"></a>03447 
<a name="l03448"></a>03448                         <a class="code" href="png_8h.html#aad6a62f03f9df908ed63a9fdd97fd460">png_composite_16</a>(v, r, a, background-&gt;red);
<a name="l03449"></a>03449                         *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03450"></a>03450                         *(dp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03451"></a>03451 
<a name="l03452"></a>03452                         <a class="code" href="png_8h.html#aad6a62f03f9df908ed63a9fdd97fd460">png_composite_16</a>(v, g, a, background-&gt;green);
<a name="l03453"></a>03453                         *(dp + 2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03454"></a>03454                         *(dp + 3) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03455"></a>03455 
<a name="l03456"></a>03456                         <a class="code" href="png_8h.html#aad6a62f03f9df908ed63a9fdd97fd460">png_composite_16</a>(v, b, a, background-&gt;blue);
<a name="l03457"></a>03457                         *(dp + 4) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03458"></a>03458                         *(dp + 5) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03459"></a>03459                      }
<a name="l03460"></a>03460                   }
<a name="l03461"></a>03461                }
<a name="l03462"></a>03462             }
<a name="l03463"></a>03463             <span class="keywordflow">break</span>;
<a name="l03464"></a>03464          }
<a name="l03465"></a>03465 
<a name="l03466"></a>03466          <span class="keywordflow">default</span>:
<a name="l03467"></a>03467             <span class="keywordflow">break</span>;
<a name="l03468"></a>03468       }
<a name="l03469"></a>03469 
<a name="l03470"></a>03470       <span class="keywordflow">if</span> (row_info-&gt;color_type &amp; <a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>)
<a name="l03471"></a>03471       {
<a name="l03472"></a>03472          row_info-&gt;color_type = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(row_info-&gt;color_type &amp;
<a name="l03473"></a>03473              ~<a class="code" href="png_8h.html#ab491f373e80fdc4595fc0b0d3b277623">PNG_COLOR_MASK_ALPHA</a>);
<a name="l03474"></a>03474          row_info-&gt;channels--;
<a name="l03475"></a>03475          row_info-&gt;pixel_depth = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(row_info-&gt;channels *
<a name="l03476"></a>03476              row_info-&gt;bit_depth);
<a name="l03477"></a>03477          row_info-&gt;rowbytes = <a class="code" href="pngpriv_8h.html#a18a47644e4b7cd60bb2b4a8c82d53f30">PNG_ROWBYTES</a>(row_info-&gt;pixel_depth, row_width);
<a name="l03478"></a>03478       }
<a name="l03479"></a>03479    }
<a name="l03480"></a>03480 }
<a name="l03481"></a>03481 <span class="preprocessor">#endif</span>
<a name="l03482"></a>03482 <span class="preprocessor"></span>
<a name="l03483"></a>03483 <span class="preprocessor">#ifdef PNG_READ_GAMMA_SUPPORTED</span>
<a name="l03484"></a>03484 <span class="preprocessor"></span><span class="comment">/* Gamma correct the image, avoiding the alpha channel.  Make sure</span>
<a name="l03485"></a>03485 <span class="comment"> * you do this after you deal with the transparency issue on grayscale</span>
<a name="l03486"></a>03486 <span class="comment"> * or RGB images. If your bit depth is 8, use gamma_table, if it</span>
<a name="l03487"></a>03487 <span class="comment"> * is 16, use gamma_16_table and gamma_shift.  Build these with</span>
<a name="l03488"></a>03488 <span class="comment"> * build_gamma_table().</span>
<a name="l03489"></a>03489 <span class="comment"> */</span>
<a name="l03490"></a>03490 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l03491"></a><a class="code" href="pngrtran_8c.html#a6506bd6efb94f82c38bd52191e686ba9">03491</a> <a class="code" href="pngrtran_8c.html#a6506bd6efb94f82c38bd52191e686ba9">png_do_gamma</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row,
<a name="l03492"></a>03492     <a class="code" href="pngconf_8h.html#a53e11f2ed74ffe5e45513458517b8af3">png_const_bytep</a> gamma_table, <a class="code" href="pngpriv_8h.html#a5518933563c30291321e86b66d4ad36d">png_const_uint_16pp</a> gamma_16_table,
<a name="l03493"></a>03493     <span class="keywordtype">int</span> gamma_shift)
<a name="l03494"></a>03494 {
<a name="l03495"></a>03495    <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp;
<a name="l03496"></a>03496    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l03497"></a>03497    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width=row_info-&gt;width;
<a name="l03498"></a>03498 
<a name="l03499"></a>03499    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_gamma&quot;</span>);
<a name="l03500"></a>03500 
<a name="l03501"></a>03501    <span class="keywordflow">if</span> (((row_info-&gt;bit_depth &lt;= 8 &amp;&amp; gamma_table != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ||
<a name="l03502"></a>03502        (row_info-&gt;bit_depth == 16 &amp;&amp; gamma_16_table != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l03503"></a>03503    {
<a name="l03504"></a>03504       <span class="keywordflow">switch</span> (row_info-&gt;color_type)
<a name="l03505"></a>03505       {
<a name="l03506"></a>03506          <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a>:
<a name="l03507"></a>03507          {
<a name="l03508"></a>03508             <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l03509"></a>03509             {
<a name="l03510"></a>03510                sp = row;
<a name="l03511"></a>03511                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03512"></a>03512                {
<a name="l03513"></a>03513                   *sp = gamma_table[*sp];
<a name="l03514"></a>03514                   sp++;
<a name="l03515"></a>03515                   *sp = gamma_table[*sp];
<a name="l03516"></a>03516                   sp++;
<a name="l03517"></a>03517                   *sp = gamma_table[*sp];
<a name="l03518"></a>03518                   sp++;
<a name="l03519"></a>03519                }
<a name="l03520"></a>03520             }
<a name="l03521"></a>03521 
<a name="l03522"></a>03522             <span class="keywordflow">else</span> <span class="comment">/* if (row_info-&gt;bit_depth == 16) */</span>
<a name="l03523"></a>03523             {
<a name="l03524"></a>03524                sp = row;
<a name="l03525"></a>03525                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03526"></a>03526                {
<a name="l03527"></a>03527                   <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v;
<a name="l03528"></a>03528 
<a name="l03529"></a>03529                   v = gamma_16_table[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03530"></a>03530                   *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03531"></a>03531                   *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03532"></a>03532                   sp += 2;
<a name="l03533"></a>03533 
<a name="l03534"></a>03534                   v = gamma_16_table[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03535"></a>03535                   *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03536"></a>03536                   *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03537"></a>03537                   sp += 2;
<a name="l03538"></a>03538 
<a name="l03539"></a>03539                   v = gamma_16_table[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03540"></a>03540                   *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03541"></a>03541                   *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03542"></a>03542                   sp += 2;
<a name="l03543"></a>03543                }
<a name="l03544"></a>03544             }
<a name="l03545"></a>03545             <span class="keywordflow">break</span>;
<a name="l03546"></a>03546          }
<a name="l03547"></a>03547 
<a name="l03548"></a>03548          <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a>:
<a name="l03549"></a>03549          {
<a name="l03550"></a>03550             <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l03551"></a>03551             {
<a name="l03552"></a>03552                sp = row;
<a name="l03553"></a>03553                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03554"></a>03554                {
<a name="l03555"></a>03555                   *sp = gamma_table[*sp];
<a name="l03556"></a>03556                   sp++;
<a name="l03557"></a>03557 
<a name="l03558"></a>03558                   *sp = gamma_table[*sp];
<a name="l03559"></a>03559                   sp++;
<a name="l03560"></a>03560 
<a name="l03561"></a>03561                   *sp = gamma_table[*sp];
<a name="l03562"></a>03562                   sp++;
<a name="l03563"></a>03563 
<a name="l03564"></a>03564                   sp++;
<a name="l03565"></a>03565                }
<a name="l03566"></a>03566             }
<a name="l03567"></a>03567 
<a name="l03568"></a>03568             <span class="keywordflow">else</span> <span class="comment">/* if (row_info-&gt;bit_depth == 16) */</span>
<a name="l03569"></a>03569             {
<a name="l03570"></a>03570                sp = row;
<a name="l03571"></a>03571                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03572"></a>03572                {
<a name="l03573"></a>03573                   <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v = gamma_16_table[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03574"></a>03574                   *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03575"></a>03575                   *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03576"></a>03576                   sp += 2;
<a name="l03577"></a>03577 
<a name="l03578"></a>03578                   v = gamma_16_table[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03579"></a>03579                   *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03580"></a>03580                   *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03581"></a>03581                   sp += 2;
<a name="l03582"></a>03582 
<a name="l03583"></a>03583                   v = gamma_16_table[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03584"></a>03584                   *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03585"></a>03585                   *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03586"></a>03586                   sp += 4;
<a name="l03587"></a>03587                }
<a name="l03588"></a>03588             }
<a name="l03589"></a>03589             <span class="keywordflow">break</span>;
<a name="l03590"></a>03590          }
<a name="l03591"></a>03591 
<a name="l03592"></a>03592          <span class="keywordflow">case</span> <a class="code" href="png_8h.html#a6f7f3931c163838e2bc3132de2cd4391">PNG_COLOR_TYPE_GRAY_ALPHA</a>:
<a name="l03593"></a>03593          {
<a name="l03594"></a>03594             <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l03595"></a>03595             {
<a name="l03596"></a>03596                sp = row;
<a name="l03597"></a>03597                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03598"></a>03598                {
<a name="l03599"></a>03599                   *sp = gamma_table[*sp];
<a name="l03600"></a>03600                   sp += 2;
<a name="l03601"></a>03601                }
<a name="l03602"></a>03602             }
<a name="l03603"></a>03603 
<a name="l03604"></a>03604             <span class="keywordflow">else</span> <span class="comment">/* if (row_info-&gt;bit_depth == 16) */</span>
<a name="l03605"></a>03605             {
<a name="l03606"></a>03606                sp = row;
<a name="l03607"></a>03607                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03608"></a>03608                {
<a name="l03609"></a>03609                   <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v = gamma_16_table[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03610"></a>03610                   *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03611"></a>03611                   *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03612"></a>03612                   sp += 4;
<a name="l03613"></a>03613                }
<a name="l03614"></a>03614             }
<a name="l03615"></a>03615             <span class="keywordflow">break</span>;
<a name="l03616"></a>03616          }
<a name="l03617"></a>03617 
<a name="l03618"></a>03618          <span class="keywordflow">case</span> <a class="code" href="png_8h.html#ac679619ad9d3f2c46c2b69fe65bd19f1">PNG_COLOR_TYPE_GRAY</a>:
<a name="l03619"></a>03619          {
<a name="l03620"></a>03620             <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 2)
<a name="l03621"></a>03621             {
<a name="l03622"></a>03622                sp = row;
<a name="l03623"></a>03623                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i += 4)
<a name="l03624"></a>03624                {
<a name="l03625"></a>03625                   <span class="keywordtype">int</span> a = *sp &amp; 0xc0;
<a name="l03626"></a>03626                   <span class="keywordtype">int</span> b = *sp &amp; 0x30;
<a name="l03627"></a>03627                   <span class="keywordtype">int</span> c = *sp &amp; 0x0c;
<a name="l03628"></a>03628                   <span class="keywordtype">int</span> d = *sp &amp; 0x03;
<a name="l03629"></a>03629 
<a name="l03630"></a>03630                   *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(
<a name="l03631"></a>03631                       ((((<span class="keywordtype">int</span>)gamma_table[a|(a&gt;&gt;2)|(a&gt;&gt;4)|(a&gt;&gt;6)])   ) &amp; 0xc0)|
<a name="l03632"></a>03632                       ((((int)gamma_table[(b&lt;&lt;2)|b|(b&gt;&gt;2)|(b&gt;&gt;4)])&gt;&gt;2) &amp; 0x30)|
<a name="l03633"></a>03633                       ((((<span class="keywordtype">int</span>)gamma_table[(c&lt;&lt;4)|(c&lt;&lt;2)|c|(c&gt;&gt;2)])&gt;&gt;4) &amp; 0x0c)|
<a name="l03634"></a>03634                       ((((int)gamma_table[(d&lt;&lt;6)|(d&lt;&lt;4)|(d&lt;&lt;2)|d])&gt;&gt;6) ));
<a name="l03635"></a>03635                   sp++;
<a name="l03636"></a>03636                }
<a name="l03637"></a>03637             }
<a name="l03638"></a>03638 
<a name="l03639"></a>03639             <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 4)
<a name="l03640"></a>03640             {
<a name="l03641"></a>03641                sp = row;
<a name="l03642"></a>03642                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i += 2)
<a name="l03643"></a>03643                {
<a name="l03644"></a>03644                   <span class="keywordtype">int</span> msb = *sp &amp; 0xf0;
<a name="l03645"></a>03645                   <span class="keywordtype">int</span> lsb = *sp &amp; 0x0f;
<a name="l03646"></a>03646 
<a name="l03647"></a>03647                   *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((((<span class="keywordtype">int</span>)gamma_table[msb | (msb &gt;&gt; 4)]) &amp; 0xf0)
<a name="l03648"></a>03648                       | (((<span class="keywordtype">int</span>)gamma_table[(lsb &lt;&lt; 4) | lsb]) &gt;&gt; 4));
<a name="l03649"></a>03649                   sp++;
<a name="l03650"></a>03650                }
<a name="l03651"></a>03651             }
<a name="l03652"></a>03652 
<a name="l03653"></a>03653             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l03654"></a>03654             {
<a name="l03655"></a>03655                sp = row;
<a name="l03656"></a>03656                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03657"></a>03657                {
<a name="l03658"></a>03658                   *sp = gamma_table[*sp];
<a name="l03659"></a>03659                   sp++;
<a name="l03660"></a>03660                }
<a name="l03661"></a>03661             }
<a name="l03662"></a>03662 
<a name="l03663"></a>03663             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 16)
<a name="l03664"></a>03664             {
<a name="l03665"></a>03665                sp = row;
<a name="l03666"></a>03666                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03667"></a>03667                {
<a name="l03668"></a>03668                   <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> v = gamma_16_table[*(sp + 1) &gt;&gt; gamma_shift][*sp];
<a name="l03669"></a>03669                   *sp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((v &gt;&gt; 8) &amp; 0xff);
<a name="l03670"></a>03670                   *(sp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(v &amp; 0xff);
<a name="l03671"></a>03671                   sp += 2;
<a name="l03672"></a>03672                }
<a name="l03673"></a>03673             }
<a name="l03674"></a>03674             <span class="keywordflow">break</span>;
<a name="l03675"></a>03675          }
<a name="l03676"></a>03676 
<a name="l03677"></a>03677          <span class="keywordflow">default</span>:
<a name="l03678"></a>03678             <span class="keywordflow">break</span>;
<a name="l03679"></a>03679       }
<a name="l03680"></a>03680    }
<a name="l03681"></a>03681 }
<a name="l03682"></a>03682 <span class="preprocessor">#endif</span>
<a name="l03683"></a>03683 <span class="preprocessor"></span>
<a name="l03684"></a>03684 <span class="preprocessor">#ifdef PNG_READ_EXPAND_SUPPORTED</span>
<a name="l03685"></a>03685 <span class="preprocessor"></span><span class="comment">/* Expands a palette row to an RGB or RGBA row depending</span>
<a name="l03686"></a>03686 <span class="comment"> * upon whether you supply trans and num_trans.</span>
<a name="l03687"></a>03687 <span class="comment"> */</span>
<a name="l03688"></a>03688 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l03689"></a><a class="code" href="pngrtran_8c.html#a490d6794b731f4fc833b290d438c05cc">03689</a> <a class="code" href="pngrtran_8c.html#a490d6794b731f4fc833b290d438c05cc">png_do_expand_palette</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row,
<a name="l03690"></a>03690    <a class="code" href="png_8h.html#a1ce0de6c9263881c96409aa45bf995c6">png_const_colorp</a> palette, <a class="code" href="pngconf_8h.html#a53e11f2ed74ffe5e45513458517b8af3">png_const_bytep</a> trans_alpha, <span class="keywordtype">int</span> num_trans)
<a name="l03691"></a>03691 {
<a name="l03692"></a>03692    <span class="keywordtype">int</span> shift, value;
<a name="l03693"></a>03693    <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp, dp;
<a name="l03694"></a>03694    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l03695"></a>03695    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width=row_info-&gt;width;
<a name="l03696"></a>03696 
<a name="l03697"></a>03697    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_expand_palette&quot;</span>);
<a name="l03698"></a>03698 
<a name="l03699"></a>03699    <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>)
<a name="l03700"></a>03700    {
<a name="l03701"></a>03701       <span class="keywordflow">if</span> (row_info-&gt;bit_depth &lt; 8)
<a name="l03702"></a>03702       {
<a name="l03703"></a>03703          <span class="keywordflow">switch</span> (row_info-&gt;bit_depth)
<a name="l03704"></a>03704          {
<a name="l03705"></a>03705             <span class="keywordflow">case</span> 1:
<a name="l03706"></a>03706             {
<a name="l03707"></a>03707                sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)((row_width - 1) &gt;&gt; 3);
<a name="l03708"></a>03708                dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l03709"></a>03709                shift = 7 - (int)((row_width + 7) &amp; 0x07);
<a name="l03710"></a>03710                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03711"></a>03711                {
<a name="l03712"></a>03712                   <span class="keywordflow">if</span> ((*sp &gt;&gt; shift) &amp; 0x01)
<a name="l03713"></a>03713                      *dp = 1;
<a name="l03714"></a>03714 
<a name="l03715"></a>03715                   <span class="keywordflow">else</span>
<a name="l03716"></a>03716                      *dp = 0;
<a name="l03717"></a>03717 
<a name="l03718"></a>03718                   <span class="keywordflow">if</span> (shift == 7)
<a name="l03719"></a>03719                   {
<a name="l03720"></a>03720                      shift = 0;
<a name="l03721"></a>03721                      sp--;
<a name="l03722"></a>03722                   }
<a name="l03723"></a>03723 
<a name="l03724"></a>03724                   <span class="keywordflow">else</span>
<a name="l03725"></a>03725                      shift++;
<a name="l03726"></a>03726 
<a name="l03727"></a>03727                   dp--;
<a name="l03728"></a>03728                }
<a name="l03729"></a>03729                <span class="keywordflow">break</span>;
<a name="l03730"></a>03730             }
<a name="l03731"></a>03731 
<a name="l03732"></a>03732             <span class="keywordflow">case</span> 2:
<a name="l03733"></a>03733             {
<a name="l03734"></a>03734                sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)((row_width - 1) &gt;&gt; 2);
<a name="l03735"></a>03735                dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l03736"></a>03736                shift = (int)((3 - ((row_width + 3) &amp; 0x03)) &lt;&lt; 1);
<a name="l03737"></a>03737                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03738"></a>03738                {
<a name="l03739"></a>03739                   value = (*sp &gt;&gt; shift) &amp; 0x03;
<a name="l03740"></a>03740                   *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)value;
<a name="l03741"></a>03741                   <span class="keywordflow">if</span> (shift == 6)
<a name="l03742"></a>03742                   {
<a name="l03743"></a>03743                      shift = 0;
<a name="l03744"></a>03744                      sp--;
<a name="l03745"></a>03745                   }
<a name="l03746"></a>03746 
<a name="l03747"></a>03747                   <span class="keywordflow">else</span>
<a name="l03748"></a>03748                      shift += 2;
<a name="l03749"></a>03749 
<a name="l03750"></a>03750                   dp--;
<a name="l03751"></a>03751                }
<a name="l03752"></a>03752                <span class="keywordflow">break</span>;
<a name="l03753"></a>03753             }
<a name="l03754"></a>03754 
<a name="l03755"></a>03755             <span class="keywordflow">case</span> 4:
<a name="l03756"></a>03756             {
<a name="l03757"></a>03757                sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)((row_width - 1) &gt;&gt; 1);
<a name="l03758"></a>03758                dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l03759"></a>03759                shift = (int)((row_width &amp; 0x01) &lt;&lt; 2);
<a name="l03760"></a>03760                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03761"></a>03761                {
<a name="l03762"></a>03762                   value = (*sp &gt;&gt; shift) &amp; 0x0f;
<a name="l03763"></a>03763                   *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)value;
<a name="l03764"></a>03764                   <span class="keywordflow">if</span> (shift == 4)
<a name="l03765"></a>03765                   {
<a name="l03766"></a>03766                      shift = 0;
<a name="l03767"></a>03767                      sp--;
<a name="l03768"></a>03768                   }
<a name="l03769"></a>03769 
<a name="l03770"></a>03770                   <span class="keywordflow">else</span>
<a name="l03771"></a>03771                      shift += 4;
<a name="l03772"></a>03772 
<a name="l03773"></a>03773                   dp--;
<a name="l03774"></a>03774                }
<a name="l03775"></a>03775                <span class="keywordflow">break</span>;
<a name="l03776"></a>03776             }
<a name="l03777"></a>03777 
<a name="l03778"></a>03778             <span class="keywordflow">default</span>:
<a name="l03779"></a>03779                <span class="keywordflow">break</span>;
<a name="l03780"></a>03780          }
<a name="l03781"></a>03781          row_info-&gt;bit_depth = 8;
<a name="l03782"></a>03782          row_info-&gt;pixel_depth = 8;
<a name="l03783"></a>03783          row_info-&gt;rowbytes = row_width;
<a name="l03784"></a>03784       }
<a name="l03785"></a>03785 
<a name="l03786"></a>03786       <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l03787"></a>03787       {
<a name="l03788"></a>03788          {
<a name="l03789"></a>03789             <span class="keywordflow">if</span> (trans_alpha != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03790"></a>03790             {
<a name="l03791"></a>03791                sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l03792"></a>03792                dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)(row_width &lt;&lt; 2) - 1;
<a name="l03793"></a>03793 
<a name="l03794"></a>03794                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03795"></a>03795                {
<a name="l03796"></a>03796                   <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)(*sp) &gt;= num_trans)
<a name="l03797"></a>03797                      *dp-- = 0xff;
<a name="l03798"></a>03798 
<a name="l03799"></a>03799                   <span class="keywordflow">else</span>
<a name="l03800"></a>03800                      *dp-- = trans_alpha[*sp];
<a name="l03801"></a>03801 
<a name="l03802"></a>03802                   *dp-- = palette[*sp].blue;
<a name="l03803"></a>03803                   *dp-- = palette[*sp].green;
<a name="l03804"></a>03804                   *dp-- = palette[*sp].red;
<a name="l03805"></a>03805                   sp--;
<a name="l03806"></a>03806                }
<a name="l03807"></a>03807                row_info-&gt;bit_depth = 8;
<a name="l03808"></a>03808                row_info-&gt;pixel_depth = 32;
<a name="l03809"></a>03809                row_info-&gt;rowbytes = row_width * 4;
<a name="l03810"></a>03810                row_info-&gt;color_type = 6;
<a name="l03811"></a>03811                row_info-&gt;channels = 4;
<a name="l03812"></a>03812             }
<a name="l03813"></a>03813 
<a name="l03814"></a>03814             <span class="keywordflow">else</span>
<a name="l03815"></a>03815             {
<a name="l03816"></a>03816                sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l03817"></a>03817                dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)(row_width * 3) - 1;
<a name="l03818"></a>03818 
<a name="l03819"></a>03819                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03820"></a>03820                {
<a name="l03821"></a>03821                   *dp-- = palette[*sp].blue;
<a name="l03822"></a>03822                   *dp-- = palette[*sp].green;
<a name="l03823"></a>03823                   *dp-- = palette[*sp].red;
<a name="l03824"></a>03824                   sp--;
<a name="l03825"></a>03825                }
<a name="l03826"></a>03826 
<a name="l03827"></a>03827                row_info-&gt;bit_depth = 8;
<a name="l03828"></a>03828                row_info-&gt;pixel_depth = 24;
<a name="l03829"></a>03829                row_info-&gt;rowbytes = row_width * 3;
<a name="l03830"></a>03830                row_info-&gt;color_type = 2;
<a name="l03831"></a>03831                row_info-&gt;channels = 3;
<a name="l03832"></a>03832             }
<a name="l03833"></a>03833          }
<a name="l03834"></a>03834       }
<a name="l03835"></a>03835    }
<a name="l03836"></a>03836 }
<a name="l03837"></a>03837 
<a name="l03838"></a>03838 <span class="comment">/* If the bit depth &lt; 8, it is expanded to 8.  Also, if the already</span>
<a name="l03839"></a>03839 <span class="comment"> * expanded transparency value is supplied, an alpha channel is built.</span>
<a name="l03840"></a>03840 <span class="comment"> */</span>
<a name="l03841"></a>03841 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l03842"></a><a class="code" href="pngrtran_8c.html#a11ab75ae810cda508df3305a3e78f7bd">03842</a> <a class="code" href="pngrtran_8c.html#a11ab75ae810cda508df3305a3e78f7bd">png_do_expand</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row,
<a name="l03843"></a>03843     <a class="code" href="png_8h.html#ab40f2d0b64d6dedbdcfabdaada204863">png_const_color_16p</a> trans_value)
<a name="l03844"></a>03844 {
<a name="l03845"></a>03845    <span class="keywordtype">int</span> shift, value;
<a name="l03846"></a>03846    <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp, dp;
<a name="l03847"></a>03847    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l03848"></a>03848    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width=row_info-&gt;width;
<a name="l03849"></a>03849 
<a name="l03850"></a>03850    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_expand&quot;</span>);
<a name="l03851"></a>03851 
<a name="l03852"></a>03852    {
<a name="l03853"></a>03853       <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#ac679619ad9d3f2c46c2b69fe65bd19f1">PNG_COLOR_TYPE_GRAY</a>)
<a name="l03854"></a>03854       {
<a name="l03855"></a>03855          <a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a> gray = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)(trans_value ? trans_value-&gt;gray : 0);
<a name="l03856"></a>03856 
<a name="l03857"></a>03857          <span class="keywordflow">if</span> (row_info-&gt;bit_depth &lt; 8)
<a name="l03858"></a>03858          {
<a name="l03859"></a>03859             <span class="keywordflow">switch</span> (row_info-&gt;bit_depth)
<a name="l03860"></a>03860             {
<a name="l03861"></a>03861                <span class="keywordflow">case</span> 1:
<a name="l03862"></a>03862                {
<a name="l03863"></a>03863                   gray = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((gray &amp; 0x01) * 0xff);
<a name="l03864"></a>03864                   sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)((row_width - 1) &gt;&gt; 3);
<a name="l03865"></a>03865                   dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l03866"></a>03866                   shift = 7 - (int)((row_width + 7) &amp; 0x07);
<a name="l03867"></a>03867                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03868"></a>03868                   {
<a name="l03869"></a>03869                      <span class="keywordflow">if</span> ((*sp &gt;&gt; shift) &amp; 0x01)
<a name="l03870"></a>03870                         *dp = 0xff;
<a name="l03871"></a>03871 
<a name="l03872"></a>03872                      <span class="keywordflow">else</span>
<a name="l03873"></a>03873                         *dp = 0;
<a name="l03874"></a>03874 
<a name="l03875"></a>03875                      <span class="keywordflow">if</span> (shift == 7)
<a name="l03876"></a>03876                      {
<a name="l03877"></a>03877                         shift = 0;
<a name="l03878"></a>03878                         sp--;
<a name="l03879"></a>03879                      }
<a name="l03880"></a>03880 
<a name="l03881"></a>03881                      <span class="keywordflow">else</span>
<a name="l03882"></a>03882                         shift++;
<a name="l03883"></a>03883 
<a name="l03884"></a>03884                      dp--;
<a name="l03885"></a>03885                   }
<a name="l03886"></a>03886                   <span class="keywordflow">break</span>;
<a name="l03887"></a>03887                }
<a name="l03888"></a>03888 
<a name="l03889"></a>03889                <span class="keywordflow">case</span> 2:
<a name="l03890"></a>03890                {
<a name="l03891"></a>03891                   gray = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((gray &amp; 0x03) * 0x55);
<a name="l03892"></a>03892                   sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)((row_width - 1) &gt;&gt; 2);
<a name="l03893"></a>03893                   dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l03894"></a>03894                   shift = (int)((3 - ((row_width + 3) &amp; 0x03)) &lt;&lt; 1);
<a name="l03895"></a>03895                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03896"></a>03896                   {
<a name="l03897"></a>03897                      value = (*sp &gt;&gt; shift) &amp; 0x03;
<a name="l03898"></a>03898                      *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(value | (value &lt;&lt; 2) | (value &lt;&lt; 4) |
<a name="l03899"></a>03899                         (value &lt;&lt; 6));
<a name="l03900"></a>03900                      <span class="keywordflow">if</span> (shift == 6)
<a name="l03901"></a>03901                      {
<a name="l03902"></a>03902                         shift = 0;
<a name="l03903"></a>03903                         sp--;
<a name="l03904"></a>03904                      }
<a name="l03905"></a>03905 
<a name="l03906"></a>03906                      <span class="keywordflow">else</span>
<a name="l03907"></a>03907                         shift += 2;
<a name="l03908"></a>03908 
<a name="l03909"></a>03909                      dp--;
<a name="l03910"></a>03910                   }
<a name="l03911"></a>03911                   <span class="keywordflow">break</span>;
<a name="l03912"></a>03912                }
<a name="l03913"></a>03913 
<a name="l03914"></a>03914                <span class="keywordflow">case</span> 4:
<a name="l03915"></a>03915                {
<a name="l03916"></a>03916                   gray = (<a class="code" href="pngconf_8h.html#a45d36e83c83df6bd10af61f3ced2b01c">png_uint_16</a>)((gray &amp; 0x0f) * 0x11);
<a name="l03917"></a>03917                   sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)((row_width - 1) &gt;&gt; 1);
<a name="l03918"></a>03918                   dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l03919"></a>03919                   shift = (int)((1 - ((row_width + 1) &amp; 0x01)) &lt;&lt; 2);
<a name="l03920"></a>03920                   <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03921"></a>03921                   {
<a name="l03922"></a>03922                      value = (*sp &gt;&gt; shift) &amp; 0x0f;
<a name="l03923"></a>03923                      *dp = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(value | (value &lt;&lt; 4));
<a name="l03924"></a>03924                      <span class="keywordflow">if</span> (shift == 4)
<a name="l03925"></a>03925                      {
<a name="l03926"></a>03926                         shift = 0;
<a name="l03927"></a>03927                         sp--;
<a name="l03928"></a>03928                      }
<a name="l03929"></a>03929 
<a name="l03930"></a>03930                      <span class="keywordflow">else</span>
<a name="l03931"></a>03931                         shift = 4;
<a name="l03932"></a>03932 
<a name="l03933"></a>03933                      dp--;
<a name="l03934"></a>03934                   }
<a name="l03935"></a>03935                   <span class="keywordflow">break</span>;
<a name="l03936"></a>03936                }
<a name="l03937"></a>03937 
<a name="l03938"></a>03938                <span class="keywordflow">default</span>:
<a name="l03939"></a>03939                   <span class="keywordflow">break</span>;
<a name="l03940"></a>03940             }
<a name="l03941"></a>03941 
<a name="l03942"></a>03942             row_info-&gt;bit_depth = 8;
<a name="l03943"></a>03943             row_info-&gt;pixel_depth = 8;
<a name="l03944"></a>03944             row_info-&gt;rowbytes = row_width;
<a name="l03945"></a>03945          }
<a name="l03946"></a>03946 
<a name="l03947"></a>03947          <span class="keywordflow">if</span> (trans_value != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03948"></a>03948          {
<a name="l03949"></a>03949             <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l03950"></a>03950             {
<a name="l03951"></a>03951                gray = gray &amp; 0xff;
<a name="l03952"></a>03952                sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_width - 1;
<a name="l03953"></a>03953                dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)(row_width &lt;&lt; 1) - 1;
<a name="l03954"></a>03954 
<a name="l03955"></a>03955                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03956"></a>03956                {
<a name="l03957"></a>03957                   <span class="keywordflow">if</span> (*sp == gray)
<a name="l03958"></a>03958                      *dp-- = 0;
<a name="l03959"></a>03959 
<a name="l03960"></a>03960                   <span class="keywordflow">else</span>
<a name="l03961"></a>03961                      *dp-- = 0xff;
<a name="l03962"></a>03962 
<a name="l03963"></a>03963                   *dp-- = *sp--;
<a name="l03964"></a>03964                }
<a name="l03965"></a>03965             }
<a name="l03966"></a>03966 
<a name="l03967"></a>03967             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 16)
<a name="l03968"></a>03968             {
<a name="l03969"></a>03969                <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> gray_high = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((gray &gt;&gt; 8) &amp; 0xff);
<a name="l03970"></a>03970                <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> gray_low = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(gray &amp; 0xff);
<a name="l03971"></a>03971                sp = row + row_info-&gt;rowbytes - 1;
<a name="l03972"></a>03972                dp = row + (row_info-&gt;rowbytes &lt;&lt; 1) - 1;
<a name="l03973"></a>03973                <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l03974"></a>03974                {
<a name="l03975"></a>03975                   <span class="keywordflow">if</span> (*(sp - 1) == gray_high &amp;&amp; *(sp) == gray_low)
<a name="l03976"></a>03976                   {
<a name="l03977"></a>03977                      *dp-- = 0;
<a name="l03978"></a>03978                      *dp-- = 0;
<a name="l03979"></a>03979                   }
<a name="l03980"></a>03980 
<a name="l03981"></a>03981                   <span class="keywordflow">else</span>
<a name="l03982"></a>03982                   {
<a name="l03983"></a>03983                      *dp-- = 0xff;
<a name="l03984"></a>03984                      *dp-- = 0xff;
<a name="l03985"></a>03985                   }
<a name="l03986"></a>03986 
<a name="l03987"></a>03987                   *dp-- = *sp--;
<a name="l03988"></a>03988                   *dp-- = *sp--;
<a name="l03989"></a>03989                }
<a name="l03990"></a>03990             }
<a name="l03991"></a>03991 
<a name="l03992"></a>03992             row_info-&gt;color_type = <a class="code" href="png_8h.html#a6f7f3931c163838e2bc3132de2cd4391">PNG_COLOR_TYPE_GRAY_ALPHA</a>;
<a name="l03993"></a>03993             row_info-&gt;channels = 2;
<a name="l03994"></a>03994             row_info-&gt;pixel_depth = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(row_info-&gt;bit_depth &lt;&lt; 1);
<a name="l03995"></a>03995             row_info-&gt;rowbytes = <a class="code" href="pngpriv_8h.html#a18a47644e4b7cd60bb2b4a8c82d53f30">PNG_ROWBYTES</a>(row_info-&gt;pixel_depth,
<a name="l03996"></a>03996                row_width);
<a name="l03997"></a>03997          }
<a name="l03998"></a>03998       }
<a name="l03999"></a>03999       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a> &amp;&amp; trans_value)
<a name="l04000"></a>04000       {
<a name="l04001"></a>04001          <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l04002"></a>04002          {
<a name="l04003"></a>04003             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> red = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(trans_value-&gt;red &amp; 0xff);
<a name="l04004"></a>04004             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> green = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(trans_value-&gt;green &amp; 0xff);
<a name="l04005"></a>04005             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> blue = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(trans_value-&gt;blue &amp; 0xff);
<a name="l04006"></a>04006             sp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)row_info-&gt;rowbytes - 1;
<a name="l04007"></a>04007             dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)(row_width &lt;&lt; 2) - 1;
<a name="l04008"></a>04008             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l04009"></a>04009             {
<a name="l04010"></a>04010                <span class="keywordflow">if</span> (*(sp - 2) == red &amp;&amp; *(sp - 1) == green &amp;&amp; *(sp) == blue)
<a name="l04011"></a>04011                   *dp-- = 0;
<a name="l04012"></a>04012 
<a name="l04013"></a>04013                <span class="keywordflow">else</span>
<a name="l04014"></a>04014                   *dp-- = 0xff;
<a name="l04015"></a>04015 
<a name="l04016"></a>04016                *dp-- = *sp--;
<a name="l04017"></a>04017                *dp-- = *sp--;
<a name="l04018"></a>04018                *dp-- = *sp--;
<a name="l04019"></a>04019             }
<a name="l04020"></a>04020          }
<a name="l04021"></a>04021          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 16)
<a name="l04022"></a>04022          {
<a name="l04023"></a>04023             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> red_high = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((trans_value-&gt;red &gt;&gt; 8) &amp; 0xff);
<a name="l04024"></a>04024             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> green_high = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((trans_value-&gt;green &gt;&gt; 8) &amp; 0xff);
<a name="l04025"></a>04025             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> blue_high = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((trans_value-&gt;blue &gt;&gt; 8) &amp; 0xff);
<a name="l04026"></a>04026             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> red_low = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(trans_value-&gt;red &amp; 0xff);
<a name="l04027"></a>04027             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> green_low = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(trans_value-&gt;green &amp; 0xff);
<a name="l04028"></a>04028             <a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a> blue_low = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(trans_value-&gt;blue &amp; 0xff);
<a name="l04029"></a>04029             sp = row + row_info-&gt;rowbytes - 1;
<a name="l04030"></a>04030             dp = row + (<a class="code" href="pngconf_8h.html#a975e35d0a699ea3b08b8feef90fd29eb">png_size_t</a>)(row_width &lt;&lt; 3) - 1;
<a name="l04031"></a>04031             <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l04032"></a>04032             {
<a name="l04033"></a>04033                <span class="keywordflow">if</span> (*(sp - 5) == red_high &amp;&amp;
<a name="l04034"></a>04034                    *(sp - 4) == red_low &amp;&amp;
<a name="l04035"></a>04035                    *(sp - 3) == green_high &amp;&amp;
<a name="l04036"></a>04036                    *(sp - 2) == green_low &amp;&amp;
<a name="l04037"></a>04037                    *(sp - 1) == blue_high &amp;&amp;
<a name="l04038"></a>04038                    *(sp    ) == blue_low)
<a name="l04039"></a>04039                {
<a name="l04040"></a>04040                   *dp-- = 0;
<a name="l04041"></a>04041                   *dp-- = 0;
<a name="l04042"></a>04042                }
<a name="l04043"></a>04043 
<a name="l04044"></a>04044                <span class="keywordflow">else</span>
<a name="l04045"></a>04045                {
<a name="l04046"></a>04046                   *dp-- = 0xff;
<a name="l04047"></a>04047                   *dp-- = 0xff;
<a name="l04048"></a>04048                }
<a name="l04049"></a>04049 
<a name="l04050"></a>04050                *dp-- = *sp--;
<a name="l04051"></a>04051                *dp-- = *sp--;
<a name="l04052"></a>04052                *dp-- = *sp--;
<a name="l04053"></a>04053                *dp-- = *sp--;
<a name="l04054"></a>04054                *dp-- = *sp--;
<a name="l04055"></a>04055                *dp-- = *sp--;
<a name="l04056"></a>04056             }
<a name="l04057"></a>04057          }
<a name="l04058"></a>04058          row_info-&gt;color_type = <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a>;
<a name="l04059"></a>04059          row_info-&gt;channels = 4;
<a name="l04060"></a>04060          row_info-&gt;pixel_depth = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(row_info-&gt;bit_depth &lt;&lt; 2);
<a name="l04061"></a>04061          row_info-&gt;rowbytes = <a class="code" href="pngpriv_8h.html#a18a47644e4b7cd60bb2b4a8c82d53f30">PNG_ROWBYTES</a>(row_info-&gt;pixel_depth, row_width);
<a name="l04062"></a>04062       }
<a name="l04063"></a>04063    }
<a name="l04064"></a>04064 }
<a name="l04065"></a>04065 <span class="preprocessor">#endif</span>
<a name="l04066"></a>04066 <span class="preprocessor"></span>
<a name="l04067"></a>04067 <span class="preprocessor">#ifdef PNG_READ_QUANTIZE_SUPPORTED</span>
<a name="l04068"></a>04068 <span class="preprocessor"></span><span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l04069"></a><a class="code" href="pngrtran_8c.html#a7c997efaee527ae3cf282135bf35778d">04069</a> <a class="code" href="pngrtran_8c.html#a7c997efaee527ae3cf282135bf35778d">png_do_quantize</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row,
<a name="l04070"></a>04070     <a class="code" href="pngconf_8h.html#a53e11f2ed74ffe5e45513458517b8af3">png_const_bytep</a> palette_lookup, <a class="code" href="pngconf_8h.html#a53e11f2ed74ffe5e45513458517b8af3">png_const_bytep</a> quantize_lookup)
<a name="l04071"></a>04071 {
<a name="l04072"></a>04072    <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> sp, dp;
<a name="l04073"></a>04073    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l04074"></a>04074    <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width=row_info-&gt;width;
<a name="l04075"></a>04075 
<a name="l04076"></a>04076    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_quantize&quot;</span>);
<a name="l04077"></a>04077 
<a name="l04078"></a>04078    <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l04079"></a>04079    {
<a name="l04080"></a>04080       <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a> &amp;&amp; palette_lookup)
<a name="l04081"></a>04081       {
<a name="l04082"></a>04082          <span class="keywordtype">int</span> r, g, b, p;
<a name="l04083"></a>04083          sp = row;
<a name="l04084"></a>04084          dp = row;
<a name="l04085"></a>04085          <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l04086"></a>04086          {
<a name="l04087"></a>04087             r = *sp++;
<a name="l04088"></a>04088             g = *sp++;
<a name="l04089"></a>04089             b = *sp++;
<a name="l04090"></a>04090 
<a name="l04091"></a>04091             <span class="comment">/* This looks real messy, but the compiler will reduce</span>
<a name="l04092"></a>04092 <span class="comment">             * it down to a reasonable formula.  For example, with</span>
<a name="l04093"></a>04093 <span class="comment">             * 5 bits per color, we get:</span>
<a name="l04094"></a>04094 <span class="comment">             * p = (((r &gt;&gt; 3) &amp; 0x1f) &lt;&lt; 10) |</span>
<a name="l04095"></a>04095 <span class="comment">             *    (((g &gt;&gt; 3) &amp; 0x1f) &lt;&lt; 5) |</span>
<a name="l04096"></a>04096 <span class="comment">             *    ((b &gt;&gt; 3) &amp; 0x1f);</span>
<a name="l04097"></a>04097 <span class="comment">             */</span>
<a name="l04098"></a>04098             p = (((r &gt;&gt; (8 - <a class="code" href="pnglibconf_8h.html#ae893b1730ca275384af3d75c6c673513">PNG_QUANTIZE_RED_BITS</a>)) &amp;
<a name="l04099"></a>04099                 ((1 &lt;&lt; <a class="code" href="pnglibconf_8h.html#ae893b1730ca275384af3d75c6c673513">PNG_QUANTIZE_RED_BITS</a>) - 1)) &lt;&lt;
<a name="l04100"></a>04100                 (<a class="code" href="pnglibconf_8h.html#a5e5e7d6d57eb08fdfb843bf618d7adac">PNG_QUANTIZE_GREEN_BITS</a> + <a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>)) |
<a name="l04101"></a>04101                 (((g &gt;&gt; (8 - <a class="code" href="pnglibconf_8h.html#a5e5e7d6d57eb08fdfb843bf618d7adac">PNG_QUANTIZE_GREEN_BITS</a>)) &amp;
<a name="l04102"></a>04102                 ((1 &lt;&lt; <a class="code" href="pnglibconf_8h.html#a5e5e7d6d57eb08fdfb843bf618d7adac">PNG_QUANTIZE_GREEN_BITS</a>) - 1)) &lt;&lt;
<a name="l04103"></a>04103                 (<a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>)) |
<a name="l04104"></a>04104                 ((b &gt;&gt; (8 - <a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>)) &amp;
<a name="l04105"></a>04105                 ((1 &lt;&lt; <a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>) - 1));
<a name="l04106"></a>04106 
<a name="l04107"></a>04107             *dp++ = palette_lookup[p];
<a name="l04108"></a>04108          }
<a name="l04109"></a>04109 
<a name="l04110"></a>04110          row_info-&gt;color_type = <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>;
<a name="l04111"></a>04111          row_info-&gt;channels = 1;
<a name="l04112"></a>04112          row_info-&gt;pixel_depth = row_info-&gt;bit_depth;
<a name="l04113"></a>04113          row_info-&gt;rowbytes = <a class="code" href="pngpriv_8h.html#a18a47644e4b7cd60bb2b4a8c82d53f30">PNG_ROWBYTES</a>(row_info-&gt;pixel_depth, row_width);
<a name="l04114"></a>04114       }
<a name="l04115"></a>04115 
<a name="l04116"></a>04116       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a> &amp;&amp;
<a name="l04117"></a>04117          palette_lookup != <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l04118"></a>04118       {
<a name="l04119"></a>04119          <span class="keywordtype">int</span> r, g, b, p;
<a name="l04120"></a>04120          sp = row;
<a name="l04121"></a>04121          dp = row;
<a name="l04122"></a>04122          <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++)
<a name="l04123"></a>04123          {
<a name="l04124"></a>04124             r = *sp++;
<a name="l04125"></a>04125             g = *sp++;
<a name="l04126"></a>04126             b = *sp++;
<a name="l04127"></a>04127             sp++;
<a name="l04128"></a>04128 
<a name="l04129"></a>04129             p = (((r &gt;&gt; (8 - <a class="code" href="pnglibconf_8h.html#ae893b1730ca275384af3d75c6c673513">PNG_QUANTIZE_RED_BITS</a>)) &amp;
<a name="l04130"></a>04130                 ((1 &lt;&lt; <a class="code" href="pnglibconf_8h.html#ae893b1730ca275384af3d75c6c673513">PNG_QUANTIZE_RED_BITS</a>) - 1)) &lt;&lt;
<a name="l04131"></a>04131                 (<a class="code" href="pnglibconf_8h.html#a5e5e7d6d57eb08fdfb843bf618d7adac">PNG_QUANTIZE_GREEN_BITS</a> + <a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>)) |
<a name="l04132"></a>04132                 (((g &gt;&gt; (8 - <a class="code" href="pnglibconf_8h.html#a5e5e7d6d57eb08fdfb843bf618d7adac">PNG_QUANTIZE_GREEN_BITS</a>)) &amp;
<a name="l04133"></a>04133                 ((1 &lt;&lt; <a class="code" href="pnglibconf_8h.html#a5e5e7d6d57eb08fdfb843bf618d7adac">PNG_QUANTIZE_GREEN_BITS</a>) - 1)) &lt;&lt;
<a name="l04134"></a>04134                 (<a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>)) |
<a name="l04135"></a>04135                 ((b &gt;&gt; (8 - <a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>)) &amp;
<a name="l04136"></a>04136                 ((1 &lt;&lt; <a class="code" href="pnglibconf_8h.html#a3bb0412bef95e003a1a2b519d80aa1d9">PNG_QUANTIZE_BLUE_BITS</a>) - 1));
<a name="l04137"></a>04137 
<a name="l04138"></a>04138             *dp++ = palette_lookup[p];
<a name="l04139"></a>04139          }
<a name="l04140"></a>04140 
<a name="l04141"></a>04141          row_info-&gt;color_type = <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a>;
<a name="l04142"></a>04142          row_info-&gt;channels = 1;
<a name="l04143"></a>04143          row_info-&gt;pixel_depth = row_info-&gt;bit_depth;
<a name="l04144"></a>04144          row_info-&gt;rowbytes = <a class="code" href="pngpriv_8h.html#a18a47644e4b7cd60bb2b4a8c82d53f30">PNG_ROWBYTES</a>(row_info-&gt;pixel_depth, row_width);
<a name="l04145"></a>04145       }
<a name="l04146"></a>04146 
<a name="l04147"></a>04147       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#ad9cb748ce20baa72dea5fb1c5d900414">PNG_COLOR_TYPE_PALETTE</a> &amp;&amp;
<a name="l04148"></a>04148          quantize_lookup)
<a name="l04149"></a>04149       {
<a name="l04150"></a>04150          sp = row;
<a name="l04151"></a>04151 
<a name="l04152"></a>04152          <span class="keywordflow">for</span> (i = 0; i &lt; row_width; i++, sp++)
<a name="l04153"></a>04153          {
<a name="l04154"></a>04154             *sp = quantize_lookup[*sp];
<a name="l04155"></a>04155          }
<a name="l04156"></a>04156       }
<a name="l04157"></a>04157    }
<a name="l04158"></a>04158 }
<a name="l04159"></a>04159 <span class="preprocessor">#endif </span><span class="comment">/* PNG_READ_QUANTIZE_SUPPORTED */</span>
<a name="l04160"></a>04160 
<a name="l04161"></a>04161 <span class="preprocessor">#ifdef PNG_MNG_FEATURES_SUPPORTED</span>
<a name="l04162"></a>04162 <span class="preprocessor"></span><span class="comment">/* Undoes intrapixel differencing  */</span>
<a name="l04163"></a>04163 <span class="keywordtype">void</span> <span class="comment">/* PRIVATE */</span>
<a name="l04164"></a><a class="code" href="pngrtran_8c.html#a3971a163ca7c2683c1467b18aaf1da8b">04164</a> <a class="code" href="pngrtran_8c.html#a3971a163ca7c2683c1467b18aaf1da8b">png_do_read_intrapixel</a>(<a class="code" href="png_8h.html#a69a5a03dfdb6e0a0b9267a273742d5f1">png_row_infop</a> row_info, <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> row)
<a name="l04165"></a>04165 {
<a name="l04166"></a>04166    <a class="code" href="pngdebug_8h.html#a902d9c110d356b4d47a47e4b4233ca27">png_debug</a>(1, <span class="stringliteral">&quot;in png_do_read_intrapixel&quot;</span>);
<a name="l04167"></a>04167 
<a name="l04168"></a>04168    <span class="keywordflow">if</span> (
<a name="l04169"></a>04169        (row_info-&gt;color_type &amp; <a class="code" href="png_8h.html#a87bc785c34abddf3bb9ff206d721964b">PNG_COLOR_MASK_COLOR</a>))
<a name="l04170"></a>04170    {
<a name="l04171"></a>04171       <span class="keywordtype">int</span> bytes_per_pixel;
<a name="l04172"></a>04172       <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> row_width = row_info-&gt;width;
<a name="l04173"></a>04173 
<a name="l04174"></a>04174       <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 8)
<a name="l04175"></a>04175       {
<a name="l04176"></a>04176          <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> rp;
<a name="l04177"></a>04177          <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l04178"></a>04178 
<a name="l04179"></a>04179          <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a>)
<a name="l04180"></a>04180             bytes_per_pixel = 3;
<a name="l04181"></a>04181 
<a name="l04182"></a>04182          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a>)
<a name="l04183"></a>04183             bytes_per_pixel = 4;
<a name="l04184"></a>04184 
<a name="l04185"></a>04185          <span class="keywordflow">else</span>
<a name="l04186"></a>04186             <span class="keywordflow">return</span>;
<a name="l04187"></a>04187 
<a name="l04188"></a>04188          <span class="keywordflow">for</span> (i = 0, rp = row; i &lt; row_width; i++, rp += bytes_per_pixel)
<a name="l04189"></a>04189          {
<a name="l04190"></a>04190             *(rp) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((256 + *rp + *(rp + 1)) &amp; 0xff);
<a name="l04191"></a>04191             *(rp+2) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((256 + *(rp + 2) + *(rp + 1)) &amp; 0xff);
<a name="l04192"></a>04192          }
<a name="l04193"></a>04193       }
<a name="l04194"></a>04194       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;bit_depth == 16)
<a name="l04195"></a>04195       {
<a name="l04196"></a>04196          <a class="code" href="pngconf_8h.html#a8ca8146b04764bd8e8b248d344f98845">png_bytep</a> rp;
<a name="l04197"></a>04197          <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> i;
<a name="l04198"></a>04198 
<a name="l04199"></a>04199          <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a30350690cac2ef450ec14447793a5a28">PNG_COLOR_TYPE_RGB</a>)
<a name="l04200"></a>04200             bytes_per_pixel = 6;
<a name="l04201"></a>04201 
<a name="l04202"></a>04202          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row_info-&gt;color_type == <a class="code" href="png_8h.html#a60d8d104ff1904a7366a90afdd75c949">PNG_COLOR_TYPE_RGB_ALPHA</a>)
<a name="l04203"></a>04203             bytes_per_pixel = 8;
<a name="l04204"></a>04204 
<a name="l04205"></a>04205          <span class="keywordflow">else</span>
<a name="l04206"></a>04206             <span class="keywordflow">return</span>;
<a name="l04207"></a>04207 
<a name="l04208"></a>04208          <span class="keywordflow">for</span> (i = 0, rp = row; i &lt; row_width; i++, rp += bytes_per_pixel)
<a name="l04209"></a>04209          {
<a name="l04210"></a>04210             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> s0   = (*(rp    ) &lt;&lt; 8) | *(rp + 1);
<a name="l04211"></a>04211             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> s1   = (*(rp + 2) &lt;&lt; 8) | *(rp + 3);
<a name="l04212"></a>04212             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> s2   = (*(rp + 4) &lt;&lt; 8) | *(rp + 5);
<a name="l04213"></a>04213             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> red  = (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)((s0 + s1 + 65536L) &amp; 0xffffL);
<a name="l04214"></a>04214             <a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a> blue = (<a class="code" href="pngconf_8h.html#a6dcaf7e9d63725c4bdc5ed8876b3b75d">png_uint_32</a>)((s2 + s1 + 65536L) &amp; 0xffffL);
<a name="l04215"></a>04215             *(rp    ) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((red &gt;&gt; 8) &amp; 0xff);
<a name="l04216"></a>04216             *(rp + 1) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(red &amp; 0xff);
<a name="l04217"></a>04217             *(rp + 4) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)((blue &gt;&gt; 8) &amp; 0xff);
<a name="l04218"></a>04218             *(rp + 5) = (<a class="code" href="pngconf_8h.html#a464361022b28ac2f3ea319b80642e9c3">png_byte</a>)(blue &amp; 0xff);
<a name="l04219"></a>04219          }
<a name="l04220"></a>04220       }
<a name="l04221"></a>04221    }
<a name="l04222"></a>04222 }
<a name="l04223"></a>04223 <span class="preprocessor">#endif </span><span class="comment">/* PNG_MNG_FEATURES_SUPPORTED */</span>
<a name="l04224"></a>04224 <span class="preprocessor">#endif </span><span class="comment">/* PNG_READ_SUPPORTED */</span>
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="pngrtran_8c.html">pngrtran.c</a>      </li>

    <li class="footer">Generated on Tue Mar 13 2012 11:44:10 for ARK2D by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.0 </li>
   </ul>
 </div>


</body>
</html>
