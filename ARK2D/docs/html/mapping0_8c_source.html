<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ARK2D: src/ARK2D/vendor/vorbis132/mapping0.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ARK2D
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('mapping0_8c.html','');
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">src/ARK2D/vendor/vorbis132/mapping0.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="mapping0_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *                                                                  *</span>
<a name="l00003"></a>00003 <span class="comment"> * THIS FILE IS PART OF THE OggVorbis SOFTWARE CODEC SOURCE CODE.   *</span>
<a name="l00004"></a>00004 <span class="comment"> * USE, DISTRIBUTION AND REPRODUCTION OF THIS LIBRARY SOURCE IS     *</span>
<a name="l00005"></a>00005 <span class="comment"> * GOVERNED BY A BSD-STYLE SOURCE LICENSE INCLUDED WITH THIS SOURCE *</span>
<a name="l00006"></a>00006 <span class="comment"> * IN &#39;COPYING&#39;. PLEASE READ THESE TERMS BEFORE DISTRIBUTING.       *</span>
<a name="l00007"></a>00007 <span class="comment"> *                                                                  *</span>
<a name="l00008"></a>00008 <span class="comment"> * THE OggVorbis SOURCE CODE IS (C) COPYRIGHT 1994-2010             *</span>
<a name="l00009"></a>00009 <span class="comment"> * by the Xiph.Org Foundation http://www.xiph.org/                  *</span>
<a name="l00010"></a>00010 <span class="comment"> *                                                                  *</span>
<a name="l00011"></a>00011 <span class="comment"> ********************************************************************</span>
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment"> function: channel mapping 0 implementation</span>
<a name="l00014"></a>00014 <span class="comment"> last mod: $Id: mapping0.c 17022 2010-03-25 03:45:42Z xiphmont $</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment"> ********************************************************************/</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;../ogg130/ogg.h&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="codec_8h.html">codec.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="codec__internal_8h.html">codec_internal.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="codebook_8h.html">codebook.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="window_8h.html">window.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="registry_8h.html">registry.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="psy_8h.html">psy.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="misc_8h.html">misc.h</a>&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="comment">/* simplistic, wasteful way of doing this (unique lookup for each</span>
<a name="l00032"></a>00032 <span class="comment">   mode/submapping); there should be a central repository for</span>
<a name="l00033"></a>00033 <span class="comment">   identical lookups.  That will require minor work, so I&#39;m putting it</span>
<a name="l00034"></a>00034 <span class="comment">   off as low priority.</span>
<a name="l00035"></a>00035 <span class="comment"></span>
<a name="l00036"></a>00036 <span class="comment">   Why a lookup for each backend in a given mode?  Because the</span>
<a name="l00037"></a>00037 <span class="comment">   blocksize is set by the mode, and low backend lookups may require</span>
<a name="l00038"></a>00038 <span class="comment">   parameters from other areas of the mode/mapping */</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="keyword">static</span> <span class="keywordtype">void</span> mapping0_free_info(<a class="code" href="codec__internal_8h.html#ac950fba32fc1ede78f8bb7b83796969e">vorbis_info_mapping</a> *i){
<a name="l00041"></a>00041   <a class="code" href="structvorbis__info__mapping0.html">vorbis_info_mapping0</a> *info=(<a class="code" href="structvorbis__info__mapping0.html">vorbis_info_mapping0</a> *)i;
<a name="l00042"></a>00042   <span class="keywordflow">if</span>(info){
<a name="l00043"></a>00043     memset(info,0,<span class="keyword">sizeof</span>(*info));
<a name="l00044"></a>00044     <a class="code" href="os__types_8h.html#ab61a62a18b8fd3a24a811112c6b751a1">_ogg_free</a>(info);
<a name="l00045"></a>00045   }
<a name="l00046"></a>00046 }
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="keyword">static</span> <span class="keywordtype">int</span> ilog(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> v){
<a name="l00049"></a>00049   <span class="keywordtype">int</span> ret=0;
<a name="l00050"></a>00050   <span class="keywordflow">if</span>(v)--v;
<a name="l00051"></a>00051   <span class="keywordflow">while</span>(v){
<a name="l00052"></a>00052     ret++;
<a name="l00053"></a>00053     v&gt;&gt;=1;
<a name="l00054"></a>00054   }
<a name="l00055"></a>00055   <span class="keywordflow">return</span>(ret);
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="keyword">static</span> <span class="keywordtype">void</span> mapping0_pack(<a class="code" href="structvorbis__info.html">vorbis_info</a> *vi,<a class="code" href="codec__internal_8h.html#ac950fba32fc1ede78f8bb7b83796969e">vorbis_info_mapping</a> *vm,
<a name="l00059"></a>00059                           <a class="code" href="structoggpack__buffer.html">oggpack_buffer</a> *opb){
<a name="l00060"></a>00060   <span class="keywordtype">int</span> i;
<a name="l00061"></a>00061   <a class="code" href="structvorbis__info__mapping0.html">vorbis_info_mapping0</a> *info=(<a class="code" href="structvorbis__info__mapping0.html">vorbis_info_mapping0</a> *)vm;
<a name="l00062"></a>00062 
<a name="l00063"></a>00063   <span class="comment">/* another &#39;we meant to do it this way&#39; hack...  up to beta 4, we</span>
<a name="l00064"></a>00064 <span class="comment">     packed 4 binary zeros here to signify one submapping in use.  We</span>
<a name="l00065"></a>00065 <span class="comment">     now redefine that to mean four bitflags that indicate use of</span>
<a name="l00066"></a>00066 <span class="comment">     deeper features; bit0:submappings, bit1:coupling,</span>
<a name="l00067"></a>00067 <span class="comment">     bit2,3:reserved. This is backward compatable with all actual uses</span>
<a name="l00068"></a>00068 <span class="comment">     of the beta code. */</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070   <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>&gt;1){
<a name="l00071"></a>00071     <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,1,1);
<a name="l00072"></a>00072     <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>-1,4);
<a name="l00073"></a>00073   }<span class="keywordflow">else</span>
<a name="l00074"></a>00074     <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,0,1);
<a name="l00075"></a>00075 
<a name="l00076"></a>00076   <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ab8336109f7ccf188b8fa4b261d92be7f">coupling_steps</a>&gt;0){
<a name="l00077"></a>00077     <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,1,1);
<a name="l00078"></a>00078     <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ab8336109f7ccf188b8fa4b261d92be7f">coupling_steps</a>-1,8);
<a name="l00079"></a>00079 
<a name="l00080"></a>00080     <span class="keywordflow">for</span>(i=0;i&lt;info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ab8336109f7ccf188b8fa4b261d92be7f">coupling_steps</a>;i++){
<a name="l00081"></a>00081       <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae668f0f09c4f101de4899e8a1310c8b">coupling_mag</a>[i],ilog(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>));
<a name="l00082"></a>00082       <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a9a145ee5d8f00b7255461b262fb4e886">coupling_ang</a>[i],ilog(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>));
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084   }<span class="keywordflow">else</span>
<a name="l00085"></a>00085     <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,0,1);
<a name="l00086"></a>00086 
<a name="l00087"></a>00087   <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,0,2); <span class="comment">/* 2,3:reserved */</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   <span class="comment">/* we don&#39;t write the channel submappings if we only have one... */</span>
<a name="l00090"></a>00090   <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>&gt;1){
<a name="l00091"></a>00091     <span class="keywordflow">for</span>(i=0;i&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;i++)
<a name="l00092"></a>00092       <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[i],4);
<a name="l00093"></a>00093   }
<a name="l00094"></a>00094   <span class="keywordflow">for</span>(i=0;i&lt;info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>;i++){
<a name="l00095"></a>00095     <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,0,8); <span class="comment">/* time submap unused */</span>
<a name="l00096"></a>00096     <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[i],8);
<a name="l00097"></a>00097     <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a279880bea4274534b86667ad7fc1ae4d">residuesubmap</a>[i],8);
<a name="l00098"></a>00098   }
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">/* also responsible for range checking */</span>
<a name="l00102"></a>00102 <span class="keyword">static</span> <a class="code" href="codec__internal_8h.html#ac950fba32fc1ede78f8bb7b83796969e">vorbis_info_mapping</a> *mapping0_unpack(<a class="code" href="structvorbis__info.html">vorbis_info</a> *vi,<a class="code" href="structoggpack__buffer.html">oggpack_buffer</a> *opb){
<a name="l00103"></a>00103   <span class="keywordtype">int</span> i,b;
<a name="l00104"></a>00104   <a class="code" href="structvorbis__info__mapping0.html">vorbis_info_mapping0</a> *info=<a class="code" href="os__types_8h.html#a309e0b91bf7968a1e7ae1072d216a0cb">_ogg_calloc</a>(1,<span class="keyword">sizeof</span>(*info));
<a name="l00105"></a>00105   <a class="code" href="structcodec__setup__info.html">codec_setup_info</a>     *ci=vi-&gt;<a class="code" href="structvorbis__info.html#a440988f081a417fd1586a4c3d44bc00c">codec_setup</a>;
<a name="l00106"></a>00106   memset(info,0,<span class="keyword">sizeof</span>(*info));
<a name="l00107"></a>00107 
<a name="l00108"></a>00108   b=<a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,1);
<a name="l00109"></a>00109   <span class="keywordflow">if</span>(b&lt;0)<span class="keywordflow">goto</span> err_out;
<a name="l00110"></a>00110   <span class="keywordflow">if</span>(b){
<a name="l00111"></a>00111     info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>=<a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,4)+1;
<a name="l00112"></a>00112     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>&lt;=0)<span class="keywordflow">goto</span> err_out;
<a name="l00113"></a>00113   }<span class="keywordflow">else</span>
<a name="l00114"></a>00114     info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>=1;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116   b=<a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,1);
<a name="l00117"></a>00117   <span class="keywordflow">if</span>(b&lt;0)<span class="keywordflow">goto</span> err_out;
<a name="l00118"></a>00118   <span class="keywordflow">if</span>(b){
<a name="l00119"></a>00119     info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ab8336109f7ccf188b8fa4b261d92be7f">coupling_steps</a>=<a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,8)+1;
<a name="l00120"></a>00120     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ab8336109f7ccf188b8fa4b261d92be7f">coupling_steps</a>&lt;=0)<span class="keywordflow">goto</span> err_out;
<a name="l00121"></a>00121     <span class="keywordflow">for</span>(i=0;i&lt;info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ab8336109f7ccf188b8fa4b261d92be7f">coupling_steps</a>;i++){
<a name="l00122"></a>00122       <span class="keywordtype">int</span> testM=info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae668f0f09c4f101de4899e8a1310c8b">coupling_mag</a>[i]=<a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,ilog(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>));
<a name="l00123"></a>00123       <span class="keywordtype">int</span> testA=info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a9a145ee5d8f00b7255461b262fb4e886">coupling_ang</a>[i]=<a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,ilog(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>));
<a name="l00124"></a>00124 
<a name="l00125"></a>00125       <span class="keywordflow">if</span>(testM&lt;0 ||
<a name="l00126"></a>00126          testA&lt;0 ||
<a name="l00127"></a>00127          testM==testA ||
<a name="l00128"></a>00128          testM&gt;=vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a> ||
<a name="l00129"></a>00129          testA&gt;=vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>) <span class="keywordflow">goto</span> err_out;
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132   }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   <span class="keywordflow">if</span>(<a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,2)!=0)<span class="keywordflow">goto</span> err_out; <span class="comment">/* 2,3:reserved */</span>
<a name="l00135"></a>00135 
<a name="l00136"></a>00136   <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>&gt;1){
<a name="l00137"></a>00137     <span class="keywordflow">for</span>(i=0;i&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;i++){
<a name="l00138"></a>00138       info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[i]=<a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,4);
<a name="l00139"></a>00139       <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[i]&gt;=info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a> || info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[i]&lt;0)<span class="keywordflow">goto</span> err_out;
<a name="l00140"></a>00140     }
<a name="l00141"></a>00141   }
<a name="l00142"></a>00142   <span class="keywordflow">for</span>(i=0;i&lt;info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>;i++){
<a name="l00143"></a>00143     <a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,8); <span class="comment">/* time submap unused */</span>
<a name="l00144"></a>00144     info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[i]=<a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,8);
<a name="l00145"></a>00145     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[i]&gt;=ci-&gt;<a class="code" href="structcodec__setup__info.html#a07326866bbd3e16ba395995c47f1afe5">floors</a> || info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[i]&lt;0)<span class="keywordflow">goto</span> err_out;
<a name="l00146"></a>00146     info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a279880bea4274534b86667ad7fc1ae4d">residuesubmap</a>[i]=<a class="code" href="bitwise_8c.html#a7e3e346e19e4a74bfe4e21f90578eee6">oggpack_read</a>(opb,8);
<a name="l00147"></a>00147     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a279880bea4274534b86667ad7fc1ae4d">residuesubmap</a>[i]&gt;=ci-&gt;<a class="code" href="structcodec__setup__info.html#af730d6d8181fb830badaf26b6b688afb">residues</a> || info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a279880bea4274534b86667ad7fc1ae4d">residuesubmap</a>[i]&lt;0)<span class="keywordflow">goto</span> err_out;
<a name="l00148"></a>00148   }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   <span class="keywordflow">return</span> info;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152  err_out:
<a name="l00153"></a>00153   mapping0_free_info(info);
<a name="l00154"></a>00154   <span class="keywordflow">return</span>(<a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 <span class="preprocessor">#include &quot;<a class="code" href="os_8h.html">os.h</a>&quot;</span>
<a name="l00158"></a>00158 <span class="preprocessor">#include &quot;<a class="code" href="lpc_8h.html">lpc.h</a>&quot;</span>
<a name="l00159"></a>00159 <span class="preprocessor">#include &quot;<a class="code" href="lsp_8h.html">lsp.h</a>&quot;</span>
<a name="l00160"></a>00160 <span class="preprocessor">#include &quot;<a class="code" href="envelope_8h.html">envelope.h</a>&quot;</span>
<a name="l00161"></a>00161 <span class="preprocessor">#include &quot;<a class="code" href="mdct_8h.html">mdct.h</a>&quot;</span>
<a name="l00162"></a>00162 <span class="preprocessor">#include &quot;<a class="code" href="psy_8h.html">psy.h</a>&quot;</span>
<a name="l00163"></a>00163 <span class="preprocessor">#include &quot;<a class="code" href="scales_8h.html">scales.h</a>&quot;</span>
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="preprocessor">#if 0</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">long</span> seq=0;
<a name="l00167"></a>00167 <span class="keyword">static</span> <a class="code" href="config__types_8h.html#a292432ede703993aa88db876e11b2306">ogg_int64_t</a> total=0;
<a name="l00168"></a>00168 <span class="keyword">static</span> <span class="keywordtype">float</span> FLOOR1_fromdB_LOOKUP[256]={
<a name="l00169"></a>00169   1.0649863e-07F, 1.1341951e-07F, 1.2079015e-07F, 1.2863978e-07F,
<a name="l00170"></a>00170   1.3699951e-07F, 1.4590251e-07F, 1.5538408e-07F, 1.6548181e-07F,
<a name="l00171"></a>00171   1.7623575e-07F, 1.8768855e-07F, 1.9988561e-07F, 2.128753e-07F,
<a name="l00172"></a>00172   2.2670913e-07F, 2.4144197e-07F, 2.5713223e-07F, 2.7384213e-07F,
<a name="l00173"></a>00173   2.9163793e-07F, 3.1059021e-07F, 3.3077411e-07F, 3.5226968e-07F,
<a name="l00174"></a>00174   3.7516214e-07F, 3.9954229e-07F, 4.2550680e-07F, 4.5315863e-07F,
<a name="l00175"></a>00175   4.8260743e-07F, 5.1396998e-07F, 5.4737065e-07F, 5.8294187e-07F,
<a name="l00176"></a>00176   6.2082472e-07F, 6.6116941e-07F, 7.0413592e-07F, 7.4989464e-07F,
<a name="l00177"></a>00177   7.9862701e-07F, 8.5052630e-07F, 9.0579828e-07F, 9.6466216e-07F,
<a name="l00178"></a>00178   1.0273513e-06F, 1.0941144e-06F, 1.1652161e-06F, 1.2409384e-06F,
<a name="l00179"></a>00179   1.3215816e-06F, 1.4074654e-06F, 1.4989305e-06F, 1.5963394e-06F,
<a name="l00180"></a>00180   1.7000785e-06F, 1.8105592e-06F, 1.9282195e-06F, 2.0535261e-06F,
<a name="l00181"></a>00181   2.1869758e-06F, 2.3290978e-06F, 2.4804557e-06F, 2.6416497e-06F,
<a name="l00182"></a>00182   2.8133190e-06F, 2.9961443e-06F, 3.1908506e-06F, 3.3982101e-06F,
<a name="l00183"></a>00183   3.6190449e-06F, 3.8542308e-06F, 4.1047004e-06F, 4.3714470e-06F,
<a name="l00184"></a>00184   4.6555282e-06F, 4.9580707e-06F, 5.2802740e-06F, 5.6234160e-06F,
<a name="l00185"></a>00185   5.9888572e-06F, 6.3780469e-06F, 6.7925283e-06F, 7.2339451e-06F,
<a name="l00186"></a>00186   7.7040476e-06F, 8.2047000e-06F, 8.7378876e-06F, 9.3057248e-06F,
<a name="l00187"></a>00187   9.9104632e-06F, 1.0554501e-05F, 1.1240392e-05F, 1.1970856e-05F,
<a name="l00188"></a>00188   1.2748789e-05F, 1.3577278e-05F, 1.4459606e-05F, 1.5399272e-05F,
<a name="l00189"></a>00189   1.6400004e-05F, 1.7465768e-05F, 1.8600792e-05F, 1.9809576e-05F,
<a name="l00190"></a>00190   2.1096914e-05F, 2.2467911e-05F, 2.3928002e-05F, 2.5482978e-05F,
<a name="l00191"></a>00191   2.7139006e-05F, 2.8902651e-05F, 3.0780908e-05F, 3.2781225e-05F,
<a name="l00192"></a>00192   3.4911534e-05F, 3.7180282e-05F, 3.9596466e-05F, 4.2169667e-05F,
<a name="l00193"></a>00193   4.4910090e-05F, 4.7828601e-05F, 5.0936773e-05F, 5.4246931e-05F,
<a name="l00194"></a>00194   5.7772202e-05F, 6.1526565e-05F, 6.5524908e-05F, 6.9783085e-05F,
<a name="l00195"></a>00195   7.4317983e-05F, 7.9147585e-05F, 8.4291040e-05F, 8.9768747e-05F,
<a name="l00196"></a>00196   9.5602426e-05F, 0.00010181521F, 0.00010843174F, 0.00011547824F,
<a name="l00197"></a>00197   0.00012298267F, 0.00013097477F, 0.00013948625F, 0.00014855085F,
<a name="l00198"></a>00198   0.00015820453F, 0.00016848555F, 0.00017943469F, 0.00019109536F,
<a name="l00199"></a>00199   0.00020351382F, 0.00021673929F, 0.00023082423F, 0.00024582449F,
<a name="l00200"></a>00200   0.00026179955F, 0.00027881276F, 0.00029693158F, 0.00031622787F,
<a name="l00201"></a>00201   0.00033677814F, 0.00035866388F, 0.00038197188F, 0.00040679456F,
<a name="l00202"></a>00202   0.00043323036F, 0.00046138411F, 0.00049136745F, 0.00052329927F,
<a name="l00203"></a>00203   0.00055730621F, 0.00059352311F, 0.00063209358F, 0.00067317058F,
<a name="l00204"></a>00204   0.00071691700F, 0.00076350630F, 0.00081312324F, 0.00086596457F,
<a name="l00205"></a>00205   0.00092223983F, 0.00098217216F, 0.0010459992F, 0.0011139742F,
<a name="l00206"></a>00206   0.0011863665F, 0.0012634633F, 0.0013455702F, 0.0014330129F,
<a name="l00207"></a>00207   0.0015261382F, 0.0016253153F, 0.0017309374F, 0.0018434235F,
<a name="l00208"></a>00208   0.0019632195F, 0.0020908006F, 0.0022266726F, 0.0023713743F,
<a name="l00209"></a>00209   0.0025254795F, 0.0026895994F, 0.0028643847F, 0.0030505286F,
<a name="l00210"></a>00210   0.0032487691F, 0.0034598925F, 0.0036847358F, 0.0039241906F,
<a name="l00211"></a>00211   0.0041792066F, 0.0044507950F, 0.0047400328F, 0.0050480668F,
<a name="l00212"></a>00212   0.0053761186F, 0.0057254891F, 0.0060975636F, 0.0064938176F,
<a name="l00213"></a>00213   0.0069158225F, 0.0073652516F, 0.0078438871F, 0.0083536271F,
<a name="l00214"></a>00214   0.0088964928F, 0.009474637F, 0.010090352F, 0.010746080F,
<a name="l00215"></a>00215   0.011444421F, 0.012188144F, 0.012980198F, 0.013823725F,
<a name="l00216"></a>00216   0.014722068F, 0.015678791F, 0.016697687F, 0.017782797F,
<a name="l00217"></a>00217   0.018938423F, 0.020169149F, 0.021479854F, 0.022875735F,
<a name="l00218"></a>00218   0.024362330F, 0.025945531F, 0.027631618F, 0.029427276F,
<a name="l00219"></a>00219   0.031339626F, 0.033376252F, 0.035545228F, 0.037855157F,
<a name="l00220"></a>00220   0.040315199F, 0.042935108F, 0.045725273F, 0.048696758F,
<a name="l00221"></a>00221   0.051861348F, 0.055231591F, 0.058820850F, 0.062643361F,
<a name="l00222"></a>00222   0.066714279F, 0.071049749F, 0.075666962F, 0.080584227F,
<a name="l00223"></a>00223   0.085821044F, 0.091398179F, 0.097337747F, 0.10366330F,
<a name="l00224"></a>00224   0.11039993F, 0.11757434F, 0.12521498F, 0.13335215F,
<a name="l00225"></a>00225   0.14201813F, 0.15124727F, 0.16107617F, 0.17154380F,
<a name="l00226"></a>00226   0.18269168F, 0.19456402F, 0.20720788F, 0.22067342F,
<a name="l00227"></a>00227   0.23501402F, 0.25028656F, 0.26655159F, 0.28387361F,
<a name="l00228"></a>00228   0.30232132F, 0.32196786F, 0.34289114F, 0.36517414F,
<a name="l00229"></a>00229   0.38890521F, 0.41417847F, 0.44109412F, 0.46975890F,
<a name="l00230"></a>00230   0.50028648F, 0.53279791F, 0.56742212F, 0.60429640F,
<a name="l00231"></a>00231   0.64356699F, 0.68538959F, 0.72993007F, 0.77736504F,
<a name="l00232"></a>00232   0.82788260F, 0.88168307F, 0.9389798F, 1.F,
<a name="l00233"></a>00233 };
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 <span class="preprocessor">#endif</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span>
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 <span class="keyword">static</span> <span class="keywordtype">int</span> mapping0_forward(<a class="code" href="structvorbis__block.html">vorbis_block</a> *vb){
<a name="l00239"></a>00239   <a class="code" href="structvorbis__dsp__state.html">vorbis_dsp_state</a>      *vd=vb-&gt;<a class="code" href="structvorbis__block.html#adefe79be61ef3631c18cd7b8afae31a2">vd</a>;
<a name="l00240"></a>00240   <a class="code" href="structvorbis__info.html">vorbis_info</a>           *vi=vd-&gt;<a class="code" href="structvorbis__dsp__state.html#ab6819a31e79031cdcd8f2ff40a5c1def">vi</a>;
<a name="l00241"></a>00241   <a class="code" href="structcodec__setup__info.html">codec_setup_info</a>      *ci=vi-&gt;<a class="code" href="structvorbis__info.html#a440988f081a417fd1586a4c3d44bc00c">codec_setup</a>;
<a name="l00242"></a>00242   <a class="code" href="structprivate__state.html">private_state</a>         *b=vb-&gt;<a class="code" href="structvorbis__block.html#adefe79be61ef3631c18cd7b8afae31a2">vd</a>-&gt;<a class="code" href="structvorbis__dsp__state.html#a97ff4df8d289e5e3968029e47d7f8162">backend_state</a>;
<a name="l00243"></a>00243   <a class="code" href="structvorbis__block__internal.html">vorbis_block_internal</a> *vbi=(<a class="code" href="structvorbis__block__internal.html">vorbis_block_internal</a> *)vb-&gt;<a class="code" href="structvorbis__block.html#ab506fee4272b6e8c634516c1cbb1e638">internal</a>;
<a name="l00244"></a>00244   <span class="keywordtype">int</span>                    <a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>=vb-&gt;<a class="code" href="structvorbis__block.html#a946562a7fdb80cabf6ee749bdce1a0ed">pcmend</a>;
<a name="l00245"></a>00245   <span class="keywordtype">int</span> i,j,k;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247   <span class="keywordtype">int</span>    *nonzero    = alloca(<span class="keyword">sizeof</span>(*nonzero)*vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>);
<a name="l00248"></a>00248   <span class="keywordtype">float</span>  **gmdct     = <a class="code" href="block_8c.html#a76a1e9def91a196cbbf17058bb6d5e97">_vorbis_block_alloc</a>(vb,vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>*<span class="keyword">sizeof</span>(*gmdct));
<a name="l00249"></a>00249   <span class="keywordtype">int</span>    **iwork      = <a class="code" href="block_8c.html#a76a1e9def91a196cbbf17058bb6d5e97">_vorbis_block_alloc</a>(vb,vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>*<span class="keyword">sizeof</span>(*iwork));
<a name="l00250"></a>00250   <span class="keywordtype">int</span> ***floor_posts = <a class="code" href="block_8c.html#a76a1e9def91a196cbbf17058bb6d5e97">_vorbis_block_alloc</a>(vb,vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>*<span class="keyword">sizeof</span>(*floor_posts));
<a name="l00251"></a>00251 
<a name="l00252"></a>00252   <span class="keywordtype">float</span> global_ampmax=vbi-&gt;<a class="code" href="structvorbis__block__internal.html#ad06b07115317a4928f8807c61a903da9">ampmax</a>;
<a name="l00253"></a>00253   <span class="keywordtype">float</span> *local_ampmax=alloca(<span class="keyword">sizeof</span>(*local_ampmax)*vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>);
<a name="l00254"></a>00254   <span class="keywordtype">int</span> blocktype=vbi-&gt;<a class="code" href="structvorbis__block__internal.html#a4e3ca80a917072fbbe17dd5bd23f96ed">blocktype</a>;
<a name="l00255"></a>00255 
<a name="l00256"></a>00256   <span class="keywordtype">int</span> modenumber=vb-&gt;<a class="code" href="structvorbis__block.html#a1e420440dd6a5a39262c0fe7afa8435a">W</a>;
<a name="l00257"></a>00257   <a class="code" href="structvorbis__info__mapping0.html">vorbis_info_mapping0</a> *info=ci-&gt;<a class="code" href="structcodec__setup__info.html#ac1ba2acf8ad63b29d8889920c43d2549">map_param</a>[modenumber];
<a name="l00258"></a>00258   <a class="code" href="structvorbis__look__psy.html">vorbis_look_psy</a> *psy_look=b-&gt;<a class="code" href="structprivate__state.html#a26015e60330f92d6d303c0db9c712287">psy</a>+blocktype+(vb-&gt;<a class="code" href="structvorbis__block.html#a1e420440dd6a5a39262c0fe7afa8435a">W</a>?2:0);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260   vb-&gt;<a class="code" href="structvorbis__block.html#adab44bb8520c9d5daafee3f1a1bcf538">mode</a>=modenumber;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262   <span class="keywordflow">for</span>(i=0;i&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;i++){
<a name="l00263"></a>00263     <span class="keywordtype">float</span> scale=4.f/<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>;
<a name="l00264"></a>00264     <span class="keywordtype">float</span> scale_dB;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keywordtype">float</span> *pcm     =vb-&gt;<a class="code" href="structvorbis__block.html#ac8312d70a6e63afc01d3df8a54ac6508">pcm</a>[i];
<a name="l00267"></a>00267     <span class="keywordtype">float</span> *logfft  =pcm;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     iwork[i]=<a class="code" href="block_8c.html#a76a1e9def91a196cbbf17058bb6d5e97">_vorbis_block_alloc</a>(vb,<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>/2*<span class="keyword">sizeof</span>(**iwork));
<a name="l00270"></a>00270     gmdct[i]=<a class="code" href="block_8c.html#a76a1e9def91a196cbbf17058bb6d5e97">_vorbis_block_alloc</a>(vb,<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>/2*<span class="keyword">sizeof</span>(**gmdct));
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     scale_dB=todB(&amp;scale) + .345; <span class="comment">/* + .345 is a hack; the original</span>
<a name="l00273"></a>00273 <span class="comment">                                     todB estimation used on IEEE 754</span>
<a name="l00274"></a>00274 <span class="comment">                                     compliant machines had a bug that</span>
<a name="l00275"></a>00275 <span class="comment">                                     returned dB values about a third</span>
<a name="l00276"></a>00276 <span class="comment">                                     of a decibel too high.  The bug</span>
<a name="l00277"></a>00277 <span class="comment">                                     was harmless because tunings</span>
<a name="l00278"></a>00278 <span class="comment">                                     implicitly took that into</span>
<a name="l00279"></a>00279 <span class="comment">                                     account.  However, fixing the bug</span>
<a name="l00280"></a>00280 <span class="comment">                                     in the estimator requires</span>
<a name="l00281"></a>00281 <span class="comment">                                     changing all the tunings as well.</span>
<a name="l00282"></a>00282 <span class="comment">                                     For now, it&#39;s easier to sync</span>
<a name="l00283"></a>00283 <span class="comment">                                     things back up here, and</span>
<a name="l00284"></a>00284 <span class="comment">                                     recalibrate the tunings in the</span>
<a name="l00285"></a>00285 <span class="comment">                                     next major model upgrade. */</span>
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="preprocessor">#if 0</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>==2){
<a name="l00289"></a>00289       <span class="keywordflow">if</span>(i==0)
<a name="l00290"></a>00290         _analysis_output(<span class="stringliteral">&quot;pcmL&quot;</span>,seq,pcm,<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>,0,0,total-<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>/2);
<a name="l00291"></a>00291       <span class="keywordflow">else</span>
<a name="l00292"></a>00292         _analysis_output(<span class="stringliteral">&quot;pcmR&quot;</span>,seq,pcm,<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>,0,0,total-<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>/2);
<a name="l00293"></a>00293     }<span class="keywordflow">else</span>{
<a name="l00294"></a>00294       _analysis_output(<span class="stringliteral">&quot;pcm&quot;</span>,seq,pcm,<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>,0,0,total-<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>/2);
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296 <span class="preprocessor">#endif</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>
<a name="l00298"></a>00298     <span class="comment">/* window the PCM data */</span>
<a name="l00299"></a>00299     <a class="code" href="window_8c.html#aa2460e67fc83adddda1759e5129d01ab">_vorbis_apply_window</a>(pcm,b-&gt;<a class="code" href="structprivate__state.html#af9be5f1a2c234d8fed9119b44b691876">window</a>,ci-&gt;<a class="code" href="structcodec__setup__info.html#a8b08129139f671b7bbd9573aa2576fe9">blocksizes</a>,vb-&gt;<a class="code" href="structvorbis__block.html#a97675088561ed9aa4559e869aafd1f2c">lW</a>,vb-&gt;<a class="code" href="structvorbis__block.html#a1e420440dd6a5a39262c0fe7afa8435a">W</a>,vb-&gt;<a class="code" href="structvorbis__block.html#a6fa002c8c36ad39c1c015cfa673dda28">nW</a>);
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 <span class="preprocessor">#if 0</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>==2){
<a name="l00303"></a>00303       <span class="keywordflow">if</span>(i==0)
<a name="l00304"></a>00304         _analysis_output(<span class="stringliteral">&quot;windowedL&quot;</span>,seq,pcm,<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>,0,0,total-<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>/2);
<a name="l00305"></a>00305       <span class="keywordflow">else</span>
<a name="l00306"></a>00306         _analysis_output(<span class="stringliteral">&quot;windowedR&quot;</span>,seq,pcm,<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>,0,0,total-<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>/2);
<a name="l00307"></a>00307     }<span class="keywordflow">else</span>{
<a name="l00308"></a>00308       _analysis_output(<span class="stringliteral">&quot;windowed&quot;</span>,seq,pcm,<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>,0,0,total-<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>/2);
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 <span class="preprocessor">#endif</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span>
<a name="l00312"></a>00312     <span class="comment">/* transform the PCM data */</span>
<a name="l00313"></a>00313     <span class="comment">/* only MDCT right now.... */</span>
<a name="l00314"></a>00314     <a class="code" href="mdct_8c.html#aaacce565968fde070906e1b134716e2b">mdct_forward</a>(b-&gt;<a class="code" href="structprivate__state.html#a1fefdab944d5992d2c837df7420ae0c3">transform</a>[vb-&gt;<a class="code" href="structvorbis__block.html#a1e420440dd6a5a39262c0fe7afa8435a">W</a>][0],pcm,gmdct[i]);
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     <span class="comment">/* FFT yields more accurate tonal estimation (not phase sensitive) */</span>
<a name="l00317"></a>00317     <a class="code" href="smallft_8c.html#aa1b54755c8bdf09d61862762720797c5">drft_forward</a>(&amp;b-&gt;<a class="code" href="structprivate__state.html#a81d78d1c72db43db2ddbc245444e4cfe">fft_look</a>[vb-&gt;<a class="code" href="structvorbis__block.html#a1e420440dd6a5a39262c0fe7afa8435a">W</a>],pcm);
<a name="l00318"></a>00318     logfft[0]=scale_dB+todB(pcm)  + .345; <span class="comment">/* + .345 is a hack; the</span>
<a name="l00319"></a>00319 <span class="comment">                                     original todB estimation used on</span>
<a name="l00320"></a>00320 <span class="comment">                                     IEEE 754 compliant machines had a</span>
<a name="l00321"></a>00321 <span class="comment">                                     bug that returned dB values about</span>
<a name="l00322"></a>00322 <span class="comment">                                     a third of a decibel too high.</span>
<a name="l00323"></a>00323 <span class="comment">                                     The bug was harmless because</span>
<a name="l00324"></a>00324 <span class="comment">                                     tunings implicitly took that into</span>
<a name="l00325"></a>00325 <span class="comment">                                     account.  However, fixing the bug</span>
<a name="l00326"></a>00326 <span class="comment">                                     in the estimator requires</span>
<a name="l00327"></a>00327 <span class="comment">                                     changing all the tunings as well.</span>
<a name="l00328"></a>00328 <span class="comment">                                     For now, it&#39;s easier to sync</span>
<a name="l00329"></a>00329 <span class="comment">                                     things back up here, and</span>
<a name="l00330"></a>00330 <span class="comment">                                     recalibrate the tunings in the</span>
<a name="l00331"></a>00331 <span class="comment">                                     next major model upgrade. */</span>
<a name="l00332"></a>00332     local_ampmax[i]=logfft[0];
<a name="l00333"></a>00333     <span class="keywordflow">for</span>(j=1;j&lt;<a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>-1;j+=2){
<a name="l00334"></a>00334       <span class="keywordtype">float</span> temp=pcm[j]*pcm[j]+pcm[j+1]*pcm[j+1];
<a name="l00335"></a>00335       temp=logfft[(j+1)&gt;&gt;1]=scale_dB+.5f*todB(&amp;temp)  + .345; <span class="comment">/* +</span>
<a name="l00336"></a>00336 <span class="comment">                                     .345 is a hack; the original todB</span>
<a name="l00337"></a>00337 <span class="comment">                                     estimation used on IEEE 754</span>
<a name="l00338"></a>00338 <span class="comment">                                     compliant machines had a bug that</span>
<a name="l00339"></a>00339 <span class="comment">                                     returned dB values about a third</span>
<a name="l00340"></a>00340 <span class="comment">                                     of a decibel too high.  The bug</span>
<a name="l00341"></a>00341 <span class="comment">                                     was harmless because tunings</span>
<a name="l00342"></a>00342 <span class="comment">                                     implicitly took that into</span>
<a name="l00343"></a>00343 <span class="comment">                                     account.  However, fixing the bug</span>
<a name="l00344"></a>00344 <span class="comment">                                     in the estimator requires</span>
<a name="l00345"></a>00345 <span class="comment">                                     changing all the tunings as well.</span>
<a name="l00346"></a>00346 <span class="comment">                                     For now, it&#39;s easier to sync</span>
<a name="l00347"></a>00347 <span class="comment">                                     things back up here, and</span>
<a name="l00348"></a>00348 <span class="comment">                                     recalibrate the tunings in the</span>
<a name="l00349"></a>00349 <span class="comment">                                     next major model upgrade. */</span>
<a name="l00350"></a>00350       <span class="keywordflow">if</span>(temp&gt;local_ampmax[i])local_ampmax[i]=temp;
<a name="l00351"></a>00351     }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     <span class="keywordflow">if</span>(local_ampmax[i]&gt;0.f)local_ampmax[i]=0.f;
<a name="l00354"></a>00354     <span class="keywordflow">if</span>(local_ampmax[i]&gt;global_ampmax)global_ampmax=local_ampmax[i];
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="preprocessor">#if 0</span>
<a name="l00357"></a>00357 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>==2){
<a name="l00358"></a>00358       <span class="keywordflow">if</span>(i==0){
<a name="l00359"></a>00359         _analysis_output(<span class="stringliteral">&quot;fftL&quot;</span>,seq,logfft,n/2,1,0,0);
<a name="l00360"></a>00360       }<span class="keywordflow">else</span>{
<a name="l00361"></a>00361         _analysis_output(<span class="stringliteral">&quot;fftR&quot;</span>,seq,logfft,n/2,1,0,0);
<a name="l00362"></a>00362       }
<a name="l00363"></a>00363     }<span class="keywordflow">else</span>{
<a name="l00364"></a>00364       _analysis_output(<span class="stringliteral">&quot;fft&quot;</span>,seq,logfft,n/2,1,0,0);
<a name="l00365"></a>00365     }
<a name="l00366"></a>00366 <span class="preprocessor">#endif</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span>
<a name="l00368"></a>00368   }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   {
<a name="l00371"></a>00371     <span class="keywordtype">float</span>   *noise        = <a class="code" href="block_8c.html#a76a1e9def91a196cbbf17058bb6d5e97">_vorbis_block_alloc</a>(vb,n/2*<span class="keyword">sizeof</span>(*noise));
<a name="l00372"></a>00372     <span class="keywordtype">float</span>   *tone         = <a class="code" href="block_8c.html#a76a1e9def91a196cbbf17058bb6d5e97">_vorbis_block_alloc</a>(vb,n/2*<span class="keyword">sizeof</span>(*tone));
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="keywordflow">for</span>(i=0;i&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;i++){
<a name="l00375"></a>00375       <span class="comment">/* the encoder setup assumes that all the modes used by any</span>
<a name="l00376"></a>00376 <span class="comment">         specific bitrate tweaking use the same floor */</span>
<a name="l00377"></a>00377 
<a name="l00378"></a>00378       <span class="keywordtype">int</span> submap=info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[i];
<a name="l00379"></a>00379 
<a name="l00380"></a>00380       <span class="comment">/* the following makes things clearer to *me* anyway */</span>
<a name="l00381"></a>00381       <span class="keywordtype">float</span> *mdct    =gmdct[i];
<a name="l00382"></a>00382       <span class="keywordtype">float</span> *logfft  =vb-&gt;<a class="code" href="structvorbis__block.html#ac8312d70a6e63afc01d3df8a54ac6508">pcm</a>[i];
<a name="l00383"></a>00383 
<a name="l00384"></a>00384       <span class="keywordtype">float</span> *logmdct =logfft+n/2;
<a name="l00385"></a>00385       <span class="keywordtype">float</span> *logmask =logfft;
<a name="l00386"></a>00386 
<a name="l00387"></a>00387       vb-&gt;<a class="code" href="structvorbis__block.html#adab44bb8520c9d5daafee3f1a1bcf538">mode</a>=modenumber;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389       floor_posts[i]=<a class="code" href="block_8c.html#a76a1e9def91a196cbbf17058bb6d5e97">_vorbis_block_alloc</a>(vb,<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>*<span class="keyword">sizeof</span>(**floor_posts));
<a name="l00390"></a>00390       memset(floor_posts[i],0,<span class="keyword">sizeof</span>(**floor_posts)*<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>);
<a name="l00391"></a>00391 
<a name="l00392"></a>00392       <span class="keywordflow">for</span>(j=0;j&lt;n/2;j++)
<a name="l00393"></a>00393         logmdct[j]=todB(mdct+j)  + .345; <span class="comment">/* + .345 is a hack; the original</span>
<a name="l00394"></a>00394 <span class="comment">                                     todB estimation used on IEEE 754</span>
<a name="l00395"></a>00395 <span class="comment">                                     compliant machines had a bug that</span>
<a name="l00396"></a>00396 <span class="comment">                                     returned dB values about a third</span>
<a name="l00397"></a>00397 <span class="comment">                                     of a decibel too high.  The bug</span>
<a name="l00398"></a>00398 <span class="comment">                                     was harmless because tunings</span>
<a name="l00399"></a>00399 <span class="comment">                                     implicitly took that into</span>
<a name="l00400"></a>00400 <span class="comment">                                     account.  However, fixing the bug</span>
<a name="l00401"></a>00401 <span class="comment">                                     in the estimator requires</span>
<a name="l00402"></a>00402 <span class="comment">                                     changing all the tunings as well.</span>
<a name="l00403"></a>00403 <span class="comment">                                     For now, it&#39;s easier to sync</span>
<a name="l00404"></a>00404 <span class="comment">                                     things back up here, and</span>
<a name="l00405"></a>00405 <span class="comment">                                     recalibrate the tunings in the</span>
<a name="l00406"></a>00406 <span class="comment">                                     next major model upgrade. */</span>
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="preprocessor">#if 0</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>==2){
<a name="l00410"></a>00410         <span class="keywordflow">if</span>(i==0)
<a name="l00411"></a>00411           _analysis_output(<span class="stringliteral">&quot;mdctL&quot;</span>,seq,logmdct,n/2,1,0,0);
<a name="l00412"></a>00412         <span class="keywordflow">else</span>
<a name="l00413"></a>00413           _analysis_output(<span class="stringliteral">&quot;mdctR&quot;</span>,seq,logmdct,n/2,1,0,0);
<a name="l00414"></a>00414       }<span class="keywordflow">else</span>{
<a name="l00415"></a>00415         _analysis_output(<span class="stringliteral">&quot;mdct&quot;</span>,seq,logmdct,n/2,1,0,0);
<a name="l00416"></a>00416       }
<a name="l00417"></a>00417 <span class="preprocessor">#endif</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span>
<a name="l00419"></a>00419       <span class="comment">/* first step; noise masking.  Not only does &#39;noise masking&#39;</span>
<a name="l00420"></a>00420 <span class="comment">         give us curves from which we can decide how much resolution</span>
<a name="l00421"></a>00421 <span class="comment">         to give noise parts of the spectrum, it also implicitly hands</span>
<a name="l00422"></a>00422 <span class="comment">         us a tonality estimate (the larger the value in the</span>
<a name="l00423"></a>00423 <span class="comment">         &#39;noise_depth&#39; vector, the more tonal that area is) */</span>
<a name="l00424"></a>00424 
<a name="l00425"></a>00425       <a class="code" href="psy_8c.html#ac1810545af983f3d7bdcc2279689f533">_vp_noisemask</a>(psy_look,
<a name="l00426"></a>00426                     logmdct,
<a name="l00427"></a>00427                     noise); <span class="comment">/* noise does not have by-frequency offset</span>
<a name="l00428"></a>00428 <span class="comment">                               bias applied yet */</span>
<a name="l00429"></a>00429 <span class="preprocessor">#if 0</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>==2){
<a name="l00431"></a>00431         <span class="keywordflow">if</span>(i==0)
<a name="l00432"></a>00432           _analysis_output(<span class="stringliteral">&quot;noiseL&quot;</span>,seq,noise,n/2,1,0,0);
<a name="l00433"></a>00433         <span class="keywordflow">else</span>
<a name="l00434"></a>00434           _analysis_output(<span class="stringliteral">&quot;noiseR&quot;</span>,seq,noise,n/2,1,0,0);
<a name="l00435"></a>00435       }<span class="keywordflow">else</span>{
<a name="l00436"></a>00436         _analysis_output(<span class="stringliteral">&quot;noise&quot;</span>,seq,noise,n/2,1,0,0);
<a name="l00437"></a>00437       }
<a name="l00438"></a>00438 <span class="preprocessor">#endif</span>
<a name="l00439"></a>00439 <span class="preprocessor"></span>
<a name="l00440"></a>00440       <span class="comment">/* second step: &#39;all the other crap&#39;; all the stuff that isn&#39;t</span>
<a name="l00441"></a>00441 <span class="comment">         computed/fit for bitrate management goes in the second psy</span>
<a name="l00442"></a>00442 <span class="comment">         vector.  This includes tone masking, peak limiting and ATH */</span>
<a name="l00443"></a>00443 
<a name="l00444"></a>00444       <a class="code" href="psy_8c.html#aa3b3c37a437296674cca2436dcba809d">_vp_tonemask</a>(psy_look,
<a name="l00445"></a>00445                    logfft,
<a name="l00446"></a>00446                    tone,
<a name="l00447"></a>00447                    global_ampmax,
<a name="l00448"></a>00448                    local_ampmax[i]);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 <span class="preprocessor">#if 0</span>
<a name="l00451"></a>00451 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>==2){
<a name="l00452"></a>00452         <span class="keywordflow">if</span>(i==0)
<a name="l00453"></a>00453           _analysis_output(<span class="stringliteral">&quot;toneL&quot;</span>,seq,tone,n/2,1,0,0);
<a name="l00454"></a>00454         <span class="keywordflow">else</span>
<a name="l00455"></a>00455           _analysis_output(<span class="stringliteral">&quot;toneR&quot;</span>,seq,tone,n/2,1,0,0);
<a name="l00456"></a>00456       }<span class="keywordflow">else</span>{
<a name="l00457"></a>00457         _analysis_output(<span class="stringliteral">&quot;tone&quot;</span>,seq,tone,n/2,1,0,0);
<a name="l00458"></a>00458       }
<a name="l00459"></a>00459 <span class="preprocessor">#endif</span>
<a name="l00460"></a>00460 <span class="preprocessor"></span>
<a name="l00461"></a>00461       <span class="comment">/* third step; we offset the noise vectors, overlay tone</span>
<a name="l00462"></a>00462 <span class="comment">         masking.  We then do a floor1-specific line fit.  If we&#39;re</span>
<a name="l00463"></a>00463 <span class="comment">         performing bitrate management, the line fit is performed</span>
<a name="l00464"></a>00464 <span class="comment">         multiple times for up/down tweakage on demand. */</span>
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 <span class="preprocessor">#if 0</span>
<a name="l00467"></a>00467 <span class="preprocessor"></span>      {
<a name="l00468"></a>00468       <span class="keywordtype">float</span> aotuv[psy_look-&gt;<a class="code" href="structvorbis__look__psy.html#a32e7f5f9a3c335d9376c9b3ffb3dd929">n</a>];
<a name="l00469"></a>00469 <span class="preprocessor">#endif</span>
<a name="l00470"></a>00470 <span class="preprocessor"></span>
<a name="l00471"></a>00471         <a class="code" href="psy_8c.html#a6a8f6ff5c487cd19e73aa3adf702dcd1">_vp_offset_and_mix</a>(psy_look,
<a name="l00472"></a>00472                            noise,
<a name="l00473"></a>00473                            tone,
<a name="l00474"></a>00474                            1,
<a name="l00475"></a>00475                            logmask,
<a name="l00476"></a>00476                            mdct,
<a name="l00477"></a>00477                            logmdct);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 <span class="preprocessor">#if 0</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>==2){
<a name="l00481"></a>00481           <span class="keywordflow">if</span>(i==0)
<a name="l00482"></a>00482             _analysis_output(<span class="stringliteral">&quot;aotuvM1_L&quot;</span>,seq,aotuv,psy_look-&gt;<a class="code" href="structvorbis__look__psy.html#a32e7f5f9a3c335d9376c9b3ffb3dd929">n</a>,1,1,0);
<a name="l00483"></a>00483           <span class="keywordflow">else</span>
<a name="l00484"></a>00484             _analysis_output(<span class="stringliteral">&quot;aotuvM1_R&quot;</span>,seq,aotuv,psy_look-&gt;<a class="code" href="structvorbis__look__psy.html#a32e7f5f9a3c335d9376c9b3ffb3dd929">n</a>,1,1,0);
<a name="l00485"></a>00485         }<span class="keywordflow">else</span>{
<a name="l00486"></a>00486           _analysis_output(<span class="stringliteral">&quot;aotuvM1&quot;</span>,seq,aotuv,psy_look-&gt;<a class="code" href="structvorbis__look__psy.html#a32e7f5f9a3c335d9376c9b3ffb3dd929">n</a>,1,1,0);
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488       }
<a name="l00489"></a>00489 <span class="preprocessor">#endif</span>
<a name="l00490"></a>00490 <span class="preprocessor"></span>
<a name="l00491"></a>00491 
<a name="l00492"></a>00492 <span class="preprocessor">#if 0</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>==2){
<a name="l00494"></a>00494         <span class="keywordflow">if</span>(i==0)
<a name="l00495"></a>00495           _analysis_output(<span class="stringliteral">&quot;mask1L&quot;</span>,seq,logmask,n/2,1,0,0);
<a name="l00496"></a>00496         <span class="keywordflow">else</span>
<a name="l00497"></a>00497           _analysis_output(<span class="stringliteral">&quot;mask1R&quot;</span>,seq,logmask,n/2,1,0,0);
<a name="l00498"></a>00498       }<span class="keywordflow">else</span>{
<a name="l00499"></a>00499         _analysis_output(<span class="stringliteral">&quot;mask1&quot;</span>,seq,logmask,n/2,1,0,0);
<a name="l00500"></a>00500       }
<a name="l00501"></a>00501 <span class="preprocessor">#endif</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span>
<a name="l00503"></a>00503       <span class="comment">/* this algorithm is hardwired to floor 1 for now; abort out if</span>
<a name="l00504"></a>00504 <span class="comment">         we&#39;re *not* floor1.  This won&#39;t happen unless someone has</span>
<a name="l00505"></a>00505 <span class="comment">         broken the encode setup lib.  Guard it anyway. */</span>
<a name="l00506"></a>00506       <span class="keywordflow">if</span>(ci-&gt;<a class="code" href="structcodec__setup__info.html#a21afed51cb5ad1c5c48d49e9ed4b3ed4">floor_type</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]]!=1)<span class="keywordflow">return</span>(-1);
<a name="l00507"></a>00507 
<a name="l00508"></a>00508       floor_posts[i][<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>/2]=
<a name="l00509"></a>00509         <a class="code" href="codec__internal_8h.html#a9cf8bca345f5cc65b555411560dbceb7">floor1_fit</a>(vb,b-&gt;<a class="code" href="structprivate__state.html#a760c8e735e944bff53e1cddba407b128">flr</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]],
<a name="l00510"></a>00510                    logmdct,
<a name="l00511"></a>00511                    logmask);
<a name="l00512"></a>00512 
<a name="l00513"></a>00513       <span class="comment">/* are we managing bitrate?  If so, perform two more fits for</span>
<a name="l00514"></a>00514 <span class="comment">         later rate tweaking (fits represent hi/lo) */</span>
<a name="l00515"></a>00515       <span class="keywordflow">if</span>(<a class="code" href="bitrate_8c.html#a340357d7f7012c18f5ca87ef769dfa97">vorbis_bitrate_managed</a>(vb) &amp;&amp; floor_posts[i][<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>/2]){
<a name="l00516"></a>00516         <span class="comment">/* higher rate by way of lower noise curve */</span>
<a name="l00517"></a>00517 
<a name="l00518"></a>00518         <a class="code" href="psy_8c.html#a6a8f6ff5c487cd19e73aa3adf702dcd1">_vp_offset_and_mix</a>(psy_look,
<a name="l00519"></a>00519                            noise,
<a name="l00520"></a>00520                            tone,
<a name="l00521"></a>00521                            2,
<a name="l00522"></a>00522                            logmask,
<a name="l00523"></a>00523                            mdct,
<a name="l00524"></a>00524                            logmdct);
<a name="l00525"></a>00525 
<a name="l00526"></a>00526 <span class="preprocessor">#if 0</span>
<a name="l00527"></a>00527 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>==2){
<a name="l00528"></a>00528           <span class="keywordflow">if</span>(i==0)
<a name="l00529"></a>00529             _analysis_output(<span class="stringliteral">&quot;mask2L&quot;</span>,seq,logmask,n/2,1,0,0);
<a name="l00530"></a>00530           <span class="keywordflow">else</span>
<a name="l00531"></a>00531             _analysis_output(<span class="stringliteral">&quot;mask2R&quot;</span>,seq,logmask,n/2,1,0,0);
<a name="l00532"></a>00532         }<span class="keywordflow">else</span>{
<a name="l00533"></a>00533           _analysis_output(<span class="stringliteral">&quot;mask2&quot;</span>,seq,logmask,n/2,1,0,0);
<a name="l00534"></a>00534         }
<a name="l00535"></a>00535 <span class="preprocessor">#endif</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span>
<a name="l00537"></a>00537         floor_posts[i][<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>-1]=
<a name="l00538"></a>00538           <a class="code" href="codec__internal_8h.html#a9cf8bca345f5cc65b555411560dbceb7">floor1_fit</a>(vb,b-&gt;<a class="code" href="structprivate__state.html#a760c8e735e944bff53e1cddba407b128">flr</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]],
<a name="l00539"></a>00539                      logmdct,
<a name="l00540"></a>00540                      logmask);
<a name="l00541"></a>00541 
<a name="l00542"></a>00542         <span class="comment">/* lower rate by way of higher noise curve */</span>
<a name="l00543"></a>00543         <a class="code" href="psy_8c.html#a6a8f6ff5c487cd19e73aa3adf702dcd1">_vp_offset_and_mix</a>(psy_look,
<a name="l00544"></a>00544                            noise,
<a name="l00545"></a>00545                            tone,
<a name="l00546"></a>00546                            0,
<a name="l00547"></a>00547                            logmask,
<a name="l00548"></a>00548                            mdct,
<a name="l00549"></a>00549                            logmdct);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551 <span class="preprocessor">#if 0</span>
<a name="l00552"></a>00552 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>==2){
<a name="l00553"></a>00553           <span class="keywordflow">if</span>(i==0)
<a name="l00554"></a>00554             _analysis_output(<span class="stringliteral">&quot;mask0L&quot;</span>,seq,logmask,n/2,1,0,0);
<a name="l00555"></a>00555           <span class="keywordflow">else</span>
<a name="l00556"></a>00556             _analysis_output(<span class="stringliteral">&quot;mask0R&quot;</span>,seq,logmask,n/2,1,0,0);
<a name="l00557"></a>00557         }<span class="keywordflow">else</span>{
<a name="l00558"></a>00558           _analysis_output(<span class="stringliteral">&quot;mask0&quot;</span>,seq,logmask,n/2,1,0,0);
<a name="l00559"></a>00559         }
<a name="l00560"></a>00560 <span class="preprocessor">#endif</span>
<a name="l00561"></a>00561 <span class="preprocessor"></span>
<a name="l00562"></a>00562         floor_posts[i][0]=
<a name="l00563"></a>00563           <a class="code" href="codec__internal_8h.html#a9cf8bca345f5cc65b555411560dbceb7">floor1_fit</a>(vb,b-&gt;<a class="code" href="structprivate__state.html#a760c8e735e944bff53e1cddba407b128">flr</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]],
<a name="l00564"></a>00564                      logmdct,
<a name="l00565"></a>00565                      logmask);
<a name="l00566"></a>00566 
<a name="l00567"></a>00567         <span class="comment">/* we also interpolate a range of intermediate curves for</span>
<a name="l00568"></a>00568 <span class="comment">           intermediate rates */</span>
<a name="l00569"></a>00569         <span class="keywordflow">for</span>(k=1;k&lt;<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>/2;k++)
<a name="l00570"></a>00570           floor_posts[i][k]=
<a name="l00571"></a>00571             <a class="code" href="codec__internal_8h.html#a833379c90cf29a7f88e6a33977f6f37a">floor1_interpolate_fit</a>(vb,b-&gt;<a class="code" href="structprivate__state.html#a760c8e735e944bff53e1cddba407b128">flr</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]],
<a name="l00572"></a>00572                                    floor_posts[i][0],
<a name="l00573"></a>00573                                    floor_posts[i][<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>/2],
<a name="l00574"></a>00574                                    k*65536/(<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>/2));
<a name="l00575"></a>00575         <span class="keywordflow">for</span>(k=<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>/2+1;k&lt;<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>-1;k++)
<a name="l00576"></a>00576           floor_posts[i][k]=
<a name="l00577"></a>00577             <a class="code" href="codec__internal_8h.html#a833379c90cf29a7f88e6a33977f6f37a">floor1_interpolate_fit</a>(vb,b-&gt;<a class="code" href="structprivate__state.html#a760c8e735e944bff53e1cddba407b128">flr</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]],
<a name="l00578"></a>00578                                    floor_posts[i][PACKETBLOBS/2],
<a name="l00579"></a>00579                                    floor_posts[i][PACKETBLOBS-1],
<a name="l00580"></a>00580                                    (k-PACKETBLOBS/2)*65536/(PACKETBLOBS/2));
<a name="l00581"></a>00581       }
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583   }
<a name="l00584"></a>00584   vbi-&gt;<a class="code" href="structvorbis__block__internal.html#ad06b07115317a4928f8807c61a903da9">ampmax</a>=global_ampmax;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586   <span class="comment">/*</span>
<a name="l00587"></a>00587 <span class="comment">    the next phases are performed once for vbr-only and PACKETBLOB</span>
<a name="l00588"></a>00588 <span class="comment">    times for bitrate managed modes.</span>
<a name="l00589"></a>00589 <span class="comment"></span>
<a name="l00590"></a>00590 <span class="comment">    1) encode actual mode being used</span>
<a name="l00591"></a>00591 <span class="comment">    2) encode the floor for each channel, compute coded mask curve/res</span>
<a name="l00592"></a>00592 <span class="comment">    3) normalize and couple.</span>
<a name="l00593"></a>00593 <span class="comment">    4) encode residue</span>
<a name="l00594"></a>00594 <span class="comment">    5) save packet bytes to the packetblob vector</span>
<a name="l00595"></a>00595 <span class="comment"></span>
<a name="l00596"></a>00596 <span class="comment">  */</span>
<a name="l00597"></a>00597 
<a name="l00598"></a>00598   <span class="comment">/* iterate over the many masking curve fits we&#39;ve created */</span>
<a name="l00599"></a>00599 
<a name="l00600"></a>00600   {
<a name="l00601"></a>00601     <span class="keywordtype">int</span> **couple_bundle=alloca(<span class="keyword">sizeof</span>(*couple_bundle)*vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>);
<a name="l00602"></a>00602     <span class="keywordtype">int</span> *zerobundle=alloca(<span class="keyword">sizeof</span>(*zerobundle)*vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="keywordflow">for</span>(k=(<a class="code" href="bitrate_8c.html#a340357d7f7012c18f5ca87ef769dfa97">vorbis_bitrate_managed</a>(vb)?0:<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>/2);
<a name="l00605"></a>00605         k&lt;=(<a class="code" href="bitrate_8c.html#a340357d7f7012c18f5ca87ef769dfa97">vorbis_bitrate_managed</a>(vb)?<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>-1:<a class="code" href="codec__internal_8h.html#a9293c5a15a78abadbe212d944080e04b">PACKETBLOBS</a>/2);
<a name="l00606"></a>00606         k++){
<a name="l00607"></a>00607       <a class="code" href="structoggpack__buffer.html">oggpack_buffer</a> *opb=vbi-&gt;<a class="code" href="structvorbis__block__internal.html#a7b98d48f2d7a3305005d0513a7698218">packetblob</a>[k];
<a name="l00608"></a>00608 
<a name="l00609"></a>00609       <span class="comment">/* start out our new packet blob with packet type and mode */</span>
<a name="l00610"></a>00610       <span class="comment">/* Encode the packet type */</span>
<a name="l00611"></a>00611       <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,0,1);
<a name="l00612"></a>00612       <span class="comment">/* Encode the modenumber */</span>
<a name="l00613"></a>00613       <span class="comment">/* Encode frame mode, pre,post windowsize, then dispatch */</span>
<a name="l00614"></a>00614       <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,modenumber,b-&gt;<a class="code" href="structprivate__state.html#a3178cdb14e6be6dc5673637d187f8a7b">modebits</a>);
<a name="l00615"></a>00615       <span class="keywordflow">if</span>(vb-&gt;<a class="code" href="structvorbis__block.html#a1e420440dd6a5a39262c0fe7afa8435a">W</a>){
<a name="l00616"></a>00616         <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,vb-&gt;<a class="code" href="structvorbis__block.html#a97675088561ed9aa4559e869aafd1f2c">lW</a>,1);
<a name="l00617"></a>00617         <a class="code" href="bitwise_8c.html#af2e77bfb7ad82b12c81e725d7b4c2133">oggpack_write</a>(opb,vb-&gt;<a class="code" href="structvorbis__block.html#a6fa002c8c36ad39c1c015cfa673dda28">nW</a>,1);
<a name="l00618"></a>00618       }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620       <span class="comment">/* encode floor, compute masking curve, sep out residue */</span>
<a name="l00621"></a>00621       <span class="keywordflow">for</span>(i=0;i&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;i++){
<a name="l00622"></a>00622         <span class="keywordtype">int</span> submap=info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[i];
<a name="l00623"></a>00623         <span class="keywordtype">int</span> *ilogmask=iwork[i];
<a name="l00624"></a>00624 
<a name="l00625"></a>00625         nonzero[i]=<a class="code" href="codec__internal_8h.html#a412dda71482901941e7f85df60347253">floor1_encode</a>(opb,vb,b-&gt;<a class="code" href="structprivate__state.html#a760c8e735e944bff53e1cddba407b128">flr</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]],
<a name="l00626"></a>00626                                  floor_posts[i][k],
<a name="l00627"></a>00627                                  ilogmask);
<a name="l00628"></a>00628 <span class="preprocessor">#if 0</span>
<a name="l00629"></a>00629 <span class="preprocessor"></span>        {
<a name="l00630"></a>00630           <span class="keywordtype">char</span> buf[80];
<a name="l00631"></a>00631           sprintf(buf,<span class="stringliteral">&quot;maskI%c%d&quot;</span>,i?<span class="charliteral">&#39;R&#39;</span>:<span class="charliteral">&#39;L&#39;</span>,k);
<a name="l00632"></a>00632           <span class="keywordtype">float</span> work[n/2];
<a name="l00633"></a>00633           <span class="keywordflow">for</span>(j=0;j&lt;n/2;j++)
<a name="l00634"></a>00634             work[j]=FLOOR1_fromdB_LOOKUP[iwork[i][j]];
<a name="l00635"></a>00635           _analysis_output(buf,seq,work,n/2,1,1,0);
<a name="l00636"></a>00636         }
<a name="l00637"></a>00637 <span class="preprocessor">#endif</span>
<a name="l00638"></a>00638 <span class="preprocessor"></span>      }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640       <span class="comment">/* our iteration is now based on masking curve, not prequant and</span>
<a name="l00641"></a>00641 <span class="comment">         coupling.  Only one prequant/coupling step */</span>
<a name="l00642"></a>00642 
<a name="l00643"></a>00643       <span class="comment">/* quantize/couple */</span>
<a name="l00644"></a>00644       <span class="comment">/* incomplete implementation that assumes the tree is all depth</span>
<a name="l00645"></a>00645 <span class="comment">         one, or no tree at all */</span>
<a name="l00646"></a>00646       <a class="code" href="psy_8c.html#a61c85571375521578807e2deff2232de">_vp_couple_quantize_normalize</a>(k,
<a name="l00647"></a>00647                                     &amp;ci-&gt;<a class="code" href="structcodec__setup__info.html#a73f2d587bb82d9c1e0c79a8d809c4e37">psy_g_param</a>,
<a name="l00648"></a>00648                                     psy_look,
<a name="l00649"></a>00649                                     info,
<a name="l00650"></a>00650                                     gmdct,
<a name="l00651"></a>00651                                     iwork,
<a name="l00652"></a>00652                                     nonzero,
<a name="l00653"></a>00653                                     ci-&gt;<a class="code" href="structcodec__setup__info.html#a73f2d587bb82d9c1e0c79a8d809c4e37">psy_g_param</a>.<a class="code" href="structvorbis__info__psy__global.html#a5d1433d9b0be686fcb7e9a9060457118">sliding_lowpass</a>[vb-&gt;<a class="code" href="structvorbis__block.html#a1e420440dd6a5a39262c0fe7afa8435a">W</a>][k],
<a name="l00654"></a>00654                                     vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 <span class="preprocessor">#if 0</span>
<a name="l00657"></a>00657 <span class="preprocessor"></span>      <span class="keywordflow">for</span>(i=0;i&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;i++){
<a name="l00658"></a>00658         <span class="keywordtype">char</span> buf[80];
<a name="l00659"></a>00659         sprintf(buf,<span class="stringliteral">&quot;res%c%d&quot;</span>,i?<span class="charliteral">&#39;R&#39;</span>:<span class="charliteral">&#39;L&#39;</span>,k);
<a name="l00660"></a>00660         <span class="keywordtype">float</span> work[n/2];
<a name="l00661"></a>00661         <span class="keywordflow">for</span>(j=0;j&lt;n/2;j++)
<a name="l00662"></a>00662           work[j]=iwork[i][j];
<a name="l00663"></a>00663         _analysis_output(buf,seq,work,n/2,1,0,0);
<a name="l00664"></a>00664       }
<a name="l00665"></a>00665 <span class="preprocessor">#endif</span>
<a name="l00666"></a>00666 <span class="preprocessor"></span>
<a name="l00667"></a>00667       <span class="comment">/* classify and encode by submap */</span>
<a name="l00668"></a>00668       <span class="keywordflow">for</span>(i=0;i&lt;info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>;i++){
<a name="l00669"></a>00669         <span class="keywordtype">int</span> ch_in_bundle=0;
<a name="l00670"></a>00670         <span class="keywordtype">long</span> **classifications;
<a name="l00671"></a>00671         <span class="keywordtype">int</span> resnum=info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a279880bea4274534b86667ad7fc1ae4d">residuesubmap</a>[i];
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         <span class="keywordflow">for</span>(j=0;j&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;j++){
<a name="l00674"></a>00674           <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[j]==i){
<a name="l00675"></a>00675             zerobundle[ch_in_bundle]=0;
<a name="l00676"></a>00676             <span class="keywordflow">if</span>(nonzero[j])zerobundle[ch_in_bundle]=1;
<a name="l00677"></a>00677             couple_bundle[ch_in_bundle++]=iwork[j];
<a name="l00678"></a>00678           }
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681         classifications=<a class="code" href="registry_8c.html#aa5681c8beefee142fb62e35dfda6b255">_residue_P</a>[ci-&gt;<a class="code" href="structcodec__setup__info.html#a47b8090556fae1648803a10d58717235">residue_type</a>[resnum]]-&gt;
<a name="l00682"></a>00682           <span class="keyword">class</span>(vb,b-&gt;<a class="code" href="structprivate__state.html#a4a336f98a934f3810f0cba19a597bb45">residue</a>[resnum],couple_bundle,zerobundle,ch_in_bundle);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684         ch_in_bundle=0;
<a name="l00685"></a>00685         <span class="keywordflow">for</span>(j=0;j&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;j++)
<a name="l00686"></a>00686           <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[j]==i)
<a name="l00687"></a>00687             couple_bundle[ch_in_bundle++]=iwork[j];
<a name="l00688"></a>00688 
<a name="l00689"></a>00689         <a class="code" href="registry_8c.html#aa5681c8beefee142fb62e35dfda6b255">_residue_P</a>[ci-&gt;<a class="code" href="structcodec__setup__info.html#a47b8090556fae1648803a10d58717235">residue_type</a>[resnum]]-&gt;
<a name="l00690"></a>00690           forward(opb,vb,b-&gt;<a class="code" href="structprivate__state.html#a4a336f98a934f3810f0cba19a597bb45">residue</a>[resnum],
<a name="l00691"></a>00691                   couple_bundle,zerobundle,ch_in_bundle,classifications,i);
<a name="l00692"></a>00692       }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694       <span class="comment">/* ok, done encoding.  Next protopacket. */</span>
<a name="l00695"></a>00695     }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697   }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 <span class="preprocessor">#if 0</span>
<a name="l00700"></a>00700 <span class="preprocessor"></span>  seq++;
<a name="l00701"></a>00701   total+=ci-&gt;<a class="code" href="structcodec__setup__info.html#a8b08129139f671b7bbd9573aa2576fe9">blocksizes</a>[vb-&gt;<a class="code" href="structvorbis__block.html#a1e420440dd6a5a39262c0fe7afa8435a">W</a>]/4+ci-&gt;<a class="code" href="structcodec__setup__info.html#a8b08129139f671b7bbd9573aa2576fe9">blocksizes</a>[vb-&gt;<a class="code" href="structvorbis__block.html#a6fa002c8c36ad39c1c015cfa673dda28">nW</a>]/4;
<a name="l00702"></a>00702 <span class="preprocessor">#endif</span>
<a name="l00703"></a>00703 <span class="preprocessor"></span>  <span class="keywordflow">return</span>(0);
<a name="l00704"></a>00704 }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706 <span class="keyword">static</span> <span class="keywordtype">int</span> mapping0_inverse(<a class="code" href="structvorbis__block.html">vorbis_block</a> *vb,<a class="code" href="codec__internal_8h.html#ac950fba32fc1ede78f8bb7b83796969e">vorbis_info_mapping</a> *l){
<a name="l00707"></a>00707   <a class="code" href="structvorbis__dsp__state.html">vorbis_dsp_state</a>     *vd=vb-&gt;<a class="code" href="structvorbis__block.html#adefe79be61ef3631c18cd7b8afae31a2">vd</a>;
<a name="l00708"></a>00708   <a class="code" href="structvorbis__info.html">vorbis_info</a>          *vi=vd-&gt;<a class="code" href="structvorbis__dsp__state.html#ab6819a31e79031cdcd8f2ff40a5c1def">vi</a>;
<a name="l00709"></a>00709   <a class="code" href="structcodec__setup__info.html">codec_setup_info</a>     *ci=vi-&gt;<a class="code" href="structvorbis__info.html#a440988f081a417fd1586a4c3d44bc00c">codec_setup</a>;
<a name="l00710"></a>00710   <a class="code" href="structprivate__state.html">private_state</a>        *b=vd-&gt;<a class="code" href="structvorbis__dsp__state.html#a97ff4df8d289e5e3968029e47d7f8162">backend_state</a>;
<a name="l00711"></a>00711   <a class="code" href="structvorbis__info__mapping0.html">vorbis_info_mapping0</a> *info=(<a class="code" href="structvorbis__info__mapping0.html">vorbis_info_mapping0</a> *)l;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713   <span class="keywordtype">int</span>                   i,j;
<a name="l00714"></a>00714   <span class="keywordtype">long</span>                  n=vb-&gt;<a class="code" href="structvorbis__block.html#a946562a7fdb80cabf6ee749bdce1a0ed">pcmend</a>=ci-&gt;<a class="code" href="structcodec__setup__info.html#a8b08129139f671b7bbd9573aa2576fe9">blocksizes</a>[vb-&gt;<a class="code" href="structvorbis__block.html#a1e420440dd6a5a39262c0fe7afa8435a">W</a>];
<a name="l00715"></a>00715 
<a name="l00716"></a>00716   <span class="keywordtype">float</span> **pcmbundle=alloca(<span class="keyword">sizeof</span>(*pcmbundle)*vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>);
<a name="l00717"></a>00717   <span class="keywordtype">int</span>    *zerobundle=alloca(<span class="keyword">sizeof</span>(*zerobundle)*vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>);
<a name="l00718"></a>00718 
<a name="l00719"></a>00719   <span class="keywordtype">int</span>   *nonzero  =alloca(<span class="keyword">sizeof</span>(*nonzero)*vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>);
<a name="l00720"></a>00720   <span class="keywordtype">void</span> **floormemo=alloca(<span class="keyword">sizeof</span>(*floormemo)*vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722   <span class="comment">/* recover the spectral envelope; store it in the PCM vector for now */</span>
<a name="l00723"></a>00723   <span class="keywordflow">for</span>(i=0;i&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;i++){
<a name="l00724"></a>00724     <span class="keywordtype">int</span> submap=info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[i];
<a name="l00725"></a>00725     floormemo[i]=<a class="code" href="registry_8c.html#a7c01d48a66e98b53974c9c3344d8426d">_floor_P</a>[ci-&gt;<a class="code" href="structcodec__setup__info.html#a21afed51cb5ad1c5c48d49e9ed4b3ed4">floor_type</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]]]-&gt;
<a name="l00726"></a>00726       inverse1(vb,b-&gt;<a class="code" href="structprivate__state.html#a760c8e735e944bff53e1cddba407b128">flr</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]]);
<a name="l00727"></a>00727     <span class="keywordflow">if</span>(floormemo[i])
<a name="l00728"></a>00728       nonzero[i]=1;
<a name="l00729"></a>00729     <span class="keywordflow">else</span>
<a name="l00730"></a>00730       nonzero[i]=0;
<a name="l00731"></a>00731     memset(vb-&gt;<a class="code" href="structvorbis__block.html#ac8312d70a6e63afc01d3df8a54ac6508">pcm</a>[i],0,<span class="keyword">sizeof</span>(*vb-&gt;<a class="code" href="structvorbis__block.html#ac8312d70a6e63afc01d3df8a54ac6508">pcm</a>[i])*n/2);
<a name="l00732"></a>00732   }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734   <span class="comment">/* channel coupling can &#39;dirty&#39; the nonzero listing */</span>
<a name="l00735"></a>00735   <span class="keywordflow">for</span>(i=0;i&lt;info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ab8336109f7ccf188b8fa4b261d92be7f">coupling_steps</a>;i++){
<a name="l00736"></a>00736     <span class="keywordflow">if</span>(nonzero[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae668f0f09c4f101de4899e8a1310c8b">coupling_mag</a>[i]] ||
<a name="l00737"></a>00737        nonzero[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a9a145ee5d8f00b7255461b262fb4e886">coupling_ang</a>[i]]){
<a name="l00738"></a>00738       nonzero[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae668f0f09c4f101de4899e8a1310c8b">coupling_mag</a>[i]]=1;
<a name="l00739"></a>00739       nonzero[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a9a145ee5d8f00b7255461b262fb4e886">coupling_ang</a>[i]]=1;
<a name="l00740"></a>00740     }
<a name="l00741"></a>00741   }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743   <span class="comment">/* recover the residue into our working vectors */</span>
<a name="l00744"></a>00744   <span class="keywordflow">for</span>(i=0;i&lt;info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ac0b282a3786771686ce023fbd9690d58">submaps</a>;i++){
<a name="l00745"></a>00745     <span class="keywordtype">int</span> ch_in_bundle=0;
<a name="l00746"></a>00746     <span class="keywordflow">for</span>(j=0;j&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;j++){
<a name="l00747"></a>00747       <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[j]==i){
<a name="l00748"></a>00748         <span class="keywordflow">if</span>(nonzero[j])
<a name="l00749"></a>00749           zerobundle[ch_in_bundle]=1;
<a name="l00750"></a>00750         <span class="keywordflow">else</span>
<a name="l00751"></a>00751           zerobundle[ch_in_bundle]=0;
<a name="l00752"></a>00752         pcmbundle[ch_in_bundle++]=vb-&gt;<a class="code" href="structvorbis__block.html#ac8312d70a6e63afc01d3df8a54ac6508">pcm</a>[j];
<a name="l00753"></a>00753       }
<a name="l00754"></a>00754     }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756     <a class="code" href="registry_8c.html#aa5681c8beefee142fb62e35dfda6b255">_residue_P</a>[ci-&gt;<a class="code" href="structcodec__setup__info.html#a47b8090556fae1648803a10d58717235">residue_type</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a279880bea4274534b86667ad7fc1ae4d">residuesubmap</a>[i]]]-&gt;
<a name="l00757"></a>00757       inverse(vb,b-&gt;<a class="code" href="structprivate__state.html#a4a336f98a934f3810f0cba19a597bb45">residue</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a279880bea4274534b86667ad7fc1ae4d">residuesubmap</a>[i]],
<a name="l00758"></a>00758               pcmbundle,zerobundle,ch_in_bundle);
<a name="l00759"></a>00759   }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761   <span class="comment">/* channel coupling */</span>
<a name="l00762"></a>00762   <span class="keywordflow">for</span>(i=info-&gt;<a class="code" href="structvorbis__info__mapping0.html#ab8336109f7ccf188b8fa4b261d92be7f">coupling_steps</a>-1;i&gt;=0;i--){
<a name="l00763"></a>00763     <span class="keywordtype">float</span> *pcmM=vb-&gt;<a class="code" href="structvorbis__block.html#ac8312d70a6e63afc01d3df8a54ac6508">pcm</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae668f0f09c4f101de4899e8a1310c8b">coupling_mag</a>[i]];
<a name="l00764"></a>00764     <span class="keywordtype">float</span> *pcmA=vb-&gt;<a class="code" href="structvorbis__block.html#ac8312d70a6e63afc01d3df8a54ac6508">pcm</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a9a145ee5d8f00b7255461b262fb4e886">coupling_ang</a>[i]];
<a name="l00765"></a>00765 
<a name="l00766"></a>00766     <span class="keywordflow">for</span>(j=0;j&lt;n/2;j++){
<a name="l00767"></a>00767       <span class="keywordtype">float</span> mag=pcmM[j];
<a name="l00768"></a>00768       <span class="keywordtype">float</span> ang=pcmA[j];
<a name="l00769"></a>00769 
<a name="l00770"></a>00770       <span class="keywordflow">if</span>(mag&gt;0)
<a name="l00771"></a>00771         <span class="keywordflow">if</span>(ang&gt;0){
<a name="l00772"></a>00772           pcmM[j]=mag;
<a name="l00773"></a>00773           pcmA[j]=mag-ang;
<a name="l00774"></a>00774         }<span class="keywordflow">else</span>{
<a name="l00775"></a>00775           pcmA[j]=mag;
<a name="l00776"></a>00776           pcmM[j]=mag+ang;
<a name="l00777"></a>00777         }
<a name="l00778"></a>00778       <span class="keywordflow">else</span>
<a name="l00779"></a>00779         <span class="keywordflow">if</span>(ang&gt;0){
<a name="l00780"></a>00780           pcmM[j]=mag;
<a name="l00781"></a>00781           pcmA[j]=mag+ang;
<a name="l00782"></a>00782         }<span class="keywordflow">else</span>{
<a name="l00783"></a>00783           pcmA[j]=mag;
<a name="l00784"></a>00784           pcmM[j]=mag-ang;
<a name="l00785"></a>00785         }
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787   }
<a name="l00788"></a>00788 
<a name="l00789"></a>00789   <span class="comment">/* compute and apply spectral envelope */</span>
<a name="l00790"></a>00790   <span class="keywordflow">for</span>(i=0;i&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;i++){
<a name="l00791"></a>00791     <span class="keywordtype">float</span> *pcm=vb-&gt;<a class="code" href="structvorbis__block.html#ac8312d70a6e63afc01d3df8a54ac6508">pcm</a>[i];
<a name="l00792"></a>00792     <span class="keywordtype">int</span> submap=info-&gt;<a class="code" href="structvorbis__info__mapping0.html#a65301b0ac70965455f29baf01503f959">chmuxlist</a>[i];
<a name="l00793"></a>00793     <a class="code" href="registry_8c.html#a7c01d48a66e98b53974c9c3344d8426d">_floor_P</a>[ci-&gt;<a class="code" href="structcodec__setup__info.html#a21afed51cb5ad1c5c48d49e9ed4b3ed4">floor_type</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]]]-&gt;
<a name="l00794"></a>00794       inverse2(vb,b-&gt;<a class="code" href="structprivate__state.html#a760c8e735e944bff53e1cddba407b128">flr</a>[info-&gt;<a class="code" href="structvorbis__info__mapping0.html#aae16b72a605d49cbbf4c8b18848e1102">floorsubmap</a>[submap]],
<a name="l00795"></a>00795                floormemo[i],pcm);
<a name="l00796"></a>00796   }
<a name="l00797"></a>00797 
<a name="l00798"></a>00798   <span class="comment">/* transform the PCM data; takes PCM vector, vb; modifies PCM vector */</span>
<a name="l00799"></a>00799   <span class="comment">/* only MDCT right now.... */</span>
<a name="l00800"></a>00800   <span class="keywordflow">for</span>(i=0;i&lt;vi-&gt;<a class="code" href="structvorbis__info.html#a4240e042b91744b4fd810426f18252b4">channels</a>;i++){
<a name="l00801"></a>00801     <span class="keywordtype">float</span> *pcm=vb-&gt;<a class="code" href="structvorbis__block.html#ac8312d70a6e63afc01d3df8a54ac6508">pcm</a>[i];
<a name="l00802"></a>00802     <a class="code" href="mdct_8c.html#a546d807c915a5bc9679fde4ab2652ca0">mdct_backward</a>(b-&gt;<a class="code" href="structprivate__state.html#a1fefdab944d5992d2c837df7420ae0c3">transform</a>[vb-&gt;<a class="code" href="structvorbis__block.html#a1e420440dd6a5a39262c0fe7afa8435a">W</a>][0],pcm,pcm);
<a name="l00803"></a>00803   }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805   <span class="comment">/* all done! */</span>
<a name="l00806"></a>00806   <span class="keywordflow">return</span>(0);
<a name="l00807"></a>00807 }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809 <span class="comment">/* export hooks */</span>
<a name="l00810"></a><a class="code" href="registry_8c.html#aeee112626f7356f26a0e31769271d10c">00810</a> <span class="keyword">const</span> <a class="code" href="structvorbis__func__mapping.html">vorbis_func_mapping</a> <a class="code" href="mapping0_8c.html#aeee112626f7356f26a0e31769271d10c">mapping0_exportbundle</a>={
<a name="l00811"></a>00811   &amp;mapping0_pack,
<a name="l00812"></a>00812   &amp;mapping0_unpack,
<a name="l00813"></a>00813   &amp;mapping0_free_info,
<a name="l00814"></a>00814   &amp;mapping0_forward,
<a name="l00815"></a>00815   &amp;mapping0_inverse
<a name="l00816"></a>00816 };
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="mapping0_8c.html">mapping0.c</a>      </li>

    <li class="footer">Generated on Tue Mar 13 2012 11:44:11 for ARK2D by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.0 </li>
   </ul>
 </div>


</body>
</html>
