<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ARK2D: src/ARK2D/vendor/android/openal/jni/src/Alc/alcReverb.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ARK2D
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('alc_reverb_8c.html','');
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">src/ARK2D/vendor/android/openal/jni/src/Alc/alcReverb.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="alc_reverb_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="al_8h.html">AL/al.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="alc_8h.html">AL/alc.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="al_main_8h.html">alMain.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="al_aux_effect_slot_8h.html">alAuxEffectSlot.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="al_effect_8h.html">alEffect.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="al_error_8h.html">alError.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="alu_8h.html">alu.h</a>&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a><a class="code" href="struct_delay_line.html">00035</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct_delay_line.html">DelayLine</a>
<a name="l00036"></a>00036 {
<a name="l00037"></a>00037     <span class="comment">// The delay lines use sample lengths that are powers of 2 to allow the</span>
<a name="l00038"></a>00038     <span class="comment">// use of bit-masking instead of a modulus for wrapping.</span>
<a name="l00039"></a><a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">00039</a>     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>   <a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a>;
<a name="l00040"></a><a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">00040</a>     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a>;
<a name="l00041"></a>00041 } <a class="code" href="alc_reverb_8c.html#a7db6fb6702a07516f0048222e0d6448d">DelayLine</a>;
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="struct_a_lverb_state.html">00043</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct_a_lverb_state.html">ALverbState</a> {
<a name="l00044"></a>00044     <span class="comment">// Must be first in all effects!</span>
<a name="l00045"></a><a class="code" href="struct_a_lverb_state.html#a8664c25159271fd8afa71e88634fcdd7">00045</a>     <a class="code" href="struct_a_leffect_state.html">ALeffectState</a> <a class="code" href="struct_a_lverb_state.html#a8664c25159271fd8afa71e88634fcdd7">state</a>;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     <span class="comment">// All delay lines are allocated as a single buffer to reduce memory</span>
<a name="l00048"></a>00048     <span class="comment">// fragmentation and management code.</span>
<a name="l00049"></a><a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">00049</a>     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>  *<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>;
<a name="l00050"></a><a class="code" href="struct_a_lverb_state.html#a33285ed214990a991160564fb7603910">00050</a>     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>    <a class="code" href="struct_a_lverb_state.html#a33285ed214990a991160564fb7603910">TotalSamples</a>;
<a name="l00051"></a>00051     <span class="comment">// Master effect low-pass filter (2 chained 1-pole filters).</span>
<a name="l00052"></a><a class="code" href="struct_a_lverb_state.html#aab75c35b4386926fbd20924e604372b0">00052</a>     <a class="code" href="struct_f_i_l_t_e_r.html">FILTER</a>    <a class="code" href="struct_a_lverb_state.html#aab75c35b4386926fbd20924e604372b0">LpFilter</a>;
<a name="l00053"></a><a class="code" href="struct_a_lverb_state.html#a5b5c060858b2e26c962fb329940af191">00053</a>     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a5b5c060858b2e26c962fb329940af191">LpHistory</a>[2];
<a name="l00054"></a>00054     <span class="keyword">struct </span>{
<a name="l00055"></a>00055         <span class="comment">// Modulator delay line.</span>
<a name="l00056"></a><a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">00056</a>         <a class="code" href="struct_delay_line.html">DelayLine</a> <a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>;
<a name="l00057"></a>00057         <span class="comment">// The vibrato time is tracked with an index over a modulus-wrapped</span>
<a name="l00058"></a>00058         <span class="comment">// range (in samples).</span>
<a name="l00059"></a><a class="code" href="struct_a_lverb_state.html#af3fcb94c1627df5038ff48ff0ca0159b">00059</a>         <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>    <a class="code" href="struct_a_lverb_state.html#af3fcb94c1627df5038ff48ff0ca0159b">Index</a>;
<a name="l00060"></a><a class="code" href="struct_a_lverb_state.html#aa7a28f50d1bc229b3ac92489c0f9acbf">00060</a>         <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>    <a class="code" href="struct_a_lverb_state.html#aa7a28f50d1bc229b3ac92489c0f9acbf">Range</a>;
<a name="l00061"></a>00061         <span class="comment">// The depth of frequency change (also in samples) and its filter.</span>
<a name="l00062"></a><a class="code" href="struct_a_lverb_state.html#aafb26255182359033d7704286a1444aa">00062</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#aafb26255182359033d7704286a1444aa">Depth</a>;
<a name="l00063"></a><a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">00063</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>;
<a name="l00064"></a><a class="code" href="struct_a_lverb_state.html#af484b13957675f52ff8fbc6b3bbbf809">00064</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#af484b13957675f52ff8fbc6b3bbbf809">Filter</a>;
<a name="l00065"></a>00065     } <a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>;
<a name="l00066"></a>00066     <span class="comment">// Initial effect delay.</span>
<a name="l00067"></a>00067     <a class="code" href="struct_delay_line.html">DelayLine</a> <a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>;
<a name="l00068"></a>00068     <span class="comment">// The tap points for the initial delay.  First tap goes to early</span>
<a name="l00069"></a>00069     <span class="comment">// reflections, the last to late reverb.</span>
<a name="l00070"></a><a class="code" href="struct_a_lverb_state.html#aae91bc3ac5e5fd7d9900d9cc9aebf614">00070</a>     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>    <a class="code" href="struct_a_lverb_state.html#aae91bc3ac5e5fd7d9900d9cc9aebf614">DelayTap</a>[2];
<a name="l00071"></a>00071     <span class="keyword">struct </span>{
<a name="l00072"></a>00072         <span class="comment">// Output gain for early reflections.</span>
<a name="l00073"></a><a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">00073</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a>;
<a name="l00074"></a>00074         <span class="comment">// Early reflections are done with 4 delay lines.</span>
<a name="l00075"></a>00075         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>[4];
<a name="l00076"></a>00076         <a class="code" href="struct_delay_line.html">DelayLine</a> <a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[4];
<a name="l00077"></a><a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">00077</a>         <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>    <a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>[4];
<a name="l00078"></a>00078         <span class="comment">// The gain for each output channel based on 3D panning (only for the</span>
<a name="l00079"></a>00079         <span class="comment">// EAX path).</span>
<a name="l00080"></a><a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">00080</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa9d24a2cd94e8ec72f22f694e60d323e7">OUTPUTCHANNELS</a>];
<a name="l00081"></a>00081     } <a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>;
<a name="l00082"></a>00082     <span class="comment">// Decorrelator delay line.</span>
<a name="l00083"></a><a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">00083</a>     <a class="code" href="struct_delay_line.html">DelayLine</a> <a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>;
<a name="l00084"></a>00084     <span class="comment">// There are actually 4 decorrelator taps, but the first occurs at the</span>
<a name="l00085"></a>00085     <span class="comment">// initial sample.</span>
<a name="l00086"></a><a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">00086</a>     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>    <a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[3];
<a name="l00087"></a>00087     <span class="keyword">struct </span>{
<a name="l00088"></a>00088         <span class="comment">// Output gain for late reverb.</span>
<a name="l00089"></a>00089         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a>;
<a name="l00090"></a>00090         <span class="comment">// Attenuation to compensate for the modal density and decay rate of</span>
<a name="l00091"></a>00091         <span class="comment">// the late lines.</span>
<a name="l00092"></a><a class="code" href="struct_a_lverb_state.html#a5e84154f5880e79ee0bc4e094c9b1e5c">00092</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a5e84154f5880e79ee0bc4e094c9b1e5c">DensityGain</a>;
<a name="l00093"></a>00093         <span class="comment">// The feed-back and feed-forward all-pass coefficient.</span>
<a name="l00094"></a><a class="code" href="struct_a_lverb_state.html#a4ff8897495d7ac9a1bd4a93de36c03c6">00094</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a4ff8897495d7ac9a1bd4a93de36c03c6">ApFeedCoeff</a>;
<a name="l00095"></a>00095         <span class="comment">// Mixing matrix coefficient.</span>
<a name="l00096"></a><a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">00096</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>;
<a name="l00097"></a>00097         <span class="comment">// Late reverb has 4 parallel all-pass filters.</span>
<a name="l00098"></a><a class="code" href="struct_a_lverb_state.html#a5d58dda9a07639a8b06bd96281441e82">00098</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a5d58dda9a07639a8b06bd96281441e82">ApCoeff</a>[4];
<a name="l00099"></a><a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">00099</a>         <a class="code" href="struct_delay_line.html">DelayLine</a> <a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>[4];
<a name="l00100"></a><a class="code" href="struct_a_lverb_state.html#ad14d16893ca9c4352b8f4772e43fe862">00100</a>         <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>    <a class="code" href="struct_a_lverb_state.html#ad14d16893ca9c4352b8f4772e43fe862">ApOffset</a>[4];
<a name="l00101"></a>00101         <span class="comment">// In addition to 4 cyclical delay lines.</span>
<a name="l00102"></a>00102         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>[4];
<a name="l00103"></a>00103         <a class="code" href="struct_delay_line.html">DelayLine</a> <a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[4];
<a name="l00104"></a>00104         <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>    <a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>[4];
<a name="l00105"></a>00105         <span class="comment">// The cyclical delay lines are 1-pole low-pass filtered.</span>
<a name="l00106"></a><a class="code" href="struct_a_lverb_state.html#a8989338e5a5a7a754919116d822351be">00106</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a8989338e5a5a7a754919116d822351be">LpCoeff</a>[4];
<a name="l00107"></a><a class="code" href="struct_a_lverb_state.html#aae60f2460d943f027893434ddb9b890e">00107</a>         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#aae60f2460d943f027893434ddb9b890e">LpSample</a>[4];
<a name="l00108"></a>00108         <span class="comment">// The gain for each output channel based on 3D panning (only for the</span>
<a name="l00109"></a>00109         <span class="comment">// EAX path).</span>
<a name="l00110"></a>00110         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa9d24a2cd94e8ec72f22f694e60d323e7">OUTPUTCHANNELS</a>];
<a name="l00111"></a>00111     } <a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>;
<a name="l00112"></a>00112     <span class="keyword">struct </span>{
<a name="l00113"></a>00113         <span class="comment">// Attenuation to compensate for the modal density and decay rate of</span>
<a name="l00114"></a>00114         <span class="comment">// the echo line.</span>
<a name="l00115"></a>00115         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a5e84154f5880e79ee0bc4e094c9b1e5c">DensityGain</a>;
<a name="l00116"></a>00116         <span class="comment">// Echo delay and all-pass lines.</span>
<a name="l00117"></a>00117         <a class="code" href="struct_delay_line.html">DelayLine</a> <a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>;
<a name="l00118"></a>00118         <a class="code" href="struct_delay_line.html">DelayLine</a> <a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>;
<a name="l00119"></a>00119         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>;
<a name="l00120"></a>00120         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a4ff8897495d7ac9a1bd4a93de36c03c6">ApFeedCoeff</a>;
<a name="l00121"></a>00121         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a5d58dda9a07639a8b06bd96281441e82">ApCoeff</a>;
<a name="l00122"></a>00122         <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>    <a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>;
<a name="l00123"></a>00123         <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>    <a class="code" href="struct_a_lverb_state.html#ad14d16893ca9c4352b8f4772e43fe862">ApOffset</a>;
<a name="l00124"></a>00124         <span class="comment">// The echo line is 1-pole low-pass filtered.</span>
<a name="l00125"></a>00125         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a8989338e5a5a7a754919116d822351be">LpCoeff</a>;
<a name="l00126"></a>00126         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#aae60f2460d943f027893434ddb9b890e">LpSample</a>;
<a name="l00127"></a>00127         <span class="comment">// Echo mixing coefficients.</span>
<a name="l00128"></a>00128         <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>   <a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>[2];
<a name="l00129"></a>00129     } <a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>;
<a name="l00130"></a>00130     <span class="comment">// The current read offset for all delay lines.</span>
<a name="l00131"></a>00131     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> <a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="comment">// Gain scale to account for device down-mixing</span>
<a name="l00134"></a><a class="code" href="struct_a_lverb_state.html#a96267a063dd46d0bd518882f4fc0afbd">00134</a>     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> <a class="code" href="struct_a_lverb_state.html#a96267a063dd46d0bd518882f4fc0afbd">Scale</a>;
<a name="l00135"></a>00135 } <a class="code" href="alc_reverb_8c.html#ae09db513dcabc95f9040741fd5813bbe">ALverbState</a>;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="comment">/* This coefficient is used to define the maximum frequency range controlled</span>
<a name="l00138"></a>00138 <span class="comment"> * by the modulation depth.  The current value of 0.1 will allow it to swing</span>
<a name="l00139"></a>00139 <span class="comment"> * from 0.9x to 1.1x.  This value must be below 1.  At 1 it will cause the</span>
<a name="l00140"></a>00140 <span class="comment"> * sampler to stall on the downswing, and above 1 it will cause it to sample</span>
<a name="l00141"></a>00141 <span class="comment"> * backwards.</span>
<a name="l00142"></a>00142 <span class="comment"> */</span>
<a name="l00143"></a>00143 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> MODULATION_DEPTH_COEFF = 0.1f;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="comment">/* A filter is used to avoid the terrible distortion caused by changing</span>
<a name="l00146"></a>00146 <span class="comment"> * modulation time and/or depth.  To be consistent across different sample</span>
<a name="l00147"></a>00147 <span class="comment"> * rates, the coefficient must be raised to a constant divided by the sample</span>
<a name="l00148"></a>00148 <span class="comment"> * rate:  coeff^(constant / rate).</span>
<a name="l00149"></a>00149 <span class="comment"> */</span>
<a name="l00150"></a>00150 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> MODULATION_FILTER_COEFF = 0.048f;
<a name="l00151"></a>00151 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> MODULATION_FILTER_CONST = 100000.0f;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="comment">// When diffusion is above 0, an all-pass filter is used to take the edge off</span>
<a name="l00154"></a>00154 <span class="comment">// the echo effect.  It uses the following line length (in seconds).</span>
<a name="l00155"></a>00155 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> ECHO_ALLPASS_LENGTH = 0.0133f;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 <span class="comment">// Input into the late reverb is decorrelated between four channels.  Their</span>
<a name="l00158"></a>00158 <span class="comment">// timings are dependent on a fraction and multiplier.  See the</span>
<a name="l00159"></a>00159 <span class="comment">// UpdateDecorrelator() routine for the calculations involved.</span>
<a name="l00160"></a>00160 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> DECO_FRACTION = 0.15f;
<a name="l00161"></a>00161 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> DECO_MULTIPLIER = 2.0f;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="comment">// All delay line lengths are specified in seconds.</span>
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="comment">// The lengths of the early delay lines.</span>
<a name="l00166"></a>00166 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> EARLY_LINE_LENGTH[4] =
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168     0.0015f, 0.0045f, 0.0135f, 0.0405f
<a name="l00169"></a>00169 };
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="comment">// The lengths of the late all-pass delay lines.</span>
<a name="l00172"></a>00172 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> ALLPASS_LINE_LENGTH[4] =
<a name="l00173"></a>00173 {
<a name="l00174"></a>00174     0.0151f, 0.0167f, 0.0183f, 0.0200f,
<a name="l00175"></a>00175 };
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="comment">// The lengths of the late cyclical delay lines.</span>
<a name="l00178"></a>00178 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> LATE_LINE_LENGTH[4] =
<a name="l00179"></a>00179 {
<a name="l00180"></a>00180     0.0211f, 0.0311f, 0.0461f, 0.0680f
<a name="l00181"></a>00181 };
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <span class="comment">// The late cyclical delay lines have a variable length dependent on the</span>
<a name="l00184"></a>00184 <span class="comment">// effect&#39;s density parameter (inverted for some reason) and this multiplier.</span>
<a name="l00185"></a>00185 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> LATE_LINE_MULTIPLIER = 4.0f;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="comment">// Calculate the length of a delay line and store its mask and offset.</span>
<a name="l00188"></a>00188 <span class="keyword">static</span> <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> CalcLineLength(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> length, <a class="code" href="al_main_8h.html#a1d7406fd9d3e3558086ad9f43961e2aa">ALintptrEXT</a> offset, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency, <a class="code" href="struct_delay_line.html">DelayLine</a> *Delay)
<a name="l00189"></a>00189 {
<a name="l00190"></a>00190     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> samples;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="comment">// All line lengths are powers of 2, calculated from their lengths, with</span>
<a name="l00193"></a>00193     <span class="comment">// an additional sample in case of rounding errors.</span>
<a name="l00194"></a>00194     samples = NextPowerOf2((<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(length * frequency) + 1);
<a name="l00195"></a>00195     <span class="comment">// All lines share a single sample buffer.</span>
<a name="l00196"></a>00196     Delay-&gt;<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a> = samples - 1;
<a name="l00197"></a>00197     Delay-&gt;<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a> = (<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>*)offset;
<a name="l00198"></a>00198     <span class="comment">// Return the sample count for accumulation.</span>
<a name="l00199"></a>00199     <span class="keywordflow">return</span> samples;
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="comment">// Given the allocated sample buffer, this function updates each delay line</span>
<a name="l00203"></a>00203 <span class="comment">// offset.</span>
<a name="l00204"></a>00204 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> RealizeLineOffset(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> * sampleBuffer, <a class="code" href="struct_delay_line.html">DelayLine</a> *Delay)
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206     Delay-&gt;<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a> = &amp;sampleBuffer[(<a class="code" href="al_main_8h.html#a1d7406fd9d3e3558086ad9f43961e2aa">ALintptrEXT</a>)Delay-&gt;<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a>];
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="comment">/* Calculates the delay line metrics and allocates the shared sample buffer</span>
<a name="l00210"></a>00210 <span class="comment"> * for all lines given a flag indicating whether or not to allocate the EAX-</span>
<a name="l00211"></a>00211 <span class="comment"> * related delays (eaxFlag) and the sample rate (frequency).  If an</span>
<a name="l00212"></a>00212 <span class="comment"> * allocation failure occurs, it returns AL_FALSE.</span>
<a name="l00213"></a>00213 <span class="comment"> */</span>
<a name="l00214"></a>00214 <span class="keyword">static</span> <a class="code" href="al_8h.html#a87bd2b64b8ce719af42bf9dfd0cdf8fc">ALboolean</a> AllocLines(<a class="code" href="al_8h.html#a87bd2b64b8ce719af42bf9dfd0cdf8fc">ALboolean</a> eaxFlag, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency, <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State)
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> totalSamples, index;
<a name="l00217"></a>00217     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> length;
<a name="l00218"></a>00218     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *newBuffer = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="comment">// All delay line lengths are calculated to accomodate the full range of</span>
<a name="l00221"></a>00221     <span class="comment">// lengths given their respective paramters.</span>
<a name="l00222"></a>00222     totalSamples = 0;
<a name="l00223"></a>00223     <span class="keywordflow">if</span>(eaxFlag)
<a name="l00224"></a>00224     {
<a name="l00225"></a>00225         <span class="comment">/* The modulator&#39;s line length is calculated from the maximum</span>
<a name="l00226"></a>00226 <span class="comment">         * modulation time and depth coefficient, and halfed for the low-to-</span>
<a name="l00227"></a>00227 <span class="comment">         * high frequency swing.  An additional sample is added to keep it</span>
<a name="l00228"></a>00228 <span class="comment">         * stable when there is no modulation.</span>
<a name="l00229"></a>00229 <span class="comment">         */</span>
<a name="l00230"></a>00230         length = (<a class="code" href="efx_8h.html#a3b42e75bc8e500088bd7ed7139d53af7">AL_EAXREVERB_MAX_MODULATION_TIME</a> * MODULATION_DEPTH_COEFF /
<a name="l00231"></a>00231                   2.0f) + (1.0f / frequency);
<a name="l00232"></a>00232         totalSamples += CalcLineLength(length, totalSamples, frequency,
<a name="l00233"></a>00233                                        &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>);
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="comment">// The initial delay is the sum of the reflections and late reverb</span>
<a name="l00237"></a>00237     <span class="comment">// delays.</span>
<a name="l00238"></a>00238     <span class="keywordflow">if</span>(eaxFlag)
<a name="l00239"></a>00239         length = <a class="code" href="efx_8h.html#a5162d8de2fa4638d9844de91447f1a52">AL_EAXREVERB_MAX_REFLECTIONS_DELAY</a> +
<a name="l00240"></a>00240                  <a class="code" href="efx_8h.html#ad59c3ff572b23e01ad2089a174ccee63">AL_EAXREVERB_MAX_LATE_REVERB_DELAY</a>;
<a name="l00241"></a>00241     <span class="keywordflow">else</span>
<a name="l00242"></a>00242         length = <a class="code" href="efx_8h.html#a903eca7005e5e19f8ab0d407e5f8be32">AL_REVERB_MAX_REFLECTIONS_DELAY</a> +
<a name="l00243"></a>00243                  <a class="code" href="efx_8h.html#aae956d85118399f6ba81d7551ff26a0d">AL_REVERB_MAX_LATE_REVERB_DELAY</a>;
<a name="l00244"></a>00244     totalSamples += CalcLineLength(length, totalSamples, frequency,
<a name="l00245"></a>00245                                    &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>);
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="comment">// The early reflection lines.</span>
<a name="l00248"></a>00248     <span class="keywordflow">for</span>(index = 0;index &lt; 4;index++)
<a name="l00249"></a>00249         totalSamples += CalcLineLength(EARLY_LINE_LENGTH[index], totalSamples,
<a name="l00250"></a>00250                                        frequency, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[index]);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="comment">// The decorrelator line is calculated from the lowest reverb density (a</span>
<a name="l00253"></a>00253     <span class="comment">// parameter value of 1).</span>
<a name="l00254"></a>00254     length = (DECO_FRACTION * DECO_MULTIPLIER * DECO_MULTIPLIER) *
<a name="l00255"></a>00255              LATE_LINE_LENGTH[0] * (1.0f + LATE_LINE_MULTIPLIER);
<a name="l00256"></a>00256     totalSamples += CalcLineLength(length, totalSamples, frequency,
<a name="l00257"></a>00257                                    &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="comment">// The late all-pass lines.</span>
<a name="l00260"></a>00260     <span class="keywordflow">for</span>(index = 0;index &lt; 4;index++)
<a name="l00261"></a>00261         totalSamples += CalcLineLength(ALLPASS_LINE_LENGTH[index], totalSamples,
<a name="l00262"></a>00262                                        frequency, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>[index]);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <span class="comment">// The late delay lines are calculated from the lowest reverb density.</span>
<a name="l00265"></a>00265     <span class="keywordflow">for</span>(index = 0;index &lt; 4;index++)
<a name="l00266"></a>00266     {
<a name="l00267"></a>00267         length = LATE_LINE_LENGTH[index] * (1.0f + LATE_LINE_MULTIPLIER);
<a name="l00268"></a>00268         totalSamples += CalcLineLength(length, totalSamples, frequency,
<a name="l00269"></a>00269                                        &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[index]);
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="keywordflow">if</span>(eaxFlag)
<a name="l00273"></a>00273     {
<a name="l00274"></a>00274         <span class="comment">// The echo all-pass and delay lines.</span>
<a name="l00275"></a>00275         totalSamples += CalcLineLength(ECHO_ALLPASS_LENGTH, totalSamples,
<a name="l00276"></a>00276                                        frequency, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>);
<a name="l00277"></a>00277         totalSamples += CalcLineLength(<a class="code" href="efx_8h.html#a3f3f27d282f6521cc7dc86ac21b3d6b4">AL_EAXREVERB_MAX_ECHO_TIME</a>, totalSamples,
<a name="l00278"></a>00278                                        frequency, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>);
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     <span class="keywordflow">if</span>(totalSamples != State-&gt;<a class="code" href="struct_a_lverb_state.html#a33285ed214990a991160564fb7603910">TotalSamples</a>)
<a name="l00282"></a>00282     {
<a name="l00283"></a>00283         newBuffer = realloc(State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>, <span class="keyword">sizeof</span>(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>) * totalSamples);
<a name="l00284"></a>00284         <span class="keywordflow">if</span>(newBuffer == <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00285"></a>00285             <span class="keywordflow">return</span> <a class="code" href="al_8h.html#a5aafce4e1e2b037b44a0c85dd7786793">AL_FALSE</a>;
<a name="l00286"></a>00286         State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a> = newBuffer;
<a name="l00287"></a>00287         State-&gt;<a class="code" href="struct_a_lverb_state.html#a33285ed214990a991160564fb7603910">TotalSamples</a> = totalSamples;
<a name="l00288"></a>00288     }
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="comment">// Update all delays to reflect the new sample buffer.</span>
<a name="l00291"></a>00291     RealizeLineOffset(State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>);
<a name="l00292"></a>00292     RealizeLineOffset(State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>);
<a name="l00293"></a>00293     <span class="keywordflow">for</span>(index = 0;index &lt; 4;index++)
<a name="l00294"></a>00294     {
<a name="l00295"></a>00295         RealizeLineOffset(State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[index]);
<a name="l00296"></a>00296         RealizeLineOffset(State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>[index]);
<a name="l00297"></a>00297         RealizeLineOffset(State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[index]);
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299     <span class="keywordflow">if</span>(eaxFlag)
<a name="l00300"></a>00300     {
<a name="l00301"></a>00301         RealizeLineOffset(State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>);
<a name="l00302"></a>00302         RealizeLineOffset(State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>);
<a name="l00303"></a>00303         RealizeLineOffset(State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>, &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>);
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="comment">// Clear the sample buffer.</span>
<a name="l00307"></a>00307     <span class="keywordflow">for</span>(index = 0;index &lt; State-&gt;<a class="code" href="struct_a_lverb_state.html#a33285ed214990a991160564fb7603910">TotalSamples</a>;index++)
<a name="l00308"></a>00308         State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>[index] = 0.0f;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="keywordflow">return</span> <a class="code" href="al_8h.html#abaf2cf350471d339f73fad46de91964a">AL_TRUE</a>;
<a name="l00311"></a>00311 }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 <span class="comment">// Calculate a decay coefficient given the length of each cycle and the time</span>
<a name="l00314"></a>00314 <span class="comment">// until the decay reaches -60 dB.</span>
<a name="l00315"></a>00315 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> CalcDecayCoeff(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> length, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> decayTime)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317     <span class="keywordflow">return</span> <a class="code" href="alu_8h.html#a94f8944f536e497a46fc40a3b31bf804">aluPow</a>(10.0f, length / decayTime * -60.0f / 20.0f);
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 <span class="comment">// Calculate a decay length from a coefficient and the time until the decay</span>
<a name="l00321"></a>00321 <span class="comment">// reaches -60 dB.</span>
<a name="l00322"></a>00322 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> CalcDecayLength(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> coeff, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> decayTime)
<a name="l00323"></a>00323 {
<a name="l00324"></a>00324     <span class="keywordflow">return</span> log10(coeff) / -60.0 * 20.0f * decayTime;
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 <span class="comment">// Calculate the high frequency parameter for the I3DL2 coefficient</span>
<a name="l00328"></a>00328 <span class="comment">// calculation.</span>
<a name="l00329"></a>00329 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> CalcI3DL2HFreq(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> hfRef, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency)
<a name="l00330"></a>00330 {
<a name="l00331"></a>00331     <span class="keywordflow">return</span> cos(2.0f * <a class="code" href="bs2b_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * hfRef / frequency);
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="comment">// Calculate an attenuation to be applied to the input of any echo models to</span>
<a name="l00335"></a>00335 <span class="comment">// compensate for modal density and decay time.</span>
<a name="l00336"></a>00336 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> CalcDensityGain(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> a)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338     <span class="comment">/* The energy of a signal can be obtained by finding the area under the</span>
<a name="l00339"></a>00339 <span class="comment">     * squared signal.  This takes the form of Sum(x_n^2), where x is the</span>
<a name="l00340"></a>00340 <span class="comment">     * amplitude for the sample n.</span>
<a name="l00341"></a>00341 <span class="comment">     *</span>
<a name="l00342"></a>00342 <span class="comment">     * Decaying feedback matches exponential decay of the form Sum(a^n),</span>
<a name="l00343"></a>00343 <span class="comment">     * where a is the attenuation coefficient, and n is the sample.  The area</span>
<a name="l00344"></a>00344 <span class="comment">     * under this decay curve can be calculated as:  1 / (1 - a).</span>
<a name="l00345"></a>00345 <span class="comment">     *</span>
<a name="l00346"></a>00346 <span class="comment">     * Modifying the above equation to find the squared area under the curve</span>
<a name="l00347"></a>00347 <span class="comment">     * (for energy) yields:  1 / (1 - a^2).  Input attenuation can then be</span>
<a name="l00348"></a>00348 <span class="comment">     * calculated by inverting the square root of this approximation,</span>
<a name="l00349"></a>00349 <span class="comment">     * yielding:  1 / sqrt(1 / (1 - a^2)), simplified to: sqrt(1 - a^2).</span>
<a name="l00350"></a>00350 <span class="comment">     */</span>
<a name="l00351"></a>00351     <span class="keywordflow">return</span> <a class="code" href="alu_8h.html#ac41b59018b2facd0fd949b939b3f9156">aluSqrt</a>(1.0f - (a * a));
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 <span class="comment">// Calculate the mixing matrix coefficients given a diffusion factor.</span>
<a name="l00355"></a>00355 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> CalcMatrixCoeffs(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> diffusion, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *x, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *y)
<a name="l00356"></a>00356 {
<a name="l00357"></a>00357     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> <a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>, t;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <span class="comment">// The matrix is of order 4, so n is sqrt (4 - 1).</span>
<a name="l00360"></a>00360     n = <a class="code" href="alu_8h.html#ac41b59018b2facd0fd949b939b3f9156">aluSqrt</a>(3.0f);
<a name="l00361"></a>00361     t = diffusion * atan(n);
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="comment">// Calculate the first mixing matrix coefficient.</span>
<a name="l00364"></a>00364     *x = cos(t);
<a name="l00365"></a>00365     <span class="comment">// Calculate the second mixing matrix coefficient.</span>
<a name="l00366"></a>00366     *y = sin(t) / <a class="code" href="jsonmain_8cpp.html#a4eacae1d9e7c39f8236bb36d4ececa77">n</a>;
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 <span class="comment">// Calculate the limited HF ratio for use with the late reverb low-pass</span>
<a name="l00370"></a>00370 <span class="comment">// filters.</span>
<a name="l00371"></a>00371 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> CalcLimitedHfRatio(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> hfRatio, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> airAbsorptionGainHF, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> decayTime)
<a name="l00372"></a>00372 {
<a name="l00373"></a>00373     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> limitRatio;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <span class="comment">/* Find the attenuation due to air absorption in dB (converting delay</span>
<a name="l00376"></a>00376 <span class="comment">     * time to meters using the speed of sound).  Then reversing the decay</span>
<a name="l00377"></a>00377 <span class="comment">     * equation, solve for HF ratio.  The delay length is cancelled out of</span>
<a name="l00378"></a>00378 <span class="comment">     * the equation, so it can be calculated once for all lines.</span>
<a name="l00379"></a>00379 <span class="comment">     */</span>
<a name="l00380"></a>00380     limitRatio = 1.0f / (CalcDecayLength(airAbsorptionGainHF, decayTime) *
<a name="l00381"></a>00381                          <a class="code" href="al_main_8h.html#a5ed2c6e28f71bfbdb9a41286224c965e">SPEEDOFSOUNDMETRESPERSEC</a>);
<a name="l00382"></a>00382     <span class="comment">// Need to limit the result to a minimum of 0.1, just like the HF ratio</span>
<a name="l00383"></a>00383     <span class="comment">// parameter.</span>
<a name="l00384"></a>00384     limitRatio = __max(limitRatio, 0.1f);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="comment">// Using the limit calculated above, apply the upper bound to the HF</span>
<a name="l00387"></a>00387     <span class="comment">// ratio.</span>
<a name="l00388"></a>00388     <span class="keywordflow">return</span> __min(hfRatio, limitRatio);
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="comment">// Calculate the coefficient for a HF (and eventually LF) decay damping</span>
<a name="l00392"></a>00392 <span class="comment">// filter.</span>
<a name="l00393"></a>00393 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> CalcDampingCoeff(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> hfRatio, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> length, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> decayTime, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> decayCoeff, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> cw)
<a name="l00394"></a>00394 {
<a name="l00395"></a>00395     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> coeff, g;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="comment">// Eventually this should boost the high frequencies when the ratio</span>
<a name="l00398"></a>00398     <span class="comment">// exceeds 1.</span>
<a name="l00399"></a>00399     coeff = 0.0f;
<a name="l00400"></a>00400     <span class="keywordflow">if</span> (hfRatio &lt; 1.0f)
<a name="l00401"></a>00401     {
<a name="l00402"></a>00402         <span class="comment">// Calculate the low-pass coefficient by dividing the HF decay</span>
<a name="l00403"></a>00403         <span class="comment">// coefficient by the full decay coefficient.</span>
<a name="l00404"></a>00404         g = CalcDecayCoeff(length, decayTime * hfRatio) / decayCoeff;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406         <span class="comment">// Damping is done with a 1-pole filter, so g needs to be squared.</span>
<a name="l00407"></a>00407         g *= g;
<a name="l00408"></a>00408         coeff = lpCoeffCalc(g, cw);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         <span class="comment">// Very low decay times will produce minimal output, so apply an</span>
<a name="l00411"></a>00411         <span class="comment">// upper bound to the coefficient.</span>
<a name="l00412"></a>00412         coeff = __min(coeff, 0.98f);
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414     <span class="keywordflow">return</span> coeff;
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 <span class="comment">// Update the EAX modulation index, range, and depth.  Keep in mind that this</span>
<a name="l00418"></a>00418 <span class="comment">// kind of vibrato is additive and not multiplicative as one may expect.  The</span>
<a name="l00419"></a>00419 <span class="comment">// downswing will sound stronger than the upswing.</span>
<a name="l00420"></a>00420 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> UpdateModulator(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> modTime, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> modDepth, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency, <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State)
<a name="l00421"></a>00421 {
<a name="l00422"></a>00422     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> length;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <span class="comment">/* Modulation is calculated in two parts.</span>
<a name="l00425"></a>00425 <span class="comment">     *</span>
<a name="l00426"></a>00426 <span class="comment">     * The modulation time effects the sinus applied to the change in</span>
<a name="l00427"></a>00427 <span class="comment">     * frequency.  An index out of the current time range (both in samples)</span>
<a name="l00428"></a>00428 <span class="comment">     * is incremented each sample.  The range is bound to a reasonable</span>
<a name="l00429"></a>00429 <span class="comment">     * minimum (1 sample) and when the timing changes, the index is rescaled</span>
<a name="l00430"></a>00430 <span class="comment">     * to the new range (to keep the sinus consistent).</span>
<a name="l00431"></a>00431 <span class="comment">     */</span>
<a name="l00432"></a>00432     length = modTime * frequency;
<a name="l00433"></a>00433     <span class="keywordflow">if</span> (length &gt;= 1.0f) {
<a name="l00434"></a>00434        State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af3fcb94c1627df5038ff48ff0ca0159b">Index</a> = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af3fcb94c1627df5038ff48ff0ca0159b">Index</a> * length /
<a name="l00435"></a>00435                                    State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#aa7a28f50d1bc229b3ac92489c0f9acbf">Range</a>);
<a name="l00436"></a>00436        State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#aa7a28f50d1bc229b3ac92489c0f9acbf">Range</a> = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)length;
<a name="l00437"></a>00437     } <span class="keywordflow">else</span> {
<a name="l00438"></a>00438        State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af3fcb94c1627df5038ff48ff0ca0159b">Index</a> = 0;
<a name="l00439"></a>00439        State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#aa7a28f50d1bc229b3ac92489c0f9acbf">Range</a> = 1;
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <span class="comment">/* The modulation depth effects the amount of frequency change over the</span>
<a name="l00443"></a>00443 <span class="comment">     * range of the sinus.  It needs to be scaled by the modulation time so</span>
<a name="l00444"></a>00444 <span class="comment">     * that a given depth produces a consistent change in frequency over all</span>
<a name="l00445"></a>00445 <span class="comment">     * ranges of time.  Since the depth is applied to a sinus value, it needs</span>
<a name="l00446"></a>00446 <span class="comment">     * to be halfed once for the sinus range and again for the sinus swing</span>
<a name="l00447"></a>00447 <span class="comment">     * in time (half of it is spent decreasing the frequency, half is spent</span>
<a name="l00448"></a>00448 <span class="comment">     * increasing it).</span>
<a name="l00449"></a>00449 <span class="comment">     */</span>
<a name="l00450"></a>00450     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#aafb26255182359033d7704286a1444aa">Depth</a> = modDepth * MODULATION_DEPTH_COEFF * modTime / 2.0f /
<a name="l00451"></a>00451                        2.0f * frequency;
<a name="l00452"></a>00452 }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 <span class="comment">// Update the offsets for the initial effect delay line.</span>
<a name="l00455"></a>00455 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> UpdateDelayLine(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> earlyDelay, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> lateDelay, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency, <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State)
<a name="l00456"></a>00456 {
<a name="l00457"></a>00457     <span class="comment">// Calculate the initial delay taps.</span>
<a name="l00458"></a>00458     State-&gt;<a class="code" href="struct_a_lverb_state.html#aae91bc3ac5e5fd7d9900d9cc9aebf614">DelayTap</a>[0] = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(earlyDelay * frequency);
<a name="l00459"></a>00459     State-&gt;<a class="code" href="struct_a_lverb_state.html#aae91bc3ac5e5fd7d9900d9cc9aebf614">DelayTap</a>[1] = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)((earlyDelay + lateDelay) * frequency);
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="comment">// Update the early reflections gain and line coefficients.</span>
<a name="l00463"></a>00463 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> UpdateEarlyLines(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> reverbGain, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> earlyGain, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> lateDelay, <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State)
<a name="l00464"></a>00464 {
<a name="l00465"></a>00465     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467     <span class="comment">// Calculate the early reflections gain (from the master effect gain, and</span>
<a name="l00468"></a>00468     <span class="comment">// reflections gain parameters) with a constant attenuation of 0.5.</span>
<a name="l00469"></a>00469     State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> = 0.5f * reverbGain * earlyGain;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <span class="comment">// Calculate the gain (coefficient) for each early delay line using the</span>
<a name="l00472"></a>00472     <span class="comment">// late delay time.  This expands the early reflections to the start of</span>
<a name="l00473"></a>00473     <span class="comment">// the late reverb.</span>
<a name="l00474"></a>00474     <span class="keywordflow">for</span>(index = 0;index &lt; 4;index++)
<a name="l00475"></a>00475         State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>[index] = CalcDecayCoeff(EARLY_LINE_LENGTH[index],
<a name="l00476"></a>00476                                                    lateDelay);
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 <span class="comment">// Update the offsets for the decorrelator line.</span>
<a name="l00480"></a>00480 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> UpdateDecorrelator(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> density, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency, <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State)
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index;
<a name="l00483"></a>00483     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> length;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     <span class="comment">/* The late reverb inputs are decorrelated to smooth the reverb tail and</span>
<a name="l00486"></a>00486 <span class="comment">     * reduce harsh echos.  The first tap occurs immediately, while the</span>
<a name="l00487"></a>00487 <span class="comment">     * remaining taps are delayed by multiples of a fraction of the smallest</span>
<a name="l00488"></a>00488 <span class="comment">     * cyclical delay time.</span>
<a name="l00489"></a>00489 <span class="comment">     *</span>
<a name="l00490"></a>00490 <span class="comment">     * offset[index] = (FRACTION (MULTIPLIER^index)) smallest_delay</span>
<a name="l00491"></a>00491 <span class="comment">     */</span>
<a name="l00492"></a>00492     <span class="keywordflow">for</span>(index = 0;index &lt; 3;index++)
<a name="l00493"></a>00493     {
<a name="l00494"></a>00494         length = (DECO_FRACTION * <a class="code" href="alu_8h.html#a94f8944f536e497a46fc40a3b31bf804">aluPow</a>(DECO_MULTIPLIER, (<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a>)index)) *
<a name="l00495"></a>00495                  LATE_LINE_LENGTH[0] * (1.0f + (density * LATE_LINE_MULTIPLIER));
<a name="l00496"></a>00496         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[index] = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(length * frequency);
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498 }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500 <span class="comment">// Update the late reverb gains, line lengths, and line coefficients.</span>
<a name="l00501"></a>00501 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> UpdateLateLines(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> reverbGain, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> lateGain, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> xMix, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> density, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> decayTime, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> diffusion, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> hfRatio, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> cw, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency, <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State)
<a name="l00502"></a>00502 {
<a name="l00503"></a>00503     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> length;
<a name="l00504"></a>00504     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506     <span class="comment">/* Calculate the late reverb gain (from the master effect gain, and late</span>
<a name="l00507"></a>00507 <span class="comment">     * reverb gain parameters).  Since the output is tapped prior to the</span>
<a name="l00508"></a>00508 <span class="comment">     * application of the next delay line coefficients, this gain needs to be</span>
<a name="l00509"></a>00509 <span class="comment">     * attenuated by the &#39;x&#39; mixing matrix coefficient as well.</span>
<a name="l00510"></a>00510 <span class="comment">     */</span>
<a name="l00511"></a>00511     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> = reverbGain * lateGain * xMix;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     <span class="comment">/* To compensate for changes in modal density and decay time of the late</span>
<a name="l00514"></a>00514 <span class="comment">     * reverb signal, the input is attenuated based on the maximal energy of</span>
<a name="l00515"></a>00515 <span class="comment">     * the outgoing signal.  This approximation is used to keep the apparent</span>
<a name="l00516"></a>00516 <span class="comment">     * energy of the signal equal for all ranges of density and decay time.</span>
<a name="l00517"></a>00517 <span class="comment">     *</span>
<a name="l00518"></a>00518 <span class="comment">     * The average length of the cyclcical delay lines is used to calculate</span>
<a name="l00519"></a>00519 <span class="comment">     * the attenuation coefficient.</span>
<a name="l00520"></a>00520 <span class="comment">     */</span>
<a name="l00521"></a>00521     length = (LATE_LINE_LENGTH[0] + LATE_LINE_LENGTH[1] +
<a name="l00522"></a>00522               LATE_LINE_LENGTH[2] + LATE_LINE_LENGTH[3]) / 4.0f;
<a name="l00523"></a>00523     length *= 1.0f + (density * LATE_LINE_MULTIPLIER);
<a name="l00524"></a>00524     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a5e84154f5880e79ee0bc4e094c9b1e5c">DensityGain</a> = CalcDensityGain(CalcDecayCoeff(length,
<a name="l00525"></a>00525                                                              decayTime));
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="comment">// Calculate the all-pass feed-back and feed-forward coefficient.</span>
<a name="l00528"></a>00528     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4ff8897495d7ac9a1bd4a93de36c03c6">ApFeedCoeff</a> = 0.5f * <a class="code" href="alu_8h.html#a94f8944f536e497a46fc40a3b31bf804">aluPow</a>(diffusion, 2.0f);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="keywordflow">for</span>(index = 0;index &lt; 4;index++)
<a name="l00531"></a>00531     {
<a name="l00532"></a>00532         <span class="comment">// Calculate the gain (coefficient) for each all-pass line.</span>
<a name="l00533"></a>00533         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a5d58dda9a07639a8b06bd96281441e82">ApCoeff</a>[index] = CalcDecayCoeff(ALLPASS_LINE_LENGTH[index],
<a name="l00534"></a>00534                                                     decayTime);
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         <span class="comment">// Calculate the length (in seconds) of each cyclical delay line.</span>
<a name="l00537"></a>00537         length = LATE_LINE_LENGTH[index] * (1.0f + (density *
<a name="l00538"></a>00538                                                     LATE_LINE_MULTIPLIER));
<a name="l00539"></a>00539 
<a name="l00540"></a>00540         <span class="comment">// Calculate the delay offset for each cyclical delay line.</span>
<a name="l00541"></a>00541         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>[index] = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(length * frequency);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543         <span class="comment">// Calculate the gain (coefficient) for each cyclical line.</span>
<a name="l00544"></a>00544         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>[index] = CalcDecayCoeff(length, decayTime);
<a name="l00545"></a>00545 
<a name="l00546"></a>00546         <span class="comment">// Calculate the damping coefficient for each low-pass filter.</span>
<a name="l00547"></a>00547         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a8989338e5a5a7a754919116d822351be">LpCoeff</a>[index] =
<a name="l00548"></a>00548             CalcDampingCoeff(hfRatio, length, decayTime,
<a name="l00549"></a>00549                              State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>[index], cw);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551         <span class="comment">// Attenuate the cyclical line coefficients by the mixing coefficient</span>
<a name="l00552"></a>00552         <span class="comment">// (x).</span>
<a name="l00553"></a>00553         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>[index] *= xMix;
<a name="l00554"></a>00554     }
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557 <span class="comment">// Update the echo gain, line offset, line coefficients, and mixing</span>
<a name="l00558"></a>00558 <span class="comment">// coefficients.</span>
<a name="l00559"></a>00559 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> UpdateEchoLine(<a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> reverbGain, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> lateGain, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> echoTime, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> decayTime, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> diffusion, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> echoDepth, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> hfRatio, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> cw, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency, <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State)
<a name="l00560"></a>00560 {
<a name="l00561"></a>00561     <span class="comment">// Update the offset and coefficient for the echo delay line.</span>
<a name="l00562"></a>00562     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(echoTime * frequency);
<a name="l00563"></a>00563 
<a name="l00564"></a>00564     <span class="comment">// Calculate the decay coefficient for the echo line.</span>
<a name="l00565"></a>00565     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a> = CalcDecayCoeff(echoTime, decayTime);
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     <span class="comment">// Calculate the energy-based attenuation coefficient for the echo delay</span>
<a name="l00568"></a>00568     <span class="comment">// line.</span>
<a name="l00569"></a>00569     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a5e84154f5880e79ee0bc4e094c9b1e5c">DensityGain</a> = CalcDensityGain(State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>);
<a name="l00570"></a>00570 
<a name="l00571"></a>00571     <span class="comment">// Calculate the echo all-pass feed coefficient.</span>
<a name="l00572"></a>00572     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a4ff8897495d7ac9a1bd4a93de36c03c6">ApFeedCoeff</a> = 0.5f * <a class="code" href="alu_8h.html#a94f8944f536e497a46fc40a3b31bf804">aluPow</a>(diffusion, 2.0f);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="comment">// Calculate the echo all-pass attenuation coefficient.</span>
<a name="l00575"></a>00575     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a5d58dda9a07639a8b06bd96281441e82">ApCoeff</a> = CalcDecayCoeff(ECHO_ALLPASS_LENGTH, decayTime);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     <span class="comment">// Calculate the damping coefficient for each low-pass filter.</span>
<a name="l00578"></a>00578     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a8989338e5a5a7a754919116d822351be">LpCoeff</a> = CalcDampingCoeff(hfRatio, echoTime, decayTime,
<a name="l00579"></a>00579                                            State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>, cw);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     <span class="comment">/* Calculate the echo mixing coefficients.  The first is applied to the</span>
<a name="l00582"></a>00582 <span class="comment">     * echo itself.  The second is used to attenuate the late reverb when</span>
<a name="l00583"></a>00583 <span class="comment">     * echo depth is high and diffusion is low, so the echo is slightly</span>
<a name="l00584"></a>00584 <span class="comment">     * stronger than the decorrelated echos in the reverb tail.</span>
<a name="l00585"></a>00585 <span class="comment">     */</span>
<a name="l00586"></a>00586     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>[0] = reverbGain * lateGain * echoDepth;
<a name="l00587"></a>00587     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>[1] = 1.0f - (echoDepth * 0.5f * (1.0f - diffusion));
<a name="l00588"></a>00588 }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 <span class="comment">// Update the early and late 3D panning gains.</span>
<a name="l00591"></a>00591 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> Update3DPanning(<span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *ReflectionsPan, <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *LateReverbPan, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *PanningLUT, <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State)
<a name="l00592"></a>00592 {
<a name="l00593"></a>00593     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> length;
<a name="l00594"></a>00594     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> earlyPan[3] = { ReflectionsPan[0], ReflectionsPan[1],
<a name="l00595"></a>00595                             ReflectionsPan[2] };
<a name="l00596"></a>00596     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> latePan[3] = { LateReverbPan[0], LateReverbPan[1],
<a name="l00597"></a>00597                            LateReverbPan[2] };
<a name="l00598"></a>00598     <a class="code" href="al_8h.html#a8e95e1bad09d820d882e1bff068a33ef">ALint</a> pos;
<a name="l00599"></a>00599     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *speakerGain, dirGain, ambientGain;
<a name="l00600"></a>00600     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602     <span class="comment">// Calculate the 3D-panning gains for the early reflections and late</span>
<a name="l00603"></a>00603     <span class="comment">// reverb.</span>
<a name="l00604"></a>00604     length = earlyPan[0]*earlyPan[0] + earlyPan[1]*earlyPan[1] + earlyPan[2]*earlyPan[2];
<a name="l00605"></a>00605     <span class="keywordflow">if</span>(length &gt; 1.0f)
<a name="l00606"></a>00606     {
<a name="l00607"></a>00607         length = 1.0f / <a class="code" href="alu_8h.html#ac41b59018b2facd0fd949b939b3f9156">aluSqrt</a>(length);
<a name="l00608"></a>00608         earlyPan[0] *= length;
<a name="l00609"></a>00609         earlyPan[1] *= length;
<a name="l00610"></a>00610         earlyPan[2] *= length;
<a name="l00611"></a>00611     }
<a name="l00612"></a>00612     length = latePan[0]*latePan[0] + latePan[1]*latePan[1] + latePan[2]*latePan[2];
<a name="l00613"></a>00613     <span class="keywordflow">if</span>(length &gt; 1.0f)
<a name="l00614"></a>00614     {
<a name="l00615"></a>00615         length = 1.0f / <a class="code" href="alu_8h.html#ac41b59018b2facd0fd949b939b3f9156">aluSqrt</a>(length);
<a name="l00616"></a>00616         latePan[0] *= length;
<a name="l00617"></a>00617         latePan[1] *= length;
<a name="l00618"></a>00618         latePan[2] *= length;
<a name="l00619"></a>00619     }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621     <span class="comment">/* This code applies directional reverb just like the mixer applies</span>
<a name="l00622"></a>00622 <span class="comment">     * directional sources.  It diffuses the sound toward all speakers as the</span>
<a name="l00623"></a>00623 <span class="comment">     * magnitude of the panning vector drops, which is only a rough</span>
<a name="l00624"></a>00624 <span class="comment">     * approximation of the expansion of sound across the speakers from the</span>
<a name="l00625"></a>00625 <span class="comment">     * panning direction.</span>
<a name="l00626"></a>00626 <span class="comment">     */</span>
<a name="l00627"></a>00627     pos = aluCart2LUTpos(earlyPan[2], earlyPan[0]);
<a name="l00628"></a>00628     speakerGain = &amp;PanningLUT[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa9d24a2cd94e8ec72f22f694e60d323e7">OUTPUTCHANNELS</a> * pos];
<a name="l00629"></a>00629     dirGain = <a class="code" href="alu_8h.html#ac41b59018b2facd0fd949b939b3f9156">aluSqrt</a>((earlyPan[0] * earlyPan[0]) + (earlyPan[2] * earlyPan[2]));
<a name="l00630"></a>00630     ambientGain = (1.0 - dirGain);
<a name="l00631"></a>00631     <span class="keywordflow">for</span>(index = 0;index &lt; <a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa9d24a2cd94e8ec72f22f694e60d323e7">OUTPUTCHANNELS</a>;index++)
<a name="l00632"></a>00632          State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[index] = dirGain * speakerGain[index] + ambientGain;
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     pos = aluCart2LUTpos(latePan[2], latePan[0]);
<a name="l00635"></a>00635     speakerGain = &amp;PanningLUT[OUTPUTCHANNELS * pos];
<a name="l00636"></a>00636     dirGain = <a class="code" href="alu_8h.html#ac41b59018b2facd0fd949b939b3f9156">aluSqrt</a>((latePan[0] * latePan[0]) + (latePan[2] * latePan[2]));
<a name="l00637"></a>00637     ambientGain = (1.0 - dirGain);
<a name="l00638"></a>00638     <span class="keywordflow">for</span>(index = 0;index &lt; <a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa9d24a2cd94e8ec72f22f694e60d323e7">OUTPUTCHANNELS</a>;index++)
<a name="l00639"></a>00639          State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[index] = dirGain * speakerGain[index] + ambientGain;
<a name="l00640"></a>00640 }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 <span class="comment">// Basic delay line input/output routines.</span>
<a name="l00643"></a>00643 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> DelayLineOut(<a class="code" href="struct_delay_line.html">DelayLine</a> *Delay, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> offset)
<a name="l00644"></a>00644 {
<a name="l00645"></a>00645     <span class="keywordflow">return</span> Delay-&gt;<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a>[offset&amp;Delay-&gt;<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a>];
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> DelayLineIn(<a class="code" href="struct_delay_line.html">DelayLine</a> *Delay, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> offset, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> in)
<a name="l00649"></a>00649 {
<a name="l00650"></a>00650     Delay-&gt;<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a>[offset&amp;Delay-&gt;<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a>] = in;
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653 <span class="comment">// Attenuated delay line output routine.</span>
<a name="l00654"></a>00654 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> AttenuatedDelayLineOut(<a class="code" href="struct_delay_line.html">DelayLine</a> *Delay, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> offset, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> coeff)
<a name="l00655"></a>00655 {
<a name="l00656"></a>00656     <span class="keywordflow">return</span> coeff * Delay-&gt;<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a>[offset&amp;Delay-&gt;<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a>];
<a name="l00657"></a>00657 }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659 <span class="comment">// Basic attenuated all-pass input/output routine.</span>
<a name="l00660"></a>00660 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> AllpassInOut(<a class="code" href="struct_delay_line.html">DelayLine</a> *Delay, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> outOffset, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> inOffset, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> in, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> feedCoeff, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> coeff)
<a name="l00661"></a>00661 {
<a name="l00662"></a>00662     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> out, feed;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664     out = DelayLineOut(Delay, outOffset);
<a name="l00665"></a>00665     feed = feedCoeff * in;
<a name="l00666"></a>00666     DelayLineIn(Delay, inOffset, (feedCoeff * (out - feed)) + in);
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="comment">// The time-based attenuation is only applied to the delay output to</span>
<a name="l00669"></a>00669     <span class="comment">// keep it from affecting the feed-back path (which is already controlled</span>
<a name="l00670"></a>00670     <span class="comment">// by the all-pass feed coefficient).</span>
<a name="l00671"></a>00671     <span class="keywordflow">return</span> (coeff * out) - feed;
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 <span class="comment">// Given an input sample, this function produces modulation for the late</span>
<a name="l00675"></a>00675 <span class="comment">// reverb.</span>
<a name="l00676"></a>00676 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> EAXModulation(<a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> in)
<a name="l00677"></a>00677 {
<a name="l00678"></a>00678     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> sinus, frac;
<a name="l00679"></a>00679     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> offset;
<a name="l00680"></a>00680     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> out0, out1;
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     <span class="comment">// Calculate the sinus rythm (dependent on modulation time and the</span>
<a name="l00683"></a>00683     <span class="comment">// sampling rate).  The center of the sinus is moved to reduce the delay</span>
<a name="l00684"></a>00684     <span class="comment">// of the effect when the time or depth are low.</span>
<a name="l00685"></a>00685     sinus = 1.0f - cos(2.0f * <a class="code" href="bs2b_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af3fcb94c1627df5038ff48ff0ca0159b">Index</a> / State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#aa7a28f50d1bc229b3ac92489c0f9acbf">Range</a>);
<a name="l00686"></a>00686 
<a name="l00687"></a>00687     <span class="comment">// The depth determines the range over which to read the input samples</span>
<a name="l00688"></a>00688     <span class="comment">// from, so it must be filtered to reduce the distortion caused by even</span>
<a name="l00689"></a>00689     <span class="comment">// small parameter changes.</span>
<a name="l00690"></a>00690     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af484b13957675f52ff8fbc6b3bbbf809">Filter</a> += (State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#aafb26255182359033d7704286a1444aa">Depth</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af484b13957675f52ff8fbc6b3bbbf809">Filter</a>) *
<a name="l00691"></a>00691                          State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>;
<a name="l00692"></a>00692 
<a name="l00693"></a>00693     <span class="comment">// Calculate the read offset and fraction between it and the next sample.</span>
<a name="l00694"></a>00694     frac   = (1.0f + (State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af484b13957675f52ff8fbc6b3bbbf809">Filter</a> * sinus));
<a name="l00695"></a>00695     offset = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)frac;
<a name="l00696"></a>00696     frac  -= offset;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     <span class="comment">// Get the two samples crossed by the offset, and feed the delay line</span>
<a name="l00699"></a>00699     <span class="comment">// with the next input sample.</span>
<a name="l00700"></a>00700     out0 = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - offset);
<a name="l00701"></a>00701     out1 = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - offset - 1);
<a name="l00702"></a>00702     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, in);
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     <span class="comment">// Step the modulation index forward, keeping it bound to its range.</span>
<a name="l00705"></a>00705     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af3fcb94c1627df5038ff48ff0ca0159b">Index</a> = (State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af3fcb94c1627df5038ff48ff0ca0159b">Index</a> + 1) % State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#aa7a28f50d1bc229b3ac92489c0f9acbf">Range</a>;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     <span class="comment">// The output is obtained by linearly interpolating the two samples that</span>
<a name="l00708"></a>00708     <span class="comment">// were acquired above.</span>
<a name="l00709"></a>00709     <span class="keywordflow">return</span> out0 + ((out1 - out0) * frac);
<a name="l00710"></a>00710 }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712 <span class="comment">// Delay line output routine for early reflections.</span>
<a name="l00713"></a>00713 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> EarlyDelayLineOut(<a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index)
<a name="l00714"></a>00714 {
<a name="l00715"></a>00715     <span class="keywordflow">return</span> AttenuatedDelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[index],
<a name="l00716"></a>00716                                   State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>[index],
<a name="l00717"></a>00717                                   State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>[index]);
<a name="l00718"></a>00718 }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720 <span class="comment">// Given an input sample, this function produces four-channel output for the</span>
<a name="l00721"></a>00721 <span class="comment">// early reflections.</span>
<a name="l00722"></a>00722 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> EarlyReflection(<a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> in, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *out)
<a name="l00723"></a>00723 {
<a name="l00724"></a>00724     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> d[4], v, f[4];
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <span class="comment">// Obtain the decayed results of each early delay line.</span>
<a name="l00727"></a>00727     d[0] = EarlyDelayLineOut(State, 0);
<a name="l00728"></a>00728     d[1] = EarlyDelayLineOut(State, 1);
<a name="l00729"></a>00729     d[2] = EarlyDelayLineOut(State, 2);
<a name="l00730"></a>00730     d[3] = EarlyDelayLineOut(State, 3);
<a name="l00731"></a>00731 
<a name="l00732"></a>00732     <span class="comment">/* The following uses a lossless scattering junction from waveguide</span>
<a name="l00733"></a>00733 <span class="comment">     * theory.  It actually amounts to a householder mixing matrix, which</span>
<a name="l00734"></a>00734 <span class="comment">     * will produce a maximally diffuse response, and means this can probably</span>
<a name="l00735"></a>00735 <span class="comment">     * be considered a simple feed-back delay network (FDN).</span>
<a name="l00736"></a>00736 <span class="comment">     *          N</span>
<a name="l00737"></a>00737 <span class="comment">     *         ---</span>
<a name="l00738"></a>00738 <span class="comment">     *         \</span>
<a name="l00739"></a>00739 <span class="comment">     * v = 2/N /   d_i</span>
<a name="l00740"></a>00740 <span class="comment">     *         ---</span>
<a name="l00741"></a>00741 <span class="comment">     *         i=1</span>
<a name="l00742"></a>00742 <span class="comment">     */</span>
<a name="l00743"></a>00743     v = (d[0] + d[1] + d[2] + d[3]) * 0.5f;
<a name="l00744"></a>00744     <span class="comment">// The junction is loaded with the input here.</span>
<a name="l00745"></a>00745     v += in;
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     <span class="comment">// Calculate the feed values for the delay lines.</span>
<a name="l00748"></a>00748     f[0] = v - d[0];
<a name="l00749"></a>00749     f[1] = v - d[1];
<a name="l00750"></a>00750     f[2] = v - d[2];
<a name="l00751"></a>00751     f[3] = v - d[3];
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     <span class="comment">// Re-feed the delay lines.</span>
<a name="l00754"></a>00754     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[0], State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, f[0]);
<a name="l00755"></a>00755     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[1], State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, f[1]);
<a name="l00756"></a>00756     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[2], State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, f[2]);
<a name="l00757"></a>00757     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[3], State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, f[3]);
<a name="l00758"></a>00758 
<a name="l00759"></a>00759     <span class="comment">// Output the results of the junction for all four channels.</span>
<a name="l00760"></a>00760     out[0] = State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> * f[0];
<a name="l00761"></a>00761     out[1] = State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> * f[1];
<a name="l00762"></a>00762     out[2] = State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> * f[2];
<a name="l00763"></a>00763     out[3] = State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> * f[3];
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 <span class="comment">// All-pass input/output routine for late reverb.</span>
<a name="l00767"></a>00767 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> LateAllPassInOut(<a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> in)
<a name="l00768"></a>00768 {
<a name="l00769"></a>00769     <span class="keywordflow">return</span> AllpassInOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>[index],
<a name="l00770"></a>00770                         State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#ad14d16893ca9c4352b8f4772e43fe862">ApOffset</a>[index],
<a name="l00771"></a>00771                         State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, in, State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4ff8897495d7ac9a1bd4a93de36c03c6">ApFeedCoeff</a>,
<a name="l00772"></a>00772                         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a5d58dda9a07639a8b06bd96281441e82">ApCoeff</a>[index]);
<a name="l00773"></a>00773 }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 <span class="comment">// Delay line output routine for late reverb.</span>
<a name="l00776"></a>00776 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> LateDelayLineOut(<a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index)
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778     <span class="keywordflow">return</span> AttenuatedDelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[index],
<a name="l00779"></a>00779                                   State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>[index],
<a name="l00780"></a>00780                                   State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>[index]);
<a name="l00781"></a>00781 }
<a name="l00782"></a>00782 
<a name="l00783"></a>00783 <span class="comment">// Low-pass filter input/output routine for late reverb.</span>
<a name="l00784"></a>00784 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> LateLowPassInOut(<a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> in)
<a name="l00785"></a>00785 {
<a name="l00786"></a>00786     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#aae60f2460d943f027893434ddb9b890e">LpSample</a>[index] = in +
<a name="l00787"></a>00787         ((State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#aae60f2460d943f027893434ddb9b890e">LpSample</a>[index] - in) * State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a8989338e5a5a7a754919116d822351be">LpCoeff</a>[index]);
<a name="l00788"></a>00788     <span class="keywordflow">return</span> State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#aae60f2460d943f027893434ddb9b890e">LpSample</a>[index];
<a name="l00789"></a>00789 }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 <span class="comment">// Given four decorrelated input samples, this function produces four-channel</span>
<a name="l00792"></a>00792 <span class="comment">// output for the late reverb.</span>
<a name="l00793"></a>00793 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> LateReverb(<a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *in, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *out)
<a name="l00794"></a>00794 {
<a name="l00795"></a>00795     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> d[4], f[4];
<a name="l00796"></a>00796 
<a name="l00797"></a>00797     <span class="comment">// Obtain the decayed results of the cyclical delay lines, and add the</span>
<a name="l00798"></a>00798     <span class="comment">// corresponding input channels.  Then pass the results through the</span>
<a name="l00799"></a>00799     <span class="comment">// low-pass filters.</span>
<a name="l00800"></a>00800 
<a name="l00801"></a>00801     <span class="comment">// This is where the feed-back cycles from line 0 to 1 to 3 to 2 and back</span>
<a name="l00802"></a>00802     <span class="comment">// to 0.</span>
<a name="l00803"></a>00803     d[0] = LateLowPassInOut(State, 2, in[2] + LateDelayLineOut(State, 2));
<a name="l00804"></a>00804     d[1] = LateLowPassInOut(State, 0, in[0] + LateDelayLineOut(State, 0));
<a name="l00805"></a>00805     d[2] = LateLowPassInOut(State, 3, in[3] + LateDelayLineOut(State, 3));
<a name="l00806"></a>00806     d[3] = LateLowPassInOut(State, 1, in[1] + LateDelayLineOut(State, 1));
<a name="l00807"></a>00807 
<a name="l00808"></a>00808     <span class="comment">// To help increase diffusion, run each line through an all-pass filter.</span>
<a name="l00809"></a>00809     <span class="comment">// When there is no diffusion, the shortest all-pass filter will feed the</span>
<a name="l00810"></a>00810     <span class="comment">// shortest delay line.</span>
<a name="l00811"></a>00811     d[0] = LateAllPassInOut(State, 0, d[0]);
<a name="l00812"></a>00812     d[1] = LateAllPassInOut(State, 1, d[1]);
<a name="l00813"></a>00813     d[2] = LateAllPassInOut(State, 2, d[2]);
<a name="l00814"></a>00814     d[3] = LateAllPassInOut(State, 3, d[3]);
<a name="l00815"></a>00815 
<a name="l00816"></a>00816     <span class="comment">/* Late reverb is done with a modified feed-back delay network (FDN)</span>
<a name="l00817"></a>00817 <span class="comment">     * topology.  Four input lines are each fed through their own all-pass</span>
<a name="l00818"></a>00818 <span class="comment">     * filter and then into the mixing matrix.  The four outputs of the</span>
<a name="l00819"></a>00819 <span class="comment">     * mixing matrix are then cycled back to the inputs.  Each output feeds</span>
<a name="l00820"></a>00820 <span class="comment">     * a different input to form a circlular feed cycle.</span>
<a name="l00821"></a>00821 <span class="comment">     *</span>
<a name="l00822"></a>00822 <span class="comment">     * The mixing matrix used is a 4D skew-symmetric rotation matrix derived</span>
<a name="l00823"></a>00823 <span class="comment">     * using a single unitary rotational parameter:</span>
<a name="l00824"></a>00824 <span class="comment">     *</span>
<a name="l00825"></a>00825 <span class="comment">     *  [  d,  a,  b,  c ]          1 = a^2 + b^2 + c^2 + d^2</span>
<a name="l00826"></a>00826 <span class="comment">     *  [ -a,  d,  c, -b ]</span>
<a name="l00827"></a>00827 <span class="comment">     *  [ -b, -c,  d,  a ]</span>
<a name="l00828"></a>00828 <span class="comment">     *  [ -c,  b, -a,  d ]</span>
<a name="l00829"></a>00829 <span class="comment">     *</span>
<a name="l00830"></a>00830 <span class="comment">     * The rotation is constructed from the effect&#39;s diffusion parameter,</span>
<a name="l00831"></a>00831 <span class="comment">     * yielding:  1 = x^2 + 3 y^2; where a, b, and c are the coefficient y</span>
<a name="l00832"></a>00832 <span class="comment">     * with differing signs, and d is the coefficient x.  The matrix is thus:</span>
<a name="l00833"></a>00833 <span class="comment">     *</span>
<a name="l00834"></a>00834 <span class="comment">     *  [  x,  y, -y,  y ]          n = sqrt(matrix_order - 1)</span>
<a name="l00835"></a>00835 <span class="comment">     *  [ -y,  x,  y,  y ]          t = diffusion_parameter * atan(n)</span>
<a name="l00836"></a>00836 <span class="comment">     *  [  y, -y,  x,  y ]          x = cos(t)</span>
<a name="l00837"></a>00837 <span class="comment">     *  [ -y, -y, -y,  x ]          y = sin(t) / n</span>
<a name="l00838"></a>00838 <span class="comment">     *</span>
<a name="l00839"></a>00839 <span class="comment">     * To reduce the number of multiplies, the x coefficient is applied with</span>
<a name="l00840"></a>00840 <span class="comment">     * the cyclical delay line coefficients.  Thus only the y coefficient is</span>
<a name="l00841"></a>00841 <span class="comment">     * applied when mixing, and is modified to be:  y / x.</span>
<a name="l00842"></a>00842 <span class="comment">     */</span>
<a name="l00843"></a>00843     f[0] = d[0] + (State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a> * ( d[1] - d[2] + d[3]));
<a name="l00844"></a>00844     f[1] = d[1] + (State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a> * (-d[0] + d[2] + d[3]));
<a name="l00845"></a>00845     f[2] = d[2] + (State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a> * ( d[0] - d[1] + d[3]));
<a name="l00846"></a>00846     f[3] = d[3] + (State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a> * (-d[0] - d[1] - d[2]));
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="comment">// Output the results of the matrix for all four channels, attenuated by</span>
<a name="l00849"></a>00849     <span class="comment">// the late reverb gain (which is attenuated by the &#39;x&#39; mix coefficient).</span>
<a name="l00850"></a>00850     out[0] = State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> * f[0];
<a name="l00851"></a>00851     out[1] = State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> * f[1];
<a name="l00852"></a>00852     out[2] = State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> * f[2];
<a name="l00853"></a>00853     out[3] = State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> * f[3];
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     <span class="comment">// Re-feed the cyclical delay lines.</span>
<a name="l00856"></a>00856     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[0], State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, f[0]);
<a name="l00857"></a>00857     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[1], State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, f[1]);
<a name="l00858"></a>00858     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[2], State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, f[2]);
<a name="l00859"></a>00859     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[3], State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, f[3]);
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
<a name="l00862"></a>00862 <span class="comment">// Given an input sample, this function mixes echo into the four-channel late</span>
<a name="l00863"></a>00863 <span class="comment">// reverb.</span>
<a name="l00864"></a>00864 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> EAXEcho(<a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> in, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *late)
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> out, feed;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="comment">// Get the latest attenuated echo sample for output.</span>
<a name="l00869"></a>00869     feed = AttenuatedDelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>,
<a name="l00870"></a>00870                                   State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>,
<a name="l00871"></a>00871                                   State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873     <span class="comment">// Mix the output into the late reverb channels.</span>
<a name="l00874"></a>00874     out = State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>[0] * feed;
<a name="l00875"></a>00875     late[0] = (State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>[1] * late[0]) + out;
<a name="l00876"></a>00876     late[1] = (State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>[1] * late[1]) + out;
<a name="l00877"></a>00877     late[2] = (State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>[1] * late[2]) + out;
<a name="l00878"></a>00878     late[3] = (State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>[1] * late[3]) + out;
<a name="l00879"></a>00879 
<a name="l00880"></a>00880     <span class="comment">// Mix the energy-attenuated input with the output and pass it through</span>
<a name="l00881"></a>00881     <span class="comment">// the echo low-pass filter.</span>
<a name="l00882"></a>00882     feed += State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a5e84154f5880e79ee0bc4e094c9b1e5c">DensityGain</a> * in;
<a name="l00883"></a>00883     feed += ((State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#aae60f2460d943f027893434ddb9b890e">LpSample</a> - feed) * State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a8989338e5a5a7a754919116d822351be">LpCoeff</a>);
<a name="l00884"></a>00884     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#aae60f2460d943f027893434ddb9b890e">LpSample</a> = feed;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     <span class="comment">// Then the echo all-pass filter.</span>
<a name="l00887"></a>00887     feed = AllpassInOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>,
<a name="l00888"></a>00888                        State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#ad14d16893ca9c4352b8f4772e43fe862">ApOffset</a>,
<a name="l00889"></a>00889                        State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, feed, State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a4ff8897495d7ac9a1bd4a93de36c03c6">ApFeedCoeff</a>,
<a name="l00890"></a>00890                        State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a5d58dda9a07639a8b06bd96281441e82">ApCoeff</a>);
<a name="l00891"></a>00891 
<a name="l00892"></a>00892     <span class="comment">// Feed the delay with the mixed and filtered sample.</span>
<a name="l00893"></a>00893     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, feed);
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 <span class="comment">// Perform the non-EAX reverb pass on a given input sample, resulting in</span>
<a name="l00897"></a>00897 <span class="comment">// four-channel output.</span>
<a name="l00898"></a>00898 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> VerbPass(<a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> in, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *early, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *late)
<a name="l00899"></a>00899 {
<a name="l00900"></a>00900     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> feed, taps[4];
<a name="l00901"></a>00901 
<a name="l00902"></a>00902     <span class="comment">// Low-pass filter the incoming sample.</span>
<a name="l00903"></a>00903     in = lpFilter2P(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#aab75c35b4386926fbd20924e604372b0">LpFilter</a>, 0, in);
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     <span class="comment">// Feed the initial delay line.</span>
<a name="l00906"></a>00906     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, in);
<a name="l00907"></a>00907 
<a name="l00908"></a>00908     <span class="comment">// Calculate the early reflection from the first delay tap.</span>
<a name="l00909"></a>00909     in = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#aae91bc3ac5e5fd7d9900d9cc9aebf614">DelayTap</a>[0]);
<a name="l00910"></a>00910     EarlyReflection(State, in, early);
<a name="l00911"></a>00911 
<a name="l00912"></a>00912     <span class="comment">// Feed the decorrelator from the energy-attenuated output of the second</span>
<a name="l00913"></a>00913     <span class="comment">// delay tap.</span>
<a name="l00914"></a>00914     in = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#aae91bc3ac5e5fd7d9900d9cc9aebf614">DelayTap</a>[1]);
<a name="l00915"></a>00915     feed = in * State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a5e84154f5880e79ee0bc4e094c9b1e5c">DensityGain</a>;
<a name="l00916"></a>00916     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, feed);
<a name="l00917"></a>00917 
<a name="l00918"></a>00918     <span class="comment">// Calculate the late reverb from the decorrelator taps.</span>
<a name="l00919"></a>00919     taps[0] = feed;
<a name="l00920"></a>00920     taps[1] = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[0]);
<a name="l00921"></a>00921     taps[2] = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[1]);
<a name="l00922"></a>00922     taps[3] = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[2]);
<a name="l00923"></a>00923     LateReverb(State, taps, late);
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <span class="comment">// Step all delays forward one sample.</span>
<a name="l00926"></a>00926     State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>++;
<a name="l00927"></a>00927 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 <span class="comment">// Perform the EAX reverb pass on a given input sample, resulting in four-</span>
<a name="l00930"></a>00930 <span class="comment">// channel output.</span>
<a name="l00931"></a>00931 <span class="keyword">static</span> __inline <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> EAXVerbPass(<a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> in, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *early, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *late)
<a name="l00932"></a>00932 {
<a name="l00933"></a>00933     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> feed, taps[4];
<a name="l00934"></a>00934 
<a name="l00935"></a>00935     <span class="comment">// Low-pass filter the incoming sample.</span>
<a name="l00936"></a>00936     in = lpFilter2P(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#aab75c35b4386926fbd20924e604372b0">LpFilter</a>, 0, in);
<a name="l00937"></a>00937 
<a name="l00938"></a>00938     <span class="comment">// Perform any modulation on the input.</span>
<a name="l00939"></a>00939     in = EAXModulation(State, in);
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <span class="comment">// Feed the initial delay line.</span>
<a name="l00942"></a>00942     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, in);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944     <span class="comment">// Calculate the early reflection from the first delay tap.</span>
<a name="l00945"></a>00945     in = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#aae91bc3ac5e5fd7d9900d9cc9aebf614">DelayTap</a>[0]);
<a name="l00946"></a>00946     EarlyReflection(State, in, early);
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     <span class="comment">// Feed the decorrelator from the energy-attenuated output of the second</span>
<a name="l00949"></a>00949     <span class="comment">// delay tap.</span>
<a name="l00950"></a>00950     in = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#aae91bc3ac5e5fd7d9900d9cc9aebf614">DelayTap</a>[1]);
<a name="l00951"></a>00951     feed = in * State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a5e84154f5880e79ee0bc4e094c9b1e5c">DensityGain</a>;
<a name="l00952"></a>00952     DelayLineIn(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>, feed);
<a name="l00953"></a>00953 
<a name="l00954"></a>00954     <span class="comment">// Calculate the late reverb from the decorrelator taps.</span>
<a name="l00955"></a>00955     taps[0] = feed;
<a name="l00956"></a>00956     taps[1] = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[0]);
<a name="l00957"></a>00957     taps[2] = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[1]);
<a name="l00958"></a>00958     taps[3] = DelayLineOut(&amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>, State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> - State-&gt;<a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[2]);
<a name="l00959"></a>00959     LateReverb(State, taps, late);
<a name="l00960"></a>00960 
<a name="l00961"></a>00961     <span class="comment">// Calculate and mix in any echo.</span>
<a name="l00962"></a>00962     EAXEcho(State, in, late);
<a name="l00963"></a>00963 
<a name="l00964"></a>00964     <span class="comment">// Step all delays forward one sample.</span>
<a name="l00965"></a>00965     State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>++;
<a name="l00966"></a>00966 }
<a name="l00967"></a>00967 
<a name="l00968"></a>00968 <span class="comment">// This destroys the reverb state.  It should be called only when the effect</span>
<a name="l00969"></a>00969 <span class="comment">// slot has a different (or no) effect loaded over the reverb effect.</span>
<a name="l00970"></a>00970 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> VerbDestroy(<a class="code" href="struct_a_leffect_state.html">ALeffectState</a> *effect)
<a name="l00971"></a>00971 {
<a name="l00972"></a>00972     <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State = (<a class="code" href="struct_a_lverb_state.html">ALverbState</a>*)effect;
<a name="l00973"></a>00973     <span class="keywordflow">if</span>(State)
<a name="l00974"></a>00974     {
<a name="l00975"></a>00975         free(State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a>);
<a name="l00976"></a>00976         State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a> = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00977"></a>00977         free(State);
<a name="l00978"></a>00978     }
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981 <span class="comment">// This updates the device-dependant reverb state.  This is called on</span>
<a name="l00982"></a>00982 <span class="comment">// initialization and any time the device parameters (eg. playback frequency,</span>
<a name="l00983"></a>00983 <span class="comment">// or format) have been changed.</span>
<a name="l00984"></a>00984 <span class="keyword">static</span> <a class="code" href="al_8h.html#a87bd2b64b8ce719af42bf9dfd0cdf8fc">ALboolean</a> VerbDeviceUpdate(<a class="code" href="struct_a_leffect_state.html">ALeffectState</a> *effect, <a class="code" href="struct_a_l_cdevice__struct.html">ALCdevice</a> *Device)
<a name="l00985"></a>00985 {
<a name="l00986"></a>00986     <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State = (<a class="code" href="struct_a_lverb_state.html">ALverbState</a>*)effect;
<a name="l00987"></a>00987     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency = Device-&gt;<a class="code" href="struct_a_l_cdevice__struct.html#a3d8c0bc7edffccd468afa080502654d3">Frequency</a>, index;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989     <span class="comment">// Allocate the delay lines.</span>
<a name="l00990"></a>00990     <span class="keywordflow">if</span>(!AllocLines(<a class="code" href="al_8h.html#a5aafce4e1e2b037b44a0c85dd7786793">AL_FALSE</a>, frequency, State))
<a name="l00991"></a>00991         <span class="keywordflow">return</span> <a class="code" href="al_8h.html#a5aafce4e1e2b037b44a0c85dd7786793">AL_FALSE</a>;
<a name="l00992"></a>00992 
<a name="l00993"></a>00993     State-&gt;<a class="code" href="struct_a_lverb_state.html#a96267a063dd46d0bd518882f4fc0afbd">Scale</a> = <a class="code" href="alu_8h.html#ac41b59018b2facd0fd949b939b3f9156">aluSqrt</a>(Device-&gt;<a class="code" href="struct_a_l_cdevice__struct.html#af47153808495a606b753aaa4160e4d5e">NumChan</a> / 8.0f);
<a name="l00994"></a>00994 
<a name="l00995"></a>00995     <span class="comment">// The early reflection and late all-pass filter line lengths are static,</span>
<a name="l00996"></a>00996     <span class="comment">// so their offsets only need to be calculated once.</span>
<a name="l00997"></a>00997     <span class="keywordflow">for</span>(index = 0;index &lt; 4;index++)
<a name="l00998"></a>00998     {
<a name="l00999"></a>00999         State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>[index] = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(EARLY_LINE_LENGTH[index] *
<a name="l01000"></a>01000                                               frequency);
<a name="l01001"></a>01001         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#ad14d16893ca9c4352b8f4772e43fe862">ApOffset</a>[index] = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(ALLPASS_LINE_LENGTH[index] *
<a name="l01002"></a>01002                                                frequency);
<a name="l01003"></a>01003     }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005     <span class="keywordflow">return</span> <a class="code" href="al_8h.html#abaf2cf350471d339f73fad46de91964a">AL_TRUE</a>;
<a name="l01006"></a>01006 }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008 <span class="comment">// This updates the device-dependant EAX reverb state.  This is called on</span>
<a name="l01009"></a>01009 <span class="comment">// initialization and any time the device parameters (eg. playback frequency,</span>
<a name="l01010"></a>01010 <span class="comment">// format) have been changed.</span>
<a name="l01011"></a>01011 <span class="keyword">static</span> <a class="code" href="al_8h.html#a87bd2b64b8ce719af42bf9dfd0cdf8fc">ALboolean</a> EAXVerbDeviceUpdate(<a class="code" href="struct_a_leffect_state.html">ALeffectState</a> *effect, <a class="code" href="struct_a_l_cdevice__struct.html">ALCdevice</a> *Device)
<a name="l01012"></a>01012 {
<a name="l01013"></a>01013     <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State = (<a class="code" href="struct_a_lverb_state.html">ALverbState</a>*)effect;
<a name="l01014"></a>01014     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency = Device-&gt;<a class="code" href="struct_a_l_cdevice__struct.html#a3d8c0bc7edffccd468afa080502654d3">Frequency</a>, index;
<a name="l01015"></a>01015 
<a name="l01016"></a>01016     <span class="comment">// Allocate the delay lines.</span>
<a name="l01017"></a>01017     <span class="keywordflow">if</span>(!AllocLines(<a class="code" href="al_8h.html#abaf2cf350471d339f73fad46de91964a">AL_TRUE</a>, frequency, State))
<a name="l01018"></a>01018         <span class="keywordflow">return</span> <a class="code" href="al_8h.html#a5aafce4e1e2b037b44a0c85dd7786793">AL_FALSE</a>;
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     State-&gt;<a class="code" href="struct_a_lverb_state.html#a96267a063dd46d0bd518882f4fc0afbd">Scale</a> = <a class="code" href="alu_8h.html#ac41b59018b2facd0fd949b939b3f9156">aluSqrt</a>(Device-&gt;<a class="code" href="struct_a_l_cdevice__struct.html#af47153808495a606b753aaa4160e4d5e">NumChan</a> / 8.0f);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022     <span class="comment">// Calculate the modulation filter coefficient.  Notice that the exponent</span>
<a name="l01023"></a>01023     <span class="comment">// is calculated given the current sample rate.  This ensures that the</span>
<a name="l01024"></a>01024     <span class="comment">// resulting filter response over time is consistent across all sample</span>
<a name="l01025"></a>01025     <span class="comment">// rates.</span>
<a name="l01026"></a>01026     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a> = <a class="code" href="alu_8h.html#a94f8944f536e497a46fc40a3b31bf804">aluPow</a>(MODULATION_FILTER_COEFF,
<a name="l01027"></a>01027                               MODULATION_FILTER_CONST / frequency);
<a name="l01028"></a>01028 
<a name="l01029"></a>01029     <span class="comment">// The early reflection and late all-pass filter line lengths are static,</span>
<a name="l01030"></a>01030     <span class="comment">// so their offsets only need to be calculated once.</span>
<a name="l01031"></a>01031     <span class="keywordflow">for</span>(index = 0;index &lt; 4;index++)
<a name="l01032"></a>01032     {
<a name="l01033"></a>01033         State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>[index] = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(EARLY_LINE_LENGTH[index] *
<a name="l01034"></a>01034                                               frequency);
<a name="l01035"></a>01035         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#ad14d16893ca9c4352b8f4772e43fe862">ApOffset</a>[index] = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(ALLPASS_LINE_LENGTH[index] *
<a name="l01036"></a>01036                                                frequency);
<a name="l01037"></a>01037     }
<a name="l01038"></a>01038 
<a name="l01039"></a>01039     <span class="comment">// The echo all-pass filter line length is static, so its offset only</span>
<a name="l01040"></a>01040     <span class="comment">// needs to be calculated once.</span>
<a name="l01041"></a>01041     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#ad14d16893ca9c4352b8f4772e43fe862">ApOffset</a> = (<a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a>)(ECHO_ALLPASS_LENGTH * frequency);
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <span class="keywordflow">return</span> <a class="code" href="al_8h.html#abaf2cf350471d339f73fad46de91964a">AL_TRUE</a>;
<a name="l01044"></a>01044 }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046 <span class="comment">// This updates the reverb state.  This is called any time the reverb effect</span>
<a name="l01047"></a>01047 <span class="comment">// is loaded into a slot.</span>
<a name="l01048"></a>01048 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> VerbUpdate(<a class="code" href="struct_a_leffect_state.html">ALeffectState</a> *effect, <a class="code" href="struct_a_l_ccontext__struct.html">ALCcontext</a> *Context, <span class="keyword">const</span> <a class="code" href="struct_a_leffect.html">ALeffect</a> *Effect)
<a name="l01049"></a>01049 {
<a name="l01050"></a>01050     <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State = (<a class="code" href="struct_a_lverb_state.html">ALverbState</a>*)effect;
<a name="l01051"></a>01051     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency = Context-&gt;<a class="code" href="struct_a_l_ccontext__struct.html#a302683c73b2f17c76562d67387ffb214">Device</a>-&gt;<a class="code" href="struct_a_l_cdevice__struct.html#a3d8c0bc7edffccd468afa080502654d3">Frequency</a>;
<a name="l01052"></a>01052     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> cw, x, y, hfRatio;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     <span class="comment">// Calculate the master low-pass filter (from the master effect HF gain).</span>
<a name="l01055"></a>01055     cw = CalcI3DL2HFreq(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#acc929124f4b87984aeded8301dc2dc16">HFReference</a>, frequency);
<a name="l01056"></a>01056     <span class="comment">// This is done with 2 chained 1-pole filters, so no need to square g.</span>
<a name="l01057"></a>01057     State-&gt;<a class="code" href="struct_a_lverb_state.html#aab75c35b4386926fbd20924e604372b0">LpFilter</a>.<a class="code" href="struct_f_i_l_t_e_r.html#a0469a542dd6d2798d82c66ace2468a6f">coeff</a> = lpCoeffCalc(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ae3f5548bd58d12a486a59f50a3c21974">GainHF</a>, cw);
<a name="l01058"></a>01058 
<a name="l01059"></a>01059     <span class="comment">// Update the initial effect delay.</span>
<a name="l01060"></a>01060     UpdateDelayLine(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a6ee8f60ab8c62e72c72053494cbbd816">ReflectionsDelay</a>,
<a name="l01061"></a>01061                     Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ad8cfb16995eea175e65dd36f7bb4fc8c">LateReverbDelay</a>, frequency, State);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063     <span class="comment">// Update the early lines.</span>
<a name="l01064"></a>01064     UpdateEarlyLines(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#af323464239a9c1a7b43c7c72c6dc6645">Gain</a>, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ab5829b153a14fb0159f2e8267793a81d">ReflectionsGain</a>,
<a name="l01065"></a>01065                      Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ad8cfb16995eea175e65dd36f7bb4fc8c">LateReverbDelay</a>, State);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067     <span class="comment">// Update the decorrelator.</span>
<a name="l01068"></a>01068     UpdateDecorrelator(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a229f5b237b7cbffaa2da3c57289ccc15">Density</a>, frequency, State);
<a name="l01069"></a>01069 
<a name="l01070"></a>01070     <span class="comment">// Get the mixing matrix coefficients (x and y).</span>
<a name="l01071"></a>01071     CalcMatrixCoeffs(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a5ee8df46a934d3f43ba31ebaa6c4e802">Diffusion</a>, &amp;x, &amp;y);
<a name="l01072"></a>01072     <span class="comment">// Then divide x into y to simplify the matrix calculation.</span>
<a name="l01073"></a>01073     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a> = y / x;
<a name="l01074"></a>01074 
<a name="l01075"></a>01075     <span class="comment">// If the HF limit parameter is flagged, calculate an appropriate limit</span>
<a name="l01076"></a>01076     <span class="comment">// based on the air absorption parameter.</span>
<a name="l01077"></a>01077     hfRatio = Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ae004b2bbc37b76292fbc806ea706acf2">DecayHFRatio</a>;
<a name="l01078"></a>01078     <span class="keywordflow">if</span>(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a1f1c9504bbe75d616fe3c93bb225b3bd">DecayHFLimit</a> &amp;&amp; Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#af1d16a8a53224ba681dd80956cf9b993">AirAbsorptionGainHF</a> &lt; 1.0f)
<a name="l01079"></a>01079         hfRatio = CalcLimitedHfRatio(hfRatio, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#af1d16a8a53224ba681dd80956cf9b993">AirAbsorptionGainHF</a>,
<a name="l01080"></a>01080                                      Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a5e454774650bf69e365d338b4baceb13">DecayTime</a>);
<a name="l01081"></a>01081 
<a name="l01082"></a>01082     <span class="comment">// Update the late lines.</span>
<a name="l01083"></a>01083     UpdateLateLines(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#af323464239a9c1a7b43c7c72c6dc6645">Gain</a>, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#aa0ee163906a654fd7f390028a6b64ecb">LateReverbGain</a>,
<a name="l01084"></a>01084                     x, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a229f5b237b7cbffaa2da3c57289ccc15">Density</a>, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a5e454774650bf69e365d338b4baceb13">DecayTime</a>,
<a name="l01085"></a>01085                     Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a5ee8df46a934d3f43ba31ebaa6c4e802">Diffusion</a>, hfRatio, cw, frequency, State);
<a name="l01086"></a>01086 }
<a name="l01087"></a>01087 
<a name="l01088"></a>01088 <span class="comment">// This updates the EAX reverb state.  This is called any time the EAX reverb</span>
<a name="l01089"></a>01089 <span class="comment">// effect is loaded into a slot.</span>
<a name="l01090"></a>01090 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> EAXVerbUpdate(<a class="code" href="struct_a_leffect_state.html">ALeffectState</a> *effect, <a class="code" href="struct_a_l_ccontext__struct.html">ALCcontext</a> *Context, <span class="keyword">const</span> <a class="code" href="struct_a_leffect.html">ALeffect</a> *Effect)
<a name="l01091"></a>01091 {
<a name="l01092"></a>01092     <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State = (<a class="code" href="struct_a_lverb_state.html">ALverbState</a>*)effect;
<a name="l01093"></a>01093     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> frequency = Context-&gt;<a class="code" href="struct_a_l_ccontext__struct.html#a302683c73b2f17c76562d67387ffb214">Device</a>-&gt;<a class="code" href="struct_a_l_cdevice__struct.html#a3d8c0bc7edffccd468afa080502654d3">Frequency</a>;
<a name="l01094"></a>01094     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> cw, x, y, hfRatio;
<a name="l01095"></a>01095 
<a name="l01096"></a>01096     <span class="comment">// Calculate the master low-pass filter (from the master effect HF gain).</span>
<a name="l01097"></a>01097     cw = CalcI3DL2HFreq(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#acc929124f4b87984aeded8301dc2dc16">HFReference</a>, frequency);
<a name="l01098"></a>01098     <span class="comment">// This is done with 2 chained 1-pole filters, so no need to square g.</span>
<a name="l01099"></a>01099     State-&gt;<a class="code" href="struct_a_lverb_state.html#aab75c35b4386926fbd20924e604372b0">LpFilter</a>.<a class="code" href="struct_f_i_l_t_e_r.html#a0469a542dd6d2798d82c66ace2468a6f">coeff</a> = lpCoeffCalc(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ae3f5548bd58d12a486a59f50a3c21974">GainHF</a>, cw);
<a name="l01100"></a>01100 
<a name="l01101"></a>01101     <span class="comment">// Update the modulator line.</span>
<a name="l01102"></a>01102     UpdateModulator(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a8b5e25f1557b774d1c4136ac2b33480b">ModulationTime</a>,
<a name="l01103"></a>01103                     Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ae261fcda819bbb07b1e0b9474668b169">ModulationDepth</a>, frequency, State);
<a name="l01104"></a>01104 
<a name="l01105"></a>01105     <span class="comment">// Update the initial effect delay.</span>
<a name="l01106"></a>01106     UpdateDelayLine(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a6ee8f60ab8c62e72c72053494cbbd816">ReflectionsDelay</a>,
<a name="l01107"></a>01107                     Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ad8cfb16995eea175e65dd36f7bb4fc8c">LateReverbDelay</a>, frequency, State);
<a name="l01108"></a>01108 
<a name="l01109"></a>01109     <span class="comment">// Update the early lines.</span>
<a name="l01110"></a>01110     UpdateEarlyLines(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#af323464239a9c1a7b43c7c72c6dc6645">Gain</a>, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ab5829b153a14fb0159f2e8267793a81d">ReflectionsGain</a>,
<a name="l01111"></a>01111                      Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ad8cfb16995eea175e65dd36f7bb4fc8c">LateReverbDelay</a>, State);
<a name="l01112"></a>01112 
<a name="l01113"></a>01113     <span class="comment">// Update the decorrelator.</span>
<a name="l01114"></a>01114     UpdateDecorrelator(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a229f5b237b7cbffaa2da3c57289ccc15">Density</a>, frequency, State);
<a name="l01115"></a>01115 
<a name="l01116"></a>01116     <span class="comment">// Get the mixing matrix coefficients (x and y).</span>
<a name="l01117"></a>01117     CalcMatrixCoeffs(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a5ee8df46a934d3f43ba31ebaa6c4e802">Diffusion</a>, &amp;x, &amp;y);
<a name="l01118"></a>01118     <span class="comment">// Then divide x into y to simplify the matrix calculation.</span>
<a name="l01119"></a>01119     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a> = y / x;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121     <span class="comment">// If the HF limit parameter is flagged, calculate an appropriate limit</span>
<a name="l01122"></a>01122     <span class="comment">// based on the air absorption parameter.</span>
<a name="l01123"></a>01123     hfRatio = Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ae004b2bbc37b76292fbc806ea706acf2">DecayHFRatio</a>;
<a name="l01124"></a>01124     <span class="keywordflow">if</span>(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a1f1c9504bbe75d616fe3c93bb225b3bd">DecayHFLimit</a> &amp;&amp; Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#af1d16a8a53224ba681dd80956cf9b993">AirAbsorptionGainHF</a> &lt; 1.0f)
<a name="l01125"></a>01125         hfRatio = CalcLimitedHfRatio(hfRatio, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#af1d16a8a53224ba681dd80956cf9b993">AirAbsorptionGainHF</a>,
<a name="l01126"></a>01126                                      Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a5e454774650bf69e365d338b4baceb13">DecayTime</a>);
<a name="l01127"></a>01127 
<a name="l01128"></a>01128     <span class="comment">// Update the late lines.</span>
<a name="l01129"></a>01129     UpdateLateLines(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#af323464239a9c1a7b43c7c72c6dc6645">Gain</a>, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#aa0ee163906a654fd7f390028a6b64ecb">LateReverbGain</a>,
<a name="l01130"></a>01130                     x, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a229f5b237b7cbffaa2da3c57289ccc15">Density</a>, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a5e454774650bf69e365d338b4baceb13">DecayTime</a>,
<a name="l01131"></a>01131                     Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a5ee8df46a934d3f43ba31ebaa6c4e802">Diffusion</a>, hfRatio, cw, frequency, State);
<a name="l01132"></a>01132 
<a name="l01133"></a>01133     <span class="comment">// Update the echo line.</span>
<a name="l01134"></a>01134     UpdateEchoLine(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#af323464239a9c1a7b43c7c72c6dc6645">Gain</a>, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#aa0ee163906a654fd7f390028a6b64ecb">LateReverbGain</a>,
<a name="l01135"></a>01135                    Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#af3d3e2f83cf8880efde476c15534018e">EchoTime</a>, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a5e454774650bf69e365d338b4baceb13">DecayTime</a>,
<a name="l01136"></a>01136                    Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a5ee8df46a934d3f43ba31ebaa6c4e802">Diffusion</a>, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#aca5b96fa8fb57e56ff89d2da468bfebb">EchoDepth</a>,
<a name="l01137"></a>01137                    hfRatio, cw, frequency, State);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139     <span class="comment">// Update early and late 3D panning.</span>
<a name="l01140"></a>01140     Update3DPanning(Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#a3cfe25b6f66177ba490c4d2380e13c81">ReflectionsPan</a>, Effect-&gt;<a class="code" href="struct_a_leffect.html#a07e097c47b85d94b014bfcbe1c7070e2">Reverb</a>.<a class="code" href="struct_a_leffect.html#ab2e20814dd5cffd6c413c79c223fad2b">LateReverbPan</a>,
<a name="l01141"></a>01141                     Context-&gt;<a class="code" href="struct_a_l_ccontext__struct.html#a302683c73b2f17c76562d67387ffb214">Device</a>-&gt;<a class="code" href="struct_a_l_cdevice__struct.html#a677166a1dcbfe4520e600912f87be5c7">PanningLUT</a>, State);
<a name="l01142"></a>01142 }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144 <span class="comment">// This processes the reverb state, given the input samples and an output</span>
<a name="l01145"></a>01145 <span class="comment">// buffer.</span>
<a name="l01146"></a>01146 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> VerbProcess(<a class="code" href="struct_a_leffect_state.html">ALeffectState</a> *effect, <span class="keyword">const</span> <a class="code" href="struct_a_leffectslot.html">ALeffectslot</a> *Slot, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> SamplesToDo, <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *SamplesIn, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> (*SamplesOut)[OUTPUTCHANNELS])
<a name="l01147"></a>01147 {
<a name="l01148"></a>01148     <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State = (<a class="code" href="struct_a_lverb_state.html">ALverbState</a>*)effect;
<a name="l01149"></a>01149     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index;
<a name="l01150"></a>01150     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> early[4], late[4], out[4];
<a name="l01151"></a>01151     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> gain = Slot-&gt;<a class="code" href="struct_a_leffectslot.html#aed9e8a706595c519a3ba110ec4baf78e">Gain</a> * State-&gt;<a class="code" href="struct_a_lverb_state.html#a96267a063dd46d0bd518882f4fc0afbd">Scale</a>;
<a name="l01152"></a>01152 
<a name="l01153"></a>01153     <span class="keywordflow">for</span>(index = 0;index &lt; SamplesToDo;index++)
<a name="l01154"></a>01154     {
<a name="l01155"></a>01155         <span class="comment">// Process reverb for this sample.</span>
<a name="l01156"></a>01156         VerbPass(State, SamplesIn[index], early, late);
<a name="l01157"></a>01157 
<a name="l01158"></a>01158         <span class="comment">// Mix early reflections and late reverb.</span>
<a name="l01159"></a>01159         out[0] = (early[0] + late[0]) * gain;
<a name="l01160"></a>01160         out[1] = (early[1] + late[1]) * gain;
<a name="l01161"></a>01161         out[2] = (early[2] + late[2]) * gain;
<a name="l01162"></a>01162         out[3] = (early[3] + late[3]) * gain;
<a name="l01163"></a>01163 
<a name="l01164"></a>01164         <span class="comment">// Output the results.</span>
<a name="l01165"></a>01165         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa3e4b80cb31443019e807a14549b1d2bd">FRONT_LEFT</a>]   += out[0];
<a name="l01166"></a>01166         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aaae8a476ec2a06c02ffb4074660093318">FRONT_RIGHT</a>]  += out[1];
<a name="l01167"></a>01167         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa08b1632d986044c9f7bd0ee267d8fed8">FRONT_CENTER</a>] += out[3];
<a name="l01168"></a>01168         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aace725f8b25c871855f7d1914d076d110">SIDE_LEFT</a>]    += out[0];
<a name="l01169"></a>01169         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aad6b32a525e853f2ec94c5c5c2e21acca">SIDE_RIGHT</a>]   += out[1];
<a name="l01170"></a>01170         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aaa119fc497b25021b60fc4a3f5137714b">BACK_LEFT</a>]    += out[0];
<a name="l01171"></a>01171         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa9cc0f4b9085df2a23ea00596afb9f1bc">BACK_RIGHT</a>]   += out[1];
<a name="l01172"></a>01172         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa33d383431449bafc4fe00a78607723b1">BACK_CENTER</a>]  += out[2];
<a name="l01173"></a>01173     }
<a name="l01174"></a>01174 }
<a name="l01175"></a>01175 
<a name="l01176"></a>01176 <span class="comment">// This processes the EAX reverb state, given the input samples and an output</span>
<a name="l01177"></a>01177 <span class="comment">// buffer.</span>
<a name="l01178"></a>01178 <span class="keyword">static</span> <a class="code" href="al_8h.html#a33f8bcbc68209e69bd2d597f0b5471d4">ALvoid</a> EAXVerbProcess(<a class="code" href="struct_a_leffect_state.html">ALeffectState</a> *effect, <span class="keyword">const</span> <a class="code" href="struct_a_leffectslot.html">ALeffectslot</a> *Slot, <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> SamplesToDo, <span class="keyword">const</span> <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> *SamplesIn, <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> (*SamplesOut)[OUTPUTCHANNELS])
<a name="l01179"></a>01179 {
<a name="l01180"></a>01180     <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State = (<a class="code" href="struct_a_lverb_state.html">ALverbState</a>*)effect;
<a name="l01181"></a>01181     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index;
<a name="l01182"></a>01182     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> early[4], late[4];
<a name="l01183"></a>01183     <a class="code" href="al_8h.html#abb26671ce5d302ed61a2e55256624169">ALfloat</a> gain = Slot-&gt;<a class="code" href="struct_a_leffectslot.html#aed9e8a706595c519a3ba110ec4baf78e">Gain</a> * State-&gt;<a class="code" href="struct_a_lverb_state.html#a96267a063dd46d0bd518882f4fc0afbd">Scale</a>;
<a name="l01184"></a>01184 
<a name="l01185"></a>01185     <span class="keywordflow">for</span>(index = 0;index &lt; SamplesToDo;index++)
<a name="l01186"></a>01186     {
<a name="l01187"></a>01187         <span class="comment">// Process reverb for this sample.</span>
<a name="l01188"></a>01188         EAXVerbPass(State, SamplesIn[index], early, late);
<a name="l01189"></a>01189 
<a name="l01190"></a>01190         <span class="comment">// Unfortunately, while the number and configuration of gains for</span>
<a name="l01191"></a>01191         <span class="comment">// panning adjust according to OUTPUTCHANNELS, the output from the</span>
<a name="l01192"></a>01192         <span class="comment">// reverb engine is not so scalable.</span>
<a name="l01193"></a>01193         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa3e4b80cb31443019e807a14549b1d2bd">FRONT_LEFT</a>] +=
<a name="l01194"></a>01194            (State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa3e4b80cb31443019e807a14549b1d2bd">FRONT_LEFT</a>]*early[0] +
<a name="l01195"></a>01195             State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa3e4b80cb31443019e807a14549b1d2bd">FRONT_LEFT</a>]*late[0]) * gain;
<a name="l01196"></a>01196         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aaae8a476ec2a06c02ffb4074660093318">FRONT_RIGHT</a>] +=
<a name="l01197"></a>01197            (State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aaae8a476ec2a06c02ffb4074660093318">FRONT_RIGHT</a>]*early[1] +
<a name="l01198"></a>01198             State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aaae8a476ec2a06c02ffb4074660093318">FRONT_RIGHT</a>]*late[1]) * gain;
<a name="l01199"></a>01199         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa08b1632d986044c9f7bd0ee267d8fed8">FRONT_CENTER</a>] +=
<a name="l01200"></a>01200            (State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa08b1632d986044c9f7bd0ee267d8fed8">FRONT_CENTER</a>]*early[3] +
<a name="l01201"></a>01201             State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa08b1632d986044c9f7bd0ee267d8fed8">FRONT_CENTER</a>]*late[3]) * gain;
<a name="l01202"></a>01202         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aace725f8b25c871855f7d1914d076d110">SIDE_LEFT</a>] +=
<a name="l01203"></a>01203            (State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aace725f8b25c871855f7d1914d076d110">SIDE_LEFT</a>]*early[0] +
<a name="l01204"></a>01204             State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aace725f8b25c871855f7d1914d076d110">SIDE_LEFT</a>]*late[0]) * gain;
<a name="l01205"></a>01205         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aad6b32a525e853f2ec94c5c5c2e21acca">SIDE_RIGHT</a>] +=
<a name="l01206"></a>01206            (State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aad6b32a525e853f2ec94c5c5c2e21acca">SIDE_RIGHT</a>]*early[1] +
<a name="l01207"></a>01207             State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aad6b32a525e853f2ec94c5c5c2e21acca">SIDE_RIGHT</a>]*late[1]) * gain;
<a name="l01208"></a>01208         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aaa119fc497b25021b60fc4a3f5137714b">BACK_LEFT</a>] +=
<a name="l01209"></a>01209            (State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aaa119fc497b25021b60fc4a3f5137714b">BACK_LEFT</a>]*early[0] +
<a name="l01210"></a>01210             State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aaa119fc497b25021b60fc4a3f5137714b">BACK_LEFT</a>]*late[0]) * gain;
<a name="l01211"></a>01211         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa9cc0f4b9085df2a23ea00596afb9f1bc">BACK_RIGHT</a>] +=
<a name="l01212"></a>01212            (State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa9cc0f4b9085df2a23ea00596afb9f1bc">BACK_RIGHT</a>]*early[1] +
<a name="l01213"></a>01213             State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa9cc0f4b9085df2a23ea00596afb9f1bc">BACK_RIGHT</a>]*late[1]) * gain;
<a name="l01214"></a>01214         SamplesOut[index][<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa33d383431449bafc4fe00a78607723b1">BACK_CENTER</a>] +=
<a name="l01215"></a>01215            (State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa33d383431449bafc4fe00a78607723b1">BACK_CENTER</a>]*early[2] +
<a name="l01216"></a>01216             State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[<a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa33d383431449bafc4fe00a78607723b1">BACK_CENTER</a>]*late[2]) * gain;
<a name="l01217"></a>01217     }
<a name="l01218"></a>01218 }
<a name="l01219"></a>01219 
<a name="l01220"></a>01220 <span class="comment">// This creates the reverb state.  It should be called only when the reverb</span>
<a name="l01221"></a>01221 <span class="comment">// effect is loaded into a slot that doesn&#39;t already have a reverb effect.</span>
<a name="l01222"></a><a class="code" href="al_aux_effect_slot_8h.html#a4ce533fde10b1aceac66f290e8ecc421">01222</a> <a class="code" href="struct_a_leffect_state.html">ALeffectState</a> *<a class="code" href="alc_reverb_8c.html#a4ce533fde10b1aceac66f290e8ecc421">VerbCreate</a>(<span class="keywordtype">void</span>)
<a name="l01223"></a>01223 {
<a name="l01224"></a>01224     <a class="code" href="struct_a_lverb_state.html">ALverbState</a> *State = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01225"></a>01225     <a class="code" href="al_8h.html#ae0292edc5c1c47db9accee3f49933e6f">ALuint</a> index;
<a name="l01226"></a>01226 
<a name="l01227"></a>01227     State = malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct_a_lverb_state.html">ALverbState</a>));
<a name="l01228"></a>01228     <span class="keywordflow">if</span>(!State)
<a name="l01229"></a>01229         <span class="keywordflow">return</span> <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01230"></a>01230 
<a name="l01231"></a>01231     State-&gt;<a class="code" href="struct_a_lverb_state.html#a8664c25159271fd8afa71e88634fcdd7">state</a>.<a class="code" href="struct_a_leffect_state.html#ad480554b01518252a0d611531eaf57cd">Destroy</a> = VerbDestroy;
<a name="l01232"></a>01232     State-&gt;<a class="code" href="struct_a_lverb_state.html#a8664c25159271fd8afa71e88634fcdd7">state</a>.<a class="code" href="struct_a_leffect_state.html#aeb643d021430b46d11b1372cd6bab014">DeviceUpdate</a> = VerbDeviceUpdate;
<a name="l01233"></a>01233     State-&gt;<a class="code" href="struct_a_lverb_state.html#a8664c25159271fd8afa71e88634fcdd7">state</a>.<a class="code" href="struct_a_leffect_state.html#a70066a4f8e05bff0f61d513a17511e69">Update</a> = VerbUpdate;
<a name="l01234"></a>01234     State-&gt;<a class="code" href="struct_a_lverb_state.html#a8664c25159271fd8afa71e88634fcdd7">state</a>.<a class="code" href="struct_a_leffect_state.html#a05675bf69d86fe4af68c2bcb155f9e62">Process</a> = VerbProcess;
<a name="l01235"></a>01235 
<a name="l01236"></a>01236     State-&gt;<a class="code" href="struct_a_lverb_state.html#a33285ed214990a991160564fb7603910">TotalSamples</a> = 0;
<a name="l01237"></a>01237     State-&gt;<a class="code" href="struct_a_lverb_state.html#a5300ed6c772a5f69b271a42b2e2e944c">SampleBuffer</a> = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01238"></a>01238 
<a name="l01239"></a>01239     State-&gt;<a class="code" href="struct_a_lverb_state.html#aab75c35b4386926fbd20924e604372b0">LpFilter</a>.<a class="code" href="struct_f_i_l_t_e_r.html#a0469a542dd6d2798d82c66ace2468a6f">coeff</a> = 0.0f;
<a name="l01240"></a>01240     State-&gt;<a class="code" href="struct_a_lverb_state.html#aab75c35b4386926fbd20924e604372b0">LpFilter</a>.<a class="code" href="struct_f_i_l_t_e_r.html#a6ece2ed72ac03cdcc6903e1914593ed5">history</a>[0] = 0.0f;
<a name="l01241"></a>01241     State-&gt;<a class="code" href="struct_a_lverb_state.html#aab75c35b4386926fbd20924e604372b0">LpFilter</a>.<a class="code" href="struct_f_i_l_t_e_r.html#a6ece2ed72ac03cdcc6903e1914593ed5">history</a>[1] = 0.0f;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>.<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a> = 0;
<a name="l01244"></a>01244     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>.<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a> = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01245"></a>01245     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af3fcb94c1627df5038ff48ff0ca0159b">Index</a> = 0;
<a name="l01246"></a>01246     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#aa7a28f50d1bc229b3ac92489c0f9acbf">Range</a> = 1;
<a name="l01247"></a>01247     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#aafb26255182359033d7704286a1444aa">Depth</a> = 0.0f;
<a name="l01248"></a>01248     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a> = 0.0f;
<a name="l01249"></a>01249     State-&gt;<a class="code" href="struct_a_lverb_state.html#a58fbc21ef7c9fff4dc5bde44ace5b2d0">Mod</a>.<a class="code" href="struct_a_lverb_state.html#af484b13957675f52ff8fbc6b3bbbf809">Filter</a> = 0.0f;
<a name="l01250"></a>01250 
<a name="l01251"></a>01251     State-&gt;<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>.<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a> = 0;
<a name="l01252"></a>01252     State-&gt;<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>.<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a> = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01253"></a>01253     State-&gt;<a class="code" href="struct_a_lverb_state.html#aae91bc3ac5e5fd7d9900d9cc9aebf614">DelayTap</a>[0] = 0;
<a name="l01254"></a>01254     State-&gt;<a class="code" href="struct_a_lverb_state.html#aae91bc3ac5e5fd7d9900d9cc9aebf614">DelayTap</a>[1] = 0;
<a name="l01255"></a>01255 
<a name="l01256"></a>01256     State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> = 0.0f;
<a name="l01257"></a>01257     <span class="keywordflow">for</span>(index = 0;index &lt; 4;index++)
<a name="l01258"></a>01258     {
<a name="l01259"></a>01259         State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>[index] = 0.0f;
<a name="l01260"></a>01260         State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[index].<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a> = 0;
<a name="l01261"></a>01261         State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[index].<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a> = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01262"></a>01262         State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>[index] = 0;
<a name="l01263"></a>01263     }
<a name="l01264"></a>01264 
<a name="l01265"></a>01265     State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>.<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a> = 0;
<a name="l01266"></a>01266     State-&gt;<a class="code" href="struct_a_lverb_state.html#a45622e55e82af161d59bdfffa4c160b3">Decorrelator</a>.<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a> = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01267"></a>01267     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[0] = 0;
<a name="l01268"></a>01268     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[1] = 0;
<a name="l01269"></a>01269     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae9f02bf8639b18f1e1f167aef807426e">DecoTap</a>[2] = 0;
<a name="l01270"></a>01270 
<a name="l01271"></a>01271     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a1cb597aef00b4711092e05fe350c0551">Gain</a> = 0.0f;
<a name="l01272"></a>01272     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a5e84154f5880e79ee0bc4e094c9b1e5c">DensityGain</a> = 0.0f;
<a name="l01273"></a>01273     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4ff8897495d7ac9a1bd4a93de36c03c6">ApFeedCoeff</a> = 0.0f;
<a name="l01274"></a>01274     State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a> = 0.0f;
<a name="l01275"></a>01275     <span class="keywordflow">for</span>(index = 0;index &lt; 4;index++)
<a name="l01276"></a>01276     {
<a name="l01277"></a>01277         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a5d58dda9a07639a8b06bd96281441e82">ApCoeff</a>[index] = 0.0f;
<a name="l01278"></a>01278         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>[index].<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a> = 0;
<a name="l01279"></a>01279         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>[index].<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a> = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01280"></a>01280         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#ad14d16893ca9c4352b8f4772e43fe862">ApOffset</a>[index] = 0;
<a name="l01281"></a>01281 
<a name="l01282"></a>01282         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a>[index] = 0.0f;
<a name="l01283"></a>01283         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[index].<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a> = 0;
<a name="l01284"></a>01284         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>[index].<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a> = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01285"></a>01285         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a>[index] = 0;
<a name="l01286"></a>01286 
<a name="l01287"></a>01287         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a8989338e5a5a7a754919116d822351be">LpCoeff</a>[index] = 0.0f;
<a name="l01288"></a>01288         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#aae60f2460d943f027893434ddb9b890e">LpSample</a>[index] = 0.0f;
<a name="l01289"></a>01289     }
<a name="l01290"></a>01290 
<a name="l01291"></a>01291     <span class="keywordflow">for</span>(index = 0;index &lt; <a class="code" href="alu_8h.html#a1ce9b523fd4f3b5bbcadcd796183455aa9d24a2cd94e8ec72f22f694e60d323e7">OUTPUTCHANNELS</a>;index++)
<a name="l01292"></a>01292     {
<a name="l01293"></a>01293         State-&gt;<a class="code" href="struct_a_lverb_state.html#a570f758664c94554dfb47ecf410f5d84">Early</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[index] = 0.0f;
<a name="l01294"></a>01294         State-&gt;<a class="code" href="struct_a_lverb_state.html#ae3057312c1af1538973c758103b27b7d">Late</a>.<a class="code" href="struct_a_lverb_state.html#a4d255eb0159709383a0353caf088fd14">PanGain</a>[index] = 0.0f;
<a name="l01295"></a>01295     }
<a name="l01296"></a>01296 
<a name="l01297"></a>01297     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a5e84154f5880e79ee0bc4e094c9b1e5c">DensityGain</a> = 0.0f;
<a name="l01298"></a>01298     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>.<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a> = 0;
<a name="l01299"></a>01299     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a2ad6ccc35db7a7746f8364387c5579a4">Delay</a>.<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a> = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01300"></a>01300     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>.<a class="code" href="struct_delay_line.html#aa5b785d0c758e71fc4fe2a7e45b177af">Mask</a> = 0;
<a name="l01301"></a>01301     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#acf2a1f82bca8d5ea3a7d1d6b2d19af89">ApDelay</a>.<a class="code" href="struct_delay_line.html#abd4ce0fab63129e4bcf9a43f580f1174">Line</a> = <a class="code" href="ftobjs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01302"></a>01302     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a95b72b08fea1383c2d956af6e381a078">Coeff</a> = 0.0f;
<a name="l01303"></a>01303     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a4ff8897495d7ac9a1bd4a93de36c03c6">ApFeedCoeff</a> = 0.0f;
<a name="l01304"></a>01304     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a5d58dda9a07639a8b06bd96281441e82">ApCoeff</a> = 0.0f;
<a name="l01305"></a>01305     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> = 0;
<a name="l01306"></a>01306     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#ad14d16893ca9c4352b8f4772e43fe862">ApOffset</a> = 0;
<a name="l01307"></a>01307     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a8989338e5a5a7a754919116d822351be">LpCoeff</a> = 0.0f;
<a name="l01308"></a>01308     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#aae60f2460d943f027893434ddb9b890e">LpSample</a> = 0.0f;
<a name="l01309"></a>01309     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>[0] = 0.0f;
<a name="l01310"></a>01310     State-&gt;<a class="code" href="struct_a_lverb_state.html#aca304ef1367cb2b052c8dc04af878f62">Echo</a>.<a class="code" href="struct_a_lverb_state.html#a695c2c6334b78d19d327d78901dfd364">MixCoeff</a>[1] = 0.0f;
<a name="l01311"></a>01311 
<a name="l01312"></a>01312     State-&gt;<a class="code" href="struct_a_lverb_state.html#ac84ab121948c095d26d2ca02f45bb690">Offset</a> = 0;
<a name="l01313"></a>01313 
<a name="l01314"></a>01314     State-&gt;<a class="code" href="struct_a_lverb_state.html#a96267a063dd46d0bd518882f4fc0afbd">Scale</a> = 1.0f;
<a name="l01315"></a>01315 
<a name="l01316"></a>01316     <span class="keywordflow">return</span> &amp;State-&gt;<a class="code" href="struct_a_lverb_state.html#a8664c25159271fd8afa71e88634fcdd7">state</a>;
<a name="l01317"></a>01317 }
<a name="l01318"></a>01318 
<a name="l01319"></a><a class="code" href="al_aux_effect_slot_8h.html#aa64c407d8a61ff680db7f690187a1304">01319</a> <a class="code" href="struct_a_leffect_state.html">ALeffectState</a> *<a class="code" href="alc_reverb_8c.html#aa64c407d8a61ff680db7f690187a1304">EAXVerbCreate</a>(<span class="keywordtype">void</span>)
<a name="l01320"></a>01320 {
<a name="l01321"></a>01321     <a class="code" href="struct_a_leffect_state.html">ALeffectState</a> *State = <a class="code" href="alc_reverb_8c.html#a4ce533fde10b1aceac66f290e8ecc421">VerbCreate</a>();
<a name="l01322"></a>01322     <span class="keywordflow">if</span>(State)
<a name="l01323"></a>01323     {
<a name="l01324"></a>01324         State-&gt;<a class="code" href="struct_a_leffect_state.html#aeb643d021430b46d11b1372cd6bab014">DeviceUpdate</a> = EAXVerbDeviceUpdate;
<a name="l01325"></a>01325         State-&gt;<a class="code" href="struct_a_leffect_state.html#a70066a4f8e05bff0f61d513a17511e69">Update</a> = EAXVerbUpdate;
<a name="l01326"></a>01326         State-&gt;<a class="code" href="struct_a_leffect_state.html#a05675bf69d86fe4af68c2bcb155f9e62">Process</a> = EAXVerbProcess;
<a name="l01327"></a>01327     }
<a name="l01328"></a>01328     <span class="keywordflow">return</span> State;
<a name="l01329"></a>01329 }
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="alc_reverb_8c.html">alcReverb.c</a>      </li>

    <li class="footer">Generated on Tue Mar 13 2012 11:44:05 for ARK2D by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.0 </li>
   </ul>
 </div>


</body>
</html>
